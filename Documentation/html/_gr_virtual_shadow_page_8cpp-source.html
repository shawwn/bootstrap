<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Bootstrap Engine: C:/Bootstrap/ProjectBX/Documentation/Code/Engine/Graphics/GrVirtualShadowPage.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>C:/Bootstrap/ProjectBX/Documentation/Code/Engine/Graphics/GrVirtualShadowPage.cpp</h1><a href="_gr_virtual_shadow_page_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//----------------------------------------------------------</span>
<a name="l00006"></a>00006 <span class="comment"></span><span class="comment">//----------------------------------------------------------</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include "<a class="code" href="graphics__afx_8h.html">graphics_afx.h</a>"</span>
<a name="l00008"></a>00008 
<a name="l00010"></a>00010 <span class="preprocessor">#include "<a class="code" href="_gr_virtual_shadow_page_8h.html">GrVirtualShadowPage.h</a>"</span>
<a name="l00011"></a>00011 
<a name="l00013"></a>00013 <span class="preprocessor">#include "<a class="code" href="_gr_virtual_shadow_segment_set_8h.html">GrVirtualShadowSegmentSet.h</a>"</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include "<a class="code" href="_gr_render_target_8h.html">GrRenderTarget.h</a>"</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include "<a class="code" href="_gr_render_target_mgr_8h.html">GrRenderTargetMgr.h</a>"</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include "<a class="code" href="_gr_renderbuffer_8h.html">GrRenderbuffer.h</a>"</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include "<a class="code" href="_gr_texture_base_8h.html">GrTextureBase.h</a>"</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include "<a class="code" href="_gr_texture_mgr_8h.html">GrTextureMgr.h</a>"</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include "<a class="code" href="_gr_shader_mgr_8h.html">GrShaderMgr.h</a>"</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include "<a class="code" href="_gr_shader_8h.html">GrShader.h</a>"</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include "<a class="code" href="_gr_light_8h.html">GrLight.h</a>"</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include "<a class="code" href="_gr_util_8h.html">GrUtil.h</a>"</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include "<a class="code" href="_gr_image_8h.html">GrImage.h</a>"</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include "<a class="code" href="_gr_debug_8h.html">GrDebug.h</a>"</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include "<a class="code" href="_g_l_subsys_8h.html">GLSubsys.h</a>"</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include "<a class="code" href="_m_a_a_box_8h.html">MAABox.h</a>"</span>
<a name="l00027"></a>00027 
<a name="l00028"></a><a class="code" href="_gr_virtual_shadow_page_8cpp.html#bcabe89874e49606633c4ee14cf49a2b">00028</a> <span class="preprocessor">#define INDIR_MOD_ADD_HANDLE            0</span>
<a name="l00029"></a>00029 <span class="preprocessor"></span>
<a name="l00031"></a><a class="code" href="_gr_virtual_shadow_page_8cpp.html#530dc596cef85ec7faeff33e9e6f5847">00031</a> <span class="preprocessor">#define SHADOW_BORDER_SIZE                      64</span>
<a name="l00032"></a>00032 <span class="preprocessor"></span>
<a name="l00033"></a>00033 <span class="comment">//**********************************************************</span>
<a name="l00035"></a>00035 <span class="comment"></span><span class="comment">//**********************************************************</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="comment">//==========================================================</span>
<a name="l00039"></a>00039 <span class="comment"></span><span class="comment">//==========================================================</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="comment">//----------------------------------------------------------</span>
<a name="l00042"></a><a class="code" href="class_gr_virtual_shadow_page.html#10dc766d8a8b6c912b39e60893bdfae8">00042</a> <a class="code" href="class_gr_virtual_shadow_page.html#10dc766d8a8b6c912b39e60893bdfae8" title="class GrVirtualShadowPage">GrVirtualShadowPage::GrVirtualShadowPage</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> shadowPageSize, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> shadowMapSize, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> indirTexSize )
<a name="l00043"></a>00043 : _shadowMapCount( <a class="code" href="common__afx_8h.html#9443605a3554459dd5144f28f698d16d">Sqr</a>( shadowPageSize / shadowMapSize ) )
<a name="l00044"></a>00044 , _texAddrStep( 1.0f / float( shadowPageSize / shadowMapSize ) )
<a name="l00045"></a>00045 , _shadowPageSize( shadowPageSize )
<a name="l00046"></a>00046 , _shadowMapSize( shadowMapSize )
<a name="l00047"></a>00047 , _shadowMapBorder( <a class="code" href="_gr_virtual_shadow_page_8cpp.html#530dc596cef85ec7faeff33e9e6f5847" title="size of each shadow map border in pixels.">SHADOW_BORDER_SIZE</a> )
<a name="l00048"></a>00048 , _prevRT( 0 )
<a name="l00049"></a>00049 {
<a name="l00052"></a>00052         <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( <a class="code" href="common__afx_8h.html#57be1bf0723f638d0d40c91339bd6f05">IsPow2</a>( shadowPageSize ) );
<a name="l00053"></a>00053         <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( <a class="code" href="common__afx_8h.html#57be1bf0723f638d0d40c91339bd6f05">IsPow2</a>( shadowMapSize ) );
<a name="l00054"></a>00054         <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( <a class="code" href="common__afx_8h.html#57be1bf0723f638d0d40c91339bd6f05">IsPow2</a>( indirTexSize ) );
<a name="l00055"></a>00055 
<a name="l00057"></a>00057         <a class="code" href="class_u_ref.html">URef&lt; GrRenderbuffer &gt;</a> indirDepth = <a class="code" href="_gr_render_target_mgr_8cpp.html#e724d8bfeb4bcd97146e35ca1646dd2f" title="class header.">gGrRenderTargetMgr</a>-&gt;<a class="code" href="class_gr_render_target_mgr.html#fabad7a065e67c6bd8f04e98e1501061" title="rendertarget component creation.">CreateRenderbuffer</a>( indirTexSize, indirTexSize, <a class="code" href="class_gr_render_target_mgr.html#66d0ebb49e9781283d824f19f4bbc3f6921d4c2f8d32dd605d25dee31fc2312d" title="not supported for renderbuffers.">GrRenderTargetMgr::EF_DEPTH</a> );
<a name="l00058"></a>00058         <a class="code" href="class_u_ref.html">URef&lt; GrTextureBase &gt;</a> indirCube = <a class="code" href="_gr_render_target_mgr_8cpp.html#e724d8bfeb4bcd97146e35ca1646dd2f" title="class header.">gGrRenderTargetMgr</a>-&gt;<a class="code" href="class_gr_render_target_mgr.html#7e1d7957a2167cd17b678a44da653898">CreateRendertexture</a>( indirTexSize, indirTexSize, <a class="code" href="class_gr_render_target_mgr.html#66d0ebb49e9781283d824f19f4bbc3f68bf48fc5dd1d228a758325704bd134bf" title="not supported for renderbuffers.">GrRenderTargetMgr::EF_RGBA128F</a>,
<a name="l00059"></a>00059                 <a class="code" href="class_gr_texture_base.html#47f4a8d764ba3c8e9e353a394edfcd2c">GrTextureBase::kNoMipMap</a>, <a class="code" href="class_gr_texture_base.html#5ce3676de03c3c565a9a0995334e53085a491542d9caa5f9543b500942b7b5a6">GrTextureBase::ETT_CUBE</a> );
<a name="l00060"></a>00060 
<a name="l00062"></a>00062         _shadowIndirCube = <a class="code" href="_gr_render_target_mgr_8cpp.html#e724d8bfeb4bcd97146e35ca1646dd2f" title="class header.">gGrRenderTargetMgr</a>-&gt;<a class="code" href="class_gr_render_target_mgr.html#2dc9cb29f5f88c355eaab0938c0f355d" title="create a render target.">CreateRenderTarget</a>( indirCube, indirDepth );
<a name="l00063"></a>00063 
<a name="l00065"></a>00065         _shadowIndirShader = <a class="code" href="_gr_shader_mgr_8cpp.html#72561a5bdde97bf632da40c53beaf8e9" title="Purpose: To manage OpenGL vertex/fragment programs.">gGrShaderMgr</a>-&gt;<a class="code" href="class_gr_shader_mgr.html#808c8e1152500a452398977b1b1ff650" title="public methods">GetShader</a>( <span class="stringliteral">"VSM/indir"</span> );
<a name="l00066"></a>00066         _shadowIndirShader-&gt;InitUserParam( <span class="stringliteral">"u_IndirModAdd"</span>, <a class="code" href="_gr_virtual_shadow_page_8cpp.html#bcabe89874e49606633c4ee14cf49a2b" title="class header.">INDIR_MOD_ADD_HANDLE</a> );
<a name="l00067"></a>00067 
<a name="l00069"></a>00069         _shadowData.<a class="code" href="struct_gr_virtual_shadow_page_1_1_s_render_data.html#31607d153b3771eaec764a6b64a67131">indirCube</a> = _shadowIndirCube-&gt;GetColorTex( 0 );
<a name="l00070"></a>00070 
<a name="l00073"></a>00073         <a class="code" href="class_gr_image.html" title="class GrTexture">GrImage</a>* images[ 6 ];
<a name="l00074"></a>00074         <span class="keywordtype">char</span> imageName[] = <span class="stringliteral">"indir_cube_face_0"</span>;
<a name="l00075"></a>00075         <span class="keywordtype">size_t</span> <a class="code" href="glext_8h.html#00140d6f5c548b26daf170bf16e86a6d">t</a> = strlen( imageName )-1;
<a name="l00076"></a>00076         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; 6; ++i )
<a name="l00077"></a>00077         {
<a name="l00078"></a>00078                 imageName[ t ] = <span class="charliteral">'0'</span> + i;
<a name="l00079"></a>00079                 images[ i ] = <span class="keyword">new</span> <a class="code" href="class_gr_image.html" title="class GrTexture">GrImage</a>( imageName, 0x7F7F7F7F );
<a name="l00080"></a>00080         }
<a name="l00081"></a>00081         _noShadowData.<a class="code" href="struct_gr_virtual_shadow_page_1_1_s_render_data.html#31607d153b3771eaec764a6b64a67131">indirCube</a> = <a class="code" href="_gr_texture_mgr_8cpp.html#51ad772529ca3df5a1d62836ace41d5c" title="singleton pointer.">gGrTextureMgr</a>-&gt;<a class="code" href="class_gr_texture_mgr.html#23e061dceb24e232264beef4ad1de42b">GetTextureCubeImages</a>( images, 1, <a class="code" href="class_gr_texture_base.html#82c606022e93566ba55fe4cd3beb687c7299859c496a8865b40024d76e6edfcd" title="5:5:5:1">GrTextureBase::EF_RGBA32</a>,
<a name="l00082"></a>00082                 <a class="code" href="class_gr_texture_base.html#47f4a8d764ba3c8e9e353a394edfcd2c">GrTextureBase::kNoMipMap</a> | <a class="code" href="class_gr_texture_base.html#184780018f2b67996c9274798e52607e">GrTextureBase::kNoCompress</a> );
<a name="l00083"></a>00083 
<a name="l00085"></a>00085         _texGenBias = <a class="code" href="class_m_mat4x4.html" title="class MMat4x4">MMat4x4</a>( 0.5f, 0.0f, 0.0f, 0.5f,
<a name="l00086"></a>00086                                                    0.0f, 0.5f, 0.0f, 0.5f,
<a name="l00087"></a>00087                                                    0.0f, 0.0f, 1.0f, 0.0f,
<a name="l00088"></a>00088                                                    0.0f, 0.0f, 0.0f, 1.0f );
<a name="l00089"></a>00089 }
<a name="l00090"></a>00090 
<a name="l00091"></a>00091 <span class="comment">//----------------------------------------------------------</span>
<a name="l00092"></a><a class="code" href="class_gr_virtual_shadow_page.html#6b13a721bc654d712d0159332f668166">00092</a> <a class="code" href="class_gr_virtual_shadow_page.html#6b13a721bc654d712d0159332f668166">GrVirtualShadowPage::~GrVirtualShadowPage</a>()
<a name="l00093"></a>00093 {
<a name="l00094"></a>00094 
<a name="l00095"></a>00095 }
<a name="l00096"></a>00096 
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 <span class="comment">//==========================================================</span>
<a name="l00100"></a>00100 <span class="comment"></span><span class="comment">//==========================================================</span>
<a name="l00101"></a>00101 
<a name="l00102"></a>00102 <span class="comment">//----------------------------------------------------------</span>
<a name="l00103"></a>00103 <span class="keywordtype">void</span>
<a name="l00104"></a><a class="code" href="class_gr_virtual_shadow_page.html#47d88b2d5752b7a1e2f38d14d5df538d">00104</a> <a class="code" href="class_gr_virtual_shadow_page.html#47d88b2d5752b7a1e2f38d14d5df538d" title="functions that enable rendering to the shadow map.">GrVirtualShadowPage::GenShadowInfo</a>( std::vector&lt; SShadowInfo &gt;&amp; shadows, <span class="keyword">const</span> <a class="code" href="class_gr_camera.html" title="class GrCamera">GrCamera</a>&amp; viewerCamera,
<a name="l00105"></a>00105                                                                         <a class="code" href="class_gr_virtual_shadow_segment_set.html" title="class GrVirtualShadowSegmentSet">GrVirtualShadowSegmentSet</a>&amp; segments, <span class="keyword">const</span> <a class="code" href="class_gr_light.html" title="class GrLight">GrLight</a>&amp; light )
<a name="l00106"></a>00106 {
<a name="l00107"></a>00107         <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="glext_8h.html#6180492a53d6843c599d9934a5facf65">border</a> = float( <a class="code" href="_gr_virtual_shadow_page_8cpp.html#530dc596cef85ec7faeff33e9e6f5847" title="size of each shadow map border in pixels.">SHADOW_BORDER_SIZE</a> ) / _shadowIndirCube-&gt;GetWidth();
<a name="l00108"></a>00108         <span class="keyword">const</span> <span class="keywordtype">float</span> invIndirCubeWidth = 1.0f / ( float )_shadowIndirCube-&gt;GetWidth();
<a name="l00109"></a>00109 
<a name="l00111"></a>00111         <a class="code" href="_gr_util_8cpp.html#da7ea629bb413c26919562c8846d6139">GrSetState</a>( 0 );
<a name="l00112"></a>00112 
<a name="l00114"></a>00114         _shadowIndirCube-&gt;Bind();
<a name="l00115"></a>00115 
<a name="l00117"></a>00117         <span class="keywordflow">if</span> ( light.<a class="code" href="class_gr_light.html#e1b04eb006abc19edf83dcdb1e364110">IsParallel</a>() || ( light.<a class="code" href="class_gr_light.html#0df072bac3ea1048c4a57aed74bb2361">GetProjection</a>().<a class="code" href="class_gr_projection.html#abd3817acc3eeef6f80ff8e30fc1467c">IsOrtho</a>() &amp;&amp; light.<a class="code" href="class_gr_light.html#739b15eaf5c39ae1937546644aab1e42">GetProjTexture</a>() ) )
<a name="l00118"></a>00118         {
<a name="l00121"></a>00121                 _shadowIndirCube-&gt;SetActiveFace( <a class="code" href="class_gr_texture_cube.html#49c6f83c73520edfce04f4eb5dcfe6a05114dcd5206ee6bfbb45bf919dabb061">GrTextureCube::CF_NEGATIVEZ</a> );
<a name="l00122"></a>00122 
<a name="l00124"></a>00124                 <a class="code" href="_gr_util_8cpp.html#7b33558bb79e3c6936f26553c282d081">GrSetWriteEnable</a>( <a class="code" href="_gr_util_8h.html#d091dcc5dafb6944427eb6d9895b25d3">GR_RGBA</a> );
<a name="l00125"></a>00125                 <a class="code" href="_gr_util_8cpp.html#60654372f8080fc80b5e1ef0aea7dd99" title="Rendering functions.">GrClear</a>( 1.0f, 1.0f, 1.0f );
<a name="l00126"></a>00126 
<a name="l00128"></a>00128                 <a class="code" href="class_gr_camera.html" title="class GrCamera">GrCamera</a> indirCamera;
<a name="l00129"></a>00129                 CalcProjCamera( indirCamera, light );
<a name="l00130"></a>00130 
<a name="l00132"></a>00132                 segments.<a class="code" href="class_gr_virtual_shadow_segment_set.html#92e15d9d6393687920a408901ba53cd2" title="calculates AA boxes for all segments given the current camera.">UpdateSegments</a>( indirCamera, border, 0.0f );
<a name="l00133"></a>00133 
<a name="l00135"></a>00135                 AllocateShadowMaps( shadows, segments, indirCamera, 0, 16 );
<a name="l00136"></a>00136 
<a name="l00139"></a>00139                 <a class="code" href="class_gr_camera.html" title="class GrCamera">GrCamera</a> faceCamera( light.<a class="code" href="class_gr_light.html#0d4a1686505a6cacd389144659887e73">GetPos</a>(), light.<a class="code" href="class_gr_light.html#6ef30451289f25c79d3b297ac0f773a8">GetWorldTransform</a>().<a class="code" href="class_m_mat4x4.html#3cc5b3636f8bd790d477e83ad2396007">GetRotate</a>(), light.<a class="code" href="class_gr_light.html#0df072bac3ea1048c4a57aed74bb2361">GetProjection</a>() );
<a name="l00140"></a>00140 
<a name="l00144"></a>00144                 <span class="keywordtype">float</span> <a class="code" href="_g_l_8h.html#e6531b1788ca42a9ae8155b0c52e7630">width</a> = ( light.<a class="code" href="class_gr_light.html#0df072bac3ea1048c4a57aed74bb2361">GetProjection</a>().<a class="code" href="class_gr_projection.html#076356ed413ff2aaab1b0f6af4cf8a3c">GetRight</a>() - light.<a class="code" href="class_gr_light.html#0df072bac3ea1048c4a57aed74bb2361">GetProjection</a>().<a class="code" href="class_gr_projection.html#259e5d940d8cd6685eafe37eb541238e">GetLeft</a>() );
<a name="l00145"></a>00145                 <span class="keywordtype">float</span> <a class="code" href="_g_l_8h.html#b2e63df950c3789599e1e43f477bc9e3">height</a> = ( light.<a class="code" href="class_gr_light.html#0df072bac3ea1048c4a57aed74bb2361">GetProjection</a>().<a class="code" href="class_gr_projection.html#08d099fb02121d3ee0d6f4637c796ae7">GetTop</a>() - light.<a class="code" href="class_gr_light.html#0df072bac3ea1048c4a57aed74bb2361">GetProjection</a>().<a class="code" href="class_gr_projection.html#ba40dc8e83e97f131286ef4daff3f459">GetBottom</a>() );
<a name="l00146"></a>00146                 <span class="keywordtype">float</span> maxDim = <a class="code" href="common__afx_8h.html#dd09d155ffe827b203d3236b451752e7">Max</a>( width, height );
<a name="l00147"></a>00147                 <span class="keywordtype">float</span> invMaxDim = 1.0f / maxDim;
<a name="l00148"></a>00148                 <a class="code" href="class_m_mat4x4.html" title="class MMat4x4">MMat4x4</a> faceProjMat = faceCamera.GetProj().GetMatrix();
<a name="l00149"></a>00149 
<a name="l00152"></a>00152                 faceProjMat( 0, 0 ) = 1.0f;
<a name="l00153"></a>00153                 faceProjMat( 1, 1 ) = 1.0f;
<a name="l00154"></a>00154                 faceProjMat( 2, 2 ) = 0.0f;
<a name="l00155"></a>00155                 faceProjMat( 2, 3 ) = -1.0f;
<a name="l00156"></a>00156 
<a name="l00158"></a>00158                 faceProjMat( 3, 2 ) = -1.0f / light.<a class="code" href="class_gr_light.html#32c3d7ec239d9b3a08869ecff626cc29">GetCachedRange</a>();
<a name="l00159"></a>00159                 faceProjMat( 3, 3 ) = 0.0f;
<a name="l00160"></a>00160 
<a name="l00163"></a>00163                 <a class="code" href="class_m_mat4x4.html" title="class MMat4x4">MMat4x4</a> scaleMat( 2.0f / width, 0.0f, 0.0f, 0.0f,
<a name="l00164"></a>00164                                                   0.0f, 2.0f / height, 0.0f, 0.0f,
<a name="l00165"></a>00165                                                   0.0f, 0.0f, 1.0f, 0.0f,
<a name="l00166"></a>00166                                                   0.0f, 0.0f, 0.0f, 1.0f );
<a name="l00167"></a>00167 
<a name="l00169"></a>00169                 _shadowData.<a class="code" href="struct_gr_virtual_shadow_page_1_1_s_render_data.html#fbc32f8ea7f4548ba9f2bd708dd7e333">shadowMatrix</a> = faceProjMat * scaleMat * faceCamera.GetViewMatrix();
<a name="l00170"></a>00170         }
<a name="l00171"></a>00171         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( light.<a class="code" href="class_gr_light.html#739b15eaf5c39ae1937546644aab1e42">GetProjTexture</a>() != 0 )
<a name="l00172"></a>00172         {
<a name="l00173"></a>00173 <span class="preprocessor">#if 0</span>
<a name="l00175"></a>00175 <span class="preprocessor">                GrLight* nonConstLight = ( GrLight* )&amp;light;</span>
<a name="l00176"></a>00176 <span class="preprocessor"></span>                nonConstLight-&gt;SetTransform( <a class="code" href="class_m_mat4x4.html" title="class MMat4x4">MMat4x4</a>( nonConstLight-&gt;GetWorldTransform().GetTranslate() ) );
<a name="l00177"></a>00177 <span class="preprocessor">#endif</span>
<a name="l00178"></a>00178 <span class="preprocessor"></span>
<a name="l00180"></a>00180                 _shadowIndirCube-&gt;SetActiveFace( <a class="code" href="class_gr_texture_cube.html#49c6f83c73520edfce04f4eb5dcfe6a05114dcd5206ee6bfbb45bf919dabb061">GrTextureCube::CF_NEGATIVEZ</a> );
<a name="l00181"></a>00181 
<a name="l00183"></a>00183                 <a class="code" href="_gr_util_8cpp.html#7b33558bb79e3c6936f26553c282d081">GrSetWriteEnable</a>( <a class="code" href="_gr_util_8h.html#d091dcc5dafb6944427eb6d9895b25d3">GR_RGBA</a> );
<a name="l00184"></a>00184                 <a class="code" href="_gr_util_8cpp.html#60654372f8080fc80b5e1ef0aea7dd99" title="Rendering functions.">GrClear</a>( 1.0f, 1.0f, 1.0f );
<a name="l00185"></a>00185 
<a name="l00187"></a>00187                 <a class="code" href="class_gr_camera.html" title="class GrCamera">GrCamera</a> indirCamera;
<a name="l00188"></a>00188                 CalcProjCamera( indirCamera, light );
<a name="l00189"></a>00189 
<a name="l00191"></a>00191                 <span class="keywordtype">float</span> distBias = 0.0f;
<a name="l00192"></a>00192                 <span class="keywordflow">if</span> ( !indirCamera.<a class="code" href="class_gr_camera.html#c4d5422b4554d779a1810e7beebc8e4e">GetProj</a>().<a class="code" href="class_gr_projection.html#abd3817acc3eeef6f80ff8e30fc1467c">IsOrtho</a>() )
<a name="l00193"></a>00193                         distBias = 2.0f * invIndirCubeWidth;
<a name="l00194"></a>00194                 segments.<a class="code" href="class_gr_virtual_shadow_segment_set.html#92e15d9d6393687920a408901ba53cd2" title="calculates AA boxes for all segments given the current camera.">UpdateSegments</a>( indirCamera, border, distBias );
<a name="l00195"></a>00195 
<a name="l00197"></a>00197                 AllocateShadowMaps( shadows, segments, indirCamera, 0, 16 );
<a name="l00198"></a>00198 
<a name="l00201"></a>00201                 <a class="code" href="class_gr_camera.html" title="class GrCamera">GrCamera</a> cubeCamera( light.<a class="code" href="class_gr_light.html#0d4a1686505a6cacd389144659887e73">GetPos</a>(), light.<a class="code" href="class_gr_light.html#6ef30451289f25c79d3b297ac0f773a8">GetWorldTransform</a>().<a class="code" href="class_m_mat4x4.html#3cc5b3636f8bd790d477e83ad2396007">GetRotate</a>(), light.<a class="code" href="class_gr_light.html#0df072bac3ea1048c4a57aed74bb2361">GetProjection</a>() );
<a name="l00202"></a>00202 
<a name="l00206"></a>00206                 <a class="code" href="class_m_mat4x4.html" title="class MMat4x4">MMat4x4</a> faceProjMat = cubeCamera.GetProj().GetMatrix();
<a name="l00207"></a>00207                 faceProjMat( 2, 2 ) *= -1.0f;
<a name="l00208"></a>00208                 faceProjMat( 2, 3 ) = 0.0f;
<a name="l00209"></a>00209                 faceProjMat( 3, 2 ) = 0.0f;
<a name="l00210"></a>00210                 faceProjMat( 3, 3 ) = 1.0f;
<a name="l00211"></a>00211 
<a name="l00213"></a>00213                 _shadowData.<a class="code" href="struct_gr_virtual_shadow_page_1_1_s_render_data.html#fbc32f8ea7f4548ba9f2bd708dd7e333">shadowMatrix</a> = faceProjMat * cubeCamera.GetViewMatrix();
<a name="l00214"></a>00214         }
<a name="l00215"></a>00215         <span class="keywordflow">else</span>
<a name="l00216"></a>00216         {
<a name="l00218"></a>00218                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> curShadowMapIdx = 0;
<a name="l00219"></a>00219 
<a name="l00221"></a>00221                 <a class="code" href="class_gr_camera.html" title="class GrCamera">GrCamera</a> indirCameras[ 6 ];
<a name="l00222"></a>00222                 CalcLightCubeCameras( indirCameras, light );
<a name="l00223"></a>00223 
<a name="l00225"></a>00225                 <a class="code" href="class_gr_texture_cube.html#49c6f83c73520edfce04f4eb5dcfe6a0">GrTextureCube::ECUBEFACE</a> faceLut[ 6 ];
<a name="l00226"></a>00226                 GetOrderedFaces( faceLut, viewerCamera, light );
<a name="l00227"></a>00227 
<a name="l00229"></a>00229                 <span class="keywordtype">float</span> distBias = 2.0f * invIndirCubeWidth;
<a name="l00230"></a>00230 
<a name="l00233"></a>00233                 <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> f = 0; f &lt; 6; ++f )
<a name="l00234"></a>00234                 {
<a name="l00236"></a>00236                         <a class="code" href="class_gr_texture_cube.html#49c6f83c73520edfce04f4eb5dcfe6a0">GrTextureCube::ECUBEFACE</a> <a class="code" href="glext_8h.html#676ca580c460c0154eb58200433d2a9e">face</a> = faceLut[ f ];
<a name="l00237"></a>00237 
<a name="l00239"></a>00239                         <span class="keyword">const</span> <a class="code" href="class_gr_camera.html" title="class GrCamera">GrCamera</a>&amp; curIndirCamera = indirCameras[ face ];
<a name="l00240"></a>00240                         segments.<a class="code" href="class_gr_virtual_shadow_segment_set.html#92e15d9d6393687920a408901ba53cd2" title="calculates AA boxes for all segments given the current camera.">UpdateSegments</a>( curIndirCamera, border, distBias );
<a name="l00241"></a>00241 
<a name="l00243"></a>00243                         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> segment = 0;
<a name="l00244"></a>00244                         <span class="keywordflow">for</span> ( ; segment &lt; segments.<a class="code" href="class_gr_virtual_shadow_segment_set.html#2289656379ca28ba3c9927dde5e5db39" title="returns the number of segments.">GetSegmentCount</a>(); ++segment )
<a name="l00245"></a>00245                                 <span class="keywordflow">if</span> ( segments.<a class="code" href="class_gr_virtual_shadow_segment_set.html#2ba9048945a0a60bb9cb59f3e8796887">IsSegmentVisible</a>( segment ) )
<a name="l00246"></a>00246                                         <span class="keywordflow">break</span>;
<a name="l00247"></a>00247 
<a name="l00249"></a>00249                         <span class="keywordflow">if</span> ( segment == segments.<a class="code" href="class_gr_virtual_shadow_segment_set.html#2289656379ca28ba3c9927dde5e5db39" title="returns the number of segments.">GetSegmentCount</a>() )
<a name="l00250"></a>00250                                 <span class="keywordflow">continue</span>;
<a name="l00251"></a>00251 
<a name="l00253"></a>00253                         _shadowIndirCube-&gt;SetActiveFace( face );
<a name="l00254"></a>00254 
<a name="l00256"></a>00256                         <a class="code" href="_gr_util_8cpp.html#7b33558bb79e3c6936f26553c282d081">GrSetWriteEnable</a>( <a class="code" href="_gr_util_8h.html#d091dcc5dafb6944427eb6d9895b25d3">GR_RGBA</a> );
<a name="l00257"></a>00257                         <a class="code" href="_gr_util_8cpp.html#60654372f8080fc80b5e1ef0aea7dd99" title="Rendering functions.">GrClear</a>();
<a name="l00258"></a>00258 
<a name="l00262"></a>00262                         <span class="comment">//              direction.</span>
<a name="l00263"></a>00263                         <span class="comment">//      2.) the indir camera's origin is inside of the viewer frustum.</span>
<a name="l00264"></a>00264                         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxShadowIdx = _shadowMapCount - 5 + f;
<a name="l00265"></a>00265                         <span class="keywordflow">if</span> ( viewerCamera.<a class="code" href="class_gr_camera.html#44d0c54e506b49a0e894700d6366741e">GetLookDir</a>().<a class="code" href="class_m_vec3.html#c224832dd149a1f44add1fa271b5b909">Dot</a>( curIndirCamera.<a class="code" href="class_gr_camera.html#44d0c54e506b49a0e894700d6366741e">GetLookDir</a>() ) &gt; 0.0f &amp;&amp;
<a name="l00266"></a>00266                                  viewerCamera.<a class="code" href="class_gr_camera.html#2ac192689362a2d6227aaae330f08473">GetFrustum</a>().<a class="code" href="class_gr_frustum.html#551cfdc1d421a551b99caadc765b6bb4">IsPointInside</a>( curIndirCamera.<a class="code" href="class_gr_camera.html#8cda9065741c39d298fe54d5ef0c3705" title="camera info accessors.">GetPos</a>() ) )
<a name="l00267"></a>00267                                 maxShadowIdx = curShadowMapIdx + 1;
<a name="l00268"></a>00268 
<a name="l00270"></a>00270                         curShadowMapIdx = AllocateShadowMaps( shadows, segments, curIndirCamera, curShadowMapIdx, maxShadowIdx );
<a name="l00271"></a>00271                 }
<a name="l00272"></a>00272 
<a name="l00274"></a>00274                 _shadowData.<a class="code" href="struct_gr_virtual_shadow_page_1_1_s_render_data.html#fbc32f8ea7f4548ba9f2bd708dd7e333">shadowMatrix</a> = <a class="code" href="class_m_mat4x4.html" title="class MMat4x4">MMat4x4</a>( -light.<a class="code" href="class_gr_light.html#0d4a1686505a6cacd389144659887e73">GetPos</a>() );
<a name="l00275"></a>00275         }
<a name="l00276"></a>00276 }
<a name="l00277"></a>00277 
<a name="l00278"></a>00278 <span class="comment">//----------------------------------------------------------</span>
<a name="l00279"></a>00279 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>
<a name="l00280"></a>00280 GrVirtualShadowPage::AllocateShadowMaps( std::vector&lt; SShadowInfo &gt;&amp; shadows, <span class="keyword">const</span> <a class="code" href="class_gr_virtual_shadow_segment_set.html" title="class GrVirtualShadowSegmentSet">GrVirtualShadowSegmentSet</a>&amp; segments,
<a name="l00281"></a>00281                                                                                  <span class="keyword">const</span> <a class="code" href="class_gr_camera.html" title="class GrCamera">GrCamera</a>&amp; indirCamera, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> startShadowMapIdx, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxShadowIdx )
<a name="l00282"></a>00282 {
<a name="l00285"></a>00285         <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( startShadowMapIdx &lt; _shadowMapCount );
<a name="l00286"></a>00286 
<a name="l00288"></a>00288         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> segmentCount = GetLastSegment( segments );
<a name="l00289"></a>00289         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="glext_8h.html#d585a1393cfa368fa9dc3d8ebff640d5">s</a> = segmentCount;
<a name="l00290"></a>00290         <span class="keywordflow">while</span> ( s-- &gt; 0 )
<a name="l00291"></a>00291         {
<a name="l00293"></a>00293                 <span class="keywordflow">if</span> ( !segments.<a class="code" href="class_gr_virtual_shadow_segment_set.html#2ba9048945a0a60bb9cb59f3e8796887">IsSegmentVisible</a>( s ) )
<a name="l00294"></a>00294                         <span class="keywordflow">continue</span>;
<a name="l00295"></a>00295 
<a name="l00297"></a>00297                 shadows.push_back( SShadowInfo() );
<a name="l00298"></a>00298                 AllocateShadowMap( shadows.back(), segments, s, indirCamera, startShadowMapIdx );
<a name="l00299"></a>00299                 ++startShadowMapIdx;
<a name="l00300"></a>00300 
<a name="l00304"></a>00304                 <span class="keywordflow">if</span> ( startShadowMapIdx == maxShadowIdx )
<a name="l00305"></a>00305                         <span class="keywordflow">break</span>;
<a name="l00306"></a>00306         }
<a name="l00307"></a>00307 
<a name="l00309"></a>00309         <span class="keywordflow">return</span> startShadowMapIdx;
<a name="l00310"></a>00310 }
<a name="l00311"></a>00311 
<a name="l00312"></a>00312 <span class="comment">//----------------------------------------------------------</span>
<a name="l00313"></a>00313 <span class="keywordtype">void</span>
<a name="l00314"></a><a class="code" href="class_gr_virtual_shadow_page.html#e438a2c1b4140e1c7a12b1c1628d2040">00314</a> <a class="code" href="class_gr_virtual_shadow_page.html#e438a2c1b4140e1c7a12b1c1628d2040">GrVirtualShadowPage::SetActiveShadowMap</a>( <span class="keyword">const</span> <a class="code" href="struct_gr_virtual_shadow_page_1_1_s_shadow_info.html">SShadowInfo</a>&amp; shadowMapInfo )
<a name="l00315"></a>00315 {
<a name="l00317"></a>00317         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> shadowMapIdx = shadowMapInfo.<a class="code" href="struct_gr_virtual_shadow_page_1_1_s_shadow_info.html#7f7e9d5b244e39ccc703ccd4d93c9529">shadowMapIdx</a>;
<a name="l00318"></a>00318         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> shadowsAcross = _shadowPageSize / _shadowMapSize;
<a name="l00319"></a>00319         <span class="keywordtype">int</span> <a class="code" href="glext_8h.html#d77deca22f617d3f0e0eb786445689fc">x</a> = shadowMapIdx % shadowsAcross * _shadowMapSize;
<a name="l00320"></a>00320         <span class="keywordtype">int</span> <a class="code" href="_g_l_8h.html#9298c7ad619074f5285b32c6b72bfdea">y</a> = shadowMapIdx / shadowsAcross * _shadowMapSize;
<a name="l00321"></a>00321         <a class="code" href="_gr_util_8cpp.html#547285e99c507990bed34ef0ec1c7b7d" title="Viewport management.">GrViewport</a>( x, y, shadowMapInfo.<a class="code" href="struct_gr_virtual_shadow_page_1_1_s_shadow_info.html#8c1baf33631ec0aa71acb781cfbe2459">width</a>, shadowMapInfo.<a class="code" href="struct_gr_virtual_shadow_page_1_1_s_shadow_info.html#9558ecd2760590cd97d3133ae338f59d">height</a> );
<a name="l00322"></a>00322 }
<a name="l00323"></a>00323 
<a name="l00324"></a>00324 <span class="comment">//----------------------------------------------------------</span>
<a name="l00325"></a>00325 <span class="keyword">const</span> <a class="code" href="struct_gr_virtual_shadow_page_1_1_s_render_data.html">GrVirtualShadowPage::SRenderData</a>&amp;
<a name="l00326"></a><a class="code" href="class_gr_virtual_shadow_page.html#6fe56d04431ca8c88be756ff92d98e09">00326</a> <a class="code" href="class_gr_virtual_shadow_page.html#6fe56d04431ca8c88be756ff92d98e09">GrVirtualShadowPage::Finish</a>()
<a name="l00327"></a>00327 {
<a name="l00328"></a>00328 <span class="preprocessor">#if 1</span>
<a name="l00330"></a>00330 <span class="preprocessor">        bool saveCurFace = false;</span>
<a name="l00331"></a>00331 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( saveCurFace )
<a name="l00332"></a>00332         {
<a name="l00333"></a>00333                 <span class="keywordtype">char</span> imageName[] = <span class="stringliteral">"shadowmap.tga"</span>;
<a name="l00334"></a>00334 
<a name="l00335"></a>00335                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dim = _shadowPageSize;
<a name="l00336"></a>00336                 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* pels = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[ dim * dim ];
<a name="l00337"></a>00337                 <a class="code" href="_g_l_subsys_8cpp.html#e2a64d16a6622519931e094765a74e1c">bglReadPixels</a>( 0, 0, dim, dim, <a class="code" href="_g_l_8h.html#ac16527902deb1ddf6b84a9ce3da6e84">GL_DEPTH_COMPONENT</a>, <a class="code" href="_g_l_8h.html#80a33c79f69417372d65d2a65ca36d49">GL_UNSIGNED_BYTE</a>, pels );
<a name="l00338"></a>00338                 <a class="code" href="_gr_debug_8cpp.html#f82ebae2e158d721c11ff92a1c69fe69" title="functions implementations.">GrSaveTGA</a>( imageName, pels, dim, dim, 1 );
<a name="l00339"></a>00339                 saveCurFace = <span class="keyword">false</span>;
<a name="l00340"></a>00340         }
<a name="l00341"></a>00341 <span class="preprocessor">#endif</span>
<a name="l00342"></a>00342 <span class="preprocessor"></span>
<a name="l00343"></a>00343 <span class="comment">/*</span>
<a name="l00345"></a>00345 <span class="comment">        B_ASSERT( _prevRT );</span>
<a name="l00346"></a>00346 <span class="comment"></span>
<a name="l00348"></a>00348 <span class="comment">        _prevRT-&gt;Bind();</span>
<a name="l00349"></a>00349 <span class="comment">        _prevRT = 0;</span>
<a name="l00350"></a>00350 <span class="comment">*/</span>
<a name="l00352"></a>00352         <span class="keywordflow">return</span> _shadowData;
<a name="l00353"></a>00353 }
<a name="l00354"></a>00354 
<a name="l00355"></a>00355 
<a name="l00356"></a>00356 <span class="comment">//==========================================================</span>
<a name="l00358"></a>00358 <span class="comment"></span><span class="comment">//==========================================================</span>
<a name="l00359"></a>00359 
<a name="l00360"></a>00360 <span class="comment">//----------------------------------------------------------</span>
<a name="l00361"></a>00361 <span class="keywordtype">void</span>
<a name="l00362"></a>00362 GrVirtualShadowPage::GetOrderedFaces( <a class="code" href="class_gr_texture_cube.html#49c6f83c73520edfce04f4eb5dcfe6a0">GrTextureCube::ECUBEFACE</a>* faceLut, <span class="keyword">const</span> <a class="code" href="class_gr_camera.html" title="class GrCamera">GrCamera</a>&amp; viewerCamera, <span class="keyword">const</span> <a class="code" href="class_gr_light.html" title="class GrLight">GrLight</a>&amp; light )
<a name="l00363"></a>00363 {
<a name="l00364"></a>00364 <span class="preprocessor">#if 1</span>
<a name="l00365"></a>00365 <span class="preprocessor"></span>        <a class="code" href="class_m_vec3.html" title="class MVec3">MVec3</a> shadowEyePos = viewerCamera.<a class="code" href="class_gr_camera.html#8cda9065741c39d298fe54d5ef0c3705" title="camera info accessors.">GetPos</a>() - light.<a class="code" href="class_gr_light.html#0d4a1686505a6cacd389144659887e73">GetPos</a>();
<a name="l00366"></a>00366 
<a name="l00368"></a>00368         <a class="code" href="class_m_vec3.html" title="class MVec3">MVec3</a> absShadowEyePos( <a class="code" href="common__afx_8h.html#7b41d482448c80b0a0e2d2c1fac77bfd">Abs</a>( shadowEyePos.<a class="code" href="class_m_vec3.html#8b834219441d8d65b3e4df28fe03f60f">GetX</a>() ), <a class="code" href="common__afx_8h.html#7b41d482448c80b0a0e2d2c1fac77bfd">Abs</a>( shadowEyePos.<a class="code" href="class_m_vec3.html#dfadf4adb521222d91980376a7679dc8">GetY</a>() ), <a class="code" href="common__afx_8h.html#7b41d482448c80b0a0e2d2c1fac77bfd">Abs</a>( shadowEyePos.<a class="code" href="class_m_vec3.html#8b29390479c105bbb9926188b9742329">GetZ</a>() ) );
<a name="l00369"></a>00369         <span class="keywordtype">int</span> xy = absShadowEyePos.GetX() &gt; absShadowEyePos.GetY() ? 0 : 1;
<a name="l00370"></a>00370         <span class="keywordtype">int</span> xz = absShadowEyePos.GetX() &gt; absShadowEyePos.GetZ() ? 0 : 2;
<a name="l00371"></a>00371         <span class="keywordtype">int</span> yz = absShadowEyePos.GetY() &gt; absShadowEyePos.GetZ() ? 1 : 2;
<a name="l00372"></a>00372 
<a name="l00373"></a>00373         <span class="keywordtype">int</span> <a class="code" href="_g_l_8h.html#970a385f6f880f2b620451db4ca4299a">first</a> = ( xy == 0 ? xz : yz );
<a name="l00374"></a>00374         <span class="keywordtype">int</span> second = ( xy == 0 ? ( xz ^ 2 ) : ( yz ^ 3 ) );
<a name="l00375"></a>00375         <span class="keywordtype">int</span> third = 3 - first - second;
<a name="l00376"></a>00376 
<a name="l00377"></a>00377         faceLut[ 0 ] = ( <a class="code" href="class_gr_texture_cube.html#49c6f83c73520edfce04f4eb5dcfe6a0">GrTextureCube::ECUBEFACE</a> )( 2 * first  + ( shadowEyePos[ first  ] &lt; 0 ? 1 : 0 ) );
<a name="l00378"></a>00378         faceLut[ 1 ] = ( <a class="code" href="class_gr_texture_cube.html#49c6f83c73520edfce04f4eb5dcfe6a0">GrTextureCube::ECUBEFACE</a> )( 2 * second + ( shadowEyePos[ second ] &lt; 0 ? 1 : 0 ) );
<a name="l00379"></a>00379         faceLut[ 2 ] = ( <a class="code" href="class_gr_texture_cube.html#49c6f83c73520edfce04f4eb5dcfe6a0">GrTextureCube::ECUBEFACE</a> )( 2 * third  + ( shadowEyePos[ third  ] &lt; 0 ? 1 : 0 ) );
<a name="l00380"></a>00380         faceLut[ 3 ] = ( <a class="code" href="class_gr_texture_cube.html#49c6f83c73520edfce04f4eb5dcfe6a0">GrTextureCube::ECUBEFACE</a> )( 2 * third  + ( shadowEyePos[ third  ] &lt; 0 ? 0 : 1 ) );
<a name="l00381"></a>00381         faceLut[ 4 ] = ( <a class="code" href="class_gr_texture_cube.html#49c6f83c73520edfce04f4eb5dcfe6a0">GrTextureCube::ECUBEFACE</a> )( 2 * second + ( shadowEyePos[ second ] &lt; 0 ? 0 : 1 ) );
<a name="l00382"></a>00382         faceLut[ 5 ] = ( <a class="code" href="class_gr_texture_cube.html#49c6f83c73520edfce04f4eb5dcfe6a0">GrTextureCube::ECUBEFACE</a> )( 2 * first  + ( shadowEyePos[ first  ] &lt; 0 ? 0 : 1 ) );
<a name="l00383"></a>00383 <span class="preprocessor">#else</span>
<a name="l00384"></a>00384 <span class="preprocessor"></span>        faceLut[ 0 ] = ( <a class="code" href="class_gr_texture_cube.html#49c6f83c73520edfce04f4eb5dcfe6a0">GrTextureCube::ECUBEFACE</a> )0;
<a name="l00385"></a>00385         faceLut[ 1 ] = ( <a class="code" href="class_gr_texture_cube.html#49c6f83c73520edfce04f4eb5dcfe6a0">GrTextureCube::ECUBEFACE</a> )1;
<a name="l00386"></a>00386         faceLut[ 2 ] = ( <a class="code" href="class_gr_texture_cube.html#49c6f83c73520edfce04f4eb5dcfe6a0">GrTextureCube::ECUBEFACE</a> )2;
<a name="l00387"></a>00387         faceLut[ 3 ] = ( <a class="code" href="class_gr_texture_cube.html#49c6f83c73520edfce04f4eb5dcfe6a0">GrTextureCube::ECUBEFACE</a> )3;
<a name="l00388"></a>00388         faceLut[ 4 ] = ( <a class="code" href="class_gr_texture_cube.html#49c6f83c73520edfce04f4eb5dcfe6a0">GrTextureCube::ECUBEFACE</a> )4;
<a name="l00389"></a>00389         faceLut[ 5 ] = ( <a class="code" href="class_gr_texture_cube.html#49c6f83c73520edfce04f4eb5dcfe6a0">GrTextureCube::ECUBEFACE</a> )5;
<a name="l00390"></a>00390 <span class="preprocessor">#endif</span>
<a name="l00391"></a>00391 <span class="preprocessor"></span>}
<a name="l00392"></a>00392 
<a name="l00393"></a>00393 <span class="comment">//----------------------------------------------------------</span>
<a name="l00394"></a>00394 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>
<a name="l00395"></a>00395 GrVirtualShadowPage::GetLastSegment( <span class="keyword">const</span> <a class="code" href="class_gr_virtual_shadow_segment_set.html" title="class GrVirtualShadowSegmentSet">GrVirtualShadowSegmentSet</a>&amp; segments )
<a name="l00396"></a>00396 {
<a name="l00398"></a>00398         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="_g_l_8h.html#10b284d589000663becfbc6867a3a9f7">count</a> = 0;
<a name="l00399"></a>00399         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> totalSegmentCount = segments.<a class="code" href="class_gr_virtual_shadow_segment_set.html#2289656379ca28ba3c9927dde5e5db39" title="returns the number of segments.">GetSegmentCount</a>();
<a name="l00400"></a>00400         <span class="keywordflow">for</span> ( ; count &lt; totalSegmentCount; ++count )
<a name="l00401"></a>00401         {
<a name="l00403"></a>00403                 <span class="keywordflow">if</span> ( segments.<a class="code" href="class_gr_virtual_shadow_segment_set.html#2ba9048945a0a60bb9cb59f3e8796887">IsSegmentVisible</a>( count ) )
<a name="l00404"></a>00404                 {
<a name="l00406"></a>00406                         <span class="keyword">const</span> <a class="code" href="struct_gr_virtual_shadow_segment_set_1_1_s_a_a_box2_d.html">GrVirtualShadowSegmentSet::SAABox2D</a>&amp; curAABox = segments.<a class="code" href="class_gr_virtual_shadow_segment_set.html#25b9adc6e79330f077e34c834521a16d">GetSegmentAABox</a>( count );
<a name="l00407"></a>00407 
<a name="l00409"></a>00409                         <span class="keywordflow">if</span> ( curAABox.<a class="code" href="struct_gr_virtual_shadow_segment_set_1_1_s_a_a_box2_d.html#259b18af6ce1cab1c4e3fb74efdd40e3">lowerLeft</a>.<a class="code" href="struct_s_vec2.html#328ec1b6dafebcc1eb6bf84f790f39b7">x</a> &lt;= -1.0f &amp;&amp; curAABox.<a class="code" href="struct_gr_virtual_shadow_segment_set_1_1_s_a_a_box2_d.html#259b18af6ce1cab1c4e3fb74efdd40e3">lowerLeft</a>.<a class="code" href="struct_s_vec2.html#47cf4560950d17311222a547a98c4fde">y</a> &lt;= -1.0f &amp;&amp;
<a name="l00410"></a>00410                                  curAABox.<a class="code" href="struct_gr_virtual_shadow_segment_set_1_1_s_a_a_box2_d.html#575507ef6de5554d267e9295adb7fe0d">upperRight</a>.<a class="code" href="struct_s_vec2.html#328ec1b6dafebcc1eb6bf84f790f39b7">x</a> &gt;= 1.0f &amp;&amp; curAABox.<a class="code" href="struct_gr_virtual_shadow_segment_set_1_1_s_a_a_box2_d.html#575507ef6de5554d267e9295adb7fe0d">upperRight</a>.<a class="code" href="struct_s_vec2.html#47cf4560950d17311222a547a98c4fde">y</a> &gt;= 1.0f )
<a name="l00411"></a>00411                         {
<a name="l00415"></a>00415                                 <span class="keywordflow">return</span> ++count;
<a name="l00416"></a>00416                         }
<a name="l00417"></a>00417                 }
<a name="l00418"></a>00418         }
<a name="l00419"></a>00419 
<a name="l00421"></a>00421         <span class="keywordflow">return</span> count;
<a name="l00422"></a>00422 }
<a name="l00423"></a>00423 
<a name="l00424"></a>00424 <span class="comment">//----------------------------------------------------------</span>
<a name="l00425"></a>00425 <span class="keywordtype">void</span>
<a name="l00426"></a>00426 GrVirtualShadowPage::AllocateShadowMap( SShadowInfo&amp; shadowInfo, <span class="keyword">const</span> <a class="code" href="class_gr_virtual_shadow_segment_set.html" title="class GrVirtualShadowSegmentSet">GrVirtualShadowSegmentSet</a>&amp; segments,
<a name="l00427"></a>00427                                                                             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> segment, <span class="keyword">const</span> <a class="code" href="class_gr_camera.html" title="class GrCamera">GrCamera</a>&amp; indirCamera, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> shadowMapIndex )
<a name="l00428"></a>00428 {
<a name="l00430"></a>00430         <span class="keywordflow">if</span> ( shadowMapIndex == _shadowMapCount )
<a name="l00431"></a>00431                 <span class="keywordflow">return</span>;
<a name="l00432"></a>00432 
<a name="l00434"></a>00434         <a class="code" href="struct_gr_virtual_shadow_segment_set_1_1_s_a_a_box2_d.html">GrVirtualShadowSegmentSet::SAABox2D</a> aaBox = segments.<a class="code" href="class_gr_virtual_shadow_segment_set.html#25b9adc6e79330f077e34c834521a16d">GetSegmentAABox</a>( segment );
<a name="l00435"></a>00435 
<a name="l00437"></a>00437         shadowInfo.width = _shadowMapSize &gt;&gt; <a class="code" href="common__afx_8h.html#0296e17691267defafdfde06589f50d5">Min</a>( aaBox.<a class="code" href="struct_gr_virtual_shadow_segment_set_1_1_s_a_a_box2_d.html#682722402a3e4f1a78207e21b6ad167d">clipLogX</a>, 2 );
<a name="l00438"></a>00438         shadowInfo.height = _shadowMapSize &gt;&gt; <a class="code" href="common__afx_8h.html#0296e17691267defafdfde06589f50d5">Min</a>( aaBox.<a class="code" href="struct_gr_virtual_shadow_segment_set_1_1_s_a_a_box2_d.html#1479933b4896c9b6e86c4d54d2c02e57">clipLogY</a>, 2 );
<a name="l00439"></a>00439 
<a name="l00442"></a>00442         shadowInfo.camera.SetPos( indirCamera.<a class="code" href="class_gr_camera.html#8cda9065741c39d298fe54d5ef0c3705" title="camera info accessors.">GetPos</a>() );
<a name="l00443"></a>00443         shadowInfo.camera.SetRot( indirCamera.<a class="code" href="class_gr_camera.html#466d702e7317ebe56a863745680e0133">GetRot</a>() );
<a name="l00444"></a>00444 
<a name="l00446"></a>00446         shadowInfo.shadowMapIdx = shadowMapIndex;
<a name="l00447"></a>00447 
<a name="l00449"></a>00449         <span class="keywordtype">float</span> <a class="code" href="_g_l_8h.html#e6531b1788ca42a9ae8155b0c52e7630">width</a> = ( aaBox.<a class="code" href="struct_gr_virtual_shadow_segment_set_1_1_s_a_a_box2_d.html#575507ef6de5554d267e9295adb7fe0d">upperRight</a>.<a class="code" href="struct_s_vec2.html#328ec1b6dafebcc1eb6bf84f790f39b7">x</a> - aaBox.<a class="code" href="struct_gr_virtual_shadow_segment_set_1_1_s_a_a_box2_d.html#259b18af6ce1cab1c4e3fb74efdd40e3">lowerLeft</a>.<a class="code" href="struct_s_vec2.html#328ec1b6dafebcc1eb6bf84f790f39b7">x</a> );
<a name="l00450"></a>00450         <span class="keywordtype">float</span> <a class="code" href="_g_l_8h.html#b2e63df950c3789599e1e43f477bc9e3">height</a> = ( aaBox.<a class="code" href="struct_gr_virtual_shadow_segment_set_1_1_s_a_a_box2_d.html#575507ef6de5554d267e9295adb7fe0d">upperRight</a>.<a class="code" href="struct_s_vec2.html#47cf4560950d17311222a547a98c4fde">y</a> - aaBox.<a class="code" href="struct_gr_virtual_shadow_segment_set_1_1_s_a_a_box2_d.html#259b18af6ce1cab1c4e3fb74efdd40e3">lowerLeft</a>.<a class="code" href="struct_s_vec2.html#47cf4560950d17311222a547a98c4fde">y</a> );
<a name="l00451"></a>00451 
<a name="l00453"></a>00453         <span class="keywordtype">float</span> borderWidth = float( <a class="code" href="_gr_virtual_shadow_page_8cpp.html#530dc596cef85ec7faeff33e9e6f5847" title="size of each shadow map border in pixels.">SHADOW_BORDER_SIZE</a> ) / float( shadowInfo.width - 2 * <a class="code" href="_gr_virtual_shadow_page_8cpp.html#530dc596cef85ec7faeff33e9e6f5847" title="size of each shadow map border in pixels.">SHADOW_BORDER_SIZE</a> );
<a name="l00454"></a>00454         <span class="keywordtype">float</span> borderHeight = float( <a class="code" href="_gr_virtual_shadow_page_8cpp.html#530dc596cef85ec7faeff33e9e6f5847" title="size of each shadow map border in pixels.">SHADOW_BORDER_SIZE</a> ) / float( shadowInfo.height - 2 * <a class="code" href="_gr_virtual_shadow_page_8cpp.html#530dc596cef85ec7faeff33e9e6f5847" title="size of each shadow map border in pixels.">SHADOW_BORDER_SIZE</a> );
<a name="l00455"></a>00455 
<a name="l00458"></a>00458         <span class="keyword">const</span> <a class="code" href="class_gr_projection.html" title="Purpose: To build and manage a projection matrix.">GrProjection</a>&amp; indirProj = indirCamera.<a class="code" href="class_gr_camera.html#c4d5422b4554d779a1810e7beebc8e4e">GetProj</a>();
<a name="l00459"></a>00459 
<a name="l00461"></a>00461         <span class="keywordtype">float</span> leftT = 0.5f * aaBox.<a class="code" href="struct_gr_virtual_shadow_segment_set_1_1_s_a_a_box2_d.html#259b18af6ce1cab1c4e3fb74efdd40e3">lowerLeft</a>.<a class="code" href="struct_s_vec2.html#328ec1b6dafebcc1eb6bf84f790f39b7">x</a> + 0.5f;
<a name="l00462"></a>00462         <span class="keywordtype">float</span> rightT = 0.5f * aaBox.<a class="code" href="struct_gr_virtual_shadow_segment_set_1_1_s_a_a_box2_d.html#575507ef6de5554d267e9295adb7fe0d">upperRight</a>.<a class="code" href="struct_s_vec2.html#328ec1b6dafebcc1eb6bf84f790f39b7">x</a> + 0.5f;
<a name="l00463"></a>00463         <span class="keywordtype">float</span> bottomT = 0.5f * aaBox.<a class="code" href="struct_gr_virtual_shadow_segment_set_1_1_s_a_a_box2_d.html#259b18af6ce1cab1c4e3fb74efdd40e3">lowerLeft</a>.<a class="code" href="struct_s_vec2.html#47cf4560950d17311222a547a98c4fde">y</a> + 0.5f;
<a name="l00464"></a>00464         <span class="keywordtype">float</span> topT = 0.5f * aaBox.<a class="code" href="struct_gr_virtual_shadow_segment_set_1_1_s_a_a_box2_d.html#575507ef6de5554d267e9295adb7fe0d">upperRight</a>.<a class="code" href="struct_s_vec2.html#47cf4560950d17311222a547a98c4fde">y</a> + 0.5f;
<a name="l00465"></a>00465 
<a name="l00468"></a>00468         <span class="keywordtype">float</span> projLeft = <a class="code" href="common__afx_8h.html#e1fb23c1e592f53f89861e329acc843a">Lerp</a>( indirProj.<a class="code" href="class_gr_projection.html#259e5d940d8cd6685eafe37eb541238e">GetLeft</a>(), indirProj.<a class="code" href="class_gr_projection.html#076356ed413ff2aaab1b0f6af4cf8a3c">GetRight</a>(), leftT );
<a name="l00469"></a>00469         <span class="keywordtype">float</span> projRight = <a class="code" href="common__afx_8h.html#e1fb23c1e592f53f89861e329acc843a">Lerp</a>( indirProj.<a class="code" href="class_gr_projection.html#259e5d940d8cd6685eafe37eb541238e">GetLeft</a>(), indirProj.<a class="code" href="class_gr_projection.html#076356ed413ff2aaab1b0f6af4cf8a3c">GetRight</a>(), rightT );
<a name="l00470"></a>00470         <span class="keywordtype">float</span> projBottom = <a class="code" href="common__afx_8h.html#e1fb23c1e592f53f89861e329acc843a">Lerp</a>( indirProj.<a class="code" href="class_gr_projection.html#ba40dc8e83e97f131286ef4daff3f459">GetBottom</a>(), indirProj.<a class="code" href="class_gr_projection.html#08d099fb02121d3ee0d6f4637c796ae7">GetTop</a>(), bottomT );
<a name="l00471"></a>00471         <span class="keywordtype">float</span> projTop = <a class="code" href="common__afx_8h.html#e1fb23c1e592f53f89861e329acc843a">Lerp</a>( indirProj.<a class="code" href="class_gr_projection.html#ba40dc8e83e97f131286ef4daff3f459">GetBottom</a>(), indirProj.<a class="code" href="class_gr_projection.html#08d099fb02121d3ee0d6f4637c796ae7">GetTop</a>(), topT );
<a name="l00472"></a>00472 
<a name="l00474"></a>00474         borderWidth *= ( projRight - projLeft );
<a name="l00475"></a>00475         borderHeight *= ( projTop - projBottom );
<a name="l00476"></a>00476 
<a name="l00478"></a>00478         <a class="code" href="class_gr_projection.html" title="Purpose: To build and manage a projection matrix.">GrProjection</a> proj( indirProj );
<a name="l00479"></a>00479         proj.SetLeft( projLeft - borderWidth );
<a name="l00480"></a>00480         proj.SetRight( projRight + borderWidth );
<a name="l00481"></a>00481         proj.SetBottom( projBottom - borderHeight );
<a name="l00482"></a>00482         proj.SetTop( projTop + borderHeight );
<a name="l00483"></a>00483 
<a name="l00485"></a>00485         shadowInfo.camera.SetProj( proj );
<a name="l00486"></a>00486 
<a name="l00488"></a>00488         shadowInfo.camera.GetFrustum();
<a name="l00489"></a>00489 
<a name="l00492"></a>00492 <span class="preprocessor">#if 0</span>
<a name="l00493"></a>00493 <span class="preprocessor"></span>        <span class="keywordtype">float</span> boxScaleX = 1.0f;
<a name="l00494"></a>00494         <span class="keywordtype">float</span> boxScaleY = 1.0f;
<a name="l00495"></a>00495         <span class="keywordflow">if</span> ( proj.IsOrtho() )
<a name="l00496"></a>00496         {
<a name="l00499"></a>00499                 <span class="keywordtype">float</span> projWidthScale = indirProj.<a class="code" href="class_gr_projection.html#076356ed413ff2aaab1b0f6af4cf8a3c">GetRight</a>() - indirProj.<a class="code" href="class_gr_projection.html#259e5d940d8cd6685eafe37eb541238e">GetLeft</a>();
<a name="l00500"></a>00500                 <span class="keywordtype">float</span> projHeightScale = indirProj.<a class="code" href="class_gr_projection.html#08d099fb02121d3ee0d6f4637c796ae7">GetTop</a>() - indirProj.<a class="code" href="class_gr_projection.html#ba40dc8e83e97f131286ef4daff3f459">GetBottom</a>();
<a name="l00501"></a>00501                 <span class="keywordtype">float</span> invMaxScale = 1.0f / <a class="code" href="common__afx_8h.html#dd09d155ffe827b203d3236b451752e7">Max</a>( projWidthScale, projHeightScale );
<a name="l00502"></a>00502 
<a name="l00504"></a>00504                 boxScaleX = invMaxScale;
<a name="l00505"></a>00505                 boxScaleY = invMaxScale;
<a name="l00506"></a>00506 <span class="comment">/*</span>
<a name="l00508"></a>00508 <span class="comment">                aaBox.lowerLeft.x *= invMaxScale;</span>
<a name="l00509"></a>00509 <span class="comment">                aaBox.upperRight.x *= invMaxScale;</span>
<a name="l00510"></a>00510 <span class="comment">                aaBox.lowerLeft.y *= invMaxScale;</span>
<a name="l00511"></a>00511 <span class="comment">                aaBox.upperRight.y *= invMaxScale;</span>
<a name="l00512"></a>00512 <span class="comment">*/</span>
<a name="l00513"></a>00513         }
<a name="l00514"></a>00514 <span class="preprocessor">#endif</span>
<a name="l00516"></a>00516 <span class="preprocessor">        RenderSegmentInfo( aaBox, shadowMapIndex, shadowInfo.width, shadowInfo.height );</span>
<a name="l00517"></a>00517 <span class="preprocessor"></span>}
<a name="l00518"></a>00518 
<a name="l00519"></a>00519 <span class="comment">//----------------------------------------------------------</span>
<a name="l00520"></a>00520 <span class="keywordtype">void</span>
<a name="l00521"></a>00521 GrVirtualShadowPage::RenderSegmentInfo( <span class="keyword">const</span> <a class="code" href="struct_gr_virtual_shadow_segment_set_1_1_s_a_a_box2_d.html">GrVirtualShadowSegmentSet::SAABox2D</a>&amp; aaBox, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> shadowMapIdx,
<a name="l00522"></a>00522                                                                             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> width, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> height )
<a name="l00523"></a>00523 {
<a name="l00525"></a>00525         <a class="code" href="struct_s_vec2.html" title="Purpose: Contains mesh data.">SVec2</a> offsetMod;
<a name="l00526"></a>00526         <a class="code" href="struct_s_vec2.html" title="Purpose: Contains mesh data.">SVec2</a> offsetAdd;
<a name="l00527"></a>00527         CalcShadowModAdd( offsetMod, offsetAdd, shadowMapIdx, width, height );
<a name="l00528"></a>00528 
<a name="l00531"></a>00531         <span class="comment">//      modAdd = texCube( vsm, lightVec );</span>
<a name="l00532"></a>00532         <span class="comment">//      xy / MA... note we have to select xy in the shader somehow.  LUT?</span>
<a name="l00533"></a>00533         <span class="comment">//      shadowUV = modAdd.xy * xy + modAdd.zw;</span>
<a name="l00534"></a>00534         <span class="comment">//      tex2D( shadowMap, shadowUV );</span>
<a name="l00535"></a>00535 
<a name="l00536"></a>00536         <span class="keywordtype">float</span> scaleX = 1.0f / ( aaBox.<a class="code" href="struct_gr_virtual_shadow_segment_set_1_1_s_a_a_box2_d.html#575507ef6de5554d267e9295adb7fe0d">upperRight</a>.<a class="code" href="struct_s_vec2.html#328ec1b6dafebcc1eb6bf84f790f39b7">x</a> - aaBox.<a class="code" href="struct_gr_virtual_shadow_segment_set_1_1_s_a_a_box2_d.html#259b18af6ce1cab1c4e3fb74efdd40e3">lowerLeft</a>.<a class="code" href="struct_s_vec2.html#328ec1b6dafebcc1eb6bf84f790f39b7">x</a> );
<a name="l00537"></a>00537         <span class="keywordtype">float</span> scaleY = 1.0f / ( aaBox.<a class="code" href="struct_gr_virtual_shadow_segment_set_1_1_s_a_a_box2_d.html#575507ef6de5554d267e9295adb7fe0d">upperRight</a>.<a class="code" href="struct_s_vec2.html#47cf4560950d17311222a547a98c4fde">y</a> - aaBox.<a class="code" href="struct_gr_virtual_shadow_segment_set_1_1_s_a_a_box2_d.html#259b18af6ce1cab1c4e3fb74efdd40e3">lowerLeft</a>.<a class="code" href="struct_s_vec2.html#47cf4560950d17311222a547a98c4fde">y</a> );
<a name="l00538"></a>00538 
<a name="l00540"></a>00540         <span class="comment">//</span>
<a name="l00542"></a>00542 <span class="comment"></span>        <span class="comment">//      mod * shadowLookup.xy / widthAndHeight - mod * bottomLeft.xy / widthAndHeight + offset.xy</span>
<a name="l00543"></a>00543         <span class="comment">//</span>
<a name="l00545"></a>00545 <span class="comment"></span>        <span class="comment">//</span>
<a name="l00546"></a>00546         <span class="comment">//      mod * ( 1.0 - ( ( shadowLookup.xy - bottomLeft.xy ) / widthAndHeight ) ) + offset.xy</span>
<a name="l00547"></a>00547         <span class="comment">//      mod * 1.0 - mod * shadowLookup.xy / widthAndHeight + mod * bottomLeft.xy / widthAndHeight + offset.xy</span>
<a name="l00548"></a>00548         <span class="comment">//      mod * shadowLookup.xy / widthAndHeight - mod * bottomLeft.xy / widthAndHeight + offset.xy</span>
<a name="l00549"></a>00549         <span class="comment">//</span>
<a name="l00550"></a>00550         <span class="keywordtype">float</span> modAdd[ 4 ] = {
<a name="l00551"></a>00551                 offsetMod.<a class="code" href="struct_s_vec2.html#328ec1b6dafebcc1eb6bf84f790f39b7">x</a> * scaleX,
<a name="l00552"></a>00552                 offsetMod.<a class="code" href="struct_s_vec2.html#47cf4560950d17311222a547a98c4fde">y</a> * scaleY,
<a name="l00553"></a>00553                 offsetAdd.<a class="code" href="struct_s_vec2.html#328ec1b6dafebcc1eb6bf84f790f39b7">x</a> - offsetMod.<a class="code" href="struct_s_vec2.html#328ec1b6dafebcc1eb6bf84f790f39b7">x</a> * scaleX * aaBox.<a class="code" href="struct_gr_virtual_shadow_segment_set_1_1_s_a_a_box2_d.html#259b18af6ce1cab1c4e3fb74efdd40e3">lowerLeft</a>.<a class="code" href="struct_s_vec2.html#328ec1b6dafebcc1eb6bf84f790f39b7">x</a>,
<a name="l00554"></a>00554                 offsetAdd.<a class="code" href="struct_s_vec2.html#47cf4560950d17311222a547a98c4fde">y</a> - offsetMod.<a class="code" href="struct_s_vec2.html#47cf4560950d17311222a547a98c4fde">y</a> * scaleY * aaBox.<a class="code" href="struct_gr_virtual_shadow_segment_set_1_1_s_a_a_box2_d.html#259b18af6ce1cab1c4e3fb74efdd40e3">lowerLeft</a>.<a class="code" href="struct_s_vec2.html#47cf4560950d17311222a547a98c4fde">y</a>,
<a name="l00555"></a>00555         };
<a name="l00556"></a>00556 
<a name="l00558"></a>00558         _shadowIndirShader-&gt;Bind( <a class="code" href="enums_8h.html#697c1ee1354746841860d5bf9f81c033a65aecaadc4e83e6faf13f9983899775">EGQ_LOW</a> );
<a name="l00559"></a>00559         _shadowIndirShader-&gt;SetUserParam4fv( <a class="code" href="_gr_virtual_shadow_page_8cpp.html#bcabe89874e49606633c4ee14cf49a2b" title="class header.">INDIR_MOD_ADD_HANDLE</a>, modAdd );
<a name="l00560"></a>00560 
<a name="l00562"></a>00562         <a class="code" href="_gr_util_8cpp.html#b380583a085e70e5db988eb1573be067">GrBindVB</a>( 0 );
<a name="l00563"></a>00563         <a class="code" href="_gr_util_8cpp.html#0f573923ce54d669ceb19234cc2f8d36">GrBindIB</a>( 0 );
<a name="l00564"></a>00564         <a class="code" href="_g_l_subsys_8cpp.html#7bf1600c864d0fbfe39d57ccdb502d61">bglMatrixMode</a>( <a class="code" href="_g_l_8h.html#8c0f92b5d50914825a1424b1cd4480cd">GL_MODELVIEW</a> );
<a name="l00565"></a>00565         <a class="code" href="_g_l_subsys_8cpp.html#2d32a9b057d36584af081d6d8316b5a3">bglLoadIdentity</a>();
<a name="l00566"></a>00566         <a class="code" href="_g_l_subsys_8cpp.html#7bf1600c864d0fbfe39d57ccdb502d61">bglMatrixMode</a>( <a class="code" href="_g_l_8h.html#85e93b355494186ced027f1a1142fefb">GL_PROJECTION</a> );
<a name="l00567"></a>00567         <a class="code" href="_g_l_subsys_8cpp.html#2d32a9b057d36584af081d6d8316b5a3">bglLoadIdentity</a>();
<a name="l00568"></a>00568         <a class="code" href="_gr_util_8cpp.html#da7ea629bb413c26919562c8846d6139">GrSetState</a>( 0 );
<a name="l00569"></a>00569 
<a name="l00571"></a>00571         <span class="keywordtype">float</span> <a class="code" href="glext_8h.html#85b8f6c07fbc1fb5d77c2ae090f21995">left</a> = aaBox.<a class="code" href="struct_gr_virtual_shadow_segment_set_1_1_s_a_a_box2_d.html#259b18af6ce1cab1c4e3fb74efdd40e3">lowerLeft</a>.<a class="code" href="struct_s_vec2.html#328ec1b6dafebcc1eb6bf84f790f39b7">x</a>;
<a name="l00572"></a>00572         <span class="keywordtype">float</span> <a class="code" href="glext_8h.html#5ffadbbacc6b89cf6218bc43b384d3fe">right</a> = aaBox.<a class="code" href="struct_gr_virtual_shadow_segment_set_1_1_s_a_a_box2_d.html#575507ef6de5554d267e9295adb7fe0d">upperRight</a>.<a class="code" href="struct_s_vec2.html#328ec1b6dafebcc1eb6bf84f790f39b7">x</a>;
<a name="l00573"></a>00573         <span class="keywordtype">float</span> <a class="code" href="glext_8h.html#95fc257e5ddf46f7db9d5e898cdf1991">bottom</a> = aaBox.<a class="code" href="struct_gr_virtual_shadow_segment_set_1_1_s_a_a_box2_d.html#259b18af6ce1cab1c4e3fb74efdd40e3">lowerLeft</a>.<a class="code" href="struct_s_vec2.html#47cf4560950d17311222a547a98c4fde">y</a>;
<a name="l00574"></a>00574         <span class="keywordtype">float</span> <a class="code" href="glext_8h.html#5ab323daeacf8dfdb8f91132fecdca23">top</a> = aaBox.<a class="code" href="struct_gr_virtual_shadow_segment_set_1_1_s_a_a_box2_d.html#575507ef6de5554d267e9295adb7fe0d">upperRight</a>.<a class="code" href="struct_s_vec2.html#47cf4560950d17311222a547a98c4fde">y</a>;
<a name="l00575"></a>00575 
<a name="l00577"></a>00577         <a class="code" href="_g_l_subsys_8cpp.html#afdf3a93cbf608f43789a1fa3ff1a925">bglBegin</a>( <a class="code" href="_g_l_8h.html#d38e94a1120d6688fce6fc805a5b998d">GL_TRIANGLE_STRIP</a> );
<a name="l00578"></a>00578                 <a class="code" href="_g_l_subsys_8cpp.html#d4b52933f1f2ae22287183b0cf8f4f10">bglTexCoord2f</a>( 0.0f, 1.0f );
<a name="l00579"></a>00579                 <a class="code" href="_g_l_subsys_8cpp.html#e38cf5086b3c3fb243e11f7e58bb5dd3">bglVertex3f</a>( left, top, 0.0f );
<a name="l00580"></a>00580 
<a name="l00581"></a>00581                 <a class="code" href="_g_l_subsys_8cpp.html#d4b52933f1f2ae22287183b0cf8f4f10">bglTexCoord2f</a>( 1.0f, 1.0f );
<a name="l00582"></a>00582                 <a class="code" href="_g_l_subsys_8cpp.html#e38cf5086b3c3fb243e11f7e58bb5dd3">bglVertex3f</a>( right, top, 0.0f );
<a name="l00583"></a>00583 
<a name="l00584"></a>00584                 <a class="code" href="_g_l_subsys_8cpp.html#d4b52933f1f2ae22287183b0cf8f4f10">bglTexCoord2f</a>( 0.0f, 0.0f );
<a name="l00585"></a>00585                 <a class="code" href="_g_l_subsys_8cpp.html#e38cf5086b3c3fb243e11f7e58bb5dd3">bglVertex3f</a>( left, bottom, 0.0f );
<a name="l00586"></a>00586 
<a name="l00587"></a>00587                 <a class="code" href="_g_l_subsys_8cpp.html#d4b52933f1f2ae22287183b0cf8f4f10">bglTexCoord2f</a>( 1.0f, 0.0f );
<a name="l00588"></a>00588                 <a class="code" href="_g_l_subsys_8cpp.html#e38cf5086b3c3fb243e11f7e58bb5dd3">bglVertex3f</a>( right, bottom, 0.0f );
<a name="l00589"></a>00589         <a class="code" href="_g_l_subsys_8cpp.html#98e730ab9ca687a9a110d6d6707a38ae">bglEnd</a>();
<a name="l00590"></a>00590 }
<a name="l00591"></a>00591 
<a name="l00592"></a>00592 <span class="comment">//----------------------------------------------------------</span>
<a name="l00593"></a>00593 <span class="keywordtype">void</span>
<a name="l00594"></a>00594 GrVirtualShadowPage::CalcLightCubeCameras( <a class="code" href="class_gr_camera.html" title="class GrCamera">GrCamera</a>* cameras, <span class="keyword">const</span> <a class="code" href="class_gr_light.html" title="class GrLight">GrLight</a>&amp; light )
<a name="l00595"></a>00595 {
<a name="l00597"></a>00597         <span class="keywordtype">float</span> <a class="code" href="glext_8h.html#7b8ad0b27a927682837f95528fa454f5">range</a> = light.<a class="code" href="class_gr_light.html#32c3d7ec239d9b3a08869ecff626cc29">GetCachedRange</a>();
<a name="l00598"></a>00598         <span class="keyword">const</span> <span class="keywordtype">float</span> fov = <a class="code" href="common__afx_8h.html#116293816763dfdfd39b4bc70c38b465" title="math functions.">DegToRad</a>( 90.0f );
<a name="l00599"></a>00599         <span class="keyword">const</span> <a class="code" href="class_m_vec3.html" title="class MVec3">MVec3</a>&amp; lightPos = light.<a class="code" href="class_gr_light.html#0d4a1686505a6cacd389144659887e73">GetPos</a>();
<a name="l00600"></a>00600 
<a name="l00602"></a>00602         <a class="code" href="class_m_mat3x3.html" title="class MMat3x3">MMat3x3</a> nzRot;
<a name="l00603"></a>00603         nzRot.<a class="code" href="class_m_mat3x3.html#34c3fe8d743433b98bd1cdf0eb053224">MakeZRotation</a>( <a class="code" href="common__afx_8h.html#116293816763dfdfd39b4bc70c38b465" title="math functions.">DegToRad</a>( 180 ) );
<a name="l00604"></a>00604 
<a name="l00606"></a>00606         <a class="code" href="class_m_mat3x3.html" title="class MMat3x3">MMat3x3</a> pzRot;
<a name="l00607"></a>00607         pzRot.<a class="code" href="class_m_mat3x3.html#772a24dfb662f3348eaf19c5e57b578b">MakeYRotation</a>( <a class="code" href="common__afx_8h.html#116293816763dfdfd39b4bc70c38b465" title="math functions.">DegToRad</a>( 180 ) );
<a name="l00608"></a>00608         pzRot = pzRot * nzRot;
<a name="l00609"></a>00609 
<a name="l00611"></a>00611         <a class="code" href="class_m_mat3x3.html" title="class MMat3x3">MMat3x3</a> nxRot;
<a name="l00612"></a>00612         nxRot.<a class="code" href="class_m_mat3x3.html#772a24dfb662f3348eaf19c5e57b578b">MakeYRotation</a>( <a class="code" href="common__afx_8h.html#116293816763dfdfd39b4bc70c38b465" title="math functions.">DegToRad</a>( 90 ) );
<a name="l00613"></a>00613         nxRot = nxRot * nzRot;
<a name="l00614"></a>00614 
<a name="l00616"></a>00616         <a class="code" href="class_m_mat3x3.html" title="class MMat3x3">MMat3x3</a> pxRot;
<a name="l00617"></a>00617         pxRot.<a class="code" href="class_m_mat3x3.html#772a24dfb662f3348eaf19c5e57b578b">MakeYRotation</a>( <a class="code" href="common__afx_8h.html#116293816763dfdfd39b4bc70c38b465" title="math functions.">DegToRad</a>( -90 ) );
<a name="l00618"></a>00618         pxRot = pxRot * nzRot;
<a name="l00619"></a>00619 
<a name="l00621"></a>00621         <a class="code" href="class_m_mat3x3.html" title="class MMat3x3">MMat3x3</a> nyRot;
<a name="l00622"></a>00622         nyRot.<a class="code" href="class_m_mat3x3.html#bd1bb896aeeaf05ec76624c5e996818b">MakeXRotation</a>( <a class="code" href="common__afx_8h.html#116293816763dfdfd39b4bc70c38b465" title="math functions.">DegToRad</a>( -90 ) );
<a name="l00623"></a>00623 
<a name="l00625"></a>00625         <a class="code" href="class_m_mat3x3.html" title="class MMat3x3">MMat3x3</a> pyRot;
<a name="l00626"></a>00626         pyRot.<a class="code" href="class_m_mat3x3.html#bd1bb896aeeaf05ec76624c5e996818b">MakeXRotation</a>( <a class="code" href="common__afx_8h.html#116293816763dfdfd39b4bc70c38b465" title="math functions.">DegToRad</a>( 90 ) );
<a name="l00627"></a>00627 
<a name="l00629"></a>00629         cameras[ 0 ] = <a class="code" href="class_gr_camera.html" title="class GrCamera">GrCamera</a>( lightPos, pxRot, fov, range, 1.0f );           
<a name="l00630"></a>00630         cameras[ 1 ] = <a class="code" href="class_gr_camera.html" title="class GrCamera">GrCamera</a>( lightPos, nxRot, fov, range, 1.0f );           
<a name="l00631"></a>00631         cameras[ 2 ] = <a class="code" href="class_gr_camera.html" title="class GrCamera">GrCamera</a>( lightPos, pyRot, fov, range, 1.0f );           
<a name="l00632"></a>00632         cameras[ 3 ] = <a class="code" href="class_gr_camera.html" title="class GrCamera">GrCamera</a>( lightPos, nyRot, fov, range, 1.0f );           
<a name="l00633"></a>00633         cameras[ 4 ] = <a class="code" href="class_gr_camera.html" title="class GrCamera">GrCamera</a>( lightPos, pzRot, fov, range, 1.0f );           
<a name="l00634"></a>00634         cameras[ 5 ] = <a class="code" href="class_gr_camera.html" title="class GrCamera">GrCamera</a>( lightPos, nzRot, fov, range, 1.0f );           
<a name="l00635"></a>00635 }
<a name="l00636"></a>00636 
<a name="l00637"></a>00637 <span class="comment">//----------------------------------------------------------</span>
<a name="l00638"></a>00638 <span class="keywordtype">void</span>
<a name="l00639"></a>00639 GrVirtualShadowPage::CalcProjCamera( <a class="code" href="class_gr_camera.html" title="class GrCamera">GrCamera</a>&amp; camera, <span class="keyword">const</span> <a class="code" href="class_gr_light.html" title="class GrLight">GrLight</a>&amp; light )
<a name="l00640"></a>00640 {
<a name="l00643"></a>00643 
<a name="l00648"></a>00648 
<a name="l00650"></a>00650         <a class="code" href="class_m_mat3x3.html" title="class MMat3x3">MMat3x3</a> nzRot;
<a name="l00651"></a>00651         nzRot.<a class="code" href="class_m_mat3x3.html#34c3fe8d743433b98bd1cdf0eb053224">MakeZRotation</a>( <a class="code" href="common__afx_8h.html#116293816763dfdfd39b4bc70c38b465" title="math functions.">DegToRad</a>( 180 ) );
<a name="l00652"></a>00652 
<a name="l00655"></a>00655         camera.<a class="code" href="class_gr_camera.html#8c8f33ad67141bad930c367ffa9db7ac">SetRot</a>( light.<a class="code" href="class_gr_light.html#6ef30451289f25c79d3b297ac0f773a8">GetWorldTransform</a>().<a class="code" href="class_m_mat4x4.html#3cc5b3636f8bd790d477e83ad2396007">GetRotate</a>() * nzRot );
<a name="l00656"></a>00656         camera.<a class="code" href="class_gr_camera.html#75ce5e2e567fbce90d92d8048b33c1b4" title="set position, lookdir, etc.">SetPos</a>( light.<a class="code" href="class_gr_light.html#0d4a1686505a6cacd389144659887e73">GetPos</a>() );
<a name="l00657"></a>00657         camera.<a class="code" href="class_gr_camera.html#56911b628538fe22dc75e9847cc93250">SetProj</a>( light.<a class="code" href="class_gr_light.html#0df072bac3ea1048c4a57aed74bb2361">GetProjection</a>() );
<a name="l00658"></a>00658 }
<a name="l00659"></a>00659 
<a name="l00660"></a>00660 <span class="comment">//----------------------------------------------------------</span>
<a name="l00661"></a>00661 <span class="keywordtype">void</span>
<a name="l00662"></a>00662 GrVirtualShadowPage::CalcShadowModAdd( <a class="code" href="struct_s_vec2.html" title="Purpose: Contains mesh data.">SVec2</a>&amp; mod, <a class="code" href="struct_s_vec2.html" title="Purpose: Contains mesh data.">SVec2</a>&amp; <span class="keyword">add</span>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> shadowMapIdx,
<a name="l00663"></a>00663                                                                            <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> width, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> height )
<a name="l00664"></a>00664 {
<a name="l00666"></a>00666         <span class="keywordtype">float</span> fInvSize = 1.0f / float( ( <span class="keywordtype">int</span> )_shadowPageSize );
<a name="l00667"></a>00667 
<a name="l00669"></a>00669 <span class="comment">//      mod.x = fInvSize * float( _shadowMapSize - 2 * SHADOW_BORDER_SIZE );</span>
<a name="l00670"></a>00670 <span class="comment">//      mod.y = fInvSize * float( _shadowMapSize - 2 * SHADOW_BORDER_SIZE );</span>
<a name="l00671"></a>00671         mod.<a class="code" href="struct_s_vec2.html#328ec1b6dafebcc1eb6bf84f790f39b7">x</a> = fInvSize * float( width - 2 * <a class="code" href="_gr_virtual_shadow_page_8cpp.html#530dc596cef85ec7faeff33e9e6f5847" title="size of each shadow map border in pixels.">SHADOW_BORDER_SIZE</a> );
<a name="l00672"></a>00672         mod.<a class="code" href="struct_s_vec2.html#47cf4560950d17311222a547a98c4fde">y</a> = fInvSize * float( height - 2 * <a class="code" href="_gr_virtual_shadow_page_8cpp.html#530dc596cef85ec7faeff33e9e6f5847" title="size of each shadow map border in pixels.">SHADOW_BORDER_SIZE</a> );
<a name="l00673"></a>00673         <span class="keywordtype">float</span> invWidthScale = ( float )( <span class="keywordtype">int</span> )( _shadowMapSize / width );
<a name="l00674"></a>00674         <span class="keywordtype">float</span> invHeightScale = ( float )( <span class="keywordtype">int</span> )( _shadowMapSize / height );
<a name="l00675"></a>00675 
<a name="l00677"></a>00677         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> shadowMapsAlongX = _shadowPageSize / _shadowMapSize;
<a name="l00678"></a>00678         <span class="keywordtype">int</span> <a class="code" href="glext_8h.html#d77deca22f617d3f0e0eb786445689fc">x</a> = shadowMapIdx % shadowMapsAlongX;
<a name="l00679"></a>00679         <span class="keywordtype">int</span> <a class="code" href="_g_l_8h.html#9298c7ad619074f5285b32c6b72bfdea">y</a> = shadowMapIdx / shadowMapsAlongX;
<a name="l00680"></a>00680         <span class="keyword">add</span>.x = x * _texAddrStep + fInvSize * float( <a class="code" href="_gr_virtual_shadow_page_8cpp.html#530dc596cef85ec7faeff33e9e6f5847" title="size of each shadow map border in pixels.">SHADOW_BORDER_SIZE</a> );
<a name="l00681"></a>00681         <span class="keyword">add</span>.y = y * _texAddrStep + fInvSize * float( <a class="code" href="_gr_virtual_shadow_page_8cpp.html#530dc596cef85ec7faeff33e9e6f5847" title="size of each shadow map border in pixels.">SHADOW_BORDER_SIZE</a> );
<a name="l00682"></a>00682 }
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Fri Feb 13 17:20:01 2009 for Bootstrap Engine by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
