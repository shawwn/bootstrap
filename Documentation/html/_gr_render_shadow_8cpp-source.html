<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Bootstrap Engine: C:/Bootstrap/ProjectBX/Documentation/Code/Engine/Graphics/GrRenderShadow.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>C:/Bootstrap/ProjectBX/Documentation/Code/Engine/Graphics/GrRenderShadow.cpp</h1><a href="_gr_render_shadow_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//----------------------------------------------------------</span>
<a name="l00006"></a>00006 <span class="comment"></span><span class="comment">//----------------------------------------------------------</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include "<a class="code" href="graphics__afx_8h.html">graphics_afx.h</a>"</span>
<a name="l00008"></a>00008 
<a name="l00010"></a>00010 <span class="preprocessor">#include "<a class="code" href="_gr_render_shadow_8h.html">GrRenderShadow.h</a>"</span>
<a name="l00011"></a>00011 
<a name="l00013"></a>00013 <span class="preprocessor">#include "<a class="code" href="_gr_texture_mgr_8h.html">GrTextureMgr.h</a>"</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include "<a class="code" href="_gr_texture_base_8h.html">GrTextureBase.h</a>"</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include "<a class="code" href="_gr_render_target_mgr_8h.html">GrRenderTargetMgr.h</a>"</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include "<a class="code" href="_gr_render_target_8h.html">GrRenderTarget.h</a>"</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include "<a class="code" href="_gr_renderbuffer_8h.html">GrRenderbuffer.h</a>"</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include "<a class="code" href="_gr_render_util_8h.html">GrRenderUtil.h</a>"</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include "<a class="code" href="_gr_shader_mgr_8h.html">GrShaderMgr.h</a>"</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include "<a class="code" href="_gr_shader_8h.html">GrShader.h</a>"</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include "<a class="code" href="_gr_camera_8h.html">GrCamera.h</a>"</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include "<a class="code" href="_gr_image_8h.html">GrImage.h</a>"</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include "<a class="code" href="_gr_light_8h.html">GrLight.h</a>"</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include "<a class="code" href="_g_l_subsys_8h.html">GLSubsys.h</a>"</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include "<a class="code" href="_gr_types_8h.html">GrTypes.h</a>"</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include "<a class="code" href="_gr_util_8h.html">GrUtil.h</a>"</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include "<a class="code" href="_gr_render_list_8h.html">GrRenderList.h</a>"</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include "<a class="code" href="_gr_material_8h.html">GrMaterial.h</a>"</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include "<a class="code" href="_gr_material_pass_8h.html">GrMaterialPass.h</a>"</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include "<a class="code" href="_gr_mesh_inst_8h.html">GrMeshInst.h</a>"</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include "<a class="code" href="_gr_streaming_i_b_8h.html">GrStreamingIB.h</a>"</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include "<a class="code" href="_m_quat_8h.html">MQuat.h</a>"</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include "<a class="code" href="_gr_debug_8h.html">GrDebug.h</a>"</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include "<a class="code" href="_gr_virtual_shadow_segment_set_8h.html">GrVirtualShadowSegmentSet.h</a>"</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include "<a class="code" href="_gr_mesh_v_b_8h.html">GrMeshVB.h</a>"</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include "<a class="code" href="_gr_mesh_i_b_8h.html">GrMeshIB.h</a>"</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 
<a name="l00039"></a><a class="code" href="_gr_render_shadow_8cpp.html#a31fd311bf7d2f2a23f8655fdccdef60">00039</a> <span class="preprocessor">#define SHADOW_VERTEX_COMPONENTS_ALPHA  ( GR_ATTRIB_POSITION_MASK | GR_ATTRIB_TANGENT_MASK | GR_ATTRIB_NORMAL_MASK | \</span>
<a name="l00040"></a>00040 <span class="preprocessor">                                                                                  GR_ATTRIB_BINORMAL_MASK | GR_ATTRIB_TEXCOORD_MASK )</span>
<a name="l00041"></a><a class="code" href="_gr_render_shadow_8cpp.html#5cb8fd999cebc545d56ad018b6115ec0">00041</a> <span class="preprocessor"></span><span class="preprocessor">#define DEPTH_MERGE_SAMPLER_LAYER0              0</span>
<a name="l00042"></a><a class="code" href="_gr_render_shadow_8cpp.html#ee75da902e20dca67408a3c226c02ad3">00042</a> <span class="preprocessor"></span><span class="preprocessor">#define DEPTH_MERGE_SAMPLER_LAYER1              1</span>
<a name="l00043"></a><a class="code" href="_gr_render_shadow_8cpp.html#141f7c5f8376a333b10d7657dad19d62">00043</a> <span class="preprocessor"></span><span class="preprocessor">#define DEPTH_PEEL_SAMPLER_TOPLAYER             15</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span>
<a name="l00045"></a>00045 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> kShadowAddressTransformParam = 1;
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> kShadowPageSize = 2048;
<a name="l00048"></a>00048 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> kShadowMapSize = 512;
<a name="l00049"></a>00049 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> kVirtualCubeSize = 1024;
<a name="l00050"></a>00050 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> kMapsPerPage = kShadowPageSize / kShadowMapSize;
<a name="l00051"></a>00051 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">float</span> kPageUVIncrement = ( float )kShadowMapSize / ( <span class="keywordtype">float</span> )kShadowPageSize;
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="comment">//**********************************************************</span>
<a name="l00055"></a>00055 <span class="comment"></span><span class="comment">//**********************************************************</span>
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="comment">//==========================================================</span>
<a name="l00059"></a>00059 <span class="comment"></span><span class="comment">//==========================================================</span>
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 <span class="comment">//----------------------------------------------------------</span>
<a name="l00062"></a><a class="code" href="class_gr_render_shadow.html#78428e5b0de23f0824717a295a8d74f6">00062</a> <a class="code" href="class_gr_render_shadow.html#78428e5b0de23f0824717a295a8d74f6" title="class GrRenderShadow">GrRenderShadow::GrRenderShadow</a>( <a class="code" href="class_gr_streaming_i_b.html" title="class GrStreamingIB">GrStreamingIB</a>* streamingIB, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxIndexBatchSize )
<a name="l00063"></a>00063 : _shadowPage( kShadowPageSize, kShadowMapSize, kVirtualCubeSize )
<a name="l00064"></a>00064 , _shadowPageSize( kShadowPageSize )
<a name="l00065"></a>00065 , _shadowMapSize( kShadowMapSize )
<a name="l00066"></a>00066 , _streamingIB( streamingIB )
<a name="l00067"></a>00067 , _maxIndexBatchSize( maxIndexBatchSize )
<a name="l00068"></a>00068 {
<a name="l00070"></a>00070         _defaultBump = <a class="code" href="_gr_texture_mgr_8cpp.html#51ad772529ca3df5a1d62836ace41d5c" title="singleton pointer.">gGrTextureMgr</a>-&gt;<a class="code" href="class_gr_texture_mgr.html#83321c109ae9862b3e9ad6acabd8819d">FindTexture</a>( <a class="code" href="_gr_config_8h.html#63736ab4111bb29343c1bbb94464429f">GR_SYSTEX_GRAY</a> );
<a name="l00071"></a>00071 
<a name="l00073"></a>00073         _depth = <a class="code" href="_gr_shader_mgr_8cpp.html#72561a5bdde97bf632da40c53beaf8e9" title="Purpose: To manage OpenGL vertex/fragment programs.">gGrShaderMgr</a>-&gt;<a class="code" href="class_gr_shader_mgr.html#808c8e1152500a452398977b1b1ff650" title="public methods">GetShader</a>( <span class="stringliteral">"VSM/depth"</span> );
<a name="l00074"></a>00074         _depthPeel = <a class="code" href="_gr_shader_mgr_8cpp.html#72561a5bdde97bf632da40c53beaf8e9" title="Purpose: To manage OpenGL vertex/fragment programs.">gGrShaderMgr</a>-&gt;<a class="code" href="class_gr_shader_mgr.html#808c8e1152500a452398977b1b1ff650" title="public methods">GetShader</a>( <span class="stringliteral">"VSM/depthPeel"</span> );
<a name="l00075"></a>00075         _depthPeelAlpha = <a class="code" href="_gr_shader_mgr_8cpp.html#72561a5bdde97bf632da40c53beaf8e9" title="Purpose: To manage OpenGL vertex/fragment programs.">gGrShaderMgr</a>-&gt;<a class="code" href="class_gr_shader_mgr.html#808c8e1152500a452398977b1b1ff650" title="public methods">GetShader</a>( <span class="stringliteral">"VSM/depthPeelAlpha"</span> );
<a name="l00076"></a>00076         _mergeDepth = <a class="code" href="_gr_shader_mgr_8cpp.html#72561a5bdde97bf632da40c53beaf8e9" title="Purpose: To manage OpenGL vertex/fragment programs.">gGrShaderMgr</a>-&gt;<a class="code" href="class_gr_shader_mgr.html#808c8e1152500a452398977b1b1ff650" title="public methods">GetShader</a>( <span class="stringliteral">"VSM/depthMerge"</span> );
<a name="l00077"></a>00077 
<a name="l00079"></a>00079         _depthPeel-&gt;BindUserSampler( <span class="stringliteral">"s_TopLayer"</span>, <a class="code" href="_gr_render_shadow_8cpp.html#141f7c5f8376a333b10d7657dad19d62">DEPTH_PEEL_SAMPLER_TOPLAYER</a> );
<a name="l00080"></a>00080         _depthPeelAlpha-&gt;BindUserSampler( <span class="stringliteral">"s_TopLayer"</span>, <a class="code" href="_gr_render_shadow_8cpp.html#141f7c5f8376a333b10d7657dad19d62">DEPTH_PEEL_SAMPLER_TOPLAYER</a> );
<a name="l00081"></a>00081         _mergeDepth-&gt;BindUserSampler( <span class="stringliteral">"s_Layer0"</span>, <a class="code" href="_gr_render_shadow_8cpp.html#5cb8fd999cebc545d56ad018b6115ec0">DEPTH_MERGE_SAMPLER_LAYER0</a> );
<a name="l00082"></a>00082         _mergeDepth-&gt;BindUserSampler( <span class="stringliteral">"s_Layer1"</span>, <a class="code" href="_gr_render_shadow_8cpp.html#ee75da902e20dca67408a3c226c02ad3">DEPTH_MERGE_SAMPLER_LAYER1</a> );
<a name="l00083"></a>00083 
<a name="l00086"></a>00086         <a class="code" href="class_u_ref.html">URef&lt; GrTextureBase &gt;</a> shadow0 = <a class="code" href="_gr_render_target_mgr_8cpp.html#e724d8bfeb4bcd97146e35ca1646dd2f" title="class header.">gGrRenderTargetMgr</a>-&gt;<a class="code" href="class_gr_render_target_mgr.html#7e1d7957a2167cd17b678a44da653898">CreateRendertexture</a>( _shadowMapSize, _shadowMapSize, <a class="code" href="class_gr_render_target_mgr.html#66d0ebb49e9781283d824f19f4bbc3f6921d4c2f8d32dd605d25dee31fc2312d" title="not supported for renderbuffers.">GrRenderTargetMgr::EF_DEPTH</a>,
<a name="l00087"></a>00087                 <a class="code" href="class_gr_texture_base.html#47f4a8d764ba3c8e9e353a394edfcd2c">GrTextureBase::kNoMipMap</a>, <a class="code" href="class_gr_texture_base.html#5ce3676de03c3c565a9a0995334e5308d02dc086ce7c780adab8a7bb57a1bb19">GrTextureBase::ETT_2D</a> );
<a name="l00088"></a>00088         _shadowCasterPage = <a class="code" href="_gr_render_target_mgr_8cpp.html#e724d8bfeb4bcd97146e35ca1646dd2f" title="class header.">gGrRenderTargetMgr</a>-&gt;<a class="code" href="class_gr_render_target_mgr.html#2dc9cb29f5f88c355eaab0938c0f355d" title="create a render target.">CreateRenderTarget</a>( 0, shadow0 );
<a name="l00089"></a>00089 
<a name="l00091"></a>00091         <a class="code" href="class_u_ref.html">URef&lt; GrTextureBase &gt;</a> shadow1 = <a class="code" href="_gr_render_target_mgr_8cpp.html#e724d8bfeb4bcd97146e35ca1646dd2f" title="class header.">gGrRenderTargetMgr</a>-&gt;<a class="code" href="class_gr_render_target_mgr.html#7e1d7957a2167cd17b678a44da653898">CreateRendertexture</a>( _shadowMapSize, _shadowMapSize, <a class="code" href="class_gr_render_target_mgr.html#66d0ebb49e9781283d824f19f4bbc3f6921d4c2f8d32dd605d25dee31fc2312d" title="not supported for renderbuffers.">GrRenderTargetMgr::EF_DEPTH</a>,
<a name="l00092"></a>00092                 <a class="code" href="class_gr_texture_base.html#47f4a8d764ba3c8e9e353a394edfcd2c">GrTextureBase::kNoMipMap</a>, <a class="code" href="class_gr_texture_base.html#5ce3676de03c3c565a9a0995334e5308d02dc086ce7c780adab8a7bb57a1bb19">GrTextureBase::ETT_2D</a> );
<a name="l00093"></a>00093         _shadowReceiverPage = <a class="code" href="_gr_render_target_mgr_8cpp.html#e724d8bfeb4bcd97146e35ca1646dd2f" title="class header.">gGrRenderTargetMgr</a>-&gt;<a class="code" href="class_gr_render_target_mgr.html#2dc9cb29f5f88c355eaab0938c0f355d" title="create a render target.">CreateRenderTarget</a>( 0, shadow1 );
<a name="l00094"></a>00094 
<a name="l00096"></a>00096         <a class="code" href="class_gr_texture.html" title="class GrTexture">GrTexture</a>* shadow2D0 = ( <a class="code" href="class_gr_texture.html" title="class GrTexture">GrTexture</a>* )( <a class="code" href="class_gr_texture_base.html" title="class GrTextureBase">GrTextureBase</a>* )shadow0;
<a name="l00097"></a>00097         <a class="code" href="class_gr_texture.html" title="class GrTexture">GrTexture</a>* shadow2D1 = ( <a class="code" href="class_gr_texture.html" title="class GrTexture">GrTexture</a>* )( <a class="code" href="class_gr_texture_base.html" title="class GrTextureBase">GrTextureBase</a>* )shadow1;
<a name="l00098"></a>00098         shadow2D0-&gt;<a class="code" href="class_gr_texture_base.html#4458c1c8d784beb36b228813f3edc6f0" title="binds the texture to the OpenGL texture unit specified [0..15]">Bind</a>( 0 );
<a name="l00099"></a>00099         shadow2D0-&gt;<a class="code" href="class_gr_texture.html#5e10056726037b39e6980e9cd81c984d" title="turns on hardware shadow mode. This is only valid for depth/depth-stencil textures...">SetHWShadowEnable</a>( <span class="keyword">false</span> );
<a name="l00100"></a>00100         shadow2D1-&gt;<a class="code" href="class_gr_texture_base.html#4458c1c8d784beb36b228813f3edc6f0" title="binds the texture to the OpenGL texture unit specified [0..15]">Bind</a>( 0 );
<a name="l00101"></a>00101         shadow2D1-&gt;<a class="code" href="class_gr_texture.html#5e10056726037b39e6980e9cd81c984d" title="turns on hardware shadow mode. This is only valid for depth/depth-stencil textures...">SetHWShadowEnable</a>( <span class="keyword">false</span> );
<a name="l00102"></a>00102 
<a name="l00104"></a>00104         <a class="code" href="class_u_ref.html">URef&lt; GrTextureBase &gt;</a> shadow2 = <a class="code" href="_gr_render_target_mgr_8cpp.html#e724d8bfeb4bcd97146e35ca1646dd2f" title="class header.">gGrRenderTargetMgr</a>-&gt;<a class="code" href="class_gr_render_target_mgr.html#7e1d7957a2167cd17b678a44da653898">CreateRendertexture</a>( _shadowPageSize, _shadowPageSize, <a class="code" href="class_gr_render_target_mgr.html#66d0ebb49e9781283d824f19f4bbc3f6921d4c2f8d32dd605d25dee31fc2312d" title="not supported for renderbuffers.">GrRenderTargetMgr::EF_DEPTH</a>,
<a name="l00105"></a>00105                 <a class="code" href="class_gr_texture_base.html#47f4a8d764ba3c8e9e353a394edfcd2c">GrTextureBase::kNoMipMap</a>, <a class="code" href="class_gr_texture_base.html#5ce3676de03c3c565a9a0995334e5308d02dc086ce7c780adab8a7bb57a1bb19">GrTextureBase::ETT_2D</a> );
<a name="l00106"></a>00106         _shadowMidpointPage = <a class="code" href="_gr_render_target_mgr_8cpp.html#e724d8bfeb4bcd97146e35ca1646dd2f" title="class header.">gGrRenderTargetMgr</a>-&gt;<a class="code" href="class_gr_render_target_mgr.html#2dc9cb29f5f88c355eaab0938c0f355d" title="create a render target.">CreateRenderTarget</a>( 0, shadow2 );
<a name="l00107"></a>00107 
<a name="l00109"></a>00109         <a class="code" href="class_gr_texture.html" title="class GrTexture">GrTexture</a>* shadow2D2 = ( <a class="code" href="class_gr_texture.html" title="class GrTexture">GrTexture</a>* )( <a class="code" href="class_gr_texture_base.html" title="class GrTextureBase">GrTextureBase</a>* )shadow2;
<a name="l00110"></a>00110         shadow2D2-&gt;<a class="code" href="class_gr_texture_base.html#4458c1c8d784beb36b228813f3edc6f0" title="binds the texture to the OpenGL texture unit specified [0..15]">Bind</a>( 0 );
<a name="l00111"></a>00111         shadow2D2-&gt;<a class="code" href="class_gr_texture.html#5e10056726037b39e6980e9cd81c984d" title="turns on hardware shadow mode. This is only valid for depth/depth-stencil textures...">SetHWShadowEnable</a>( <span class="keyword">true</span> );
<a name="l00112"></a>00112 
<a name="l00114"></a>00114         <a class="code" href="_g_l_subsys_8h.html#ab12f88c1ad74a5b4876f37fcf105bda">CHECK_GL</a>();
<a name="l00115"></a>00115 }
<a name="l00116"></a>00116 
<a name="l00117"></a>00117 <span class="comment">//----------------------------------------------------------</span>
<a name="l00118"></a><a class="code" href="class_gr_render_shadow.html#ebc5b2d3b47785bd1d08f2626a7c9a2e">00118</a> <a class="code" href="class_gr_render_shadow.html#ebc5b2d3b47785bd1d08f2626a7c9a2e">GrRenderShadow::~GrRenderShadow</a>()
<a name="l00119"></a>00119 {
<a name="l00120"></a>00120 
<a name="l00121"></a>00121 }
<a name="l00122"></a>00122 
<a name="l00123"></a>00123 
<a name="l00124"></a>00124 <span class="comment">//==========================================================</span>
<a name="l00126"></a>00126 <span class="comment"></span><span class="comment">//==========================================================</span>
<a name="l00127"></a>00127 
<a name="l00128"></a>00128 <span class="comment">//----------------------------------------------------------</span>
<a name="l00129"></a>00129 <a class="code" href="class_u_ref.html">URef&lt; GrTextureBase &gt;</a>
<a name="l00130"></a><a class="code" href="class_gr_render_shadow.html#96026faa3feecbc650de41111af57c28">00130</a> <a class="code" href="class_gr_render_shadow.html#96026faa3feecbc650de41111af57c28" title="this renders the shadow.">GrRenderShadow::RenderShadow</a>( <a class="code" href="struct_gr_virtual_shadow_page_1_1_s_render_data.html">GrVirtualShadowPage::SRenderData</a>&amp; shadowData, <span class="keyword">const</span> <a class="code" href="class_gr_render_list.html" title="class GrRenderList">GrRenderList</a>&amp; shadowCasters,
<a name="l00131"></a>00131                                                           <span class="keyword">const</span> <a class="code" href="class_gr_camera.html" title="class GrCamera">GrCamera</a>&amp; camera, <span class="keyword">const</span> <a class="code" href="class_gr_light.html" title="class GrLight">GrLight</a>&amp; light, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> time, <a class="code" href="enums_8h.html#697c1ee1354746841860d5bf9f81c033" title="standard quality enum">EGRQUALITY</a> quality )
<a name="l00132"></a>00132 {
<a name="l00134"></a>00134         <a class="code" href="class_gr_render_target.html" title="IX = internal only.">GrRenderTarget</a>* prevRT = <a class="code" href="class_gr_render_target.html#0bf3b1509691c2567d9b0f01a29f42d4" title="binds back to the primary render target.">GrRenderTarget::GetCurrentRT</a>();
<a name="l00135"></a>00135 
<a name="l00137"></a>00137         <a class="code" href="class_gr_virtual_shadow_segment_set.html" title="class GrVirtualShadowSegmentSet">GrVirtualShadowSegmentSet</a> segments( camera, 10, 2.0f );
<a name="l00138"></a>00138         _shadowPage.<a class="code" href="class_gr_virtual_shadow_page.html#47d88b2d5752b7a1e2f38d14d5df538d" title="functions that enable rendering to the shadow map.">GenShadowInfo</a>( _virtualShadowCache, camera, segments, light );
<a name="l00139"></a>00139 
<a name="l00141"></a>00141         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> vsmCount = ( <span class="keywordtype">unsigned</span> <a class="code" href="_g_l_aux_8h.html#b832c174e145540d491b0830fc05dbb1">int</a> )_virtualShadowCache.size();
<a name="l00142"></a>00142         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; vsmCount; ++i )
<a name="l00143"></a>00143         {
<a name="l00145"></a>00145                 RenderShadowCasters( shadowCasters, _virtualShadowCache[ i ].camera, time, quality );
<a name="l00146"></a>00146 
<a name="l00148"></a>00148                 RenderShadowReceivers( shadowCasters, _virtualShadowCache[ i ].camera, time, quality );
<a name="l00149"></a>00149 
<a name="l00150"></a>00150 <span class="preprocessor">#if 1</span>
<a name="l00151"></a>00151 <span class="preprocessor"></span>                <span class="keywordtype">bool</span> saveCurFace = <span class="keyword">false</span>;
<a name="l00152"></a>00152                 <span class="keywordflow">if</span> ( saveCurFace )
<a name="l00153"></a>00153                 {
<a name="l00154"></a>00154                         <span class="keywordtype">char</span> imageName[] = <span class="stringliteral">"shadowmap.tga"</span>;
<a name="l00155"></a>00155 
<a name="l00156"></a>00156                         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dim = _shadowMapSize;
<a name="l00157"></a>00157                         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* pels = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[ dim * dim ];
<a name="l00158"></a>00158                         <a class="code" href="_g_l_subsys_8cpp.html#e2a64d16a6622519931e094765a74e1c">bglReadPixels</a>( 0, 0, dim, dim, <a class="code" href="_g_l_8h.html#ac16527902deb1ddf6b84a9ce3da6e84">GL_DEPTH_COMPONENT</a>, <a class="code" href="_g_l_8h.html#80a33c79f69417372d65d2a65ca36d49">GL_UNSIGNED_BYTE</a>, pels );
<a name="l00159"></a>00159                         <a class="code" href="_gr_debug_8cpp.html#f82ebae2e158d721c11ff92a1c69fe69" title="functions implementations.">GrSaveTGA</a>( imageName, pels, dim, dim, 1 );
<a name="l00160"></a>00160                         saveCurFace = <span class="keyword">false</span>;
<a name="l00161"></a>00161                 }
<a name="l00162"></a>00162 <span class="preprocessor">#endif</span>
<a name="l00163"></a>00163 <span class="preprocessor"></span>
<a name="l00165"></a>00165                 _shadowMidpointPage-&gt;Bind( <span class="keyword">false</span> );
<a name="l00166"></a>00166                 _shadowPage.<a class="code" href="class_gr_virtual_shadow_page.html#e438a2c1b4140e1c7a12b1c1628d2040">SetActiveShadowMap</a>( _virtualShadowCache[ i ] );
<a name="l00167"></a>00167                 <a class="code" href="_gr_util_8cpp.html#7b33558bb79e3c6936f26553c282d081">GrSetWriteEnable</a>( <a class="code" href="_gr_util_8h.html#263ecb0b6dc90d2aca7b9291d81a7024">GR_DEPTH</a> );
<a name="l00168"></a>00168                 <a class="code" href="_gr_util_8cpp.html#da7ea629bb413c26919562c8846d6139">GrSetState</a>( <a class="code" href="_gr_util_8h.html#df38fed29d4a8214bf4a51a0df0a7512" title="render states.">GR_DEPTHTEST</a> );
<a name="l00169"></a>00169                 <a class="code" href="_gr_util_8cpp.html#60d9ac55af862efb36a5e95f19c14407">GrSetDepthMode</a>( <a class="code" href="_gr_util_8h.html#987cbe08cd23c0d7a12ae576e9ce09845b5e26e846a6edfdbb028ff8d1bc5779">EDM_ALWAYS</a> );
<a name="l00170"></a>00170 
<a name="l00172"></a>00172                 CalcShadowMidpoint( quality );
<a name="l00173"></a>00173         }
<a name="l00174"></a>00174 
<a name="l00176"></a>00176         shadowData = _shadowPage.<a class="code" href="class_gr_virtual_shadow_page.html#6fe56d04431ca8c88be756ff92d98e09">Finish</a>();
<a name="l00177"></a>00177 
<a name="l00179"></a>00179         _virtualShadowCache.resize( 0 );
<a name="l00180"></a>00180 
<a name="l00182"></a>00182         prevRT-&gt;<a class="code" href="class_gr_render_target.html#26ee9e8fef318184bbf038f4b718f746" title="binds this render target.">Bind</a>();
<a name="l00183"></a>00183 
<a name="l00185"></a>00185         <span class="keywordflow">return</span> _shadowMidpointPage-&gt;GetDepthTex();
<a name="l00186"></a>00186 }
<a name="l00187"></a>00187 
<a name="l00188"></a>00188 
<a name="l00189"></a>00189 <span class="comment">//==========================================================</span>
<a name="l00191"></a>00191 <span class="comment"></span><span class="comment">//==========================================================</span>
<a name="l00192"></a>00192 
<a name="l00193"></a>00193 <span class="comment">//----------------------------------------------------------</span>
<a name="l00194"></a>00194 <span class="keywordtype">void</span>
<a name="l00195"></a>00195 GrRenderShadow::RenderShadowCasters( <span class="keyword">const</span> <a class="code" href="class_gr_render_list.html" title="class GrRenderList">GrRenderList</a>&amp; shadowCasters, <span class="keyword">const</span> <a class="code" href="class_gr_camera.html" title="class GrCamera">GrCamera</a>&amp; shadowCamera,
<a name="l00196"></a>00196                                                                          <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> time, <a class="code" href="enums_8h.html#697c1ee1354746841860d5bf9f81c033" title="standard quality enum">EGRQUALITY</a> quality )
<a name="l00197"></a>00197 {
<a name="l00199"></a>00199         _shadowCasterPage-&gt;Bind();
<a name="l00200"></a>00200 
<a name="l00202"></a>00202         <a class="code" href="_gr_util_8cpp.html#da7ea629bb413c26919562c8846d6139">GrSetState</a>( <a class="code" href="_gr_util_8h.html#df38fed29d4a8214bf4a51a0df0a7512" title="render states.">GR_DEPTHTEST</a> );
<a name="l00203"></a>00203         <a class="code" href="_gr_util_8cpp.html#7b33558bb79e3c6936f26553c282d081">GrSetWriteEnable</a>( <a class="code" href="_gr_util_8h.html#263ecb0b6dc90d2aca7b9291d81a7024">GR_DEPTH</a> );
<a name="l00204"></a>00204         <a class="code" href="_gr_util_8cpp.html#60d9ac55af862efb36a5e95f19c14407">GrSetDepthMode</a>( <a class="code" href="_gr_util_8h.html#987cbe08cd23c0d7a12ae576e9ce098411cf9194e24cc66a0779bd0d6619ce9d">EDM_LESSEQUAL</a> );
<a name="l00205"></a>00205 
<a name="l00207"></a>00207         <a class="code" href="_gr_util_8cpp.html#60654372f8080fc80b5e1ef0aea7dd99" title="Rendering functions.">GrClear</a>();
<a name="l00208"></a>00208 
<a name="l00210"></a>00210         _depth-&gt;Bind( quality );
<a name="l00211"></a>00211 
<a name="l00213"></a>00213         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> startObj = 0;
<a name="l00214"></a>00214         <span class="keywordflow">while</span> ( startObj &lt; shadowCasters.<a class="code" href="class_gr_render_list.html#eb7629d3dfeedc0b4506fe89805626ca" title="renderable accessors.">GetItemCount</a>() )
<a name="l00215"></a>00215         {
<a name="l00217"></a>00217                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> endObj = 0;
<a name="l00218"></a>00218                 <span class="keyword">const</span> <a class="code" href="class_gr_material.html" title="class GrMaterial">GrMaterial</a>* material = GetShadowSpan( endObj, shadowCasters, startObj );
<a name="l00219"></a>00219 
<a name="l00221"></a>00221                 <span class="keywordflow">if</span> ( !material-&gt;<a class="code" href="class_gr_material.html#9f2498b4265e1c59a1abdaf03792b23a">CastShadow</a>() )
<a name="l00222"></a>00222                 {
<a name="l00223"></a>00223                         startObj = endObj;
<a name="l00224"></a>00224                         <span class="keywordflow">continue</span>;
<a name="l00225"></a>00225                 }
<a name="l00226"></a>00226 
<a name="l00228"></a>00228                 <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> passCount = material-&gt;<a class="code" href="class_gr_material.html#c5afd8886b80a26cb67430eb48ba8bf7" title="returns the number of passes needed.">GetPassCount</a>();
<a name="l00229"></a>00229                 <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pass = 0; pass &lt; passCount; ++pass )
<a name="l00230"></a>00230                 {
<a name="l00232"></a>00232                         <span class="keyword">const</span> <a class="code" href="class_gr_material_pass.html" title="class GrMaterialPass">GrMaterialPass</a>* curPass = material-&gt;<a class="code" href="class_gr_material.html#d1d9f753c4b3875f7d2b361bcf8cf99a">GetPass</a>( pass );
<a name="l00233"></a>00233 
<a name="l00235"></a>00235                         <span class="keywordflow">if</span> ( !curPass-&gt;<a class="code" href="class_gr_material_pass.html#c968cf3eafd243fa2de5ffaf3e3d2981">CastShadow</a>() )
<a name="l00236"></a>00236                                 <span class="keywordflow">continue</span>;
<a name="l00237"></a>00237 
<a name="l00239"></a>00239                         curPass-&gt;<a class="code" href="class_gr_material_pass.html#272b822ee696efb7e967a9565cd79a97">ApplyStates</a>( <a class="code" href="_gr_util_8h.html#20b24dfbb3798202873d51b43f75082d">GR_ALPHATEST</a> | <a class="code" href="_gr_util_8h.html#43f8fbc0073e1858f6bba0a73acfe8a6">GR_CULLFACE</a>, <a class="code" href="_gr_util_8h.html#263ecb0b6dc90d2aca7b9291d81a7024">GR_DEPTH</a> );
<a name="l00240"></a>00240 
<a name="l00242"></a>00242                         <span class="keywordtype">bool</span> alphaTest = curPass-&gt;<a class="code" href="class_gr_material_pass.html#854289ca69d0efcfe29047c80c25fd3d" title="texgen flags enable/disable.">AlphaTest</a>();
<a name="l00243"></a>00243                         <span class="keywordflow">if</span> ( alphaTest )
<a name="l00244"></a>00244                         {
<a name="l00246"></a>00246                                 curPass-&gt;<a class="code" href="class_gr_material_pass.html#d4fe8b412fb170dcf48688ba424c7d18">GetTextureSet</a>().<a class="code" href="class_gr_texture_set.html#974058b8d0d8f04b85807f52ae857a63">ApplyGlobalState</a>( _depth );
<a name="l00247"></a>00247                                 curPass-&gt;<a class="code" href="class_gr_material_pass.html#d4fe8b412fb170dcf48688ba424c7d18">GetTextureSet</a>().<a class="code" href="class_gr_texture_set.html#e3e1bfc4506ef8333d5ef947f8d7b391">ApplyStageState</a>( <a class="code" href="_gr_config_8h.html#6df36e6af6bdeed00ff250f968160688b1b35286c474a867806a21cea61952b5">ES_BUMP</a>, <a class="code" href="_gr_config_8h.html#4efb41e353cc885eb72be8fb688fc5d4">GR_TEX_BUMP</a>, _depth, <a class="code" href="class_gr_shader.html#2f004c603bb97711d05eb68381a5a7ba3f52eed666dad2ab377a721dec7d48c2">GrShader::EP_BUMP_MOD</a>, <a class="code" href="class_gr_shader.html#2f004c603bb97711d05eb68381a5a7baca21fbc32f19ff7f96d197e91fa8241f">GrShader::EP_BUMP_ADD</a> );
<a name="l00248"></a>00248                                 curPass-&gt;<a class="code" href="class_gr_material_pass.html#d4fe8b412fb170dcf48688ba424c7d18">GetTextureSet</a>().<a class="code" href="class_gr_texture_set.html#e3e1bfc4506ef8333d5ef947f8d7b391">ApplyStageState</a>( <a class="code" href="_gr_config_8h.html#6df36e6af6bdeed00ff250f9681606884a3d034db25df349c89094e48978258d">ES_DIFFUSE</a>, <a class="code" href="_gr_config_8h.html#414a361b34dcaaf2c98e12af6d40752c">GR_TEX_DIFFUSE</a>, _depth, <a class="code" href="class_gr_shader.html#2f004c603bb97711d05eb68381a5a7babd45973b924f00252c2b0119fe5b3fe5">GrShader::EP_DIFFUSE_MOD</a>, <a class="code" href="class_gr_shader.html#2f004c603bb97711d05eb68381a5a7ba2a9f47816bdefe2925a532af749de481">GrShader::EP_DIFFUSE_ADD</a> );
<a name="l00249"></a>00249                         }
<a name="l00250"></a>00250 
<a name="l00252"></a>00252                         RenderObjects( shadowCasters, startObj, endObj, shadowCamera, _depth, time, alphaTest );
<a name="l00253"></a>00253 
<a name="l00257"></a>00257                         <span class="keywordflow">if</span> ( !alphaTest )
<a name="l00258"></a>00258                                 <span class="keywordflow">break</span>;
<a name="l00259"></a>00259                 }
<a name="l00260"></a>00260 
<a name="l00262"></a>00262                 startObj = endObj;
<a name="l00263"></a>00263         }
<a name="l00264"></a>00264 }
<a name="l00265"></a>00265 
<a name="l00266"></a>00266 <span class="comment">//----------------------------------------------------------</span>
<a name="l00267"></a>00267 <span class="keywordtype">void</span>
<a name="l00268"></a>00268 GrRenderShadow::RenderShadowReceivers( <span class="keyword">const</span> <a class="code" href="class_gr_render_list.html" title="class GrRenderList">GrRenderList</a>&amp; shadowReceivers, <span class="keyword">const</span> <a class="code" href="class_gr_camera.html" title="class GrCamera">GrCamera</a>&amp; shadowCamera,
<a name="l00269"></a>00269                                                                            <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> time, <a class="code" href="enums_8h.html#697c1ee1354746841860d5bf9f81c033" title="standard quality enum">EGRQUALITY</a> quality )
<a name="l00270"></a>00270 {
<a name="l00271"></a>00271         _shadowReceiverPage-&gt;Bind();
<a name="l00272"></a>00272 
<a name="l00274"></a>00274         <a class="code" href="_gr_util_8cpp.html#7b33558bb79e3c6936f26553c282d081">GrSetWriteEnable</a>( <a class="code" href="_gr_util_8h.html#263ecb0b6dc90d2aca7b9291d81a7024">GR_DEPTH</a> );
<a name="l00275"></a>00275         <a class="code" href="_gr_util_8cpp.html#da7ea629bb413c26919562c8846d6139">GrSetState</a>( <a class="code" href="_gr_util_8h.html#df38fed29d4a8214bf4a51a0df0a7512" title="render states.">GR_DEPTHTEST</a> );
<a name="l00276"></a>00276         <a class="code" href="_gr_util_8cpp.html#60d9ac55af862efb36a5e95f19c14407">GrSetDepthMode</a>( <a class="code" href="_gr_util_8h.html#987cbe08cd23c0d7a12ae576e9ce098411cf9194e24cc66a0779bd0d6619ce9d">EDM_LESSEQUAL</a> );
<a name="l00277"></a>00277 
<a name="l00279"></a>00279         <a class="code" href="_gr_util_8cpp.html#60654372f8080fc80b5e1ef0aea7dd99" title="Rendering functions.">GrClear</a>();
<a name="l00280"></a>00280 
<a name="l00282"></a>00282         _shadowCasterPage-&gt;GetDepthTex()-&gt;Bind( <a class="code" href="_gr_render_shadow_8cpp.html#141f7c5f8376a333b10d7657dad19d62">DEPTH_PEEL_SAMPLER_TOPLAYER</a> );
<a name="l00283"></a>00283 
<a name="l00285"></a>00285         <a class="code" href="class_gr_shader.html" title="Purpose: To load and manage a shader.">GrShader</a>* curShader = 0;
<a name="l00286"></a>00286         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> startObj = 0;
<a name="l00287"></a>00287         <span class="keywordflow">while</span> ( startObj &lt; shadowReceivers.<a class="code" href="class_gr_render_list.html#eb7629d3dfeedc0b4506fe89805626ca" title="renderable accessors.">GetItemCount</a>() )
<a name="l00288"></a>00288         {
<a name="l00290"></a>00290                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> endObj = 0;
<a name="l00291"></a>00291                 <span class="keyword">const</span> <a class="code" href="class_gr_material.html" title="class GrMaterial">GrMaterial</a>* material = GetShadowSpan( endObj, shadowReceivers, startObj );
<a name="l00292"></a>00292 
<a name="l00294"></a>00294                 <span class="keywordflow">if</span> ( !material-&gt;<a class="code" href="class_gr_material.html#c4ef3f9a72931e59ce603dc68b2d1317">ReceiveShadow</a>() )
<a name="l00295"></a>00295                 {
<a name="l00296"></a>00296                         startObj = endObj;
<a name="l00297"></a>00297                         <span class="keywordflow">continue</span>;
<a name="l00298"></a>00298                 }
<a name="l00299"></a>00299 
<a name="l00301"></a>00301                 <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> passCount = material-&gt;<a class="code" href="class_gr_material.html#c5afd8886b80a26cb67430eb48ba8bf7" title="returns the number of passes needed.">GetPassCount</a>();
<a name="l00302"></a>00302                 <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pass = 0; pass &lt; passCount; ++pass )
<a name="l00303"></a>00303                 {
<a name="l00305"></a>00305                         <span class="keyword">const</span> <a class="code" href="class_gr_material_pass.html" title="class GrMaterialPass">GrMaterialPass</a>* curPass = material-&gt;<a class="code" href="class_gr_material.html#d1d9f753c4b3875f7d2b361bcf8cf99a">GetPass</a>( pass );
<a name="l00306"></a>00306 
<a name="l00308"></a>00308                         <span class="keywordflow">if</span> ( !curPass-&gt;<a class="code" href="class_gr_material_pass.html#ca6fb93ef3404e9aad9396cd7aecb083">ReceiveShadow</a>() )
<a name="l00309"></a>00309                                 <span class="keywordflow">continue</span>;
<a name="l00310"></a>00310 
<a name="l00312"></a>00312                         curPass-&gt;<a class="code" href="class_gr_material_pass.html#272b822ee696efb7e967a9565cd79a97">ApplyStates</a>( <a class="code" href="_gr_util_8h.html#20b24dfbb3798202873d51b43f75082d">GR_ALPHATEST</a> | <a class="code" href="_gr_util_8h.html#43f8fbc0073e1858f6bba0a73acfe8a6">GR_CULLFACE</a>, <a class="code" href="_gr_util_8h.html#263ecb0b6dc90d2aca7b9291d81a7024">GR_DEPTH</a> );
<a name="l00313"></a>00313 
<a name="l00315"></a>00315                         <span class="keywordtype">bool</span> alphaTest = curPass-&gt;<a class="code" href="class_gr_material_pass.html#854289ca69d0efcfe29047c80c25fd3d" title="texgen flags enable/disable.">AlphaTest</a>();
<a name="l00316"></a>00316                         <span class="keywordflow">if</span> ( alphaTest )
<a name="l00317"></a>00317                         {
<a name="l00318"></a>00318                                 <span class="keywordflow">if</span> ( curShader != _depthPeelAlpha )
<a name="l00319"></a>00319                                 {
<a name="l00320"></a>00320                                         _depthPeelAlpha-&gt;Bind( quality );
<a name="l00321"></a>00321                                         curShader = _depthPeelAlpha;
<a name="l00322"></a>00322                                 }
<a name="l00323"></a>00323 
<a name="l00325"></a>00325                                 curPass-&gt;<a class="code" href="class_gr_material_pass.html#d4fe8b412fb170dcf48688ba424c7d18">GetTextureSet</a>().<a class="code" href="class_gr_texture_set.html#974058b8d0d8f04b85807f52ae857a63">ApplyGlobalState</a>( _depthPeelAlpha );
<a name="l00326"></a>00326                                 curPass-&gt;<a class="code" href="class_gr_material_pass.html#d4fe8b412fb170dcf48688ba424c7d18">GetTextureSet</a>().<a class="code" href="class_gr_texture_set.html#e3e1bfc4506ef8333d5ef947f8d7b391">ApplyStageState</a>( <a class="code" href="_gr_config_8h.html#6df36e6af6bdeed00ff250f968160688b1b35286c474a867806a21cea61952b5">ES_BUMP</a>, <a class="code" href="_gr_config_8h.html#4efb41e353cc885eb72be8fb688fc5d4">GR_TEX_BUMP</a>, curShader, <a class="code" href="class_gr_shader.html#2f004c603bb97711d05eb68381a5a7ba3f52eed666dad2ab377a721dec7d48c2">GrShader::EP_BUMP_MOD</a>, <a class="code" href="class_gr_shader.html#2f004c603bb97711d05eb68381a5a7baca21fbc32f19ff7f96d197e91fa8241f">GrShader::EP_BUMP_ADD</a> );
<a name="l00327"></a>00327                                 curPass-&gt;<a class="code" href="class_gr_material_pass.html#d4fe8b412fb170dcf48688ba424c7d18">GetTextureSet</a>().<a class="code" href="class_gr_texture_set.html#e3e1bfc4506ef8333d5ef947f8d7b391">ApplyStageState</a>( <a class="code" href="_gr_config_8h.html#6df36e6af6bdeed00ff250f9681606884a3d034db25df349c89094e48978258d">ES_DIFFUSE</a>, <a class="code" href="_gr_config_8h.html#414a361b34dcaaf2c98e12af6d40752c">GR_TEX_DIFFUSE</a>, curShader, <a class="code" href="class_gr_shader.html#2f004c603bb97711d05eb68381a5a7babd45973b924f00252c2b0119fe5b3fe5">GrShader::EP_DIFFUSE_MOD</a>, <a class="code" href="class_gr_shader.html#2f004c603bb97711d05eb68381a5a7ba2a9f47816bdefe2925a532af749de481">GrShader::EP_DIFFUSE_ADD</a> );
<a name="l00328"></a>00328                         }
<a name="l00329"></a>00329                         <span class="keywordflow">else</span>
<a name="l00330"></a>00330                         {
<a name="l00331"></a>00331                                 <span class="keywordflow">if</span> ( curShader != _depthPeel )
<a name="l00332"></a>00332                                 {
<a name="l00333"></a>00333                                         _depthPeel-&gt;Bind( quality );
<a name="l00334"></a>00334                                         curShader = _depthPeel;
<a name="l00335"></a>00335                                 }
<a name="l00336"></a>00336                         }
<a name="l00337"></a>00337 
<a name="l00338"></a>00338                         RenderObjects( shadowReceivers, startObj, endObj, shadowCamera, curShader, time, alphaTest );
<a name="l00339"></a>00339 
<a name="l00343"></a>00343                         <span class="keywordflow">if</span> ( !alphaTest )
<a name="l00344"></a>00344                                 <span class="keywordflow">break</span>;
<a name="l00345"></a>00345                 }
<a name="l00346"></a>00346 
<a name="l00348"></a>00348                 startObj = endObj;
<a name="l00349"></a>00349         }
<a name="l00350"></a>00350 }
<a name="l00351"></a>00351 
<a name="l00352"></a>00352 <span class="comment">//----------------------------------------------------------</span>
<a name="l00353"></a>00353 <span class="keywordtype">void</span>
<a name="l00354"></a>00354 GrRenderShadow::RenderShadowMap( <span class="keyword">const</span> <a class="code" href="class_gr_render_list.html" title="class GrRenderList">GrRenderList</a>&amp; shadowCasters, <span class="keyword">const</span> <a class="code" href="class_gr_camera.html" title="class GrCamera">GrCamera</a>&amp; shadowCamera,
<a name="l00355"></a>00355                                                                  <a class="code" href="class_gr_shader.html" title="Purpose: To load and manage a shader.">GrShader</a>* depthShader, <a class="code" href="class_gr_shader.html" title="Purpose: To load and manage a shader.">GrShader</a>* alphaTestShader, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> writeMask,
<a name="l00356"></a>00356                                                                  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> time, <a class="code" href="enums_8h.html#697c1ee1354746841860d5bf9f81c033" title="standard quality enum">EGRQUALITY</a> quality, <span class="keywordtype">bool</span> honorCastShadow )
<a name="l00357"></a>00357 {
<a name="l00359"></a>00359         <a class="code" href="_gr_util_8cpp.html#da7ea629bb413c26919562c8846d6139">GrSetState</a>( <a class="code" href="_gr_util_8h.html#df38fed29d4a8214bf4a51a0df0a7512" title="render states.">GR_DEPTHTEST</a> );
<a name="l00360"></a>00360         <a class="code" href="_gr_util_8cpp.html#7b33558bb79e3c6936f26553c282d081">GrSetWriteEnable</a>( writeMask );
<a name="l00361"></a>00361         <a class="code" href="_gr_util_8cpp.html#60d9ac55af862efb36a5e95f19c14407">GrSetDepthMode</a>( <a class="code" href="_gr_util_8h.html#987cbe08cd23c0d7a12ae576e9ce098411cf9194e24cc66a0779bd0d6619ce9d">EDM_LESSEQUAL</a> );
<a name="l00362"></a>00362 
<a name="l00364"></a>00364         RenderShadowFaces( shadowCasters, shadowCamera, depthShader, alphaTestShader, writeMask, time,
<a name="l00365"></a>00365                 quality, honorCastShadow );
<a name="l00366"></a>00366 }
<a name="l00367"></a>00367 
<a name="l00368"></a>00368 <span class="comment">//----------------------------------------------------------</span>
<a name="l00369"></a>00369 <span class="keywordtype">void</span>
<a name="l00370"></a>00370 GrRenderShadow::RenderShadowFaces( <span class="keyword">const</span> <a class="code" href="class_gr_render_list.html" title="class GrRenderList">GrRenderList</a>&amp; shadowCasters, <span class="keyword">const</span> <a class="code" href="class_gr_camera.html" title="class GrCamera">GrCamera</a>&amp; shadowCamera,
<a name="l00371"></a>00371                                                                    <a class="code" href="class_gr_shader.html" title="Purpose: To load and manage a shader.">GrShader</a>* depthShader, <a class="code" href="class_gr_shader.html" title="Purpose: To load and manage a shader.">GrShader</a>* alphaTestShader, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> writeMask,
<a name="l00372"></a>00372                                                                    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> time, <a class="code" href="enums_8h.html#697c1ee1354746841860d5bf9f81c033" title="standard quality enum">EGRQUALITY</a> quality, <span class="keywordtype">bool</span> honorCastShadow )
<a name="l00373"></a>00373 {
<a name="l00376"></a>00376         <a class="code" href="class_m_mat4x4.html" title="class MMat4x4">MMat4x4</a> projMat = shadowCamera.<a class="code" href="class_gr_camera.html#c4d5422b4554d779a1810e7beebc8e4e">GetProj</a>().<a class="code" href="class_gr_projection.html#1255da0c4733b6c9b53bb6d7266a6315" title="returns a reference to the matrix.">GetMatrix</a>();
<a name="l00377"></a>00377 
<a name="l00379"></a>00379         <a class="code" href="class_gr_shader.html" title="Purpose: To load and manage a shader.">GrShader</a>* curShader = 0;
<a name="l00380"></a>00380         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> startObj = 0;
<a name="l00381"></a>00381         <span class="keywordflow">while</span> ( startObj &lt; shadowCasters.<a class="code" href="class_gr_render_list.html#eb7629d3dfeedc0b4506fe89805626ca" title="renderable accessors.">GetItemCount</a>() )
<a name="l00382"></a>00382         {
<a name="l00384"></a>00384                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> endObj = 0;
<a name="l00385"></a>00385                 <span class="keyword">const</span> <a class="code" href="class_gr_material.html" title="class GrMaterial">GrMaterial</a>* material = GetShadowSpan( endObj, shadowCasters, startObj );
<a name="l00386"></a>00386 
<a name="l00388"></a>00388                 <span class="keywordflow">if</span> ( !material-&gt;<a class="code" href="class_gr_material.html#9f2498b4265e1c59a1abdaf03792b23a">CastShadow</a>() &amp;&amp; honorCastShadow )
<a name="l00389"></a>00389                 {
<a name="l00390"></a>00390                         startObj = endObj;
<a name="l00391"></a>00391                         <span class="keywordflow">continue</span>;
<a name="l00392"></a>00392                 }
<a name="l00393"></a>00393 
<a name="l00395"></a>00395                 <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> passCount = material-&gt;<a class="code" href="class_gr_material.html#c5afd8886b80a26cb67430eb48ba8bf7" title="returns the number of passes needed.">GetPassCount</a>();
<a name="l00396"></a>00396                 <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pass = 0; pass &lt; passCount; ++pass )
<a name="l00397"></a>00397                 {
<a name="l00399"></a>00399                         <span class="keyword">const</span> <a class="code" href="class_gr_material_pass.html" title="class GrMaterialPass">GrMaterialPass</a>* curPass = material-&gt;<a class="code" href="class_gr_material.html#d1d9f753c4b3875f7d2b361bcf8cf99a">GetPass</a>( pass );
<a name="l00400"></a>00400 
<a name="l00402"></a>00402                         <span class="keywordflow">if</span> ( !curPass-&gt;<a class="code" href="class_gr_material_pass.html#c968cf3eafd243fa2de5ffaf3e3d2981">CastShadow</a>() &amp;&amp; honorCastShadow )
<a name="l00403"></a>00403                                 <span class="keywordflow">continue</span>;
<a name="l00404"></a>00404 
<a name="l00406"></a>00406                         curPass-&gt;<a class="code" href="class_gr_material_pass.html#272b822ee696efb7e967a9565cd79a97">ApplyStates</a>( <a class="code" href="_gr_util_8h.html#20b24dfbb3798202873d51b43f75082d">GR_ALPHATEST</a> | <a class="code" href="_gr_util_8h.html#43f8fbc0073e1858f6bba0a73acfe8a6">GR_CULLFACE</a>, <a class="code" href="_gr_util_8h.html#263ecb0b6dc90d2aca7b9291d81a7024">GR_DEPTH</a> );
<a name="l00407"></a>00407 
<a name="l00409"></a>00409                         <span class="keywordtype">bool</span> alphaTest = curPass-&gt;<a class="code" href="class_gr_material_pass.html#854289ca69d0efcfe29047c80c25fd3d" title="texgen flags enable/disable.">AlphaTest</a>();
<a name="l00410"></a>00410                         <span class="keywordflow">if</span> ( alphaTest )
<a name="l00411"></a>00411                         {
<a name="l00412"></a>00412                                 <span class="keywordflow">if</span> ( !alphaTestShader )
<a name="l00413"></a>00413                                 {
<a name="l00414"></a>00414                                         <span class="keywordflow">continue</span>;
<a name="l00415"></a>00415                                 }
<a name="l00416"></a>00416 
<a name="l00417"></a>00417                                 <span class="keywordflow">if</span> ( curShader != alphaTestShader )
<a name="l00418"></a>00418                                 {
<a name="l00419"></a>00419                                         alphaTestShader-&gt;<a class="code" href="class_gr_shader.html#f32a4e5288174733e6460afac22c21c3" title="make the shader current.">Bind</a>( quality );
<a name="l00420"></a>00420                                         curShader = alphaTestShader;
<a name="l00421"></a>00421                                 }
<a name="l00422"></a>00422 
<a name="l00423"></a>00423 <span class="preprocessor">#if GR_OPTION_ALPHATEST_COLOR_WRITE</span>
<a name="l00425"></a>00425 <span class="preprocessor">                                GrSetWriteEnable( writeMask | GR_RGBA );</span>
<a name="l00426"></a>00426 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00427"></a>00427 <span class="preprocessor"></span>
<a name="l00429"></a>00429                                 curPass-&gt;<a class="code" href="class_gr_material_pass.html#d4fe8b412fb170dcf48688ba424c7d18">GetTextureSet</a>().<a class="code" href="class_gr_texture_set.html#974058b8d0d8f04b85807f52ae857a63">ApplyGlobalState</a>( alphaTestShader );
<a name="l00430"></a>00430                                 curPass-&gt;<a class="code" href="class_gr_material_pass.html#d4fe8b412fb170dcf48688ba424c7d18">GetTextureSet</a>().<a class="code" href="class_gr_texture_set.html#e3e1bfc4506ef8333d5ef947f8d7b391">ApplyStageState</a>( <a class="code" href="_gr_config_8h.html#6df36e6af6bdeed00ff250f968160688b1b35286c474a867806a21cea61952b5">ES_BUMP</a>, <a class="code" href="_gr_config_8h.html#4efb41e353cc885eb72be8fb688fc5d4">GR_TEX_BUMP</a>, curShader, <a class="code" href="class_gr_shader.html#2f004c603bb97711d05eb68381a5a7ba3f52eed666dad2ab377a721dec7d48c2">GrShader::EP_BUMP_MOD</a>, <a class="code" href="class_gr_shader.html#2f004c603bb97711d05eb68381a5a7baca21fbc32f19ff7f96d197e91fa8241f">GrShader::EP_BUMP_ADD</a> );
<a name="l00431"></a>00431                                 curPass-&gt;<a class="code" href="class_gr_material_pass.html#d4fe8b412fb170dcf48688ba424c7d18">GetTextureSet</a>().<a class="code" href="class_gr_texture_set.html#e3e1bfc4506ef8333d5ef947f8d7b391">ApplyStageState</a>( <a class="code" href="_gr_config_8h.html#6df36e6af6bdeed00ff250f9681606884a3d034db25df349c89094e48978258d">ES_DIFFUSE</a>, <a class="code" href="_gr_config_8h.html#414a361b34dcaaf2c98e12af6d40752c">GR_TEX_DIFFUSE</a>, curShader, <a class="code" href="class_gr_shader.html#2f004c603bb97711d05eb68381a5a7babd45973b924f00252c2b0119fe5b3fe5">GrShader::EP_DIFFUSE_MOD</a>, <a class="code" href="class_gr_shader.html#2f004c603bb97711d05eb68381a5a7ba2a9f47816bdefe2925a532af749de481">GrShader::EP_DIFFUSE_ADD</a> );
<a name="l00432"></a>00432                         }
<a name="l00433"></a>00433                         <span class="keywordflow">else</span>
<a name="l00434"></a>00434                         {
<a name="l00435"></a>00435                                 <span class="keywordflow">if</span> ( curShader != depthShader )
<a name="l00436"></a>00436                                 {
<a name="l00437"></a>00437                                         depthShader-&gt;<a class="code" href="class_gr_shader.html#f32a4e5288174733e6460afac22c21c3" title="make the shader current.">Bind</a>( quality );
<a name="l00438"></a>00438                                         curShader = depthShader;
<a name="l00439"></a>00439                                 }
<a name="l00440"></a>00440 
<a name="l00441"></a>00441 <span class="preprocessor">#if GR_OPTION_ALPHATEST_COLOR_WRITE</span>
<a name="l00444"></a>00444 <span class="preprocessor">                                GrSetWriteEnable( writeMask );</span>
<a name="l00445"></a>00445 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00446"></a>00446 <span class="preprocessor"></span>                        }
<a name="l00447"></a>00447 
<a name="l00448"></a>00448                         RenderObjects( shadowCasters, startObj, endObj, shadowCamera, curShader, time, alphaTest );
<a name="l00449"></a>00449 
<a name="l00453"></a>00453                         <span class="keywordflow">if</span> ( !alphaTest )
<a name="l00454"></a>00454                                 <span class="keywordflow">break</span>;
<a name="l00455"></a>00455                 }
<a name="l00456"></a>00456 
<a name="l00458"></a>00458                 startObj = endObj;
<a name="l00459"></a>00459         }
<a name="l00460"></a>00460 }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462 <span class="comment">//----------------------------------------------------------</span>
<a name="l00463"></a>00463 <span class="keywordtype">void</span>
<a name="l00464"></a>00464 GrRenderShadow::RenderObjects( <span class="keyword">const</span> <a class="code" href="class_gr_render_list.html" title="class GrRenderList">GrRenderList</a>&amp; shadowCasters, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="_g_l_8h.html#c55adc720a3098c1b454d2a4647f4361">start</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="_g_l_8h.html#432111147038972f06e049e18a837002">end</a>,
<a name="l00465"></a>00465                                                            <span class="keyword">const</span> <a class="code" href="class_gr_camera.html" title="class GrCamera">GrCamera</a>&amp; shadowCamera, <a class="code" href="class_gr_shader.html" title="Purpose: To load and manage a shader.">GrShader</a>* curShader, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> time, <span class="keywordtype">bool</span> alphaTest )
<a name="l00466"></a>00466 {
<a name="l00469"></a>00469         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="glext_8h.html#0c0d4701a6c89f4f7f0640715d27ab26">obj</a> = start; <a class="code" href="glext_8h.html#0c0d4701a6c89f4f7f0640715d27ab26">obj</a> &lt; end; ++<a class="code" href="glext_8h.html#0c0d4701a6c89f4f7f0640715d27ab26">obj</a> )
<a name="l00470"></a>00470         {
<a name="l00472"></a>00472                 <span class="keyword">const</span> <a class="code" href="struct_gr_render_list_1_1_s_item.html">GrRenderList::SItem</a>&amp; renderable = shadowCasters[ <a class="code" href="glext_8h.html#0c0d4701a6c89f4f7f0640715d27ab26">obj</a> ];
<a name="l00473"></a>00473                 <span class="keywordflow">if</span> ( renderable.<a class="code" href="struct_gr_render_list_1_1_s_item.html#2e41f93266e69ba59b799dbfebea3575">preTransformed</a> )
<a name="l00474"></a>00474                 {
<a name="l00476"></a>00476                         <span class="keywordflow">if</span> ( alphaTest )
<a name="l00477"></a>00477                                 curShader-&gt;<a class="code" href="class_gr_shader.html#151b6e0ff7c3e9fa37c5bc2498e752fe" title="renderer driven params.">SetEngineParam4fv</a>( <a class="code" href="class_gr_shader.html#2f004c603bb97711d05eb68381a5a7ba5fb8b055e849e72981bbccd2019bdcd8">GrShader::EP_LOCAL_VIEW_POSITION</a>, shadowCamera.<a class="code" href="class_gr_camera.html#8cda9065741c39d298fe54d5ef0c3705" title="camera info accessors.">GetPos</a>() );
<a name="l00478"></a>00478 
<a name="l00480"></a>00480                         curShader-&gt;<a class="code" href="class_gr_shader.html#c054492b117be764f4fd2440b7bd1020">SetEngineParam4x4fv</a>( <a class="code" href="class_gr_shader.html#2f004c603bb97711d05eb68381a5a7ba30e37abd2fd8b590c15664405e826b85" title="vertex params.">GrShader::EP_MODEL_VIEW_PROJECTION_MATRIX</a>, shadowCamera.<a class="code" href="class_gr_camera.html#a9a8ab5d4d339a769d58e0fa4f1bc823">GetViewProjMatrix</a>() );
<a name="l00481"></a>00481                         <span class="keywordflow">if</span> ( renderable.<a class="code" href="struct_gr_render_list_1_1_s_item.html#d6ed05f00aea8fb71dfae70328e77bb8">meshInst</a>-&gt;<a class="code" href="class_gr_mesh_inst.html#afe9b877585d9b86d1f464595b65e91c">GetMesh</a>()-&gt;<a class="code" href="class_gr_mesh.html#fab649dd273299791c3813c96224ae75">GetRange</a>( renderable.<a class="code" href="struct_gr_render_list_1_1_s_item.html#4585412be0e3084c369d507382bbe941">range</a> ).count &lt; _maxIndexBatchSize )
<a name="l00482"></a>00482                                 <a class="code" href="glext_8h.html#0c0d4701a6c89f4f7f0640715d27ab26">obj</a> = BatchRender( shadowCasters, <a class="code" href="glext_8h.html#0c0d4701a6c89f4f7f0640715d27ab26">obj</a>, end, time, <a class="code" href="_gr_render_shadow_8cpp.html#a31fd311bf7d2f2a23f8655fdccdef60" title="class header.">SHADOW_VERTEX_COMPONENTS_ALPHA</a> );
<a name="l00483"></a>00483                         <span class="keywordflow">else</span>
<a name="l00484"></a>00484                                 renderable.<a class="code" href="struct_gr_render_list_1_1_s_item.html#d6ed05f00aea8fb71dfae70328e77bb8">meshInst</a>-&gt;<a class="code" href="class_gr_mesh_inst.html#ca05d2e8e1fbaecd7902301797a1586b" title="render.">RenderRange</a>( renderable.<a class="code" href="struct_gr_render_list_1_1_s_item.html#4585412be0e3084c369d507382bbe941">range</a>, <a class="code" href="_gr_render_shadow_8cpp.html#a31fd311bf7d2f2a23f8655fdccdef60" title="class header.">SHADOW_VERTEX_COMPONENTS_ALPHA</a>, time );
<a name="l00485"></a>00485                 }
<a name="l00486"></a>00486                 <span class="keywordflow">else</span>
<a name="l00487"></a>00487                 {
<a name="l00489"></a>00489                         <span class="keyword">const</span> <a class="code" href="class_m_mat4x4.html" title="class MMat4x4">MMat4x4</a>&amp; world = renderable.<a class="code" href="struct_gr_render_list_1_1_s_item.html#d6ed05f00aea8fb71dfae70328e77bb8">meshInst</a>-&gt;<a class="code" href="class_gr_mesh_inst.html#bc956297c8b4dc6cae1e16f04f949bf6">GetTransform</a>();
<a name="l00490"></a>00490 
<a name="l00492"></a>00492                         <span class="keyword">const</span> <a class="code" href="class_m_mat4x4.html" title="class MMat4x4">MMat4x4</a>&amp; invWorld = renderable.<a class="code" href="struct_gr_render_list_1_1_s_item.html#d6ed05f00aea8fb71dfae70328e77bb8">meshInst</a>-&gt;<a class="code" href="class_gr_mesh_inst.html#34b8224971a8f2756d1eadb4af5e9124">GetInvTransform</a>();
<a name="l00493"></a>00493                         <span class="keywordflow">if</span> ( alphaTest )
<a name="l00494"></a>00494                         {
<a name="l00495"></a>00495                                 <a class="code" href="class_m_vec3.html" title="class MVec3">MVec3</a> localEyePos = invWorld.<a class="code" href="class_m_mat4x4.html#385cd0e1af4a803cfb38860de8195572">TransformCoord</a>( shadowCamera.<a class="code" href="class_gr_camera.html#8cda9065741c39d298fe54d5ef0c3705" title="camera info accessors.">GetPos</a>() );
<a name="l00496"></a>00496                                 curShader-&gt;<a class="code" href="class_gr_shader.html#151b6e0ff7c3e9fa37c5bc2498e752fe" title="renderer driven params.">SetEngineParam4fv</a>( <a class="code" href="class_gr_shader.html#2f004c603bb97711d05eb68381a5a7ba5fb8b055e849e72981bbccd2019bdcd8">GrShader::EP_LOCAL_VIEW_POSITION</a>, localEyePos );
<a name="l00497"></a>00497                         }
<a name="l00498"></a>00498 
<a name="l00500"></a>00500                         curShader-&gt;<a class="code" href="class_gr_shader.html#c054492b117be764f4fd2440b7bd1020">SetEngineParam4x4fv</a>( <a class="code" href="class_gr_shader.html#2f004c603bb97711d05eb68381a5a7ba30e37abd2fd8b590c15664405e826b85" title="vertex params.">GrShader::EP_MODEL_VIEW_PROJECTION_MATRIX</a>, shadowCamera.<a class="code" href="class_gr_camera.html#a9a8ab5d4d339a769d58e0fa4f1bc823">GetViewProjMatrix</a>() * world );
<a name="l00501"></a>00501                         renderable.<a class="code" href="struct_gr_render_list_1_1_s_item.html#d6ed05f00aea8fb71dfae70328e77bb8">meshInst</a>-&gt;<a class="code" href="class_gr_mesh_inst.html#ca05d2e8e1fbaecd7902301797a1586b" title="render.">RenderRange</a>( renderable.<a class="code" href="struct_gr_render_list_1_1_s_item.html#4585412be0e3084c369d507382bbe941">range</a>, <a class="code" href="_gr_render_shadow_8cpp.html#a31fd311bf7d2f2a23f8655fdccdef60" title="class header.">SHADOW_VERTEX_COMPONENTS_ALPHA</a>, time );
<a name="l00502"></a>00502                 }
<a name="l00503"></a>00503         }
<a name="l00504"></a>00504 }
<a name="l00505"></a>00505 
<a name="l00506"></a>00506 <span class="comment">//----------------------------------------------------------</span>
<a name="l00507"></a>00507 <span class="keywordtype">void</span>
<a name="l00508"></a>00508 GrRenderShadow::CalcShadowMidpoint( <a class="code" href="enums_8h.html#697c1ee1354746841860d5bf9f81c033" title="standard quality enum">EGRQUALITY</a> quality )
<a name="l00509"></a>00509 {
<a name="l00511"></a>00511         _mergeDepth-&gt;Bind( quality );
<a name="l00512"></a>00512         _shadowCasterPage-&gt;GetDepthTex()-&gt;Bind( <a class="code" href="_gr_render_shadow_8cpp.html#5cb8fd999cebc545d56ad018b6115ec0">DEPTH_MERGE_SAMPLER_LAYER0</a> );
<a name="l00513"></a>00513         _shadowReceiverPage-&gt;GetDepthTex()-&gt;Bind( <a class="code" href="_gr_render_shadow_8cpp.html#ee75da902e20dca67408a3c226c02ad3">DEPTH_MERGE_SAMPLER_LAYER1</a> );
<a name="l00514"></a>00514 
<a name="l00516"></a>00516         <a class="code" href="_gr_render_util_8cpp.html#fb34712df0783f1147102607ffa75997" title="singleton pointer.">gGrRenderUtil</a>-&gt;<a class="code" href="class_gr_render_util.html#7927ea8c2c13526dc291ad0812a8da46" title="drawing functions that submit positions and UVs.">DrawScreenQuad</a>();
<a name="l00517"></a>00517 <span class="comment">//      GrDrawScreenQuad( GR_ATTRIB_TEXCOORD_INDEX );</span>
<a name="l00518"></a>00518 }
<a name="l00519"></a>00519 
<a name="l00520"></a>00520 <span class="comment">//----------------------------------------------------------</span>
<a name="l00521"></a>00521 <span class="keyword">const</span> <a class="code" href="class_gr_material.html" title="class GrMaterial">GrMaterial</a>*
<a name="l00522"></a>00522 GrRenderShadow::GetShadowSpan( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>&amp; spanEnd, <span class="keyword">const</span> <a class="code" href="class_gr_render_list.html" title="class GrRenderList">GrRenderList</a>&amp; list, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> startObj )
<a name="l00523"></a>00523 {
<a name="l00526"></a>00526         <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( startObj &lt; list.<a class="code" href="class_gr_render_list.html#eb7629d3dfeedc0b4506fe89805626ca" title="renderable accessors.">GetItemCount</a>() );
<a name="l00527"></a>00527         <span class="keyword">const</span> <a class="code" href="class_gr_material.html" title="class GrMaterial">GrMaterial</a>* curMaterial = list[ startObj ].meshInst-&gt;GetMaterial( list[ startObj ].<a class="code" href="glext_8h.html#7b8ad0b27a927682837f95528fa454f5">range</a> );
<a name="l00528"></a>00528         spanEnd = startObj+1;
<a name="l00529"></a>00529         <span class="keywordflow">while</span> ( spanEnd &lt; list.<a class="code" href="class_gr_render_list.html#eb7629d3dfeedc0b4506fe89805626ca" title="renderable accessors.">GetItemCount</a>() )
<a name="l00530"></a>00530         {
<a name="l00531"></a>00531                 <span class="keyword">const</span> <a class="code" href="class_gr_material.html" title="class GrMaterial">GrMaterial</a>* material2 = list[ spanEnd ].meshInst-&gt;GetMaterial( list[ spanEnd ].range );
<a name="l00532"></a>00532                 <span class="keywordflow">if</span> ( !IsCompatibleShadow( curMaterial, material2 ) )
<a name="l00533"></a>00533                         <span class="keywordflow">break</span>;
<a name="l00534"></a>00534                 <span class="keywordflow">else</span>
<a name="l00535"></a>00535                         curMaterial = material2;
<a name="l00536"></a>00536                 ++spanEnd;
<a name="l00537"></a>00537         }
<a name="l00538"></a>00538         <span class="keywordflow">return</span> curMaterial;
<a name="l00539"></a>00539 }
<a name="l00540"></a>00540 
<a name="l00541"></a>00541 <span class="comment">//----------------------------------------------------------</span>
<a name="l00542"></a>00542 <span class="keywordtype">bool</span>
<a name="l00543"></a>00543 GrRenderShadow::IsCompatibleShadow( <span class="keyword">const</span> <a class="code" href="class_gr_material.html" title="class GrMaterial">GrMaterial</a>* material1, <span class="keyword">const</span> <a class="code" href="class_gr_material.html" title="class GrMaterial">GrMaterial</a>* material2 )
<a name="l00544"></a>00544 {
<a name="l00546"></a>00546         <span class="keywordflow">if</span> ( material1 == material2 )
<a name="l00547"></a>00547                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00548"></a>00548 
<a name="l00550"></a>00550         <span class="keywordflow">return</span> material1-&gt;<a class="code" href="class_gr_material.html#25a173f7ea53817987aca0ff8924112a" title="return true if all of the material&amp;#39;s passes have the property.">AlphaTest</a>() == material2-&gt;<a class="code" href="class_gr_material.html#25a173f7ea53817987aca0ff8924112a" title="return true if all of the material&amp;#39;s passes have the property.">AlphaTest</a>() &amp;&amp; material1-&gt;<a class="code" href="class_gr_material.html#9f2498b4265e1c59a1abdaf03792b23a">CastShadow</a>() == material2-&gt;<a class="code" href="class_gr_material.html#9f2498b4265e1c59a1abdaf03792b23a">CastShadow</a>();
<a name="l00551"></a>00551 }
<a name="l00552"></a>00552 
<a name="l00553"></a>00553 <span class="comment">//----------------------------------------------------------</span>
<a name="l00554"></a>00554 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>
<a name="l00555"></a>00555 GrRenderShadow::BatchRender( <span class="keyword">const</span> <a class="code" href="class_gr_render_list.html" title="class GrRenderList">GrRenderList</a>&amp; renderableArray, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> startIdx, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> endIdx, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> time,
<a name="l00556"></a>00556                                                          <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> vertexComponents )
<a name="l00557"></a>00557 {
<a name="l00560"></a>00560         <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( renderableArray[ startIdx ].preTransformed );
<a name="l00561"></a>00561         <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( renderableArray[ startIdx ].meshInst-&gt;GetSkinInst() == 0 );
<a name="l00562"></a>00562         <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( renderableArray[ startIdx ].meshInst-&gt;GetMesh()-&gt;GetIndexData() != 0 );
<a name="l00563"></a>00563 
<a name="l00565"></a>00565         <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( renderableArray[ startIdx ].meshInst-&gt;GetMesh()-&gt;GetRange( renderableArray[ startIdx ].range ).count &lt; _maxIndexBatchSize )
<a name="l00566"></a>00566 
<a name="l00568"></a>00568         <a class="code" href="class_u_ref.html">URef&lt; GrMesh &gt;</a> mesh = renderableArray[ startIdx ].meshInst-&gt;GetMesh();
<a name="l00569"></a>00569         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> minIndex = 0xFFFF;
<a name="l00570"></a>00570         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxIndex = 0;
<a name="l00571"></a>00571         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="_g_l_8h.html#10b284d589000663becfbc6867a3a9f7">count</a> = 0;
<a name="l00572"></a>00572 
<a name="l00574"></a>00574         _streamingIB-&gt;<a class="code" href="class_gr_streaming_i_b.html#a01b21e6d8ca9f23938fe4c6a02ba11e" title="binds the buffer for use with rendering.">Bind</a>();
<a name="l00575"></a>00575         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="glext_8h.html#a782f3aea23e3c30029c811241dc2c82">offset</a> = _streamingIB-&gt;<a class="code" href="class_gr_streaming_i_b.html#6ebe51c20516af70e2beb954a402d7c2">GetOffset</a>();
<a name="l00576"></a>00576 
<a name="l00579"></a>00579         <span class="keywordflow">do</span>
<a name="l00580"></a>00580         {
<a name="l00582"></a>00582                 <span class="keyword">const</span> <a class="code" href="struct_gr_render_list_1_1_s_item.html">GrRenderList::SItem</a>&amp; curRenderable = renderableArray[ startIdx ];
<a name="l00583"></a>00583 
<a name="l00585"></a>00585                 <span class="keywordflow">if</span> ( ( count + mesh-&gt;GetRange( curRenderable.<a class="code" href="struct_gr_render_list_1_1_s_item.html#4585412be0e3084c369d507382bbe941">range</a> ).count ) &gt; _maxIndexBatchSize )
<a name="l00586"></a>00586                         <span class="keywordflow">break</span>;
<a name="l00587"></a>00587 
<a name="l00589"></a>00589                 count += curRenderable.<a class="code" href="struct_gr_render_list_1_1_s_item.html#d6ed05f00aea8fb71dfae70328e77bb8">meshInst</a>-&gt;<a class="code" href="class_gr_mesh_inst.html#cc009c82642378bb9e6640fe329b0584" title="note that this is only usable if the transform is identity.">BatchRange</a>( *_streamingIB, curRenderable.<a class="code" href="struct_gr_render_list_1_1_s_item.html#4585412be0e3084c369d507382bbe941">range</a>, time );
<a name="l00590"></a>00590 
<a name="l00592"></a>00592                 minIndex = <a class="code" href="common__afx_8h.html#0296e17691267defafdfde06589f50d5">Min</a>( mesh-&gt;GetRange( curRenderable.<a class="code" href="struct_gr_render_list_1_1_s_item.html#4585412be0e3084c369d507382bbe941">range</a> ).minIndex, minIndex );
<a name="l00593"></a>00593                 maxIndex = <a class="code" href="common__afx_8h.html#dd09d155ffe827b203d3236b451752e7">Max</a>( mesh-&gt;GetRange( curRenderable.<a class="code" href="struct_gr_render_list_1_1_s_item.html#4585412be0e3084c369d507382bbe941">range</a> ).maxIndex, maxIndex );
<a name="l00594"></a>00594 
<a name="l00596"></a>00596                 ++startIdx;
<a name="l00597"></a>00597         }
<a name="l00598"></a>00598         <span class="keywordflow">while</span> (
<a name="l00599"></a>00599                 startIdx &lt; endIdx &amp;&amp;
<a name="l00600"></a>00600                 renderableArray[ startIdx ].preTransformed &amp;&amp;
<a name="l00601"></a>00601                 renderableArray[ startIdx ].meshInst-&gt;GetMesh() == mesh
<a name="l00602"></a>00602                 );
<a name="l00603"></a>00603 
<a name="l00605"></a>00605         <a class="code" href="_g_l_subsys_8h.html#ab12f88c1ad74a5b4876f37fcf105bda">CHECK_GL</a>();
<a name="l00606"></a>00606 
<a name="l00608"></a>00608         mesh-&gt;GetVertexData()-&gt;Bind( vertexComponents );
<a name="l00609"></a>00609         <a class="code" href="_g_l_subsys_8h.html#ab12f88c1ad74a5b4876f37fcf105bda">CHECK_GL</a>();
<a name="l00610"></a>00610 
<a name="l00612"></a>00612         <a class="code" href="_g_l_subsys_8cpp.html#423585e9e2816753618fa813f15475bf">bglDrawRangeElements</a>( 
<a name="l00613"></a>00613                 <a class="code" href="_g_l_8h.html#6079e7a02a59adad65eb953d9482b1ed">GL_TRIANGLES</a>,
<a name="l00614"></a>00614                 minIndex,
<a name="l00615"></a>00615                 maxIndex,
<a name="l00616"></a>00616                 count,
<a name="l00617"></a>00617                 <a class="code" href="_g_l_8h.html#36c3f955599ab92217a70cce8a22e11f">GL_UNSIGNED_SHORT</a>,
<a name="l00618"></a>00618                 ( ( <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>* )0 ) + offset );
<a name="l00619"></a>00619         <a class="code" href="_g_l_subsys_8h.html#ab12f88c1ad74a5b4876f37fcf105bda">CHECK_GL</a>();
<a name="l00620"></a>00620 
<a name="l00622"></a>00622         <span class="keywordflow">return</span> startIdx-1;
<a name="l00623"></a>00623 }
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Fri Feb 13 17:19:58 2009 for Bootstrap Engine by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
