<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Bootstrap Engine: C:/Bootstrap/ProjectBX/Documentation/Code/Engine/Graphics/GrModel.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>C:/Bootstrap/ProjectBX/Documentation/Code/Engine/Graphics/GrModel.cpp</h1><a href="_gr_model_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//----------------------------------------------------------</span>
<a name="l00006"></a>00006 <span class="comment"></span><span class="comment">//----------------------------------------------------------</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include "<a class="code" href="graphics__afx_8h.html">graphics_afx.h</a>"</span>
<a name="l00008"></a>00008 
<a name="l00010"></a>00010 <span class="preprocessor">#include "<a class="code" href="_gr_model_8h.html">GrModel.h</a>"</span>
<a name="l00011"></a>00011 
<a name="l00013"></a>00013 <span class="preprocessor">#include "<a class="code" href="_gr_model_node_8h.html">GrModelNode.h</a>"</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include "<a class="code" href="_gr_light_8h.html">GrLight.h</a>"</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include "<a class="code" href="_gr_mesh_inst_8h.html">GrMeshInst.h</a>"</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include "<a class="code" href="_gr_frustum_8h.html">GrFrustum.h</a>"</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include "<a class="code" href="_gr_polygon_node_8h.html">GrPolygonNode.h</a>"</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include "<a class="code" href="_gr_polygon_mesh_8h.html">GrPolygonMesh.h</a>"</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include "<a class="code" href="_gr_anim_player_8h.html">GrAnimPlayer.h</a>"</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include "<a class="code" href="_gr_scene_traverser_8h.html">GrSceneTraverser.h</a>"</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include "<a class="code" href="_gr_k_f_anim_8h.html">GrKFAnim.h</a>"</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include "<a class="code" href="_gr_k_f_anim_mgr_8h.html">GrKFAnimMgr.h</a>"</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include "<a class="code" href="_u_reader_8h.html">UReader.h</a>"</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include "<a class="code" href="_u_writer_8h.html">UWriter.h</a>"</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include "<a class="code" href="_gr_scene_8h.html">GrScene.h</a>"</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include "<a class="code" href="_gr_skin_8h.html">GrSkin.h</a>"</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include "<a class="code" href="_gr_model_skin_controller_8h.html">GrModelSkinController.h</a>"</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include "<a class="code" href="_gr_render_list_8h.html">GrRenderList.h</a>"</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include "<a class="code" href="_gr_model_mgr_8h.html">GrModelMgr.h</a>"</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include "<a class="code" href="_gr_light_mgr_8h.html">GrLightMgr.h</a>"</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include "<a class="code" href="_g_l_subsys_8h.html">GLSubsys.h</a>"</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include "<a class="code" href="_r_file_mgr_8h.html">RFileMgr.h</a>"</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include "<a class="code" href="_r_file_8h.html">RFile.h</a>"</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include "<a class="code" href="_m_ray_8h.html">MRay.h</a>"</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include "<a class="code" href="_gr_mesh_v_b_8h.html">GrMeshVB.h</a>"</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include "<a class="code" href="_gr_mesh_i_b_8h.html">GrMeshIB.h</a>"</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include "<a class="code" href="_gr_util_8h.html">GrUtil.h</a>"</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <a class="code" href="class_gr_model.html" title="class GrModel">GrModel</a>*
<a name="l00040"></a>00040 GrModel::_rootModel = 0;
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="comment">//**********************************************************</span>
<a name="l00044"></a>00044 <span class="comment"></span><span class="comment">//**********************************************************</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="comment">//==========================================================</span>
<a name="l00048"></a>00048 <span class="comment"></span><span class="comment">//==========================================================</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="comment">//----------------------------------------------------------</span>
<a name="l00051"></a><a class="code" href="class_gr_model.html#4def572ffb7a4575939f3286d566ac4a">00051</a> <a class="code" href="class_gr_model.html#4def572ffb7a4575939f3286d566ac4a" title="this is a special constructor reserved for use by the scene only.">GrModel::GrModel</a>( <span class="keyword">const</span> <a class="code" href="common__afx_8h.html#816fa58fd77499b0edb2c69ebe803d5c" title="include BootstrapFS.">tstring</a>&amp; <a class="code" href="glext_8h.html#f7477b8725fcf509c9623f64b9d09164">name</a> )
<a name="l00052"></a>00052 : _fileName( <span class="stringliteral">""</span> )
<a name="l00053"></a>00053 , _instName( name )
<a name="l00054"></a>00054 , _parent( 0 )
<a name="l00055"></a>00055 , _parentNode( 0 )
<a name="l00056"></a>00056 , _root( 0 )
<a name="l00057"></a>00057 , _animPlayer( 0 )
<a name="l00058"></a>00058 , _defaultAnim( 0 )
<a name="l00059"></a>00059 , _skinControllers( 0 )
<a name="l00060"></a>00060 , _skinControllerCount( 0 )
<a name="l00061"></a>00061 , _lastVisibleFrameId( ~0 )
<a name="l00062"></a>00062 , _userPtr( 0 )
<a name="l00063"></a>00063 , _dirty( true )
<a name="l00064"></a>00064 , _inScene( true )
<a name="l00065"></a>00065 , _pickable( true )
<a name="l00066"></a>00066 {
<a name="l00068"></a>00068         _rootModel = <span class="keyword">this</span>;
<a name="l00069"></a>00069 
<a name="l00071"></a>00071         _root = <span class="keyword">new</span> <a class="code" href="class_gr_model_node.html" title="class GrModelNode">GrModelNode</a>( <span class="keyword">this</span>, <span class="keyword">new</span> <a class="code" href="class_gr_polygon_node.html" title="class GrPolygonNode">GrPolygonNode</a>( name, <a class="code" href="class_m_mat4x4.html" title="class MMat4x4">MMat4x4</a>() ) );
<a name="l00072"></a>00072 
<a name="l00074"></a>00074         CreateSkinControllers();
<a name="l00075"></a>00075 }
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 <span class="comment">//----------------------------------------------------------</span>
<a name="l00078"></a><a class="code" href="class_gr_model.html#15d52f8774a7781ad079f8bf3604226f">00078</a> <a class="code" href="class_gr_model.html#4def572ffb7a4575939f3286d566ac4a" title="this is a special constructor reserved for use by the scene only.">GrModel::GrModel</a>( <span class="keyword">const</span> <a class="code" href="class_u_path.html" title="Purpose: To provide a clean way to represent paths strings.">UPath</a>&amp; instName, <a class="code" href="class_gr_polygon_node.html" title="class GrPolygonNode">GrPolygonNode</a>* root )
<a name="l00079"></a>00079 : _fileName( <span class="stringliteral">""</span> )
<a name="l00080"></a>00080 , _instName( instName )
<a name="l00081"></a>00081 , _parent( 0 )
<a name="l00082"></a>00082 , _parentNode( 0 )
<a name="l00083"></a>00083 , _root( 0 )
<a name="l00084"></a>00084 , _animPlayer( 0 )
<a name="l00085"></a>00085 , _defaultAnim( 0 )
<a name="l00086"></a>00086 , _skinControllers( 0 )
<a name="l00087"></a>00087 , _skinControllerCount( 0 )
<a name="l00088"></a>00088 , _lastVisibleFrameId( ~0 )
<a name="l00089"></a>00089 , _userPtr( 0 )
<a name="l00090"></a>00090 , _dirty( true )
<a name="l00091"></a>00091 , _inScene( false )
<a name="l00092"></a>00092 , _pickable( true )
<a name="l00093"></a>00093 {
<a name="l00095"></a>00095         _root = <span class="keyword">new</span> <a class="code" href="class_gr_model_node.html" title="class GrModelNode">GrModelNode</a>( <span class="keyword">this</span>, root );
<a name="l00096"></a>00096 
<a name="l00098"></a>00098         CreateSkinControllers();
<a name="l00099"></a>00099 }
<a name="l00100"></a>00100 
<a name="l00101"></a>00101 <span class="comment">//----------------------------------------------------------</span>
<a name="l00102"></a>00102 GrModel::GrModel()
<a name="l00103"></a>00103 : _fileName( <span class="stringliteral">""</span> )
<a name="l00104"></a>00104 , _instName( <span class="stringliteral">""</span> )
<a name="l00105"></a>00105 , _parent( 0 )
<a name="l00106"></a>00106 , _parentNode( 0 )
<a name="l00107"></a>00107 , _root( 0 )
<a name="l00108"></a>00108 , _animPlayer( 0 )
<a name="l00109"></a>00109 , _defaultAnim( 0 )
<a name="l00110"></a>00110 , _skinControllers( 0 )
<a name="l00111"></a>00111 , _skinControllerCount( 0 )
<a name="l00112"></a>00112 , _lastVisibleFrameId( ~0 )
<a name="l00113"></a>00113 , _userPtr( 0 )
<a name="l00114"></a>00114 , _dirty( true )
<a name="l00115"></a>00115 , _inScene( false )
<a name="l00116"></a>00116 , _pickable( true )
<a name="l00117"></a>00117 {
<a name="l00118"></a>00118 
<a name="l00119"></a>00119 }
<a name="l00120"></a>00120 
<a name="l00121"></a>00121 <span class="comment">//----------------------------------------------------------</span>
<a name="l00122"></a><a class="code" href="class_gr_model.html#2cf8487be82f62f575f549e0081435ae">00122</a> <a class="code" href="class_gr_model.html#4def572ffb7a4575939f3286d566ac4a" title="this is a special constructor reserved for use by the scene only.">GrModel::GrModel</a>( <span class="keyword">const</span> <a class="code" href="class_u_path.html" title="Purpose: To provide a clean way to represent paths strings.">UPath</a>&amp; fileName, <span class="keyword">const</span> <a class="code" href="class_u_path.html" title="Purpose: To provide a clean way to represent paths strings.">UPath</a>&amp; instName, <a class="code" href="class_u_reader.html" title="Purpose: To wrap and simplify pointer read operations.">UReader</a>&amp; reader )
<a name="l00123"></a>00123 : _fileName( fileName )
<a name="l00124"></a>00124 , _instName( instName )
<a name="l00125"></a>00125 , _parent( 0 )
<a name="l00126"></a>00126 , _parentNode( 0 )
<a name="l00127"></a>00127 , _root( 0 )
<a name="l00128"></a>00128 , _animPlayer( 0 )
<a name="l00129"></a>00129 , _defaultAnim( 0 )
<a name="l00130"></a>00130 , _skinControllers( 0 )
<a name="l00131"></a>00131 , _skinControllerCount( 0 )
<a name="l00132"></a>00132 , _lastVisibleFrameId( ~0 )
<a name="l00133"></a>00133 , _userPtr( 0 )
<a name="l00134"></a>00134 , _dirty( true )
<a name="l00135"></a>00135 , _inScene( false )
<a name="l00136"></a>00136 , _pickable( true )
<a name="l00137"></a>00137 {
<a name="l00138"></a>00138         Load( fileName, reader );
<a name="l00139"></a>00139 }
<a name="l00140"></a>00140 
<a name="l00141"></a>00141 <span class="comment">//----------------------------------------------------------</span>
<a name="l00142"></a><a class="code" href="class_gr_model.html#e48b47449f463e0b0a7b42943db1310c">00142</a> <a class="code" href="class_gr_model.html#e48b47449f463e0b0a7b42943db1310c">GrModel::~GrModel</a>()
<a name="l00143"></a>00143 {
<a name="l00145"></a>00145         Clean();
<a name="l00146"></a>00146         <span class="keywordflow">if</span> ( <span class="keyword">this</span> == _rootModel )
<a name="l00147"></a>00147                 _rootModel = 0;
<a name="l00148"></a>00148 }
<a name="l00149"></a>00149 
<a name="l00150"></a>00150 
<a name="l00151"></a>00151 <span class="comment">//==========================================================</span>
<a name="l00153"></a>00153 <span class="comment"></span><span class="comment">//==========================================================</span>
<a name="l00154"></a>00154 
<a name="l00155"></a>00155 <span class="comment">//----------------------------------------------------------</span>
<a name="l00156"></a>00156 <a class="code" href="class_gr_model.html" title="class GrModel">GrModel</a>*
<a name="l00157"></a><a class="code" href="class_gr_model.html#29d55ee007063d294ee9097c56d9f453">00157</a> <a class="code" href="class_gr_model.html#29d55ee007063d294ee9097c56d9f453" title="public methods">GrModel::Clone</a>( <span class="keyword">const</span> <a class="code" href="class_u_path.html" title="Purpose: To provide a clean way to represent paths strings.">UPath</a>&amp; instName, <span class="keywordtype">bool</span> deep, <span class="keywordtype">bool</span> lights )<span class="keyword"> const</span>
<a name="l00158"></a>00158 <span class="keyword"></span>{
<a name="l00160"></a>00160         <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( <span class="keyword">this</span> != _rootModel );
<a name="l00161"></a>00161 
<a name="l00163"></a>00163         <a class="code" href="class_gr_model.html" title="class GrModel">GrModel</a>* newModel = <span class="keyword">new</span> <a class="code" href="class_gr_model.html" title="class GrModel">GrModel</a>;
<a name="l00164"></a>00164 
<a name="l00166"></a>00166         newModel-&gt;<a class="code" href="class_gr_model.html#2bbee530883205b04ed7e7ed4aebf2f0">_fileName</a> = _fileName;
<a name="l00167"></a>00167         newModel-&gt;<a class="code" href="class_gr_model.html#313f4b89d4c956c68b8090556d22c5ec" title="file we came from.">_instName</a> = instName;
<a name="l00168"></a>00168         newModel-&gt;<a class="code" href="class_gr_model.html#87ac842e26802753f03123d6c72e0410" title="model name.">_source</a> = _source;
<a name="l00169"></a>00169         newModel-&gt;<a class="code" href="class_gr_model.html#15637caf2d5a5cbe649a008d6ca15d6a" title="imported from.">_author</a> = _author;
<a name="l00170"></a>00170         newModel-&gt;<a class="code" href="class_gr_model.html#084c1aabd4a5abf88d105982de4a8968">_pickable</a> = _pickable;
<a name="l00171"></a>00171 
<a name="l00173"></a>00173         newModel-&gt;<a class="code" href="class_gr_model.html#be10a994eede25f97176fb2094f7481c" title="node we&amp;#39;re attached to in the parent.">_root</a> = _root-&gt;<a class="code" href="class_gr_model_node.html#6bcd4b9a2763671b7bd20a5556aa1a22" title="clones a node hierarchy.">Clone</a>( newModel, deep );
<a name="l00174"></a>00174 
<a name="l00176"></a>00176         <span class="keywordflow">if</span> ( _defaultAnim )
<a name="l00177"></a>00177         {
<a name="l00179"></a>00179                 newModel-&gt;<a class="code" href="class_gr_model.html#60d33d18942cb47f188ad1d48df9a394">_defaultAnim</a> = ( <a class="code" href="class_gr_k_f_anim.html" title="class GrKFAnim">GrKFAnim</a>* )_defaultAnim-&gt;<a class="code" href="class_gr_k_f_anim.html#5392ada1053eff8dcb27fa727e107f79" title="public methods">Clone</a>();
<a name="l00180"></a>00180 
<a name="l00183"></a>00183                 <a class="code" href="class_gr_anim_player.html" title="class GrAnimPlayer">GrAnimPlayer</a>* newAnimPlayer = <span class="keyword">new</span> <a class="code" href="class_gr_anim_player.html" title="class GrAnimPlayer">GrAnimPlayer</a>( newModel );
<a name="l00184"></a>00184                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="keywordtype">id</span> = newAnimPlayer-&gt;<a class="code" href="class_gr_anim_player.html#1207033fa4b66842478bd2d7d30c7925" title="returns the animation mix ID.">AddAnim</a>( <span class="stringliteral">"default"</span>, _defaultAnim );
<a name="l00185"></a>00185                 newAnimPlayer-&gt;<a class="code" href="class_gr_anim_player.html#20592a82ff4bd496988566edd6151c61" title="play, pause, etc.">SetActiveAnim</a>( <span class="keywordtype">id</span> );
<a name="l00186"></a>00186                 newAnimPlayer-&gt;<a class="code" href="class_gr_anim_player.html#8ffa920aacb2bc0682c0b842e7c913a8">Play</a>();
<a name="l00187"></a>00187 
<a name="l00189"></a>00189                 newModel-&gt;<a class="code" href="class_gr_model.html#3c879c25f93e1c77017692e6242cf44b" title="default animation (for ambient animations).">_animPlayer</a> = newAnimPlayer;
<a name="l00190"></a>00190         }
<a name="l00191"></a>00191 
<a name="l00193"></a>00193         <span class="keywordflow">if</span> ( lights )
<a name="l00194"></a>00194         {
<a name="l00195"></a>00195                 <a class="code" href="common__afx_8h.html#816fa58fd77499b0edb2c69ebe803d5c" title="include BootstrapFS.">tstring</a> errors;
<a name="l00196"></a>00196                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lightCount = ( <span class="keywordtype">unsigned</span> <a class="code" href="_g_l_aux_8h.html#b832c174e145540d491b0830fc05dbb1">int</a> )_lights.size();
<a name="l00197"></a>00197                 <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; lightCount; ++i )
<a name="l00198"></a>00198                 {
<a name="l00199"></a>00199                         <span class="keyword">const</span> <a class="code" href="class_u_path.html" title="Purpose: To provide a clean way to represent paths strings.">UPath</a>&amp; originalLightName = _lights[ i ].light-&gt;GetId();
<a name="l00200"></a>00200                         <a class="code" href="class_u_path.html" title="Purpose: To provide a clean way to represent paths strings.">UPath</a> newLightName( originalLightName.<a class="code" href="class_u_path.html#970648bc09145c6da1712022d84ad3b7" title="returns the path string.">GetPathString</a>() + instName.<a class="code" href="class_u_path.html#970648bc09145c6da1712022d84ad3b7" title="returns the path string.">GetPathString</a>() );
<a name="l00201"></a>00201 
<a name="l00203"></a>00203                         <a class="code" href="class_u_ref.html">URef&lt; GrLight &gt;</a> light = <a class="code" href="_gr_light_mgr_8cpp.html#d2e92e9386149b1b99f9d2e6179019f7" title="class header.">gGrLightMgr</a>-&gt;<a class="code" href="class_gr_light_mgr.html#5ea84c63918a70154432b723c9b8cf15" title="clones a light.">GetOrCloneLight</a>( newLightName, originalLightName, errors );
<a name="l00204"></a>00204                         <span class="keywordflow">if</span> ( !light )
<a name="l00205"></a>00205                                 <span class="keywordflow">continue</span>;
<a name="l00206"></a>00206 
<a name="l00208"></a>00208                         <a class="code" href="common__afx_8h.html#816fa58fd77499b0edb2c69ebe803d5c" title="include BootstrapFS.">tstring</a> parentName = _lights[ i ].parent-&gt;GetName();
<a name="l00209"></a>00209                         <a class="code" href="class_gr_model_node.html" title="class GrModelNode">GrModelNode</a>* parent = newModel-&gt;<a class="code" href="class_gr_model.html#be10a994eede25f97176fb2094f7481c" title="node we&amp;#39;re attached to in the parent.">_root</a>-&gt;<a class="code" href="class_gr_model_node.html#ea35f9469b11a8a8033f8ad1c7a54c24">FindNode</a>( parentName.c_str(), false );
<a name="l00210"></a>00210 
<a name="l00212"></a>00212                         newModel-&gt;<a class="code" href="class_gr_model.html#4d7fbb62dd1022da5a5fd25c6cb0e1fc" title="child lights.">AddLight</a>( light, parent );
<a name="l00213"></a>00213                 }
<a name="l00214"></a>00214         }
<a name="l00215"></a>00215 
<a name="l00217"></a>00217         <span class="keywordflow">return</span> newModel;
<a name="l00218"></a>00218 }
<a name="l00219"></a>00219 
<a name="l00220"></a>00220 <span class="comment">//----------------------------------------------------------</span>
<a name="l00221"></a>00221 <a class="code" href="class_gr_model.html" title="class GrModel">GrModel</a>*
<a name="l00222"></a><a class="code" href="class_gr_model.html#fe7a05f880c1d67b55ef8130971836d6">00222</a> <a class="code" href="class_gr_model.html#fe7a05f880c1d67b55ef8130971836d6">GrModel::CloneFile</a>( <span class="keyword">const</span> <a class="code" href="class_u_path.html" title="Purpose: To provide a clean way to represent paths strings.">UPath</a>&amp; fileName, <span class="keyword">const</span> <a class="code" href="class_u_path.html" title="Purpose: To provide a clean way to represent paths strings.">UPath</a>&amp; instName )<span class="keyword"> const</span>
<a name="l00223"></a>00223 <span class="keyword"></span>{
<a name="l00225"></a>00225         <a class="code" href="class_gr_model.html" title="class GrModel">GrModel</a>* model = <a class="code" href="class_gr_model.html#29d55ee007063d294ee9097c56d9f453" title="public methods">Clone</a>( instName, <span class="keyword">true</span>, <span class="keyword">true</span> );
<a name="l00226"></a>00226 
<a name="l00228"></a>00228         model-&gt;<a class="code" href="class_gr_model.html#2bbee530883205b04ed7e7ed4aebf2f0">_fileName</a> = fileName;
<a name="l00229"></a>00229 
<a name="l00231"></a>00231         <a class="code" href="class_u_writer.html" title="Purpose: To wrap and simplify pointer write operations.">UWriter</a> writer;
<a name="l00232"></a>00232         model-&gt;<a class="code" href="class_gr_model.html#94605ad2262faa9e3e858cd2f9b5d9d1" title="load and save the model. This does not save children.">Save</a>( writer );
<a name="l00233"></a>00233 
<a name="l00235"></a>00235         <a class="code" href="class_u_ref.html">URef&lt; RFile &gt;</a> file = <a class="code" href="_r_file_mgr_8cpp.html#b27cd6d5cc5b23b502509e7fdab9c32e">gRFileMgr</a>-&gt;<a class="code" href="class_r_file_mgr.html#d7f101aeebcb703282cfcb6c8eba67f9" title="get a file.">GetFile</a>( fileName, <a class="code" href="class_r_file_mgr.html#d50cfef45d5e20a1de1abc17c0691067">RFileMgr::kFlagWrite</a> );
<a name="l00236"></a>00236         <span class="keywordflow">if</span> ( !file )
<a name="l00237"></a>00237         {
<a name="l00239"></a>00239                 <span class="keyword">delete</span> model;
<a name="l00240"></a>00240                 <span class="keywordflow">return</span> 0;
<a name="l00241"></a>00241         }
<a name="l00242"></a>00242 
<a name="l00244"></a>00244         file-&gt;WriteData( 0, writer.<a class="code" href="class_u_writer.html#9bd5aca0223d14eea6a715449e613300">GetBufferPtr</a>(), writer.<a class="code" href="class_u_writer.html#362bb4a3c111c793e22927a6b26afe0c">GetBytesWritten</a>() );
<a name="l00245"></a>00245 
<a name="l00247"></a>00247         <a class="code" href="_gr_model_mgr_8cpp.html#fbcece7dd2c93af667a693fcaead872a">gGrModelMgr</a>-&gt;<a class="code" href="class_gr_model_mgr.html#17714eeebe02b7db342aa4d28efbc4d9">AddModel</a>( model );
<a name="l00248"></a>00248 
<a name="l00250"></a>00250         <span class="keywordflow">return</span> model;
<a name="l00251"></a>00251 }
<a name="l00252"></a>00252 
<a name="l00253"></a>00253 <span class="comment">//----------------------------------------------------------</span>
<a name="l00254"></a>00254 <a class="code" href="class_gr_anim_player.html" title="class GrAnimPlayer">GrAnimPlayer</a>*
<a name="l00255"></a><a class="code" href="class_gr_model.html#1d20cf8034ee3a0bd2fe1506fe81f73d">00255</a> <a class="code" href="class_gr_model.html#1759e9f0d11efd39892411dc80fd3312">GrModel::GetAnimPlayer</a>( <span class="keywordtype">bool</span> create )
<a name="l00256"></a>00256 {
<a name="l00257"></a>00257         <span class="keywordflow">if</span> ( create &amp;&amp; !_animPlayer )
<a name="l00258"></a>00258                 _animPlayer = <span class="keyword">new</span> <a class="code" href="class_gr_anim_player.html" title="class GrAnimPlayer">GrAnimPlayer</a>( <span class="keyword">this</span> );
<a name="l00259"></a>00259         <span class="keywordflow">return</span> _animPlayer;
<a name="l00260"></a>00260 }
<a name="l00261"></a>00261 
<a name="l00262"></a>00262 <span class="comment">//----------------------------------------------------------</span>
<a name="l00263"></a>00263 <a class="code" href="class_gr_anim_player.html" title="class GrAnimPlayer">GrAnimPlayer</a>*
<a name="l00264"></a><a class="code" href="class_gr_model.html#1759e9f0d11efd39892411dc80fd3312">00264</a> <a class="code" href="class_gr_model.html#1759e9f0d11efd39892411dc80fd3312">GrModel::GetAnimPlayer</a>()<span class="keyword"> const</span>
<a name="l00265"></a>00265 <span class="keyword"></span>{
<a name="l00266"></a>00266         <span class="keywordflow">return</span> _animPlayer;
<a name="l00267"></a>00267 }
<a name="l00268"></a>00268 
<a name="l00269"></a>00269 <span class="comment">//----------------------------------------------------------</span>
<a name="l00270"></a>00270 <span class="keywordtype">void</span>
<a name="l00271"></a><a class="code" href="class_gr_model.html#e99405dcb83200626b7c715755f70836">00271</a> <a class="code" href="class_gr_model.html#e99405dcb83200626b7c715755f70836" title="local transform.">GrModel::SetLocal</a>( <span class="keyword">const</span> <a class="code" href="class_m_mat4x4.html" title="class MMat4x4">MMat4x4</a>&amp; <a class="code" href="glext_8h.html#07993c0d92c1aeeb357ba0495c8b5325">transform</a> )
<a name="l00272"></a>00272 {
<a name="l00273"></a>00273         _local = transform;
<a name="l00274"></a>00274         _dirty = <span class="keyword">true</span>;
<a name="l00275"></a>00275 }
<a name="l00276"></a>00276 
<a name="l00277"></a>00277 <span class="comment">//----------------------------------------------------------</span>
<a name="l00278"></a>00278 <span class="keywordtype">void</span>
<a name="l00279"></a><a class="code" href="class_gr_model.html#a3f1827d34de5f0c67d20103cf0d97bc">00279</a> <a class="code" href="class_gr_model.html#a3f1827d34de5f0c67d20103cf0d97bc">GrModel::SetWorld</a>( <span class="keyword">const</span> <a class="code" href="class_m_mat4x4.html" title="class MMat4x4">MMat4x4</a>&amp; <a class="code" href="glext_8h.html#07993c0d92c1aeeb357ba0495c8b5325">transform</a> )
<a name="l00280"></a>00280 {
<a name="l00282"></a>00282     <a class="code" href="class_m_mat4x4.html" title="class MMat4x4">MMat4x4</a> parentWorld = <a class="code" href="class_m_mat4x4.html#ea61fe6cd5a7fdea9260a96812a95298">MMat4x4::Identity</a>();
<a name="l00283"></a>00283     <span class="keywordflow">if</span> ( _parentNode )
<a name="l00284"></a>00284         parentWorld = _parentNode-&gt;<a class="code" href="class_gr_model_node.html#2799107e185b3fb30a4429b1bb0cf1f9">GetWorld</a>();
<a name="l00285"></a>00285     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( _parent )
<a name="l00286"></a>00286         parentWorld = _parent-&gt;<a class="code" href="class_gr_model.html#624ce6372c1bdd5a077e51c16adb9242">GetWorld</a>();
<a name="l00287"></a>00287 
<a name="l00289"></a>00289     <a class="code" href="class_m_mat4x4.html" title="class MMat4x4">MMat4x4</a> parentWorldInv;
<a name="l00290"></a>00290     <span class="keywordtype">bool</span> success = parentWorld.<a class="code" href="class_m_mat4x4.html#5045e1a3e2dda8f62a8c3cba29b721db">Inverse</a>( parentWorldInv );
<a name="l00291"></a>00291     <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( success );
<a name="l00292"></a>00292     <span class="keywordflow">if</span> ( success )
<a name="l00293"></a>00293     {
<a name="l00295"></a>00295         _local = parentWorldInv * transform;
<a name="l00296"></a>00296         _dirty = <span class="keyword">true</span>;
<a name="l00297"></a>00297     }
<a name="l00298"></a>00298 }
<a name="l00299"></a>00299 
<a name="l00300"></a>00300 <span class="comment">//----------------------------------------------------------</span>
<a name="l00301"></a>00301 <a class="code" href="class_m_mat4x4.html" title="class MMat4x4">MMat4x4</a>
<a name="l00302"></a><a class="code" href="class_gr_model.html#624ce6372c1bdd5a077e51c16adb9242">00302</a> <a class="code" href="class_gr_model.html#624ce6372c1bdd5a077e51c16adb9242">GrModel::GetWorld</a>() 
<a name="l00303"></a>00303 {
<a name="l00305"></a>00305     <a class="code" href="class_gr_model.html#12002759a1e3c55bf2ec71d21f197a0d">EnsureUpdated</a>();
<a name="l00306"></a>00306 
<a name="l00308"></a>00308     <span class="keywordflow">if</span> ( _parentNode )
<a name="l00309"></a>00309         <span class="keywordflow">return</span> _parentNode-&gt;<a class="code" href="class_gr_model_node.html#2799107e185b3fb30a4429b1bb0cf1f9">GetWorld</a>() * _local;
<a name="l00310"></a>00310 
<a name="l00312"></a>00312     <span class="keywordflow">if</span> ( _parent )
<a name="l00313"></a>00313         <span class="keywordflow">return</span> _parent-&gt;<a class="code" href="class_gr_model.html#624ce6372c1bdd5a077e51c16adb9242">GetWorld</a>() * _local;
<a name="l00314"></a>00314 
<a name="l00317"></a>00317     <span class="keywordflow">return</span> _local;
<a name="l00318"></a>00318 }
<a name="l00319"></a>00319 
<a name="l00320"></a>00320 <span class="comment">//----------------------------------------------------------</span>
<a name="l00321"></a>00321 <span class="keywordtype">void</span>
<a name="l00322"></a><a class="code" href="class_gr_model.html#c232d8ab1c8c5e6349acd53eebc9db61">00322</a> <a class="code" href="class_gr_model.html#c232d8ab1c8c5e6349acd53eebc9db61" title="child models.">GrModel::AddChild</a>( <a class="code" href="class_u_ref.html">URef&lt; GrModel &gt;</a> model, <a class="code" href="class_gr_model_node.html" title="class GrModelNode">GrModelNode</a>* attachTo )
<a name="l00323"></a>00323 {
<a name="l00325"></a>00325         <span class="keywordflow">if</span> ( attachTo == 0 )
<a name="l00326"></a>00326                 attachTo = _root;
<a name="l00327"></a>00327 
<a name="l00330"></a>00330         <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( attachTo-&gt;<a class="code" href="class_gr_model_node.html#f03b5dd5229d1c4f8f6232fd6d419335">GetOwner</a>() == this );
<a name="l00331"></a>00331         <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( model != _rootModel );
<a name="l00332"></a>00332         <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( model != <span class="keyword">this</span> );
<a name="l00333"></a>00333         <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( model != 0 );
<a name="l00334"></a>00334 
<a name="l00336"></a>00336         model-&gt;_parent = <span class="keyword">this</span>;
<a name="l00337"></a>00337         model-&gt;_parentNode = attachTo;
<a name="l00338"></a>00338         model-&gt;_dirty = <span class="keyword">true</span>;
<a name="l00339"></a>00339         <span class="keywordflow">if</span> ( model-&gt;_inScene != _inScene )
<a name="l00340"></a>00340                 model-&gt;SetInScene( _inScene );
<a name="l00341"></a>00341 
<a name="l00343"></a>00343         _children.<a class="code" href="class_u_fast_array.html#23fd2ded4aa241f76b313a925861c828">Push</a>( model );
<a name="l00344"></a>00344 }
<a name="l00345"></a>00345 
<a name="l00346"></a>00346 <span class="comment">//----------------------------------------------------------</span>
<a name="l00347"></a>00347 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>
<a name="l00348"></a><a class="code" href="class_gr_model.html#0d67f658382989a2dc3744dc88b28c22">00348</a> <a class="code" href="class_gr_model.html#0d67f658382989a2dc3744dc88b28c22">GrModel::GetChildCount</a>()<span class="keyword"> const</span>
<a name="l00349"></a>00349 <span class="keyword"></span>{
<a name="l00350"></a>00350         <span class="keywordflow">return</span> _children.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>();
<a name="l00351"></a>00351 }
<a name="l00352"></a>00352 
<a name="l00353"></a>00353 <span class="comment">//----------------------------------------------------------</span>
<a name="l00354"></a>00354 <a class="code" href="class_u_ref.html">URef&lt; GrModel &gt;</a>
<a name="l00355"></a><a class="code" href="class_gr_model.html#462d3723b7fe4909bc9a92b3fcb0028c">00355</a> <a class="code" href="class_gr_model.html#462d3723b7fe4909bc9a92b3fcb0028c">GrModel::GetChild</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx )
<a name="l00356"></a>00356 {
<a name="l00357"></a>00357         <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( idx &lt; _children.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>() );
<a name="l00358"></a>00358         <span class="keywordflow">return</span> _children[ idx ];
<a name="l00359"></a>00359 }
<a name="l00360"></a>00360 
<a name="l00361"></a>00361 <span class="comment">//----------------------------------------------------------</span>
<a name="l00362"></a>00362 <span class="keywordtype">bool</span>
<a name="l00363"></a><a class="code" href="class_gr_model.html#9148b455251ccd009790f95c126ec936">00363</a> <a class="code" href="class_gr_model.html#9148b455251ccd009790f95c126ec936">GrModel::RemoveChild</a>( <a class="code" href="class_gr_model.html" title="class GrModel">GrModel</a>* model )
<a name="l00364"></a>00364 {
<a name="l00367"></a>00367         <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( model != _rootModel );
<a name="l00368"></a>00368 
<a name="l00370"></a>00370         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; _children.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>(); ++i )
<a name="l00371"></a>00371         {
<a name="l00372"></a>00372                 <span class="keywordflow">if</span> ( _children[ i ] == model )
<a name="l00373"></a>00373                 {
<a name="l00376"></a>00376                         <span class="keywordflow">if</span> ( _inScene )
<a name="l00377"></a>00377                                 model-&gt;<a class="code" href="class_gr_model.html#7e681e1353f29fe9a6412947926228d3" title="private methods">SetInScene</a>( <span class="keyword">false</span> );
<a name="l00378"></a>00378 
<a name="l00380"></a>00380                         model-&gt;<a class="code" href="class_gr_model.html#d4f1c836bd0851133011546f8eb980a8">_parent</a> = 0;
<a name="l00381"></a>00381                         model-&gt;<a class="code" href="class_gr_model.html#845b2dcc21f7f0440de259e75dfba227">_parentNode</a> = 0;
<a name="l00382"></a>00382                         model-&gt;<a class="code" href="class_gr_model.html#2be47e38413a84445ad47b131fe7bba9">_dirty</a> = <span class="keyword">true</span>;
<a name="l00383"></a>00383 
<a name="l00385"></a>00385                         _children.<a class="code" href="class_u_fast_array.html#eef6f5a281cb95cf277c33714117ab05">Erase</a>( i );
<a name="l00386"></a>00386                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00387"></a>00387                 }
<a name="l00388"></a>00388         }
<a name="l00389"></a>00389 
<a name="l00391"></a>00391         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00392"></a>00392 }
<a name="l00393"></a>00393 
<a name="l00394"></a>00394 <span class="comment">//----------------------------------------------------------</span>
<a name="l00395"></a>00395 <span class="keywordtype">void</span>
<a name="l00396"></a><a class="code" href="class_gr_model.html#79e3bfacd56b97bf810b971f064d4a91">00396</a> <a class="code" href="class_gr_model.html#79e3bfacd56b97bf810b971f064d4a91">GrModel::RemoveChildren</a>()
<a name="l00397"></a>00397 {
<a name="l00399"></a>00399         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; _children.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>(); ++i )
<a name="l00400"></a>00400         {
<a name="l00402"></a>00402                 <a class="code" href="class_gr_model.html" title="class GrModel">GrModel</a>* curModel = _children[ i ];
<a name="l00403"></a>00403 
<a name="l00406"></a>00406                 <span class="keywordflow">if</span> ( _inScene )
<a name="l00407"></a>00407                         curModel-&gt;<a class="code" href="class_gr_model.html#7e681e1353f29fe9a6412947926228d3" title="private methods">SetInScene</a>( <span class="keyword">false</span> );
<a name="l00408"></a>00408 
<a name="l00410"></a>00410                 curModel-&gt;<a class="code" href="class_gr_model.html#d4f1c836bd0851133011546f8eb980a8">_parent</a> = 0;
<a name="l00411"></a>00411                 curModel-&gt;<a class="code" href="class_gr_model.html#845b2dcc21f7f0440de259e75dfba227">_parentNode</a> = 0;
<a name="l00412"></a>00412                 curModel-&gt;<a class="code" href="class_gr_model.html#2be47e38413a84445ad47b131fe7bba9">_dirty</a> = <span class="keyword">true</span>;
<a name="l00413"></a>00413         }
<a name="l00414"></a>00414         _children.<a class="code" href="class_u_fast_array.html#97c6c9910cc6e541254eaaaa530d48a9">Clear</a>();
<a name="l00415"></a>00415 }
<a name="l00416"></a>00416 
<a name="l00417"></a>00417 <span class="comment">//----------------------------------------------------------</span>
<a name="l00418"></a>00418 <span class="keywordtype">void</span>
<a name="l00419"></a><a class="code" href="class_gr_model.html#4d7fbb62dd1022da5a5fd25c6cb0e1fc">00419</a> <a class="code" href="class_gr_model.html#4d7fbb62dd1022da5a5fd25c6cb0e1fc" title="child lights.">GrModel::AddLight</a>( <a class="code" href="class_u_ref.html">URef&lt; GrLight &gt;</a> light, <a class="code" href="class_gr_model_node.html" title="class GrModelNode">GrModelNode</a>* attachTo )
<a name="l00420"></a>00420 {
<a name="l00423"></a>00423         <span class="keywordflow">if</span> ( !light )
<a name="l00424"></a>00424                 <span class="keywordflow">return</span>;
<a name="l00425"></a>00425 
<a name="l00426"></a>00426         <span class="keywordflow">if</span> ( !attachTo )
<a name="l00427"></a>00427                 attachTo = _root;
<a name="l00428"></a>00428 
<a name="l00429"></a>00429         SLightAttachment <a class="code" href="glext_8h.html#d8f97111cc6514af5f352219d1cceb40">attachment</a>;
<a name="l00430"></a>00430         attachment.parent = attachTo;
<a name="l00431"></a>00431         attachment.light = light;
<a name="l00432"></a>00432         _lights.push_back( attachment );
<a name="l00433"></a>00433 
<a name="l00434"></a>00434         <span class="keywordflow">if</span> ( _inScene )
<a name="l00435"></a>00435                 <a class="code" href="_gr_scene_8cpp.html#61317b03beb338f79e32ea73a3e8276b">gGrScene</a>-&gt;<a class="code" href="class_gr_scene.html#edba5aec2c8d98d63416dd3be618a427" title="light management.">AddLight</a>( light );
<a name="l00436"></a>00436 }
<a name="l00437"></a>00437 
<a name="l00438"></a>00438 <span class="comment">//----------------------------------------------------------</span>
<a name="l00439"></a>00439 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>
<a name="l00440"></a><a class="code" href="class_gr_model.html#fbd44f70a2b06c82884eac31c40baeab">00440</a> <a class="code" href="class_gr_model.html#fbd44f70a2b06c82884eac31c40baeab">GrModel::GetLightCount</a>()<span class="keyword"> const</span>
<a name="l00441"></a>00441 <span class="keyword"></span>{
<a name="l00442"></a>00442         <span class="keywordflow">return</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> )_lights.size();
<a name="l00443"></a>00443 }
<a name="l00444"></a>00444 
<a name="l00445"></a>00445 <span class="comment">//----------------------------------------------------------</span>
<a name="l00446"></a>00446 <a class="code" href="class_u_ref.html">URef&lt; GrLight &gt;</a>
<a name="l00447"></a><a class="code" href="class_gr_model.html#6f9177f0b2648997f0cb8dd4da0a481b">00447</a> <a class="code" href="class_gr_model.html#6f9177f0b2648997f0cb8dd4da0a481b">GrModel::GetLight</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx )
<a name="l00448"></a>00448 {
<a name="l00449"></a>00449         <span class="keywordflow">return</span> _lights[ idx ].light;
<a name="l00450"></a>00450 }
<a name="l00451"></a>00451 
<a name="l00452"></a>00452 <span class="comment">//----------------------------------------------------------</span>
<a name="l00453"></a>00453 <a class="code" href="class_gr_model_node.html" title="class GrModelNode">GrModelNode</a>*
<a name="l00454"></a><a class="code" href="class_gr_model.html#7ff4ed21e0a840da8ce5570b31b68a15">00454</a> <a class="code" href="class_gr_model.html#7ff4ed21e0a840da8ce5570b31b68a15">GrModel::GetLightParent</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx )
<a name="l00455"></a>00455 {
<a name="l00456"></a>00456         <span class="keywordflow">return</span> _lights[ idx ].parent;
<a name="l00457"></a>00457 }
<a name="l00458"></a>00458 
<a name="l00459"></a>00459 <span class="comment">//----------------------------------------------------------</span>
<a name="l00460"></a>00460 <span class="keywordtype">bool</span>
<a name="l00461"></a><a class="code" href="class_gr_model.html#931e8f832b0858244d75b1dda2d5a70d">00461</a> <a class="code" href="class_gr_model.html#931e8f832b0858244d75b1dda2d5a70d">GrModel::RemoveLight</a>( <a class="code" href="class_gr_light.html" title="class GrLight">GrLight</a>* light )
<a name="l00462"></a>00462 {
<a name="l00465"></a>00465         LightVec::iterator iter = _lights.begin();
<a name="l00466"></a>00466         LightVec::iterator <a class="code" href="_g_l_8h.html#432111147038972f06e049e18a837002">end</a> = _lights.end();
<a name="l00467"></a>00467         <span class="keywordflow">for</span> ( ; iter != end; ++iter )
<a name="l00468"></a>00468         {
<a name="l00469"></a>00469                 <span class="keywordflow">if</span> ( iter-&gt;light == light )
<a name="l00470"></a>00470                 {
<a name="l00471"></a>00471                         <a class="code" href="common__afx_8h.html#47011226fb8cfe2fc14382b095dddb1a" title="fast erase for vectors. This does not maintain element order.">FastVectorErase</a>( _lights, iter );
<a name="l00472"></a>00472                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00473"></a>00473                 }
<a name="l00474"></a>00474         }
<a name="l00475"></a>00475 
<a name="l00476"></a>00476         <span class="keywordflow">if</span> ( _inScene )
<a name="l00477"></a>00477                 <a class="code" href="_gr_scene_8cpp.html#61317b03beb338f79e32ea73a3e8276b">gGrScene</a>-&gt;<a class="code" href="class_gr_scene.html#d164195244a057f9a27808fed5e49a97">RemoveLight</a>( light );
<a name="l00478"></a>00478 
<a name="l00480"></a>00480         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00481"></a>00481 }
<a name="l00482"></a>00482 
<a name="l00483"></a>00483 <span class="comment">//----------------------------------------------------------</span>
<a name="l00484"></a>00484 <span class="keywordtype">void</span>
<a name="l00485"></a><a class="code" href="class_gr_model.html#95abd2705120c297a44287fe1d173224">00485</a> <a class="code" href="class_gr_model.html#95abd2705120c297a44287fe1d173224">GrModel::RemoveLights</a>()
<a name="l00486"></a>00486 {
<a name="l00487"></a>00487         <span class="keywordflow">if</span> ( _inScene )
<a name="l00488"></a>00488         {
<a name="l00489"></a>00489                 LightVec::iterator iter = _lights.begin();
<a name="l00490"></a>00490                 LightVec::iterator <a class="code" href="_g_l_8h.html#432111147038972f06e049e18a837002">end</a> = _lights.end();
<a name="l00491"></a>00491                 <span class="keywordflow">for</span> ( ; iter != end; ++iter )
<a name="l00492"></a>00492                         <a class="code" href="_gr_scene_8cpp.html#61317b03beb338f79e32ea73a3e8276b">gGrScene</a>-&gt;<a class="code" href="class_gr_scene.html#d164195244a057f9a27808fed5e49a97">RemoveLight</a>( iter-&gt;light );
<a name="l00493"></a>00493         }
<a name="l00494"></a>00494         _lights.resize( 0 );
<a name="l00495"></a>00495 }
<a name="l00496"></a>00496 
<a name="l00497"></a>00497 <span class="comment">//----------------------------------------------------------</span>
<a name="l00498"></a>00498 <a class="code" href="class_u_ref.html">URef&lt; GrModel &gt;</a>
<a name="l00499"></a><a class="code" href="class_gr_model.html#edeff0285708b660e0c21e2cb65da360">00499</a> <a class="code" href="class_gr_model.html#edeff0285708b660e0c21e2cb65da360" title="recursively finds a model by its instance name or its file name.">GrModel::FindModelByInstName</a>( <span class="keyword">const</span> <a class="code" href="class_u_path.html" title="Purpose: To provide a clean way to represent paths strings.">UPath</a>&amp; instName )
<a name="l00500"></a>00500 {
<a name="l00502"></a>00502         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; _children.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>(); ++i )
<a name="l00503"></a>00503         {
<a name="l00505"></a>00505                 <a class="code" href="class_gr_model.html" title="class GrModel">GrModel</a>* curModel = _children[ i ];
<a name="l00506"></a>00506                 <span class="keywordflow">if</span> ( curModel-&gt;<a class="code" href="class_gr_model.html#e8a075163c88d6bf6623db37d65cd17a">GetInstName</a>() == instName )
<a name="l00507"></a>00507                         <span class="keywordflow">return</span> curModel;
<a name="l00508"></a>00508 
<a name="l00510"></a>00510                 curModel-&gt;<a class="code" href="class_gr_model.html#edeff0285708b660e0c21e2cb65da360" title="recursively finds a model by its instance name or its file name.">FindModelByInstName</a>( instName );
<a name="l00511"></a>00511         }
<a name="l00512"></a>00512 
<a name="l00514"></a>00514         <span class="keywordflow">return</span> 0;
<a name="l00515"></a>00515 }
<a name="l00516"></a>00516 
<a name="l00517"></a>00517 <span class="comment">//----------------------------------------------------------</span>
<a name="l00518"></a>00518 <span class="keywordtype">void</span>
<a name="l00519"></a><a class="code" href="class_gr_model.html#51f1bc0e7546b45969e3d40f600f7690">00519</a> <a class="code" href="class_gr_model.html#51f1bc0e7546b45969e3d40f600f7690">GrModel::FindModelsByFileName</a>( <a class="code" href="class_u_fast_array.html" title="Purpose: To act like a std::vector, only faster. Avoids.">UFastArray</a>&lt; <a class="code" href="class_u_ref.html">URef&lt; GrModel &gt;</a> &gt;&amp; models, <span class="keyword">const</span> <a class="code" href="class_u_path.html" title="Purpose: To provide a clean way to represent paths strings.">UPath</a>&amp; fileName )
<a name="l00520"></a>00520 {
<a name="l00522"></a>00522         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; _children.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>(); ++i )
<a name="l00523"></a>00523         {
<a name="l00525"></a>00525                 <a class="code" href="class_gr_model.html" title="class GrModel">GrModel</a>* curModel = _children[ i ];
<a name="l00526"></a>00526                 <span class="keywordflow">if</span> ( curModel-&gt;<a class="code" href="class_gr_model.html#390da9636c9c396d1fa3241b72ff6166" title="returns information about the model&amp;#39;s name.">GetFileName</a>() == fileName )
<a name="l00527"></a>00527                         models.<a class="code" href="class_u_fast_array.html#23fd2ded4aa241f76b313a925861c828">Push</a>( curModel );
<a name="l00528"></a>00528 
<a name="l00530"></a>00530                 curModel-&gt;<a class="code" href="class_gr_model.html#51f1bc0e7546b45969e3d40f600f7690">FindModelsByFileName</a>( models, fileName );
<a name="l00531"></a>00531         }
<a name="l00532"></a>00532 }
<a name="l00533"></a>00533 
<a name="l00534"></a>00534 <span class="comment">//----------------------------------------------------------</span>
<a name="l00535"></a>00535 <span class="keywordtype">void</span>
<a name="l00536"></a><a class="code" href="class_gr_model.html#0b9f56be2def3c655a5a37ed425539c4">00536</a> <a class="code" href="class_gr_model.html#0b9f56be2def3c655a5a37ed425539c4" title="retreives all of the mesh instances from the model.">GrModel::GetMeshInsts</a>( <a class="code" href="class_u_fast_array.html">UFastArray&lt; GrMeshInst* &gt;</a>&amp; meshInsts )
<a name="l00537"></a>00537 {
<a name="l00538"></a>00538         <a class="code" href="class_gr_model.html#0b9f56be2def3c655a5a37ed425539c4" title="retreives all of the mesh instances from the model.">GetMeshInsts</a>( meshInsts, _root );
<a name="l00539"></a>00539 }
<a name="l00540"></a>00540 
<a name="l00541"></a>00541 <span class="comment">//----------------------------------------------------------</span>
<a name="l00542"></a>00542 <span class="keywordtype">void</span>
<a name="l00543"></a><a class="code" href="class_gr_model.html#2c9c76c4d7715ab154fb9f89dd62d4d0">00543</a> <a class="code" href="class_gr_model.html#2c9c76c4d7715ab154fb9f89dd62d4d0" title="retrieves all of the mesh instances from the model and from each of its children...">GrModel::GetAllMeshInsts</a>( <a class="code" href="class_u_fast_array.html">UFastArray&lt; GrMeshInst* &gt;</a>&amp; meshInsts )
<a name="l00544"></a>00544 {
<a name="l00546"></a>00546         <a class="code" href="class_gr_model.html#0b9f56be2def3c655a5a37ed425539c4" title="retreives all of the mesh instances from the model.">GetMeshInsts</a>( meshInsts, _root );
<a name="l00547"></a>00547 
<a name="l00549"></a>00549         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> childCount = _children.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>();
<a name="l00550"></a>00550         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; childCount; ++i )
<a name="l00551"></a>00551         {
<a name="l00552"></a>00552                 <a class="code" href="class_gr_model.html" title="class GrModel">GrModel</a>* child = _children[ i ];
<a name="l00553"></a>00553                 child-&gt;<a class="code" href="class_gr_model.html#2c9c76c4d7715ab154fb9f89dd62d4d0" title="retrieves all of the mesh instances from the model and from each of its children...">GetAllMeshInsts</a>( meshInsts );
<a name="l00554"></a>00554         }
<a name="l00555"></a>00555 }
<a name="l00556"></a>00556 
<a name="l00557"></a>00557 <span class="comment">//----------------------------------------------------------</span>
<a name="l00558"></a>00558 <span class="keywordtype">bool</span>
<a name="l00559"></a><a class="code" href="class_gr_model.html#dbb1580e4409efde8590f9a6feacd0c9">00559</a> <a class="code" href="class_gr_model.html#dbb1580e4409efde8590f9a6feacd0c9">GrModel::Update</a>( <span class="keywordtype">bool</span> forceXFormUpdate )
<a name="l00560"></a>00560 {
<a name="l00562"></a>00562         <span class="keywordflow">if</span> ( _animPlayer )
<a name="l00563"></a>00563         {
<a name="l00565"></a>00565                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timeDelta = <a class="code" href="_gr_scene_8cpp.html#61317b03beb338f79e32ea73a3e8276b">gGrScene</a>-&gt;<a class="code" href="class_gr_scene.html#6b41fa1f794c9c955beff22da3f2e948">GetTimeDelta</a>();
<a name="l00566"></a>00566                 <span class="keywordflow">if</span> ( timeDelta &gt; 0 )
<a name="l00567"></a>00567                         _animPlayer-&gt;<a class="code" href="class_gr_anim_player.html#5a21c0ec51c825365b37a34b05cbfad5" title="update the current active mix(es).">ApplyPose</a>( <span class="keywordtype">float</span>( timeDelta ) / 1000.0f );
<a name="l00568"></a>00568         }
<a name="l00569"></a>00569 
<a name="l00571"></a>00571         forceXFormUpdate = forceXFormUpdate || _dirty;
<a name="l00572"></a>00572         <span class="keywordflow">if</span> ( forceXFormUpdate )
<a name="l00573"></a>00573                 <a class="code" href="class_gr_model.html#fbc38dc0bd373a8b199535d55a06fc84" title="updates transforms. This is should usually only be called internally.">UpdateXForms</a>();
<a name="l00574"></a>00574 
<a name="l00576"></a>00576         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; _skinControllerCount; ++i )
<a name="l00577"></a>00577                 _skinControllers[ i ].<a class="code" href="class_gr_model.html#dbb1580e4409efde8590f9a6feacd0c9">Update</a>();
<a name="l00578"></a>00578 
<a name="l00580"></a>00580         <span class="keywordflow">if</span> ( forceXFormUpdate )
<a name="l00581"></a>00581         {
<a name="l00582"></a>00582                 _bounds.<a class="code" href="class_m_a_a_box.html#65a37e6adae9f465bb0ac964f4bfbe63">SetCenter</a>( _local.<a class="code" href="class_m_mat4x4.html#cb765b649243077af476897147c75919">GetTranslate</a>() );
<a name="l00583"></a>00583                 _bounds.<a class="code" href="class_m_a_a_box.html#9ce3a23bc3cfa705d6776807289bd178">SetHalfExts</a>( <a class="code" href="class_m_vec3.html" title="class MVec3">MVec3</a>() );
<a name="l00584"></a>00584                 _root-&gt;<a class="code" href="class_gr_model_node.html#3bc9a825d5c12c5f8484a869e992ac0f" title="calculates the optimal AABB from geometry.">CalcBoundsExact</a>( _bounds );
<a name="l00585"></a>00585         }
<a name="l00586"></a>00586 
<a name="l00588"></a>00588         <span class="keywordtype">bool</span> boundsUpdate = forceXFormUpdate;
<a name="l00589"></a>00589         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> childCount = _children.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>();
<a name="l00590"></a>00590         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; childCount; ++i )
<a name="l00591"></a>00591         {
<a name="l00593"></a>00593                 <span class="keywordflow">if</span> ( _children[ i ]-&gt;<a class="code" href="class_gr_model.html#dbb1580e4409efde8590f9a6feacd0c9">Update</a>( forceXFormUpdate ) )
<a name="l00594"></a>00594                 {
<a name="l00595"></a>00595                         boundsUpdate = _bounds.<a class="code" href="class_m_a_a_box.html#7da828ab9a51859fb07aedfce50967f0" title="expands the axis-aligned box by the box passed in.">AddBoxToVolume</a>( _children[ i ]-&gt;<a class="code" href="class_gr_model.html#3667043cfbdca6e413d4de9d0449aa5f" title="returns the current bounds of the model.">GetBounds</a>() ) || boundsUpdate;
<a name="l00596"></a>00596                 }
<a name="l00597"></a>00597         }
<a name="l00598"></a>00598 
<a name="l00600"></a>00600         LightVec::iterator iter = _lights.begin();
<a name="l00601"></a>00601         LightVec::iterator <a class="code" href="_g_l_8h.html#432111147038972f06e049e18a837002">end</a> = _lights.end();
<a name="l00602"></a>00602         <span class="keywordflow">for</span> ( ; iter != end; ++iter )
<a name="l00603"></a>00603                 iter-&gt;light-&gt;SetParentTransform( iter-&gt;parent-&gt;GetWorld() );
<a name="l00604"></a>00604 
<a name="l00606"></a>00606         <span class="keywordflow">return</span> boundsUpdate;
<a name="l00607"></a>00607 }
<a name="l00608"></a>00608 
<a name="l00609"></a>00609 <span class="comment">//----------------------------------------------------------</span>
<a name="l00610"></a>00610 <span class="keywordtype">void</span>
<a name="l00611"></a><a class="code" href="class_gr_model.html#fbc38dc0bd373a8b199535d55a06fc84">00611</a> <a class="code" href="class_gr_model.html#fbc38dc0bd373a8b199535d55a06fc84" title="updates transforms. This is should usually only be called internally.">GrModel::UpdateXForms</a>()
<a name="l00612"></a>00612 {
<a name="l00614"></a>00614         _dirty = <span class="keyword">false</span>;
<a name="l00615"></a>00615 
<a name="l00617"></a>00617         <span class="keywordflow">if</span> ( _parentNode )
<a name="l00618"></a>00618                 _root-&gt;<a class="code" href="class_gr_model_node.html#c5c58f7cd659b01c66e0f45054cd6200" title="updates the transform.">Update</a>( _parentNode-&gt;<a class="code" href="class_gr_model_node.html#2799107e185b3fb30a4429b1bb0cf1f9">GetWorld</a>() * _local );
<a name="l00619"></a>00619         <span class="keywordflow">else</span>
<a name="l00620"></a>00620                 _root-&gt;<a class="code" href="class_gr_model_node.html#c5c58f7cd659b01c66e0f45054cd6200" title="updates the transform.">Update</a>( _local );
<a name="l00621"></a>00621 }
<a name="l00622"></a>00622 
<a name="l00623"></a>00623 <span class="comment">//----------------------------------------------------------</span>
<a name="l00624"></a>00624 <span class="keywordtype">void</span>
<a name="l00625"></a><a class="code" href="class_gr_model.html#12002759a1e3c55bf2ec71d21f197a0d">00625</a> <a class="code" href="class_gr_model.html#12002759a1e3c55bf2ec71d21f197a0d">GrModel::EnsureUpdated</a>()
<a name="l00626"></a>00626 {
<a name="l00628"></a>00628     <span class="keywordflow">if</span> ( _parent )
<a name="l00629"></a>00629         _parent-&gt;<a class="code" href="class_gr_model.html#12002759a1e3c55bf2ec71d21f197a0d">EnsureUpdated</a>();
<a name="l00630"></a>00630     <span class="keywordflow">else</span>
<a name="l00631"></a>00631         <a class="code" href="class_gr_model.html#dbb1580e4409efde8590f9a6feacd0c9">Update</a>();
<a name="l00632"></a>00632 }
<a name="l00633"></a>00633 
<a name="l00634"></a>00634 <span class="comment">//----------------------------------------------------------</span>
<a name="l00635"></a>00635 <span class="keywordtype">bool</span>
<a name="l00636"></a><a class="code" href="class_gr_model.html#fbbc5426863525467f35ff2df3cca3ce">00636</a> <a class="code" href="class_gr_model.html#fbbc5426863525467f35ff2df3cca3ce" title="pick against the mesh.">GrModel::Pick</a>( <span class="keywordtype">float</span>&amp; dist, <span class="keyword">const</span> <a class="code" href="class_m_ray.html" title="class MRay">MRay</a>&amp; ray )
<a name="l00637"></a>00637 {
<a name="l00639"></a>00639         <a class="code" href="class_gr_model.html" title="class GrModel">GrModel</a>* model = 0;
<a name="l00640"></a>00640         <a class="code" href="class_gr_mesh_inst.html" title="class GrMeshInst">GrMeshInst</a>* meshInst = 0;
<a name="l00641"></a>00641         <a class="code" href="struct_gr_mesh_1_1_s_tri_collision.html" title="triangle collision data.">GrMesh::STriCollision</a> hit;
<a name="l00642"></a>00642         <span class="keywordflow">if</span> ( !<a class="code" href="class_gr_model.html#fbbc5426863525467f35ff2df3cca3ce" title="pick against the mesh.">Pick</a>( model, meshInst, hit, ray ) )
<a name="l00643"></a>00643                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00644"></a>00644 
<a name="l00646"></a>00646         dist = ray.<a class="code" href="class_m_ray.html#50cd4ec247b5df4a4a336478a3a19c91">GetStart</a>().<a class="code" href="class_m_vec3.html#55337896656651e4e3a8214c718e5043">Dist</a>( hit.<a class="code" href="struct_gr_mesh_1_1_s_tri_collision.html#3a4997da126ca2145ef6974ba9f4b6c2">hitLoc</a> );
<a name="l00647"></a>00647 
<a name="l00649"></a>00649         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00650"></a>00650 }
<a name="l00651"></a>00651 
<a name="l00652"></a>00652 <span class="comment">//----------------------------------------------------------</span>
<a name="l00653"></a>00653 <span class="keywordtype">bool</span>
<a name="l00654"></a><a class="code" href="class_gr_model.html#525915234ad6fe9e03ee62e699d27fad">00654</a> <a class="code" href="class_gr_model.html#fbbc5426863525467f35ff2df3cca3ce" title="pick against the mesh.">GrModel::Pick</a>( <a class="code" href="class_gr_model.html" title="class GrModel">GrModel</a>*&amp; model, <a class="code" href="class_gr_mesh_inst.html" title="class GrMeshInst">GrMeshInst</a>*&amp; mesh, <a class="code" href="struct_gr_mesh_1_1_s_tri_collision.html" title="triangle collision data.">GrMesh::STriCollision</a>&amp; hit, <span class="keyword">const</span> <a class="code" href="class_m_ray.html" title="class MRay">MRay</a>&amp; ray )
<a name="l00655"></a>00655 {
<a name="l00657"></a>00657         <a class="code" href="class_gr_model.html#dbb1580e4409efde8590f9a6feacd0c9">Update</a>( <span class="keyword">true</span> );
<a name="l00658"></a>00658 
<a name="l00661"></a>00661         <span class="keywordflow">if</span> ( !ray.<a class="code" href="class_m_ray.html#d58f4fca993f73968696e69fa58f4a93" title="returns true if the ray intersects with the box provided.">Intersect</a>( <a class="code" href="class_gr_model.html#3667043cfbdca6e413d4de9d0449aa5f" title="returns the current bounds of the model.">GetBounds</a>() ) )
<a name="l00662"></a>00662                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00663"></a>00663 
<a name="l00665"></a>00665         <span class="keywordtype">float</span> curDistSqr = 65536.0f;
<a name="l00666"></a>00666         <span class="keywordtype">bool</span> rayHitSomething = <span class="keyword">false</span>;
<a name="l00667"></a>00667 
<a name="l00669"></a>00669         <span class="keywordflow">if</span> ( _pickable )
<a name="l00670"></a>00670         {
<a name="l00671"></a>00671                 rayHitSomething = PickNode( mesh, hit, _root, ray );
<a name="l00672"></a>00672                 <span class="keywordflow">if</span> ( rayHitSomething )
<a name="l00673"></a>00673                         curDistSqr = ray.<a class="code" href="class_m_ray.html#50cd4ec247b5df4a4a336478a3a19c91">GetStart</a>().<a class="code" href="class_m_vec3.html#71ac5757ebbfabeacbf4e8337f291d7d">DistSqr</a>( hit.<a class="code" href="struct_gr_mesh_1_1_s_tri_collision.html#3a4997da126ca2145ef6974ba9f4b6c2">hitLoc</a> );
<a name="l00674"></a>00674         }
<a name="l00675"></a>00675 
<a name="l00677"></a>00677         <a class="code" href="class_gr_mesh_inst.html" title="class GrMeshInst">GrMeshInst</a>* childMesh = 0;
<a name="l00678"></a>00678         <a class="code" href="struct_gr_mesh_1_1_s_tri_collision.html" title="triangle collision data.">GrMesh::STriCollision</a> childHit;
<a name="l00679"></a>00679         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> childCount = _children.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>();
<a name="l00680"></a>00680         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; childCount; ++i )
<a name="l00681"></a>00681         {
<a name="l00683"></a>00683                 <a class="code" href="class_gr_model.html" title="class GrModel">GrModel</a>* curChild = _children[ i ];
<a name="l00684"></a>00684                 <span class="keywordflow">if</span> ( curChild-&gt;<a class="code" href="class_gr_model.html#fbbc5426863525467f35ff2df3cca3ce" title="pick against the mesh.">Pick</a>( model, childMesh, childHit, ray ) )
<a name="l00685"></a>00685                 {
<a name="l00686"></a>00686                         <span class="keywordtype">float</span> childDistSqr = ray.<a class="code" href="class_m_ray.html#50cd4ec247b5df4a4a336478a3a19c91">GetStart</a>().<a class="code" href="class_m_vec3.html#71ac5757ebbfabeacbf4e8337f291d7d">DistSqr</a>( childHit.<a class="code" href="struct_gr_mesh_1_1_s_tri_collision.html#3a4997da126ca2145ef6974ba9f4b6c2">hitLoc</a> );
<a name="l00687"></a>00687                         <span class="keywordflow">if</span> ( childDistSqr &lt; curDistSqr )
<a name="l00688"></a>00688                         {
<a name="l00689"></a>00689                                 rayHitSomething = <span class="keyword">true</span>;
<a name="l00690"></a>00690                                 curDistSqr = childDistSqr;
<a name="l00691"></a>00691                                 hit = childHit;
<a name="l00692"></a>00692                                 mesh = childMesh;
<a name="l00693"></a>00693                                 model = curChild; 
<a name="l00694"></a>00694                         }
<a name="l00695"></a>00695                 }
<a name="l00696"></a>00696         }
<a name="l00697"></a>00697 
<a name="l00699"></a>00699         <span class="keywordflow">return</span> rayHitSomething;
<a name="l00700"></a>00700 }
<a name="l00701"></a>00701 
<a name="l00702"></a>00702 <span class="comment">//----------------------------------------------------------</span>
<a name="l00703"></a>00703 <span class="keywordtype">void</span>
<a name="l00704"></a><a class="code" href="class_gr_model.html#89501566d6de6f63cda4527fb7cae760">00704</a> <a class="code" href="class_gr_model.html#89501566d6de6f63cda4527fb7cae760" title="traverses meshes in the model higherarchy.">GrModel::Traverse</a>( <a class="code" href="class_gr_scene_traverser.html" title="class GrSceneTraverser">GrSceneTraverser</a>* traverser )
<a name="l00705"></a>00705 {
<a name="l00707"></a>00707         <span class="keywordflow">if</span> ( !traverser-&gt;<a class="code" href="class_gr_scene_traverser.html#f6c83b18404f6b8c9e20824676eb19f8">OnNode</a>( _bounds ) )
<a name="l00708"></a>00708                 <span class="keywordflow">return</span>;
<a name="l00709"></a>00709 
<a name="l00711"></a>00711         TraverseNode( traverser, _root );
<a name="l00712"></a>00712 
<a name="l00714"></a>00714         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> childCount = _children.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>();
<a name="l00715"></a>00715         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; childCount; ++i )
<a name="l00716"></a>00716                 _children[ i ]-&gt;<a class="code" href="class_gr_model.html#89501566d6de6f63cda4527fb7cae760" title="traverses meshes in the model higherarchy.">Traverse</a>( traverser );
<a name="l00717"></a>00717 }
<a name="l00718"></a>00718 
<a name="l00719"></a>00719 <span class="comment">//----------------------------------------------------------</span>
<a name="l00720"></a>00720 <span class="keywordtype">void</span>
<a name="l00721"></a><a class="code" href="class_gr_model.html#a125d73b384a3353dfbac65a93588282">00721</a> <a class="code" href="class_gr_model.html#a125d73b384a3353dfbac65a93588282" title="debug functionality.">GrModel::DbgDrawHierarchy</a>()
<a name="l00722"></a>00722 {
<a name="l00723"></a>00723         <a class="code" href="_gr_util_8cpp.html#a40f94ecd4645027260b3217ce172cbe">GrBindShader</a>( 0 );
<a name="l00724"></a>00724         <a class="code" href="_gr_util_8cpp.html#da7ea629bb413c26919562c8846d6139">GrSetState</a>( 0 );
<a name="l00725"></a>00725         <a class="code" href="_gr_util_8cpp.html#7b33558bb79e3c6936f26553c282d081">GrSetWriteEnable</a>( <a class="code" href="_gr_util_8h.html#d091dcc5dafb6944427eb6d9895b25d3">GR_RGBA</a> );
<a name="l00726"></a>00726         <a class="code" href="_g_l_subsys_8cpp.html#afdf3a93cbf608f43789a1fa3ff1a925">bglBegin</a>( <a class="code" href="_g_l_8h.html#532ed3612eae8eaed8a7a53ecd7a28f3">GL_LINES</a> );
<a name="l00727"></a>00727         <a class="code" href="_g_l_subsys_8cpp.html#cc1fa40c487f0c5595bcfee12de11a85">bglColor4f</a>( 0.0f, 1.0f, 0.0f, 1.0f );
<a name="l00728"></a>00728         DbgDrawNode( _root );
<a name="l00729"></a>00729         <a class="code" href="_g_l_subsys_8cpp.html#98e730ab9ca687a9a110d6d6707a38ae">bglEnd</a>();
<a name="l00730"></a>00730 }
<a name="l00731"></a>00731 
<a name="l00732"></a>00732 <span class="comment">//----------------------------------------------------------</span>
<a name="l00733"></a>00733 <span class="keywordtype">void</span>
<a name="l00734"></a><a class="code" href="class_gr_model.html#d3a2e4287aebf5351e971b9b64dbbe11">00734</a> <a class="code" href="class_gr_model.html#d3a2e4287aebf5351e971b9b64dbbe11" title="caches and evicts meshes.">GrModel::Cache</a>()
<a name="l00735"></a>00735 {
<a name="l00736"></a>00736         _root-&gt;<a class="code" href="class_gr_model_node.html#8dfebc45736fa221d3988d7bc05f71bf" title="caches or evicts child nodes.">Cache</a>();
<a name="l00737"></a>00737 }
<a name="l00738"></a>00738 
<a name="l00739"></a>00739 <span class="comment">//----------------------------------------------------------</span>
<a name="l00740"></a>00740 <span class="keywordtype">void</span>
<a name="l00741"></a><a class="code" href="class_gr_model.html#2b4b150bcaf7982b1e70cb80549bc704">00741</a> <a class="code" href="class_gr_model.html#2b4b150bcaf7982b1e70cb80549bc704">GrModel::Evict</a>()
<a name="l00742"></a>00742 {
<a name="l00743"></a>00743         _root-&gt;<a class="code" href="class_gr_model_node.html#598ada3ae0f7b3028d0b9f3cff6c1edd">Evict</a>();
<a name="l00744"></a>00744 }
<a name="l00745"></a>00745 
<a name="l00746"></a>00746 <span class="comment">//----------------------------------------------------------</span>
<a name="l00747"></a>00747 <span class="keywordtype">void</span>
<a name="l00748"></a><a class="code" href="class_gr_model.html#c6e775a1ef9fd0321916e99a2de5db2d">00748</a> <a class="code" href="class_gr_model.html#c6e775a1ef9fd0321916e99a2de5db2d" title="rendering services.">GrModel::GetLitObjectsAndMarkVisible</a>( <a class="code" href="class_gr_render_list.html" title="class GrRenderList">GrRenderList</a>&amp; lightReceivers, <span class="keyword">const</span> <a class="code" href="class_gr_frustum.html" title="class GrFrustum">GrFrustum</a>&amp; frustum, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> frameId )<span class="keyword"> const</span>
<a name="l00749"></a>00749 <span class="keyword"></span>{
<a name="l00751"></a>00751         <span class="keywordflow">if</span> ( !frustum.<a class="code" href="class_gr_frustum.html#2d3c8e27667405f7d98bcc8bb6e8ece5">IsAABoxInside</a>( _bounds ) )
<a name="l00752"></a>00752                 <span class="keywordflow">return</span>;
<a name="l00753"></a>00753 
<a name="l00755"></a>00755         _lastVisibleFrameId = frameId;
<a name="l00756"></a>00756         _root-&gt;<a class="code" href="class_gr_model_node.html#ad9c0636157e8cad390826cf91e16780" title="send to the renderer.">GetRenderableObjects</a>( lightReceivers, 0 );
<a name="l00757"></a>00757 
<a name="l00759"></a>00759         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> childCount = _children.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>();
<a name="l00760"></a>00760         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; childCount; ++i )
<a name="l00761"></a>00761         {
<a name="l00762"></a>00762                 <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( _children[ i ] != 0 );
<a name="l00763"></a>00763                 _children[ i ]-&gt;GetLitObjectsAndMarkVisible( lightReceivers, frustum, frameId );
<a name="l00764"></a>00764         }
<a name="l00765"></a>00765 }
<a name="l00766"></a>00766 
<a name="l00767"></a>00767 <span class="comment">//----------------------------------------------------------</span>
<a name="l00768"></a>00768 <span class="keywordtype">void</span>
<a name="l00769"></a><a class="code" href="class_gr_model.html#4dbbe93eef470aa2339ae8921535780a">00769</a> <a class="code" href="class_gr_model.html#4dbbe93eef470aa2339ae8921535780a">GrModel::GetLitObjects</a>( <a class="code" href="class_gr_render_list.html" title="class GrRenderList">GrRenderList</a>&amp; lightReceivers, <a class="code" href="class_gr_render_list.html" title="class GrRenderList">GrRenderList</a>* shadowCasters, <span class="keyword">const</span> <a class="code" href="class_m_sphere.html" title="class MSphere">MSphere</a>&amp; sphere,
<a name="l00770"></a>00770                                                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> frameId )<span class="keyword"> const</span>
<a name="l00771"></a>00771 <span class="keyword"></span>{
<a name="l00772"></a>00772         <span class="keywordflow">if</span> ( !shadowCasters &amp;&amp; _lastVisibleFrameId != frameId )
<a name="l00773"></a>00773                 <span class="keywordflow">return</span>;
<a name="l00774"></a>00774 
<a name="l00775"></a>00775         <span class="keywordflow">if</span> ( !_bounds.<a class="code" href="class_m_a_a_box.html#b309a32c61158e79a35b19a339d05248" title="returns whether the axis-aligned box intersects various shapes.">Intersect</a>( sphere ) )
<a name="l00776"></a>00776                 <span class="keywordflow">return</span>;
<a name="l00777"></a>00777 
<a name="l00779"></a>00779         _root-&gt;<a class="code" href="class_gr_model_node.html#ad9c0636157e8cad390826cf91e16780" title="send to the renderer.">GetRenderableObjects</a>( lightReceivers, shadowCasters );
<a name="l00780"></a>00780 
<a name="l00782"></a>00782         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> childCount = _children.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>();
<a name="l00783"></a>00783         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; childCount; ++i )
<a name="l00784"></a>00784         {
<a name="l00785"></a>00785                 <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( _children[ i ] != 0 );
<a name="l00786"></a>00786                 _children[ i ]-&gt;GetLitObjects( lightReceivers, shadowCasters, sphere, frameId );
<a name="l00787"></a>00787         }
<a name="l00788"></a>00788 }
<a name="l00789"></a>00789 
<a name="l00790"></a>00790 <span class="comment">//----------------------------------------------------------</span>
<a name="l00791"></a>00791 <span class="keywordtype">void</span>
<a name="l00792"></a><a class="code" href="class_gr_model.html#6533ef543b8238ce8434256f02be5f07">00792</a> <a class="code" href="class_gr_model.html#4dbbe93eef470aa2339ae8921535780a">GrModel::GetLitObjects</a>( <a class="code" href="class_gr_render_list.html" title="class GrRenderList">GrRenderList</a>&amp; lightReceivers, <a class="code" href="class_gr_render_list.html" title="class GrRenderList">GrRenderList</a>* shadowCasters, <span class="keyword">const</span> <a class="code" href="class_gr_frustum.html" title="class GrFrustum">GrFrustum</a>&amp; frustum,
<a name="l00793"></a>00793                                             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> frameId )<span class="keyword"> const</span>
<a name="l00794"></a>00794 <span class="keyword"></span>{
<a name="l00795"></a>00795         <span class="keywordflow">if</span> ( !shadowCasters &amp;&amp; _lastVisibleFrameId != frameId )
<a name="l00796"></a>00796                 <span class="keywordflow">return</span>;
<a name="l00797"></a>00797 
<a name="l00799"></a>00799         <span class="keywordflow">if</span> ( !frustum.<a class="code" href="class_gr_frustum.html#2d3c8e27667405f7d98bcc8bb6e8ece5">IsAABoxInside</a>( _bounds ) )
<a name="l00800"></a>00800                 <span class="keywordflow">return</span>;
<a name="l00801"></a>00801 
<a name="l00803"></a>00803         _root-&gt;<a class="code" href="class_gr_model_node.html#ad9c0636157e8cad390826cf91e16780" title="send to the renderer.">GetRenderableObjects</a>( lightReceivers, shadowCasters );
<a name="l00804"></a>00804 
<a name="l00806"></a>00806         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> childCount = _children.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>();
<a name="l00807"></a>00807         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; childCount; ++i )
<a name="l00808"></a>00808         {
<a name="l00809"></a>00809                 <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( _children[ i ] != 0 );
<a name="l00810"></a>00810                 _children[ i ]-&gt;GetLitObjects( lightReceivers, shadowCasters, frustum, frameId );
<a name="l00811"></a>00811         }
<a name="l00812"></a>00812 }
<a name="l00813"></a>00813 
<a name="l00814"></a>00814 <span class="comment">//----------------------------------------------------------</span>
<a name="l00815"></a>00815 <span class="keywordtype">void</span>                    
<a name="l00816"></a><a class="code" href="class_gr_model.html#d152158878fd8ee7d0f4f07915c54d01">00816</a> <a class="code" href="class_gr_model.html#d152158878fd8ee7d0f4f07915c54d01" title="query services.">GrModel::GetObjectsInFrustum</a>( <a class="code" href="class_gr_render_list.html" title="class GrRenderList">GrRenderList</a>&amp; objects, <span class="keyword">const</span> <a class="code" href="class_gr_frustum.html" title="class GrFrustum">GrFrustum</a>&amp; frustum )<span class="keyword"> const</span>
<a name="l00817"></a>00817 <span class="keyword"></span>{
<a name="l00819"></a>00819     <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( !_dirty );
<a name="l00820"></a>00820     <span class="keywordflow">if</span> ( _dirty )
<a name="l00821"></a>00821         <span class="keywordflow">return</span>;
<a name="l00822"></a>00822 
<a name="l00824"></a>00824         <span class="keywordflow">if</span> ( !frustum.<a class="code" href="class_gr_frustum.html#2d3c8e27667405f7d98bcc8bb6e8ece5">IsAABoxInside</a>( _bounds ) )
<a name="l00825"></a>00825                 <span class="keywordflow">return</span>;
<a name="l00826"></a>00826 
<a name="l00828"></a>00828         _root-&gt;<a class="code" href="class_gr_model_node.html#ad9c0636157e8cad390826cf91e16780" title="send to the renderer.">GetRenderableObjects</a>( objects, 0 );
<a name="l00829"></a>00829 
<a name="l00831"></a>00831         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> childCount = _children.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>();
<a name="l00832"></a>00832         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; childCount; ++i )
<a name="l00833"></a>00833         {
<a name="l00834"></a>00834                 <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( _children[ i ] != 0 );
<a name="l00835"></a>00835                 _children[ i ]-&gt;GetObjectsInFrustum( objects, frustum );
<a name="l00836"></a>00836         }
<a name="l00837"></a>00837 }
<a name="l00838"></a>00838 
<a name="l00839"></a>00839 <span class="comment">//----------------------------------------------------------</span>
<a name="l00840"></a>00840 <span class="keywordtype">void</span>
<a name="l00841"></a><a class="code" href="class_gr_model.html#94605ad2262faa9e3e858cd2f9b5d9d1">00841</a> <a class="code" href="class_gr_model.html#94605ad2262faa9e3e858cd2f9b5d9d1" title="load and save the model. This does not save children.">GrModel::Save</a>( <a class="code" href="class_u_writer.html" title="Purpose: To wrap and simplify pointer write operations.">UWriter</a>&amp; writer )<span class="keyword"> const</span>
<a name="l00842"></a>00842 <span class="keyword"></span>{
<a name="l00844"></a>00844         writer.<a class="code" href="class_u_writer.html#bbe55ee0c4a3b202b365da202899d410" title="public methods">WriteString</a>( <span class="stringliteral">"MDL"</span> );    
<a name="l00845"></a>00845 
<a name="l00847"></a>00847         writer.<a class="code" href="class_u_writer.html#2012d798142a97cacf03227395c2e24c">WriteInt</a>( 0x00010001 );  
<a name="l00848"></a>00848         writer.<a class="code" href="class_u_writer.html#bbe55ee0c4a3b202b365da202899d410" title="public methods">WriteString</a>( _source );  
<a name="l00849"></a>00849         writer.<a class="code" href="class_u_writer.html#bbe55ee0c4a3b202b365da202899d410" title="public methods">WriteString</a>( _author );  
<a name="l00850"></a>00850 
<a name="l00852"></a>00852         _local.<a class="code" href="class_m_mat4x4.html#51096a071af230f20fe4d5a94db23913" title="saving and loading.">Save</a>( writer );
<a name="l00853"></a>00853 
<a name="l00855"></a>00855         writer.<a class="code" href="class_u_writer.html#bbe55ee0c4a3b202b365da202899d410" title="public methods">WriteString</a>( _defaultAnim ? _defaultAnim-&gt;<a class="code" href="class_gr_anim.html#16847f80539915f15a8670858cc08461">GetName</a>() : <span class="stringliteral">""</span> );
<a name="l00856"></a>00856 
<a name="l00858"></a>00858         <a class="code" href="class_u_fast_array.html" title="Purpose: To act like a std::vector, only faster. Avoids.">UFastArray&lt; URef&lt; GrMesh &gt;</a> &gt; meshArray;
<a name="l00859"></a>00859         _root-&gt;<a class="code" href="class_gr_model_node.html#2c131ad23d4aa9b499340a803690e3d0" title="builds a list of all unique meshes in the hierarchy.">BuildMeshList</a>( meshArray );
<a name="l00860"></a>00860         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> meshCount = meshArray.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>();
<a name="l00861"></a>00861 
<a name="l00863"></a>00863         <a class="code" href="class_u_fast_array.html" title="Purpose: To act like a std::vector, only faster. Avoids.">UFastArray&lt; URef&lt; GrSkin &gt;</a> &gt; skinArray;
<a name="l00864"></a>00864         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; meshCount; ++i )
<a name="l00865"></a>00865         {
<a name="l00866"></a>00866                 <a class="code" href="class_gr_skin.html" title="class GrSkin">GrSkin</a>* curSkin = meshArray[ i ]-&gt;GetSkin();
<a name="l00867"></a>00867                 <span class="keywordflow">if</span> ( curSkin != 0 )
<a name="l00868"></a>00868                 {
<a name="l00869"></a>00869                         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0;
<a name="l00870"></a>00870                         <span class="keywordflow">for</span> ( ; j &lt; skinArray.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>(); ++j )
<a name="l00871"></a>00871                         {
<a name="l00872"></a>00872                                 <span class="keywordflow">if</span> ( skinArray[ j ]-&gt;GetName() == curSkin-&gt;<a class="code" href="class_gr_skin.html#ec9baeb9cbd26de5ab8747c8c81a7ff6">GetName</a>() )
<a name="l00873"></a>00873                                         <span class="keywordflow">break</span>;
<a name="l00874"></a>00874                         }
<a name="l00875"></a>00875                         <span class="keywordflow">if</span> ( j == skinArray.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>() )
<a name="l00876"></a>00876                                 skinArray.<a class="code" href="class_u_fast_array.html#23fd2ded4aa241f76b313a925861c828">Push</a>( curSkin );
<a name="l00877"></a>00877                 }
<a name="l00878"></a>00878         }
<a name="l00879"></a>00879 
<a name="l00881"></a>00881         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> skinCount = skinArray.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>();
<a name="l00882"></a>00882         writer.<a class="code" href="class_u_writer.html#2012d798142a97cacf03227395c2e24c">WriteInt</a>( skinCount );
<a name="l00883"></a>00883         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; skinCount; ++i )
<a name="l00884"></a>00884                 skinArray[ i ]-&gt;<a class="code" href="class_gr_model.html#94605ad2262faa9e3e858cd2f9b5d9d1" title="load and save the model. This does not save children.">Save</a>( writer );
<a name="l00885"></a>00885 
<a name="l00887"></a>00887         writer.<a class="code" href="class_u_writer.html#2012d798142a97cacf03227395c2e24c">WriteInt</a>( meshCount );
<a name="l00888"></a>00888         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; meshCount; ++i )
<a name="l00889"></a>00889                 meshArray[ i ]-&gt;<a class="code" href="class_gr_model.html#94605ad2262faa9e3e858cd2f9b5d9d1" title="load and save the model. This does not save children.">Save</a>( writer );
<a name="l00890"></a>00890 
<a name="l00892"></a>00892         _root-&gt;<a class="code" href="class_gr_model_node.html#5232522d893c1b123115f95a6e1b1a7a" title="load and save the node tree.">Save</a>( writer );
<a name="l00893"></a>00893 
<a name="l00895"></a>00895         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lightCount = ( <span class="keywordtype">unsigned</span> <a class="code" href="_g_l_aux_8h.html#b832c174e145540d491b0830fc05dbb1">int</a> )_lights.size();
<a name="l00896"></a>00896         writer.<a class="code" href="class_u_writer.html#2012d798142a97cacf03227395c2e24c">WriteInt</a>( lightCount );
<a name="l00897"></a>00897         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; lightCount; ++i )
<a name="l00898"></a>00898         {
<a name="l00899"></a>00899                 writer.<a class="code" href="class_u_writer.html#bbe55ee0c4a3b202b365da202899d410" title="public methods">WriteString</a>( _lights[ i ].light-&gt;GetName() );
<a name="l00900"></a>00900                 writer.<a class="code" href="class_u_writer.html#bbe55ee0c4a3b202b365da202899d410" title="public methods">WriteString</a>( _lights[ i ].parent-&gt;GetName() );
<a name="l00901"></a>00901         }
<a name="l00902"></a>00902 }
<a name="l00903"></a>00903 
<a name="l00904"></a>00904 <span class="comment">//----------------------------------------------------------</span>
<a name="l00905"></a>00905 <span class="keywordtype">void</span>
<a name="l00906"></a><a class="code" href="class_gr_model.html#b29ae276eab8a6460d09a0f727765c40">00906</a> <a class="code" href="class_gr_model.html#b29ae276eab8a6460d09a0f727765c40" title="forces transforms/bounds to be updated. Internal use only.">GrModel::MarkAsDirty</a>()
<a name="l00907"></a>00907 {
<a name="l00910"></a>00910         _dirty = <span class="keyword">true</span>;
<a name="l00911"></a>00911 }
<a name="l00912"></a>00912 
<a name="l00913"></a>00913 
<a name="l00914"></a>00914 <span class="comment">//==========================================================</span>
<a name="l00916"></a>00916 <span class="comment"></span><span class="comment">//==========================================================</span>
<a name="l00917"></a>00917 
<a name="l00918"></a>00918 <span class="comment">//----------------------------------------------------------</span>
<a name="l00919"></a>00919 <span class="keywordtype">void</span>
<a name="l00920"></a>00920 GrModel::SetInScene( <span class="keywordtype">bool</span> inScene )
<a name="l00921"></a>00921 {
<a name="l00923"></a>00923         <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( _inScene != inScene );
<a name="l00924"></a>00924 
<a name="l00926"></a>00926         LightVec::iterator iter = _lights.begin();
<a name="l00927"></a>00927         LightVec::iterator <a class="code" href="_g_l_8h.html#432111147038972f06e049e18a837002">end</a> = _lights.end();
<a name="l00928"></a>00928         <span class="keywordflow">if</span> ( inScene )
<a name="l00929"></a>00929         {
<a name="l00930"></a>00930                 <span class="keywordflow">for</span> ( ; iter != end; ++iter )
<a name="l00931"></a>00931                         <a class="code" href="_gr_scene_8cpp.html#61317b03beb338f79e32ea73a3e8276b">gGrScene</a>-&gt;<a class="code" href="class_gr_scene.html#edba5aec2c8d98d63416dd3be618a427" title="light management.">AddLight</a>( iter-&gt;light );
<a name="l00932"></a>00932         }
<a name="l00933"></a>00933         <span class="keywordflow">else</span>
<a name="l00934"></a>00934         {
<a name="l00935"></a>00935                 <span class="keywordflow">for</span> ( ; iter != end; ++iter )
<a name="l00936"></a>00936                         <a class="code" href="_gr_scene_8cpp.html#61317b03beb338f79e32ea73a3e8276b">gGrScene</a>-&gt;<a class="code" href="class_gr_scene.html#d164195244a057f9a27808fed5e49a97">RemoveLight</a>( iter-&gt;light );
<a name="l00937"></a>00937         }
<a name="l00938"></a>00938 
<a name="l00940"></a>00940         _inScene = inScene;
<a name="l00941"></a>00941         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> childCount = _children.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>();
<a name="l00942"></a>00942         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; childCount; ++i )
<a name="l00943"></a>00943                 _children[ i ]-&gt;SetInScene( inScene );
<a name="l00944"></a>00944 }
<a name="l00945"></a>00945 
<a name="l00946"></a>00946 <span class="comment">//----------------------------------------------------------</span>
<a name="l00947"></a>00947 <span class="keywordtype">void</span>
<a name="l00948"></a>00948 GrModel::Load( <span class="keyword">const</span> <a class="code" href="class_u_path.html" title="Purpose: To provide a clean way to represent paths strings.">UPath</a>&amp; fileName, <a class="code" href="class_u_reader.html" title="Purpose: To wrap and simplify pointer read operations.">UReader</a>&amp; reader )
<a name="l00949"></a>00949 {
<a name="l00950"></a>00950         Clean();
<a name="l00951"></a>00951 
<a name="l00953"></a>00953         <a class="code" href="common__afx_8h.html#816fa58fd77499b0edb2c69ebe803d5c" title="include BootstrapFS.">tstring</a> <a class="code" href="_g_l_8h.html#7d05960f4f1c1b11f3177dc963a45d86">type</a> = reader.<a class="code" href="class_u_reader.html#2c8ded1a48118dd661e60ce19a6c926a" title="public members">ReadString</a>();
<a name="l00954"></a>00954         <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( type == <span class="stringliteral">"MDL"</span> );
<a name="l00955"></a>00955 
<a name="l00957"></a>00957         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> minorVer = reader.<a class="code" href="class_u_reader.html#4ddc2edc9b761259588297ef1618a68b">ReadShort</a>();
<a name="l00958"></a>00958         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> majorVer = reader.<a class="code" href="class_u_reader.html#4ddc2edc9b761259588297ef1618a68b">ReadShort</a>();
<a name="l00959"></a>00959         <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( majorVer == 1 );
<a name="l00960"></a>00960 
<a name="l00962"></a>00962         _fileName = fileName;
<a name="l00963"></a>00963         _source = reader.<a class="code" href="class_u_reader.html#2c8ded1a48118dd661e60ce19a6c926a" title="public members">ReadString</a>();
<a name="l00964"></a>00964         _author = reader.<a class="code" href="class_u_reader.html#2c8ded1a48118dd661e60ce19a6c926a" title="public members">ReadString</a>();
<a name="l00965"></a>00965 
<a name="l00967"></a>00967         _local.<a class="code" href="class_m_mat4x4.html#3ca6c5ddab80f8b7eb30ec47f4f908c9">Load</a>( reader );
<a name="l00968"></a>00968 
<a name="l00970"></a>00970         <a class="code" href="common__afx_8h.html#816fa58fd77499b0edb2c69ebe803d5c" title="include BootstrapFS.">tstring</a> defaultAnimPath = reader.<a class="code" href="class_u_reader.html#2c8ded1a48118dd661e60ce19a6c926a" title="public members">ReadString</a>();
<a name="l00971"></a>00971         <span class="keywordflow">if</span> ( defaultAnimPath.length() &gt; 0 )
<a name="l00972"></a>00972                 _defaultAnim = <a class="code" href="_gr_k_f_anim_mgr_8cpp.html#832ed58e88601080b1a84e6731772702" title="class header.">gGrKFAnimMgr</a>-&gt;<a class="code" href="class_gr_k_f_anim_mgr.html#bd9ec4d6de5f1bea19523b6352fe1d04" title="public methods">GetKFAnim</a>( defaultAnimPath );
<a name="l00973"></a>00973 
<a name="l00975"></a>00975         <a class="code" href="class_u_fast_array.html" title="Purpose: To act like a std::vector, only faster. Avoids.">UFastArray&lt; URef&lt; GrSkin &gt;</a> &gt; skinArray;
<a name="l00976"></a>00976         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> skinCount = reader.<a class="code" href="class_u_reader.html#e30a8a2deaba30f2dc209781ea1bc16b">ReadInt</a>();
<a name="l00977"></a>00977         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; skinCount; ++i )
<a name="l00978"></a>00978                 skinArray.<a class="code" href="class_u_fast_array.html#23fd2ded4aa241f76b313a925861c828">Push</a>( <span class="keyword">new</span> <a class="code" href="class_gr_skin.html" title="class GrSkin">GrSkin</a>( reader ) );
<a name="l00979"></a>00979 
<a name="l00981"></a>00981         <a class="code" href="class_u_fast_array.html" title="Purpose: To act like a std::vector, only faster. Avoids.">UFastArray&lt; URef&lt; GrMesh &gt;</a> &gt; meshArray;
<a name="l00982"></a>00982         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> meshCount = reader.<a class="code" href="class_u_reader.html#14d2bfe8a38307b1ecb774b70c910c65">ReadUInt</a>();
<a name="l00983"></a>00983         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; meshCount; ++i )
<a name="l00984"></a>00984                 meshArray.<a class="code" href="class_u_fast_array.html#23fd2ded4aa241f76b313a925861c828">Push</a>( <span class="keyword">new</span> <a class="code" href="class_gr_mesh.html" title="class GrMesh">GrMesh</a>( reader, skinArray ) );
<a name="l00985"></a>00985 
<a name="l00987"></a>00987         _root = <span class="keyword">new</span> <a class="code" href="class_gr_model_node.html" title="class GrModelNode">GrModelNode</a>( <span class="keyword">this</span>, reader, meshArray, majorVer, minorVer );
<a name="l00988"></a>00988 
<a name="l00990"></a>00990         <span class="keywordflow">if</span> ( majorVer == 1 &amp;&amp; minorVer &gt;= 1 )
<a name="l00991"></a>00991         {
<a name="l00992"></a>00992                 <a class="code" href="common__afx_8h.html#816fa58fd77499b0edb2c69ebe803d5c" title="include BootstrapFS.">tstring</a> errors;
<a name="l00993"></a>00993                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lightCount = reader.<a class="code" href="class_u_reader.html#14d2bfe8a38307b1ecb774b70c910c65">ReadUInt</a>();
<a name="l00994"></a>00994                 <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; lightCount; ++i )
<a name="l00995"></a>00995                 {
<a name="l00997"></a>00997                         <a class="code" href="common__afx_8h.html#816fa58fd77499b0edb2c69ebe803d5c" title="include BootstrapFS.">tstring</a> lightName = reader.<a class="code" href="class_u_reader.html#2c8ded1a48118dd661e60ce19a6c926a" title="public members">ReadString</a>();
<a name="l00998"></a>00998                         <a class="code" href="common__afx_8h.html#816fa58fd77499b0edb2c69ebe803d5c" title="include BootstrapFS.">tstring</a> parentName = reader.<a class="code" href="class_u_reader.html#2c8ded1a48118dd661e60ce19a6c926a" title="public members">ReadString</a>();
<a name="l00999"></a>00999 
<a name="l01001"></a>01001                         <a class="code" href="class_u_ref.html">URef&lt; GrLight &gt;</a> light = <a class="code" href="_gr_light_mgr_8cpp.html#d2e92e9386149b1b99f9d2e6179019f7" title="class header.">gGrLightMgr</a>-&gt;<a class="code" href="class_gr_light_mgr.html#6e2d2113c8d6092935f4f39ad9e1388d">GetLight</a>( lightName, errors );
<a name="l01002"></a>01002 
<a name="l01004"></a>01004                         <a class="code" href="class_gr_model_node.html" title="class GrModelNode">GrModelNode</a>* parent = 0;
<a name="l01005"></a>01005                         <span class="keywordflow">if</span> ( parentName.length() &gt; 0 )
<a name="l01006"></a>01006                                 parent = _root-&gt;<a class="code" href="class_gr_model_node.html#ea35f9469b11a8a8033f8ad1c7a54c24">FindNode</a>( parentName.c_str(), false );
<a name="l01007"></a>01007 
<a name="l01009"></a>01009                         <a class="code" href="class_gr_model.html#4d7fbb62dd1022da5a5fd25c6cb0e1fc" title="child lights.">AddLight</a>( light, parent );
<a name="l01010"></a>01010                 }
<a name="l01011"></a>01011         }
<a name="l01012"></a>01012 
<a name="l01015"></a>01015         <span class="keywordflow">if</span> ( _defaultAnim != 0 )
<a name="l01016"></a>01016         {
<a name="l01017"></a>01017                 _animPlayer = <span class="keyword">new</span> <a class="code" href="class_gr_anim_player.html" title="class GrAnimPlayer">GrAnimPlayer</a>( <span class="keyword">this</span> );
<a name="l01018"></a>01018                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="keywordtype">id</span> = _animPlayer-&gt;<a class="code" href="class_gr_anim_player.html#1207033fa4b66842478bd2d7d30c7925" title="returns the animation mix ID.">AddAnim</a>( <span class="stringliteral">"default"</span>, _defaultAnim );
<a name="l01019"></a>01019                 _animPlayer-&gt;<a class="code" href="class_gr_anim_player.html#20592a82ff4bd496988566edd6151c61" title="play, pause, etc.">SetActiveAnim</a>( <span class="keywordtype">id</span> );
<a name="l01020"></a>01020                 _animPlayer-&gt;<a class="code" href="class_gr_anim_player.html#8ffa920aacb2bc0682c0b842e7c913a8">Play</a>();
<a name="l01021"></a>01021         }
<a name="l01022"></a>01022 
<a name="l01024"></a>01024         CreateSkinControllers();
<a name="l01025"></a>01025 }
<a name="l01026"></a>01026 
<a name="l01027"></a>01027 <span class="comment">//----------------------------------------------------------</span>
<a name="l01028"></a>01028 <span class="keywordtype">void</span>
<a name="l01029"></a>01029 GrModel::CreateSkinControllers()
<a name="l01030"></a>01030 {
<a name="l01032"></a>01032         _skinControllerCount = GetSkinInstCount( _root );
<a name="l01033"></a>01033 
<a name="l01035"></a>01035         <span class="keywordflow">if</span> ( _skinControllerCount )
<a name="l01036"></a>01036         {
<a name="l01037"></a>01037                 _skinControllers = <span class="keyword">new</span> <a class="code" href="class_gr_model_skin_controller.html" title="class GrModelSkinController">GrModelSkinController</a>[ _skinControllerCount ];
<a name="l01038"></a>01038                 InitSkinControllers( _root, _skinControllers );
<a name="l01039"></a>01039         }
<a name="l01040"></a>01040 }
<a name="l01041"></a>01041 
<a name="l01042"></a>01042 <span class="comment">//----------------------------------------------------------</span>
<a name="l01043"></a>01043 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>
<a name="l01044"></a>01044 GrModel::GetSkinInstCount( <a class="code" href="class_gr_model_node.html" title="class GrModelNode">GrModelNode</a>* root )
<a name="l01045"></a>01045 {
<a name="l01046"></a>01046         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> skinInstCount = 0;
<a name="l01047"></a>01047         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; root-&gt;<a class="code" href="class_gr_model_node.html#34fb55f7a4af15a5d6f241117f62012f" title="mesh instance management.">GetMeshInstCount</a>(); ++i )
<a name="l01048"></a>01048         {
<a name="l01050"></a>01050                 <a class="code" href="class_gr_mesh_inst.html" title="class GrMeshInst">GrMeshInst</a>* curMeshInst = root-&gt;<a class="code" href="class_gr_model_node.html#f5340d3bc303ba7f9211f89e791b013d">GetMeshInst</a>( i );
<a name="l01051"></a>01051                 <span class="keywordflow">if</span> ( curMeshInst-&gt;<a class="code" href="class_gr_mesh_inst.html#08eab6fa5c82f0c5a0b1bbe86f4f6dac" title="skinning instance data.">GetSkinInst</a>() != 0 )
<a name="l01052"></a>01052                         ++skinInstCount;
<a name="l01053"></a>01053         }
<a name="l01054"></a>01054 
<a name="l01056"></a>01056         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; root-&gt;<a class="code" href="class_gr_model_node.html#a21248145ac1e276678ee4e8e1b02b0c" title="child management.">GetChildCount</a>(); ++i )
<a name="l01057"></a>01057                 skinInstCount += GetSkinInstCount( root-&gt;<a class="code" href="class_gr_model_node.html#5b6cf7fff3778f0c4411823132cb5c28">GetChild</a>( i ) );
<a name="l01058"></a>01058 
<a name="l01060"></a>01060         <span class="keywordflow">return</span> skinInstCount;
<a name="l01061"></a>01061 }
<a name="l01062"></a>01062 
<a name="l01063"></a>01063 <span class="comment">//----------------------------------------------------------</span>
<a name="l01064"></a>01064 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>
<a name="l01065"></a>01065 GrModel::InitSkinControllers( <a class="code" href="class_gr_model_node.html" title="class GrModelNode">GrModelNode</a>* root, <a class="code" href="class_gr_model_skin_controller.html" title="class GrModelSkinController">GrModelSkinController</a>* controllers )
<a name="l01066"></a>01066 {
<a name="l01068"></a>01068         <a class="code" href="class_gr_model_skin_controller.html" title="class GrModelSkinController">GrModelSkinController</a>* <a class="code" href="_g_l_8h.html#c55adc720a3098c1b454d2a4647f4361">start</a> = controllers;
<a name="l01069"></a>01069 
<a name="l01071"></a>01071         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; root-&gt;<a class="code" href="class_gr_model_node.html#34fb55f7a4af15a5d6f241117f62012f" title="mesh instance management.">GetMeshInstCount</a>(); ++i )
<a name="l01072"></a>01072         {
<a name="l01075"></a>01075                 <a class="code" href="class_gr_mesh_inst.html" title="class GrMeshInst">GrMeshInst</a>* curMeshInst = root-&gt;<a class="code" href="class_gr_model_node.html#f5340d3bc303ba7f9211f89e791b013d">GetMeshInst</a>( i );
<a name="l01076"></a>01076                 <span class="keywordflow">if</span> ( curMeshInst-&gt;<a class="code" href="class_gr_mesh_inst.html#08eab6fa5c82f0c5a0b1bbe86f4f6dac" title="skinning instance data.">GetSkinInst</a>() != 0 )
<a name="l01077"></a>01077                 {
<a name="l01080"></a>01080                         controllers-&gt;<a class="code" href="class_gr_model_skin_controller.html#84a6d50f21bf0731bccc817506827808" title="this is for array initialization.">Init</a>( curMeshInst-&gt;<a class="code" href="class_gr_mesh_inst.html#08eab6fa5c82f0c5a0b1bbe86f4f6dac" title="skinning instance data.">GetSkinInst</a>(), _root );
<a name="l01081"></a>01081                         ++controllers;
<a name="l01082"></a>01082                 }
<a name="l01083"></a>01083         }
<a name="l01084"></a>01084 
<a name="l01086"></a>01086         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; root-&gt;<a class="code" href="class_gr_model_node.html#a21248145ac1e276678ee4e8e1b02b0c" title="child management.">GetChildCount</a>(); ++i )
<a name="l01087"></a>01087                 controllers += InitSkinControllers( root-&gt;<a class="code" href="class_gr_model_node.html#5b6cf7fff3778f0c4411823132cb5c28">GetChild</a>( i ), controllers );
<a name="l01088"></a>01088 
<a name="l01091"></a>01091         <span class="keywordflow">return</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> )( controllers - start );
<a name="l01092"></a>01092 }
<a name="l01093"></a>01093 
<a name="l01094"></a>01094 <span class="comment">//----------------------------------------------------------</span>
<a name="l01095"></a>01095 <span class="keywordtype">void</span>
<a name="l01096"></a>01096 GrModel::Optimize( <a class="code" href="class_gr_model_node.html" title="class GrModelNode">GrModelNode</a>* root )
<a name="l01097"></a>01097 {
<a name="l01099"></a>01099         root-&gt;<a class="code" href="class_gr_model_node.html#6dd727604b84d6463b1ba282d0702b4a" title="optimize meshes on this node.">Optimize</a>();
<a name="l01100"></a>01100 
<a name="l01102"></a>01102         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; root-&gt;<a class="code" href="class_gr_model_node.html#a21248145ac1e276678ee4e8e1b02b0c" title="child management.">GetChildCount</a>(); ++i )
<a name="l01103"></a>01103                 Optimize( root-&gt;<a class="code" href="class_gr_model_node.html#5b6cf7fff3778f0c4411823132cb5c28">GetChild</a>( i ) );
<a name="l01104"></a>01104 }
<a name="l01105"></a>01105 
<a name="l01106"></a>01106 <span class="comment">//----------------------------------------------------------</span>
<a name="l01107"></a>01107 <span class="keywordtype">void</span>
<a name="l01108"></a>01108 <a class="code" href="class_gr_model.html#0b9f56be2def3c655a5a37ed425539c4" title="retreives all of the mesh instances from the model.">GrModel::GetMeshInsts</a>( <a class="code" href="class_u_fast_array.html">UFastArray&lt; GrMeshInst* &gt;</a>&amp; meshInsts, <a class="code" href="class_gr_model_node.html" title="class GrModelNode">GrModelNode</a>* root )
<a name="l01109"></a>01109 {
<a name="l01111"></a>01111         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> meshInstCount = root-&gt;<a class="code" href="class_gr_model_node.html#34fb55f7a4af15a5d6f241117f62012f" title="mesh instance management.">GetMeshInstCount</a>();
<a name="l01112"></a>01112         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; meshInstCount; ++i )
<a name="l01113"></a>01113                 meshInsts.<a class="code" href="class_u_fast_array.html#23fd2ded4aa241f76b313a925861c828">Push</a>( root-&gt;<a class="code" href="class_gr_model_node.html#f5340d3bc303ba7f9211f89e791b013d">GetMeshInst</a>( i ) );
<a name="l01114"></a>01114 
<a name="l01116"></a>01116         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> childCount = root-&gt;<a class="code" href="class_gr_model_node.html#a21248145ac1e276678ee4e8e1b02b0c" title="child management.">GetChildCount</a>();
<a name="l01117"></a>01117         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; childCount; ++i )
<a name="l01118"></a>01118                 <a class="code" href="class_gr_model.html#0b9f56be2def3c655a5a37ed425539c4" title="retreives all of the mesh instances from the model.">GetMeshInsts</a>( meshInsts, root-&gt;<a class="code" href="class_gr_model_node.html#5b6cf7fff3778f0c4411823132cb5c28">GetChild</a>( i ) );
<a name="l01119"></a>01119 }
<a name="l01120"></a>01120 
<a name="l01121"></a>01121 <span class="comment">//----------------------------------------------------------</span>
<a name="l01122"></a>01122 <span class="keywordtype">bool</span>
<a name="l01123"></a>01123 GrModel::PickNode( <a class="code" href="class_gr_mesh_inst.html" title="class GrMeshInst">GrMeshInst</a>*&amp; meshInst, <a class="code" href="struct_gr_mesh_1_1_s_tri_collision.html" title="triangle collision data.">GrMesh::STriCollision</a>&amp; hit, <a class="code" href="class_gr_model_node.html" title="class GrModelNode">GrModelNode</a>* root, <span class="keyword">const</span> <a class="code" href="class_m_ray.html" title="class MRay">MRay</a>&amp; ray )
<a name="l01124"></a>01124 {
<a name="l01126"></a>01126         <span class="keywordtype">bool</span> meshHit = <span class="keyword">false</span>;
<a name="l01127"></a>01127         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> meshCount = root-&gt;<a class="code" href="class_gr_model_node.html#34fb55f7a4af15a5d6f241117f62012f" title="mesh instance management.">GetMeshInstCount</a>();
<a name="l01128"></a>01128         <span class="keywordtype">float</span> distSqr = FLT_MAX;
<a name="l01129"></a>01129         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; meshCount; ++i )
<a name="l01130"></a>01130         {
<a name="l01132"></a>01132                 <a class="code" href="class_gr_mesh_inst.html" title="class GrMeshInst">GrMeshInst</a>* curMeshInst = root-&gt;<a class="code" href="class_gr_model_node.html#f5340d3bc303ba7f9211f89e791b013d">GetMeshInst</a>( i );
<a name="l01133"></a>01133 
<a name="l01135"></a>01135                 <a class="code" href="struct_gr_mesh_1_1_s_tri_collision.html" title="triangle collision data.">GrMesh::STriCollision</a> curHit;
<a name="l01136"></a>01136                 <span class="keywordflow">if</span> ( curMeshInst-&gt;<a class="code" href="class_gr_mesh_inst.html#5c7494299c0668f3114a1bccb8722bf2" title="picks against the mesh.">Pick</a>( curHit, ray ) )
<a name="l01137"></a>01137                 {
<a name="l01139"></a>01139                         <span class="keywordtype">float</span> curDistSqr = curHit.<a class="code" href="struct_gr_mesh_1_1_s_tri_collision.html#3a4997da126ca2145ef6974ba9f4b6c2">hitLoc</a>.<a class="code" href="class_m_vec3.html#71ac5757ebbfabeacbf4e8337f291d7d">DistSqr</a>( ray.<a class="code" href="class_m_ray.html#50cd4ec247b5df4a4a336478a3a19c91">GetStart</a>() );
<a name="l01140"></a>01140                         <span class="keywordflow">if</span> ( curDistSqr &lt; distSqr )
<a name="l01141"></a>01141                         {
<a name="l01142"></a>01142                                 meshHit = <span class="keyword">true</span>;
<a name="l01143"></a>01143                                 meshInst = curMeshInst;
<a name="l01144"></a>01144                                 distSqr = curDistSqr;
<a name="l01145"></a>01145                                 hit = curHit;
<a name="l01146"></a>01146                         }
<a name="l01147"></a>01147                 }
<a name="l01148"></a>01148         }
<a name="l01149"></a>01149 
<a name="l01151"></a>01151         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> childCount = root-&gt;<a class="code" href="class_gr_model_node.html#a21248145ac1e276678ee4e8e1b02b0c" title="child management.">GetChildCount</a>();
<a name="l01152"></a>01152         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; childCount; ++i )
<a name="l01153"></a>01153         {
<a name="l01155"></a>01155                 <a class="code" href="class_gr_model_node.html" title="class GrModelNode">GrModelNode</a>* curChild = root-&gt;<a class="code" href="class_gr_model_node.html#5b6cf7fff3778f0c4411823132cb5c28">GetChild</a>( i );
<a name="l01156"></a>01156 
<a name="l01158"></a>01158                 <a class="code" href="class_gr_mesh_inst.html" title="class GrMeshInst">GrMeshInst</a>* curMeshInst;
<a name="l01159"></a>01159                 <a class="code" href="struct_gr_mesh_1_1_s_tri_collision.html" title="triangle collision data.">GrMesh::STriCollision</a> curHit;
<a name="l01160"></a>01160                 <span class="keywordflow">if</span> ( PickNode( curMeshInst, curHit, curChild, ray ) )
<a name="l01161"></a>01161                 {
<a name="l01163"></a>01163                         <span class="keywordtype">float</span> curDistSqr = curHit.<a class="code" href="struct_gr_mesh_1_1_s_tri_collision.html#3a4997da126ca2145ef6974ba9f4b6c2">hitLoc</a>.<a class="code" href="class_m_vec3.html#71ac5757ebbfabeacbf4e8337f291d7d">DistSqr</a>( ray.<a class="code" href="class_m_ray.html#50cd4ec247b5df4a4a336478a3a19c91">GetStart</a>() );
<a name="l01164"></a>01164                         <span class="keywordflow">if</span> ( curDistSqr &lt; distSqr )
<a name="l01165"></a>01165                         {
<a name="l01166"></a>01166                                 meshHit = <span class="keyword">true</span>;
<a name="l01167"></a>01167                                 meshInst = curMeshInst;
<a name="l01168"></a>01168                                 distSqr = curDistSqr;
<a name="l01169"></a>01169                                 hit = curHit;
<a name="l01170"></a>01170                         }
<a name="l01171"></a>01171                 }
<a name="l01172"></a>01172         }
<a name="l01173"></a>01173 
<a name="l01175"></a>01175         <span class="keywordflow">return</span> meshHit;
<a name="l01176"></a>01176 }
<a name="l01177"></a>01177 
<a name="l01178"></a>01178 <span class="comment">//----------------------------------------------------------</span>
<a name="l01179"></a>01179 <span class="keywordtype">void</span>
<a name="l01180"></a>01180 GrModel::TraverseNode( <a class="code" href="class_gr_scene_traverser.html" title="class GrSceneTraverser">GrSceneTraverser</a>* traverser, <a class="code" href="class_gr_model_node.html" title="class GrModelNode">GrModelNode</a>* root )
<a name="l01181"></a>01181 {
<a name="l01183"></a>01183         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> meshCount = root-&gt;<a class="code" href="class_gr_model_node.html#34fb55f7a4af15a5d6f241117f62012f" title="mesh instance management.">GetMeshInstCount</a>();
<a name="l01184"></a>01184         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; meshCount; ++i )
<a name="l01185"></a>01185         {
<a name="l01186"></a>01186                 <a class="code" href="class_gr_mesh_inst.html" title="class GrMeshInst">GrMeshInst</a>* meshInst = root-&gt;<a class="code" href="class_gr_model_node.html#f5340d3bc303ba7f9211f89e791b013d">GetMeshInst</a>( i );
<a name="l01187"></a>01187                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rangeCount = meshInst-&gt;<a class="code" href="class_gr_mesh_inst.html#cbd495c05b5c83745059b6d842470607" title="accessors">GetRangeCount</a>();
<a name="l01188"></a>01188                 <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="glext_8h.html#31034e24af8271ed8267858116fe2e48">r</a> = 0; <a class="code" href="glext_8h.html#31034e24af8271ed8267858116fe2e48">r</a> &lt; rangeCount; ++<a class="code" href="glext_8h.html#31034e24af8271ed8267858116fe2e48">r</a> )
<a name="l01189"></a>01189                         traverser-&gt;<a class="code" href="class_gr_scene_traverser.html#4b78a9ad02a45670f5f3f7544ac3f411" title="this is called when there is a mesh instance range.">OnMeshInstRange</a>( meshInst, <a class="code" href="glext_8h.html#31034e24af8271ed8267858116fe2e48">r</a> );
<a name="l01190"></a>01190         }
<a name="l01191"></a>01191 
<a name="l01193"></a>01193         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> childCount = root-&gt;<a class="code" href="class_gr_model_node.html#a21248145ac1e276678ee4e8e1b02b0c" title="child management.">GetChildCount</a>();
<a name="l01194"></a>01194         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; childCount; ++i )
<a name="l01195"></a>01195                 TraverseNode( traverser, root-&gt;<a class="code" href="class_gr_model_node.html#5b6cf7fff3778f0c4411823132cb5c28">GetChild</a>( i ) );
<a name="l01196"></a>01196 }
<a name="l01197"></a>01197 
<a name="l01198"></a>01198 <span class="comment">//----------------------------------------------------------</span>
<a name="l01199"></a>01199 <span class="keywordtype">void</span>
<a name="l01200"></a>01200 GrModel::DbgDrawNode( <a class="code" href="class_gr_model_node.html" title="class GrModelNode">GrModelNode</a>* node )
<a name="l01201"></a>01201 {
<a name="l01202"></a>01202         <a class="code" href="class_m_vec3.html" title="class MVec3">MVec3</a> pos = node-&gt;<a class="code" href="class_gr_model_node.html#2799107e185b3fb30a4429b1bb0cf1f9">GetWorld</a>().<a class="code" href="class_m_mat4x4.html#cb765b649243077af476897147c75919">GetTranslate</a>();
<a name="l01203"></a>01203         <span class="keywordflow">if</span> ( node-&gt;<a class="code" href="class_gr_model_node.html#e203953dfdbddbb5cf35859187a2e749">GetParent</a>() )
<a name="l01204"></a>01204         {
<a name="l01205"></a>01205                 <a class="code" href="class_m_vec3.html" title="class MVec3">MVec3</a> start = node-&gt;<a class="code" href="class_gr_model_node.html#e203953dfdbddbb5cf35859187a2e749">GetParent</a>()-&gt;<a class="code" href="class_gr_model_node.html#2799107e185b3fb30a4429b1bb0cf1f9">GetWorld</a>().<a class="code" href="class_m_mat4x4.html#cb765b649243077af476897147c75919">GetTranslate</a>();
<a name="l01206"></a>01206                 <a class="code" href="_g_l_subsys_8cpp.html#e38cf5086b3c3fb243e11f7e58bb5dd3">bglVertex3f</a>( start.<a class="code" href="class_m_vec3.html#8b834219441d8d65b3e4df28fe03f60f">GetX</a>(), start.<a class="code" href="class_m_vec3.html#dfadf4adb521222d91980376a7679dc8">GetY</a>(), start.<a class="code" href="class_m_vec3.html#8b29390479c105bbb9926188b9742329">GetZ</a>() );
<a name="l01207"></a>01207                 <a class="code" href="_g_l_subsys_8cpp.html#e38cf5086b3c3fb243e11f7e58bb5dd3">bglVertex3f</a>( pos.<a class="code" href="class_m_vec3.html#8b834219441d8d65b3e4df28fe03f60f">GetX</a>(), pos.<a class="code" href="class_m_vec3.html#dfadf4adb521222d91980376a7679dc8">GetY</a>(), pos.<a class="code" href="class_m_vec3.html#8b29390479c105bbb9926188b9742329">GetZ</a>() );
<a name="l01208"></a>01208         }
<a name="l01209"></a>01209         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( _parentNode )
<a name="l01210"></a>01210         {
<a name="l01211"></a>01211                 <a class="code" href="class_m_vec3.html" title="class MVec3">MVec3</a> start = _parentNode-&gt;<a class="code" href="class_gr_model_node.html#2799107e185b3fb30a4429b1bb0cf1f9">GetWorld</a>().<a class="code" href="class_m_mat4x4.html#cb765b649243077af476897147c75919">GetTranslate</a>();
<a name="l01212"></a>01212                 <a class="code" href="_g_l_subsys_8cpp.html#e38cf5086b3c3fb243e11f7e58bb5dd3">bglVertex3f</a>( start.<a class="code" href="class_m_vec3.html#8b834219441d8d65b3e4df28fe03f60f">GetX</a>(), start.<a class="code" href="class_m_vec3.html#dfadf4adb521222d91980376a7679dc8">GetY</a>(), start.<a class="code" href="class_m_vec3.html#8b29390479c105bbb9926188b9742329">GetZ</a>() );
<a name="l01213"></a>01213                 <a class="code" href="_g_l_subsys_8cpp.html#e38cf5086b3c3fb243e11f7e58bb5dd3">bglVertex3f</a>( pos.<a class="code" href="class_m_vec3.html#8b834219441d8d65b3e4df28fe03f60f">GetX</a>(), pos.<a class="code" href="class_m_vec3.html#dfadf4adb521222d91980376a7679dc8">GetY</a>(), pos.<a class="code" href="class_m_vec3.html#8b29390479c105bbb9926188b9742329">GetZ</a>() );
<a name="l01214"></a>01214         }
<a name="l01215"></a>01215 
<a name="l01216"></a>01216         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = node-&gt;<a class="code" href="class_gr_model_node.html#a21248145ac1e276678ee4e8e1b02b0c" title="child management.">GetChildCount</a>();
<a name="l01217"></a>01217         <span class="keywordflow">while</span> ( i-- &gt; 0 )
<a name="l01218"></a>01218                 DbgDrawNode( node-&gt;<a class="code" href="class_gr_model_node.html#5b6cf7fff3778f0c4411823132cb5c28">GetChild</a>( i ) );
<a name="l01219"></a>01219 
<a name="l01220"></a>01220         i = _children.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>();
<a name="l01221"></a>01221         <span class="keywordflow">while</span> ( i-- &gt; 0 )
<a name="l01222"></a>01222                 _children[ i ]-&gt;DbgDrawNode( _children[ i ]-&gt;_root );
<a name="l01223"></a>01223 }
<a name="l01224"></a>01224 
<a name="l01225"></a>01225 <span class="comment">//----------------------------------------------------------</span>
<a name="l01226"></a>01226 <span class="keywordtype">void</span>
<a name="l01227"></a>01227 GrModel::Clean()
<a name="l01228"></a>01228 {
<a name="l01230"></a>01230         <span class="keywordflow">if</span> ( _parent != 0 )
<a name="l01231"></a>01231                 _parent-&gt;<a class="code" href="class_gr_model.html#9148b455251ccd009790f95c126ec936">RemoveChild</a>( <span class="keyword">this</span> );
<a name="l01232"></a>01232 
<a name="l01234"></a>01234         <a class="code" href="class_gr_model.html#79e3bfacd56b97bf810b971f064d4a91">RemoveChildren</a>();
<a name="l01235"></a>01235 
<a name="l01237"></a>01237         <a class="code" href="class_gr_model.html#95abd2705120c297a44287fe1d173224">RemoveLights</a>();
<a name="l01238"></a>01238 
<a name="l01240"></a>01240         <span class="keywordflow">if</span> ( _animPlayer )
<a name="l01241"></a>01241                 <span class="keyword">delete</span> _animPlayer;
<a name="l01242"></a>01242 
<a name="l01244"></a>01244         <span class="keyword">delete</span> _defaultAnim;
<a name="l01245"></a>01245         _defaultAnim = 0;
<a name="l01246"></a>01246 
<a name="l01248"></a>01248         <span class="keyword">delete</span>[] _skinControllers;
<a name="l01249"></a>01249         _skinControllers = 0;
<a name="l01250"></a>01250 
<a name="l01252"></a>01252         <span class="keyword">delete</span> _root;
<a name="l01253"></a>01253         _root = 0;
<a name="l01254"></a>01254 }
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Fri Feb 13 17:19:56 2009 for Bootstrap Engine by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
