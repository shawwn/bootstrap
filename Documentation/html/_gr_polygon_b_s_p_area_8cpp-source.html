<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Bootstrap Engine: C:/Bootstrap/ProjectBX/Documentation/Code/Engine/Graphics/GrPolygonBSPArea.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>C:/Bootstrap/ProjectBX/Documentation/Code/Engine/Graphics/GrPolygonBSPArea.cpp</h1><a href="_gr_polygon_b_s_p_area_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//----------------------------------------------------------</span>
<a name="l00006"></a>00006 <span class="comment"></span><span class="comment">//----------------------------------------------------------</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include "<a class="code" href="graphics__afx_8h.html">graphics_afx.h</a>"</span>
<a name="l00008"></a>00008 
<a name="l00010"></a>00010 <span class="preprocessor">#include "<a class="code" href="_gr_polygon_b_s_p_area_8h.html">GrPolygonBSPArea.h</a>"</span>
<a name="l00011"></a>00011 
<a name="l00013"></a>00013 <span class="preprocessor">#include "<a class="code" href="_gr_polygon_b_s_p_portal_set_8h.html">GrPolygonBSPPortalSet.h</a>"</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include "<a class="code" href="_gr_polygon_b_s_p_portal_8h.html">GrPolygonBSPPortal.h</a>"</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include "<a class="code" href="_gr_polygon_b_s_p_split_8h.html">GrPolygonBSPSplit.h</a>"</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include "<a class="code" href="_gr_polygon_uber_patch_group_8h.html">GrPolygonUberPatchGroup.h</a>"</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include "<a class="code" href="_gr_mesh_inst_8h.html">GrMeshInst.h</a>"</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include "<a class="code" href="_gr_frustum_8h.html">GrFrustum.h</a>"</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include "<a class="code" href="_u_reader_8h.html">UReader.h</a>"</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include "<a class="code" href="_u_writer_8h.html">UWriter.h</a>"</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include "<a class="code" href="_m_ray_8h.html">MRay.h</a>"</span>
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="comment">//#define _NO_PVS</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="comment">//**********************************************************</span>
<a name="l00027"></a>00027 <span class="comment"></span><span class="comment">//**********************************************************</span>
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="comment">//==========================================================</span>
<a name="l00031"></a>00031 <span class="comment"></span><span class="comment">//==========================================================</span>
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="comment">//----------------------------------------------------------</span>
<a name="l00034"></a><a class="code" href="class_gr_polygon_b_s_p_area.html#9fdd7b9d43647ca566f1c00b20fc11ba">00034</a> <a class="code" href="class_gr_polygon_b_s_p_area.html#9fdd7b9d43647ca566f1c00b20fc11ba" title="class header.">GrPolygonBSPArea::GrPolygonBSPArea</a>( <span class="keyword">const</span> <a class="code" href="class_gr_polygon_group.html" title="class GrPolygonGroup">GrPolygonGroup</a>&amp; hullPolygons )
<a name="l00035"></a>00035 : _polygons( hullPolygons )
<a name="l00036"></a>00036 , _uberData( 0 )
<a name="l00037"></a>00037 , _inFlood( false )
<a name="l00038"></a>00038 {
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 }
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="comment">//----------------------------------------------------------</span>
<a name="l00043"></a><a class="code" href="class_gr_polygon_b_s_p_area.html#c7e3331609edd245efdba8ef8b7e8cc4">00043</a> <a class="code" href="class_gr_polygon_b_s_p_area.html#9fdd7b9d43647ca566f1c00b20fc11ba" title="class header.">GrPolygonBSPArea::GrPolygonBSPArea</a>( <a class="code" href="class_u_reader.html" title="Purpose: To wrap and simplify pointer read operations.">UReader</a>&amp; reader )
<a name="l00044"></a>00044 : _inFlood( false )
<a name="l00045"></a>00045 {
<a name="l00046"></a>00046         <a class="code" href="class_gr_polygon_b_s_p_area.html#034f884ac7b83c468d3b1d2947950013" title="leaf load/save.">Load</a>( reader );
<a name="l00047"></a>00047 }
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="comment">//----------------------------------------------------------</span>
<a name="l00050"></a><a class="code" href="class_gr_polygon_b_s_p_area.html#5892b7c346ad8b00b9c384211e9ed12d">00050</a> <a class="code" href="class_gr_polygon_b_s_p_area.html#5892b7c346ad8b00b9c384211e9ed12d">GrPolygonBSPArea::~GrPolygonBSPArea</a>()
<a name="l00051"></a>00051 {
<a name="l00052"></a>00052         Clean();
<a name="l00053"></a>00053 }
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="comment">//==========================================================</span>
<a name="l00058"></a>00058 <span class="comment"></span><span class="comment">//==========================================================</span>
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="comment">//----------------------------------------------------------</span>
<a name="l00061"></a>00061 <span class="keywordtype">void</span>
<a name="l00062"></a><a class="code" href="class_gr_polygon_b_s_p_area.html#15324cca2e63613b45d88de81b4f8666">00062</a> <a class="code" href="class_gr_polygon_b_s_p_area.html#15324cca2e63613b45d88de81b4f8666" title="returns a pointer to the list of visibility info.">GrPolygonBSPArea::GetVisibilityData</a>( <span class="keyword">const</span> std::vector&lt; unsigned int &gt;** pvsIndices )<span class="keyword"> const</span>
<a name="l00063"></a>00063 <span class="keyword"></span>{
<a name="l00064"></a>00064         <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( pvsIndices != 0 );
<a name="l00065"></a>00065         *pvsIndices = &amp;_pvsIndices;
<a name="l00066"></a>00066 }
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="comment">//----------------------------------------------------------</span>
<a name="l00069"></a>00069 <span class="keyword">const</span> <a class="code" href="class_m_a_a_box.html" title="class MAABox">MAABox</a>&amp;
<a name="l00070"></a><a class="code" href="class_gr_polygon_b_s_p_area.html#dab93dce455697f234e10a72b57806c9">00070</a> <a class="code" href="class_gr_polygon_b_s_p_area.html#dab93dce455697f234e10a72b57806c9" title="mark the area as visible.">GrPolygonBSPArea::GetBoundingAABox</a>()<span class="keyword"> const</span>
<a name="l00071"></a>00071 <span class="keyword"></span>{
<a name="l00072"></a>00072         <span class="keywordflow">return</span> _polygons.<a class="code" href="class_gr_polygon_group.html#f036e17871ac905b28a8e9c90da6d0e6">GetAABox</a>();
<a name="l00073"></a>00073 }
<a name="l00074"></a>00074 
<a name="l00075"></a>00075 <span class="comment">//----------------------------------------------------------</span>
<a name="l00076"></a>00076 <a class="code" href="class_m_sphere.html" title="class MSphere">MSphere</a>
<a name="l00077"></a><a class="code" href="class_gr_polygon_b_s_p_area.html#3cc8969be9caa17c5beae9ff355ea462">00077</a> <a class="code" href="class_gr_polygon_b_s_p_area.html#3cc8969be9caa17c5beae9ff355ea462">GrPolygonBSPArea::GetBoundingSphere</a>()<span class="keyword"> const</span>
<a name="l00078"></a>00078 <span class="keyword"></span>{
<a name="l00079"></a>00079         <span class="keywordflow">return</span> _polygons.<a class="code" href="class_gr_polygon_group.html#ebce104e3d59538c74e2701e98542afa" title="returns a volume that encompasses all polygons.">GetBoundingSphere</a>();
<a name="l00080"></a>00080 }
<a name="l00081"></a>00081 
<a name="l00082"></a>00082 <span class="comment">//----------------------------------------------------------</span>
<a name="l00083"></a>00083 <span class="keywordtype">void</span>
<a name="l00084"></a><a class="code" href="class_gr_polygon_b_s_p_area.html#ced30316ed0ae05a05b8b5242ae9cc73">00084</a> <a class="code" href="class_gr_polygon_b_s_p_area.html#ced30316ed0ae05a05b8b5242ae9cc73" title="generate ubertexture data.">GrPolygonBSPArea::GenUberTexData</a>( <span class="keywordtype">float</span> texelsPerMeter )
<a name="l00085"></a>00085 {
<a name="l00088"></a>00088         _uberData = <span class="keyword">new</span> <a class="code" href="class_gr_polygon_uber_patch_group.html" title="class GrPolygonUberPatchGroup">GrPolygonUberPatchGroup</a>( &amp;_polygons, texelsPerMeter );
<a name="l00089"></a>00089 }
<a name="l00090"></a>00090 
<a name="l00091"></a>00091 <span class="comment">//----------------------------------------------------------</span>
<a name="l00092"></a>00092 <span class="keywordtype">void</span>
<a name="l00093"></a><a class="code" href="class_gr_polygon_b_s_p_area.html#e32bb3ed77dc93651dbbaaf8ae55b5c8">00093</a> <a class="code" href="class_gr_polygon_b_s_p_area.html#e32bb3ed77dc93651dbbaaf8ae55b5c8" title="adds a portal.">GrPolygonBSPArea::AddPortal</a>( <a class="code" href="class_gr_polygon_b_s_p_portal_set.html" title="class GrPolygonBSPPortalSet">GrPolygonBSPPortalSet</a>* portal )
<a name="l00094"></a>00094 {
<a name="l00096"></a>00096         portal-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#bf746cf2cfeaf5b44a803625986ba073" title="area management.">SetOwner</a>( <span class="keyword">this</span> );
<a name="l00097"></a>00097 
<a name="l00100"></a>00100 <span class="preprocessor">#if 0</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span>        <span class="keyword">const</span> <a class="code" href="class_m_plane.html" title="class MPlane">MPlane</a>&amp; portalPlane = portal-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#c58d0feb66fa4c5d875df0d25e7ad352">GetPlane</a>();
<a name="l00102"></a>00102         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> portalCount = _portals.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>();
<a name="l00103"></a>00103         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; portalCount; ++i )
<a name="l00104"></a>00104         {
<a name="l00105"></a>00105                 <a class="code" href="class_gr_polygon_b_s_p_portal_set.html" title="class GrPolygonBSPPortalSet">GrPolygonBSPPortalSet</a> frontTemp;
<a name="l00106"></a>00106                 <a class="code" href="class_gr_polygon_b_s_p_portal_set.html" title="class GrPolygonBSPPortalSet">GrPolygonBSPPortalSet</a> backTemp;
<a name="l00107"></a>00107                 <span class="keywordtype">int</span> ret = _portals[ i ]-&gt;Split( frontTemp, backTemp, portalPlane, 5.0f );
<a name="l00108"></a>00108                 <span class="keywordflow">if</span> ( ret &gt;= 0 &amp;&amp; frontTemp.<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#d159b8572928f77a50b23264da9a95ac" title="generate frustums from portal geometry.">GetPortalCount</a>() &gt; 0 )
<a name="l00109"></a>00109                 {
<a name="l00110"></a>00110                         frontTemp.<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#bf746cf2cfeaf5b44a803625986ba073" title="area management.">SetOwner</a>( <span class="keyword">this</span> );
<a name="l00111"></a>00111                         *_portals[ i ] = frontTemp;
<a name="l00112"></a>00112                 }
<a name="l00113"></a>00113                 <span class="keywordflow">else</span>
<a name="l00114"></a>00114                         _portals.<a class="code" href="class_u_fast_array.html#eef6f5a281cb95cf277c33714117ab05">Erase</a>( i-- );
<a name="l00115"></a>00115 <span class="comment">//              B_ASSERT( ret &gt;= 0 );/* ||</span>
<a name="l00116"></a>00116 <span class="comment">//                      ( </span>
<a name="l00117"></a>00117 <span class="comment">//                              Abs( portalPlane.GetNormal().Dot( _portals[ i ]-&gt;GetPlane().GetNormal() ) ) &gt; 0.95f &amp;&amp;</span>
<a name="l00118"></a>00118 <span class="comment">//                              ( Abs( portalPlane.GetD() ) - Abs( _portals[ i ]-&gt;GetPlane().GetD() ) ) &lt; 0.1f</span>
<a name="l00119"></a>00119 <span class="comment">//                      )</span>
<a name="l00120"></a>00120 <span class="comment">//              );*/</span>
<a name="l00121"></a>00121         }
<a name="l00122"></a>00122 <span class="preprocessor">#endif</span>
<a name="l00123"></a>00123 <span class="preprocessor"></span>
<a name="l00125"></a>00125         <span class="keywordflow">if</span> ( SubtractAreaFromPortal( portal, <span class="keyword">this</span> ) )
<a name="l00126"></a>00126                 _portals.<a class="code" href="class_u_fast_array.html#23fd2ded4aa241f76b313a925861c828">Push</a>( portal );
<a name="l00127"></a>00127         <span class="keywordflow">else</span>
<a name="l00128"></a>00128                 <span class="keyword">delete</span> portal;
<a name="l00129"></a>00129 }
<a name="l00130"></a>00130 
<a name="l00131"></a>00131 <span class="comment">//----------------------------------------------------------</span>
<a name="l00132"></a>00132 <span class="keywordtype">void</span>
<a name="l00133"></a><a class="code" href="class_gr_polygon_b_s_p_area.html#5149561c0870fd83f3a77d3e9b94072e">00133</a> <a class="code" href="class_gr_polygon_b_s_p_area.html#5149561c0870fd83f3a77d3e9b94072e">GrPolygonBSPArea::FindNeighbors</a>( <a class="code" href="class_gr_polygon_b_s_p_split.html" title="class GrPolygonBSPSplit">GrPolygonBSPSplit</a>* root )
<a name="l00134"></a>00134 {
<a name="l00138"></a>00138         std::vector&lt; GrPolygonBSPPortalSet* &gt; neighborLinks;
<a name="l00139"></a>00139         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> portalSetCount = _portals.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>();
<a name="l00140"></a>00140         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; portalSetCount; ++i )
<a name="l00141"></a>00141         {
<a name="l00144"></a>00144                 <a class="code" href="class_gr_polygon_b_s_p_portal_set.html" title="class GrPolygonBSPPortalSet">GrPolygonBSPPortalSet</a>* reversed = <span class="keyword">new</span> <a class="code" href="class_gr_polygon_b_s_p_portal_set.html" title="class GrPolygonBSPPortalSet">GrPolygonBSPPortalSet</a>( *_portals[ i ] );
<a name="l00145"></a>00145                 reversed-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#c5ed27275dfb126e94fbf1da5a5e787f" title="reverses the winding of all portals in the set.">ReverseWinding</a>();
<a name="l00146"></a>00146                 FindPortalSetNeighbors( neighborLinks, root, reversed );
<a name="l00147"></a>00147                 <span class="keyword">delete</span> _portals[ i ];
<a name="l00148"></a>00148         }
<a name="l00149"></a>00149 
<a name="l00151"></a>00151         _portals.<a class="code" href="class_u_fast_array.html#97c6c9910cc6e541254eaaaa530d48a9">Clear</a>();
<a name="l00152"></a>00152         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> neighborCount = ( <span class="keywordtype">unsigned</span> <a class="code" href="_g_l_aux_8h.html#b832c174e145540d491b0830fc05dbb1">int</a> )neighborLinks.size();
<a name="l00153"></a>00153         <span class="keywordflow">for</span>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; neighborCount; ++i )
<a name="l00154"></a>00154                 _portals.<a class="code" href="class_u_fast_array.html#23fd2ded4aa241f76b313a925861c828">Push</a>( neighborLinks[ i ] );
<a name="l00155"></a>00155 
<a name="l00157"></a>00157 <span class="comment">//      CalcPortalBounds();</span>
<a name="l00158"></a>00158 }
<a name="l00159"></a>00159 
<a name="l00160"></a>00160 <span class="comment">//----------------------------------------------------------</span>
<a name="l00161"></a>00161 <span class="keywordtype">void</span>
<a name="l00162"></a><a class="code" href="class_gr_polygon_b_s_p_area.html#2d77bc4b77ace5d859713e906db5e295">00162</a> <a class="code" href="class_gr_polygon_b_s_p_area.html#2d77bc4b77ace5d859713e906db5e295" title="checks neighbors for any tjunctions and fixes them.">GrPolygonBSPArea::FixTJuncs</a>()
<a name="l00163"></a>00163 {
<a name="l00165"></a>00165         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> portalSetCount = _portals.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>();
<a name="l00166"></a>00166         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; portalSetCount; ++i )
<a name="l00167"></a>00167         {
<a name="l00169"></a>00169                 <a class="code" href="class_gr_polygon_b_s_p_area.html" title="class GrPolygonBSPArea">GrPolygonBSPArea</a>* curNeighbor = _portals[ i ]-&gt;GetNeighbor();
<a name="l00170"></a>00170                 <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( curNeighbor != 0 );
<a name="l00171"></a>00171 
<a name="l00173"></a>00173                 _polygons.<a class="code" href="class_gr_polygon_group.html#1f1f0c55854848f37a12efe4f0bb1819" title="builds a palette of planes to use for splitting from the geometry in the group.">FixTJuncs</a>( curNeighbor-&gt;<a class="code" href="class_gr_polygon_b_s_p_area.html#1ef46b31e200203f49c92eb5c5890cd3" title="group of polygons and a temporary renderable mesh.">_polygons</a>, <a class="code" href="_gr_config_8h.html#9a0c3a6e273be90e493ad8592f587865">GR_BSP_TJUNC_EPSILON</a> );
<a name="l00174"></a>00174         }
<a name="l00175"></a>00175 }
<a name="l00176"></a>00176 
<a name="l00177"></a>00177 <span class="comment">//----------------------------------------------------------</span>
<a name="l00178"></a>00178 <span class="keywordtype">void</span>
<a name="l00179"></a><a class="code" href="class_gr_polygon_b_s_p_area.html#93c40f74ada66587db01a2c044421d02">00179</a> <a class="code" href="class_gr_polygon_b_s_p_area.html#93c40f74ada66587db01a2c044421d02" title="builds a list of visible leaves.">GrPolygonBSPArea::CalcPVS</a>( <span class="keyword">const</span> std::vector&lt; GrPolygonBSPArea* &gt;&amp; leaves )
<a name="l00180"></a>00180 {
<a name="l00181"></a>00181 <span class="preprocessor">#if !defined _NO_PVS</span>
<a name="l00182"></a>00182 <span class="preprocessor"></span><span class="preprocessor"> #if 0</span>
<a name="l00184"></a>00184 <span class="preprocessor">        std::set&lt; GrPolygonBSPArea* &gt; visibleSet;</span>
<a name="l00185"></a>00185 <span class="preprocessor"></span>        visibleSet.insert( <span class="keyword">this</span> );
<a name="l00186"></a>00186 
<a name="l00188"></a>00188         std::vector&lt; GrPolygonBSPArea* &gt;::const_iterator iter = leaves.begin();
<a name="l00189"></a>00189         <span class="keyword">const</span> std::vector&lt; GrPolygonBSPArea* &gt;::const_iterator <a class="code" href="_g_l_8h.html#432111147038972f06e049e18a837002">end</a> = leaves.end();
<a name="l00190"></a>00190         <span class="keywordflow">for</span> ( ; iter != end; ++iter )
<a name="l00191"></a>00191         {
<a name="l00193"></a>00193                 <span class="keywordflow">if</span> ( *iter == <span class="keyword">this</span> )
<a name="l00194"></a>00194                         <span class="keywordflow">continue</span>;
<a name="l00195"></a>00195 
<a name="l00197"></a>00197                 <span class="keywordflow">if</span> ( CheckVisibility( *iter ) )
<a name="l00198"></a>00198                         visibleSet.insert( *iter );
<a name="l00199"></a>00199         }
<a name="l00200"></a>00200 <span class="preprocessor"> #else</span>
<a name="l00202"></a>00202 <span class="preprocessor">        std::set&lt; GrPolygonBSPArea* &gt; visibleSet;</span>
<a name="l00203"></a>00203 <span class="preprocessor"></span>        visibleSet.insert( <span class="keyword">this</span> );
<a name="l00204"></a>00204 
<a name="l00206"></a>00206         _inFlood = <span class="keyword">true</span>;
<a name="l00207"></a>00207 
<a name="l00209"></a>00209         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> portalSetCount = _portals.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>();
<a name="l00210"></a>00210         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; portalSetCount; ++i )
<a name="l00211"></a>00211         {
<a name="l00213"></a>00213                 <a class="code" href="class_gr_polygon_b_s_p_area.html" title="class GrPolygonBSPArea">GrPolygonBSPArea</a>* neighbor = _portals[ i ]-&gt;GetNeighbor();
<a name="l00214"></a>00214                 <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( neighbor != 0 &amp;&amp; neighbor != <span class="keyword">this</span> );
<a name="l00215"></a>00215 
<a name="l00217"></a>00217                 <span class="keywordflow">if</span> ( neighbor-&gt;<a class="code" href="class_gr_polygon_b_s_p_area.html#63247847ab821f68c3c8d6b166ebc419" title="local polygons.">GetPolygons</a>().<a class="code" href="class_gr_polygon_group.html#3e0a4ae8030ded12301495eed40135df" title="polygon iteration">GetPolygonCount</a>() == 0 )
<a name="l00218"></a>00218                         <span class="keywordflow">continue</span>;
<a name="l00219"></a>00219 
<a name="l00221"></a>00221                 <a class="code" href="class_gr_polygon_b_s_p_portal_set.html" title="class GrPolygonBSPPortalSet">GrPolygonBSPPortalSet</a>* curPortalSet = _portals[ i ];
<a name="l00222"></a>00222 
<a name="l00224"></a>00224                 <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> portalCount = curPortalSet-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#d159b8572928f77a50b23264da9a95ac" title="generate frustums from portal geometry.">GetPortalCount</a>();
<a name="l00225"></a>00225                 <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; portalCount; ++j )
<a name="l00226"></a>00226                 {
<a name="l00228"></a>00228                         <span class="keyword">const</span> <a class="code" href="class_gr_portal.html" title="class GrPortal">GrPortal</a>&amp; curPortal = curPortalSet-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#e771e0ac35b02fd0f7c229121e50e561">GetPortal</a>( j );
<a name="l00229"></a>00229                         std::vector&lt; MPlane &gt; temp;
<a name="l00230"></a>00230                         neighbor-&gt;<a class="code" href="class_gr_polygon_b_s_p_area.html#d5cd0189039e2ea0153600516522c992">FloodPVS</a>( visibleSet, temp, curPortal, curPortalSet-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#c4ae6e28d3a43e9dea180ba4c1b05f47">GetCreator</a>() );
<a name="l00231"></a>00231                 }
<a name="l00232"></a>00232         }
<a name="l00233"></a>00233 
<a name="l00235"></a>00235         std::set&lt; GrPolygonBSPArea* &gt;::iterator iter = visibleSet.begin();
<a name="l00236"></a>00236         <span class="keyword">const</span> std::set&lt; GrPolygonBSPArea* &gt;::iterator end = visibleSet.end();
<a name="l00237"></a>00237         <span class="keywordflow">for</span> ( ; iter != end; ++iter )
<a name="l00238"></a>00238         {
<a name="l00239"></a>00239                 _pvsVector.push_back( *iter );
<a name="l00240"></a>00240         }
<a name="l00241"></a>00241 
<a name="l00243"></a>00243         _inFlood = <span class="keyword">false</span>;
<a name="l00244"></a>00244 <span class="preprocessor"> #endif</span>
<a name="l00245"></a>00245 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00246"></a>00246 <span class="preprocessor"></span>
<a name="l00247"></a>00247 <span class="preprocessor">#endif</span>
<a name="l00248"></a>00248 <span class="preprocessor"></span>}
<a name="l00249"></a>00249 
<a name="l00250"></a>00250 <span class="comment">//----------------------------------------------------------</span>
<a name="l00251"></a>00251 <span class="keywordtype">void</span>
<a name="l00252"></a><a class="code" href="class_gr_polygon_b_s_p_area.html#e35cc92d44e0aed14c6b6d3dcc40ea40">00252</a> <a class="code" href="class_gr_polygon_b_s_p_area.html#e35cc92d44e0aed14c6b6d3dcc40ea40" title="sets PVS to all leaves.">GrPolygonBSPArea::CalcPVSAllVisibleIndices</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> leafCount )
<a name="l00253"></a>00253 {
<a name="l00254"></a>00254         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; leafCount; ++i )
<a name="l00255"></a>00255                 _pvsIndices.push_back( i );
<a name="l00256"></a>00256 }
<a name="l00257"></a>00257 
<a name="l00258"></a>00258 <span class="comment">//----------------------------------------------------------</span>
<a name="l00259"></a>00259 <span class="keywordtype">void</span>
<a name="l00260"></a><a class="code" href="class_gr_polygon_b_s_p_area.html#1b7856f8931a29e532bb823fe9d0c78f">00260</a> <a class="code" href="class_gr_polygon_b_s_p_area.html#1b7856f8931a29e532bb823fe9d0c78f" title="compresses PVS data to a list of indices into the array passed in.">GrPolygonBSPArea::CompressPVSData</a>( <span class="keyword">const</span> std::vector&lt; GrPolygonBSPArea* &gt;&amp; leaves )
<a name="l00261"></a>00261 {
<a name="l00262"></a>00262 <span class="preprocessor">#if !defined _NO_PVS</span>
<a name="l00263"></a>00263 <span class="preprocessor"></span>        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pvsItemCount = ( <span class="keywordtype">unsigned</span> <a class="code" href="_g_l_aux_8h.html#b832c174e145540d491b0830fc05dbb1">int</a> )_pvsVector.size();
<a name="l00264"></a>00264         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; pvsItemCount; ++i )
<a name="l00265"></a>00265         {
<a name="l00266"></a>00266                 <a class="code" href="class_gr_polygon_b_s_p_area.html" title="class GrPolygonBSPArea">GrPolygonBSPArea</a>* curArea = _pvsVector[ i ];
<a name="l00267"></a>00267                 <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> leafCount = ( <span class="keywordtype">unsigned</span> <a class="code" href="_g_l_aux_8h.html#b832c174e145540d491b0830fc05dbb1">int</a> )leaves.size();
<a name="l00268"></a>00268                 <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; leafCount; ++j )
<a name="l00269"></a>00269                 {
<a name="l00271"></a>00271                         <span class="keywordflow">if</span> ( curArea == leaves[ j ] )
<a name="l00272"></a>00272                         {
<a name="l00273"></a>00273                                 _pvsIndices.push_back( j );
<a name="l00274"></a>00274                                 <span class="keywordflow">break</span>;
<a name="l00275"></a>00275                         }
<a name="l00276"></a>00276                 }
<a name="l00277"></a>00277         }
<a name="l00278"></a>00278 <span class="preprocessor">#else</span>
<a name="l00279"></a>00279 <span class="preprocessor"></span>        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> leafCount = ( <span class="keywordtype">unsigned</span> <a class="code" href="_g_l_aux_8h.html#b832c174e145540d491b0830fc05dbb1">int</a> )leaves.size();
<a name="l00280"></a>00280         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; leafCount; ++j )
<a name="l00281"></a>00281                 _pvsIndices.push_back( j );     
<a name="l00282"></a>00282 <span class="preprocessor">#endif</span>
<a name="l00283"></a>00283 <span class="preprocessor"></span>}
<a name="l00284"></a>00284 
<a name="l00285"></a>00285 <span class="comment">//----------------------------------------------------------</span>
<a name="l00286"></a>00286 <span class="keywordtype">bool</span>
<a name="l00287"></a><a class="code" href="class_gr_polygon_b_s_p_area.html#6e7ef012b866a7d4d69e8fec2aa10ff3">00287</a> <a class="code" href="class_gr_polygon_b_s_p_area.html#6e7ef012b866a7d4d69e8fec2aa10ff3" title="checks for an intersection with the ray passed in.">GrPolygonBSPArea::GetIntersect</a>( <a class="code" href="class_m_vec3.html" title="class MVec3">MVec3</a>&amp; hitPos, <span class="keyword">const</span> <a class="code" href="class_m_ray.html" title="class MRay">MRay</a>&amp; ray, <span class="keywordtype">float</span> maxDist )
<a name="l00288"></a>00288 {
<a name="l00290"></a>00290         <span class="keywordflow">if</span> ( !ray.<a class="code" href="class_m_ray.html#d58f4fca993f73968696e69fa58f4a93" title="returns true if the ray intersects with the box provided.">Intersect</a>( <a class="code" href="class_gr_polygon_b_s_p_area.html#dab93dce455697f234e10a72b57806c9" title="mark the area as visible.">GetBoundingAABox</a>(), maxDist ) )
<a name="l00291"></a>00291                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00292"></a>00292 
<a name="l00294"></a>00294         <a class="code" href="struct_s_vec3.html" title="struct SVec3">SVec3</a> rayStart = ray.<a class="code" href="class_m_ray.html#50cd4ec247b5df4a4a336478a3a19c91">GetStart</a>();
<a name="l00295"></a>00295         <a class="code" href="struct_s_vec3.html" title="struct SVec3">SVec3</a> rayDir = ray.<a class="code" href="class_m_ray.html#cd7ab740f3c8ff43dd79f95ed9a969b6">GetDir</a>();
<a name="l00296"></a>00296         <span class="keywordtype">float</span> bestDist = FLT_MAX;
<a name="l00297"></a>00297         <a class="code" href="struct_gr_polygon_1_1_s_ray_intersect_info.html">GrPolygon::SRayIntersectInfo</a> rayIntersectInfo;
<a name="l00298"></a>00298 
<a name="l00300"></a>00300         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = _polygons.<a class="code" href="class_gr_polygon_group.html#3e0a4ae8030ded12301495eed40135df" title="polygon iteration">GetPolygonCount</a>();
<a name="l00301"></a>00301         <span class="keywordflow">while</span> ( i-- &gt; 0 )
<a name="l00302"></a>00302         {
<a name="l00304"></a>00304                 <span class="keyword">const</span> <a class="code" href="class_gr_polygon.html" title="class GrPolygon">GrPolygon</a>&amp; curPolygon = _polygons.<a class="code" href="class_gr_polygon_group.html#267706848b196a4f1b7b0ebdeeb7188e">GetPolygon</a>( i );
<a name="l00305"></a>00305                 <span class="keywordflow">if</span> ( curPolygon.<a class="code" href="class_gr_polygon.html#45191c8b4b5ee1943e690e27e4110562">Intersect</a>( rayIntersectInfo, rayStart, rayDir, maxDist ) )
<a name="l00306"></a>00306                 {
<a name="l00307"></a>00307                         <span class="keywordflow">if</span> ( rayIntersectInfo.<a class="code" href="struct_gr_polygon_1_1_s_ray_intersect_info.html#6c39b205f7e2f9fb4490a87df5a55d24">hitDist</a> &lt; bestDist )
<a name="l00308"></a>00308                         {
<a name="l00309"></a>00309                                 bestDist = rayIntersectInfo.<a class="code" href="struct_gr_polygon_1_1_s_ray_intersect_info.html#6c39b205f7e2f9fb4490a87df5a55d24">hitDist</a>;
<a name="l00310"></a>00310                                 hitPos = rayIntersectInfo.<a class="code" href="struct_gr_polygon_1_1_s_ray_intersect_info.html#087c70a3931cf6fcafc953d94954bcb8">hitLoc</a>;
<a name="l00311"></a>00311                         }
<a name="l00312"></a>00312                 }
<a name="l00313"></a>00313         }
<a name="l00314"></a>00314 
<a name="l00315"></a>00315         <span class="keywordflow">return</span> bestDist &lt; FLT_MAX;
<a name="l00316"></a>00316 }
<a name="l00317"></a>00317 
<a name="l00318"></a>00318 <span class="comment">//----------------------------------------------------------</span>
<a name="l00319"></a>00319 <span class="keywordtype">void</span>
<a name="l00320"></a><a class="code" href="class_gr_polygon_b_s_p_area.html#6985c4d6183a19c0bc0df57f8aa2c8fb">00320</a> <a class="code" href="class_gr_polygon_b_s_p_area.html#6985c4d6183a19c0bc0df57f8aa2c8fb" title="returns the ubertexture data for the current area.">GrPolygonBSPArea::GetUberTexData</a>( std::vector&lt; GrPolygonUberPatchGroup* &gt;&amp; dataArray )<span class="keyword"> const</span>
<a name="l00321"></a>00321 <span class="keyword"></span>{
<a name="l00322"></a>00322         <span class="keywordflow">if</span> ( _uberData )
<a name="l00323"></a>00323                 dataArray.push_back( _uberData );
<a name="l00324"></a>00324 }
<a name="l00325"></a>00325 
<a name="l00326"></a>00326 <span class="comment">//----------------------------------------------------------</span>
<a name="l00327"></a>00327 <span class="keywordtype">void</span>
<a name="l00328"></a><a class="code" href="class_gr_polygon_b_s_p_area.html#034f884ac7b83c468d3b1d2947950013">00328</a> <a class="code" href="class_gr_polygon_b_s_p_area.html#034f884ac7b83c468d3b1d2947950013" title="leaf load/save.">GrPolygonBSPArea::Load</a>( <a class="code" href="class_u_reader.html" title="Purpose: To wrap and simplify pointer read operations.">UReader</a>&amp; reader )
<a name="l00329"></a>00329 {
<a name="l00330"></a>00330         Clean();
<a name="l00331"></a>00331 
<a name="l00333"></a>00333         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> polyCount = reader.<a class="code" href="class_u_reader.html#14d2bfe8a38307b1ecb774b70c910c65">ReadUInt</a>();
<a name="l00334"></a>00334         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; polyCount; ++i )
<a name="l00335"></a>00335                 _polygons.<a class="code" href="class_gr_polygon_group.html#2f06fcddd6fd04a28b8ae8682a36d508" title="polygon management.">AddPolygon</a>( <a class="code" href="class_gr_polygon.html" title="class GrPolygon">GrPolygon</a>( reader ) );
<a name="l00336"></a>00336 
<a name="l00338"></a>00338         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pvsCount = reader.<a class="code" href="class_u_reader.html#14d2bfe8a38307b1ecb774b70c910c65">ReadUInt</a>();
<a name="l00339"></a>00339         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; pvsCount; ++i )
<a name="l00340"></a>00340                 _pvsIndices.push_back( reader.<a class="code" href="class_u_reader.html#14d2bfe8a38307b1ecb774b70c910c65">ReadUInt</a>() );
<a name="l00341"></a>00341 }
<a name="l00342"></a>00342 
<a name="l00343"></a>00343 <span class="comment">//----------------------------------------------------------</span>
<a name="l00344"></a>00344 <span class="keywordtype">void</span>
<a name="l00345"></a><a class="code" href="class_gr_polygon_b_s_p_area.html#22eb539982e6f805ef94c58294940aeb">00345</a> <a class="code" href="class_gr_polygon_b_s_p_area.html#22eb539982e6f805ef94c58294940aeb">GrPolygonBSPArea::Save</a>( <a class="code" href="class_u_writer.html" title="Purpose: To wrap and simplify pointer write operations.">UWriter</a>&amp; writer )
<a name="l00346"></a>00346 {
<a name="l00348"></a>00348         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> polyCount = _polygons.<a class="code" href="class_gr_polygon_group.html#3e0a4ae8030ded12301495eed40135df" title="polygon iteration">GetPolygonCount</a>();
<a name="l00349"></a>00349         writer.<a class="code" href="class_u_writer.html#a1f6d44d3988a40cc188ab237c5edc0a">WriteUInt</a>( polyCount );
<a name="l00350"></a>00350         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; polyCount; ++i )
<a name="l00351"></a>00351                 _polygons.<a class="code" href="class_gr_polygon_group.html#267706848b196a4f1b7b0ebdeeb7188e">GetPolygon</a>( i ).<a class="code" href="class_gr_polygon.html#8124d42ce98f591b5e75c63b1adc673c" title="save/load">Save</a>( writer );
<a name="l00352"></a>00352 
<a name="l00354"></a>00354         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pvsCount = ( <span class="keywordtype">unsigned</span> <a class="code" href="_g_l_aux_8h.html#b832c174e145540d491b0830fc05dbb1">int</a> )_pvsIndices.size();
<a name="l00355"></a>00355         writer.<a class="code" href="class_u_writer.html#a1f6d44d3988a40cc188ab237c5edc0a">WriteUInt</a>( pvsCount );
<a name="l00356"></a>00356         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; pvsCount; ++i )
<a name="l00357"></a>00357                 writer.<a class="code" href="class_u_writer.html#a1f6d44d3988a40cc188ab237c5edc0a">WriteUInt</a>( _pvsIndices[ i ] );
<a name="l00358"></a>00358 }
<a name="l00359"></a>00359 
<a name="l00360"></a>00360 
<a name="l00361"></a>00361 <span class="comment">//==========================================================</span>
<a name="l00363"></a>00363 <span class="comment"></span><span class="comment">//==========================================================</span>
<a name="l00364"></a>00364 
<a name="l00365"></a>00365 <span class="comment">//----------------------------------------------------------</span>
<a name="l00366"></a>00366 <span class="keywordtype">bool</span>
<a name="l00367"></a>00367 GrPolygonBSPArea::SubtractAreaFromPortal( <a class="code" href="class_gr_polygon_b_s_p_portal_set.html" title="class GrPolygonBSPPortalSet">GrPolygonBSPPortalSet</a>* portals, <a class="code" href="class_gr_polygon_b_s_p_area.html" title="class GrPolygonBSPArea">GrPolygonBSPArea</a>* area )
<a name="l00368"></a>00368 {
<a name="l00370"></a>00370         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> polygonCount = area-&gt;<a class="code" href="class_gr_polygon_b_s_p_area.html#1ef46b31e200203f49c92eb5c5890cd3" title="group of polygons and a temporary renderable mesh.">_polygons</a>.<a class="code" href="class_gr_polygon_group.html#3e0a4ae8030ded12301495eed40135df" title="polygon iteration">GetPolygonCount</a>();
<a name="l00371"></a>00371         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; polygonCount; ++i )
<a name="l00372"></a>00372         {
<a name="l00373"></a>00373                 <span class="keyword">const</span> <a class="code" href="class_gr_polygon.html" title="class GrPolygon">GrPolygon</a>&amp; curPolygon = area-&gt;<a class="code" href="class_gr_polygon_b_s_p_area.html#1ef46b31e200203f49c92eb5c5890cd3" title="group of polygons and a temporary renderable mesh.">_polygons</a>.<a class="code" href="class_gr_polygon_group.html#267706848b196a4f1b7b0ebdeeb7188e">GetPolygon</a>( i );
<a name="l00374"></a>00374                 <span class="keywordflow">if</span> ( curPolygon.<a class="code" href="class_gr_polygon.html#f6f970043ece48bc218ff5bc62fa66a5" title="checks to see if the polygon is coplanar to the plane passed in.">IsCoplanar</a>( portals-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#c58d0feb66fa4c5d875df0d25e7ad352">GetPlane</a>(), <a class="code" href="_gr_config_8h.html#ca8a807541c7459e5966dce3ffe5b625" title="Scene compile options.">GR_BSP_PORTAL_EPSILON</a> ) )
<a name="l00375"></a>00375                 {
<a name="l00377"></a>00377                         <span class="keywordflow">if</span> ( !portals-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#c5d3b95b76f34209537fcbe66e47aa9f" title="public methods">Subtract</a>( area-&gt;<a class="code" href="class_gr_polygon_b_s_p_area.html#1ef46b31e200203f49c92eb5c5890cd3" title="group of polygons and a temporary renderable mesh.">_polygons</a>.<a class="code" href="class_gr_polygon_group.html#267706848b196a4f1b7b0ebdeeb7188e">GetPolygon</a>( i ), <a class="code" href="_gr_config_8h.html#ca8a807541c7459e5966dce3ffe5b625" title="Scene compile options.">GR_BSP_PORTAL_EPSILON</a> ) )
<a name="l00378"></a>00378                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00379"></a>00379                 }
<a name="l00380"></a>00380         }
<a name="l00381"></a>00381 
<a name="l00383"></a>00383         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00384"></a>00384 }
<a name="l00385"></a>00385 
<a name="l00386"></a>00386 <span class="comment">//----------------------------------------------------------</span>
<a name="l00387"></a>00387 <span class="keywordtype">void</span>
<a name="l00388"></a>00388 GrPolygonBSPArea::FindPortalSetNeighbors( std::vector&lt; GrPolygonBSPPortalSet* &gt;&amp; neighborLinks, <a class="code" href="class_gr_polygon_b_s_p_split.html" title="class GrPolygonBSPSplit">GrPolygonBSPSplit</a>* root, <a class="code" href="class_gr_polygon_b_s_p_portal_set.html" title="class GrPolygonBSPPortalSet">GrPolygonBSPPortalSet</a>* curPortalSet )
<a name="l00389"></a>00389 {
<a name="l00390"></a>00390         <a class="code" href="class_gr_polygon_b_s_p_portal_set.html" title="class GrPolygonBSPPortalSet">GrPolygonBSPPortalSet</a>* frontPortals = <span class="keyword">new</span> <a class="code" href="class_gr_polygon_b_s_p_portal_set.html" title="class GrPolygonBSPPortalSet">GrPolygonBSPPortalSet</a>;
<a name="l00391"></a>00391         <a class="code" href="class_gr_polygon_b_s_p_portal_set.html" title="class GrPolygonBSPPortalSet">GrPolygonBSPPortalSet</a>* backPortals = <span class="keyword">new</span> <a class="code" href="class_gr_polygon_b_s_p_portal_set.html" title="class GrPolygonBSPPortalSet">GrPolygonBSPPortalSet</a>;
<a name="l00392"></a>00392 
<a name="l00394"></a>00394         <a class="code" href="class_gr_polygon_b_s_p_area.html" title="class GrPolygonBSPArea">GrPolygonBSPArea</a>* originalOwner = curPortalSet-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#84098f84d7dbf0ec066aaa6ad30aa1e1">GetOwner</a>();
<a name="l00395"></a>00395 
<a name="l00397"></a>00397         frontPortals-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#bf746cf2cfeaf5b44a803625986ba073" title="area management.">SetOwner</a>( originalOwner );
<a name="l00398"></a>00398         backPortals-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#bf746cf2cfeaf5b44a803625986ba073" title="area management.">SetOwner</a>( originalOwner );
<a name="l00399"></a>00399 
<a name="l00401"></a>00401         curPortalSet-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#9215f97cca8ae51fc89dd82487fc14f2" title="splits the portal polygons into two groups.">Split</a>( *frontPortals, *backPortals, root-&gt;<a class="code" href="class_gr_polygon_b_s_p_split.html#1ccd3b94364851f152fb982679c2b348" title="BSP node split plane.">GetPlane</a>(), <a class="code" href="_gr_config_8h.html#ca8a807541c7459e5966dce3ffe5b625" title="Scene compile options.">GR_BSP_PORTAL_EPSILON</a> );
<a name="l00402"></a>00402         <span class="keyword">delete</span> curPortalSet;
<a name="l00403"></a>00403         curPortalSet = 0;
<a name="l00404"></a>00404 
<a name="l00405"></a>00405         <span class="keywordflow">if</span> ( frontPortals-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#d159b8572928f77a50b23264da9a95ac" title="generate frustums from portal geometry.">GetPortalCount</a>() &gt; 0 )
<a name="l00406"></a>00406         {
<a name="l00407"></a>00407                 <span class="keywordflow">if</span> ( root-&gt;<a class="code" href="class_gr_polygon_b_s_p_split.html#8a418bd7c053b3249cffedef4c13c74a" title="child management.">GetFrontChild</a>() )
<a name="l00408"></a>00408                 {
<a name="l00409"></a>00409                         FindPortalSetNeighbors( neighborLinks, root-&gt;<a class="code" href="class_gr_polygon_b_s_p_split.html#8a418bd7c053b3249cffedef4c13c74a" title="child management.">GetFrontChild</a>(), frontPortals );
<a name="l00410"></a>00410                 }
<a name="l00411"></a>00411                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( root-&gt;<a class="code" href="class_gr_polygon_b_s_p_split.html#585ea05b4c4d67c5851c2176f902ccfd" title="leaf management.">GetFrontLeaf</a>() &amp;&amp; originalOwner != root-&gt;<a class="code" href="class_gr_polygon_b_s_p_split.html#585ea05b4c4d67c5851c2176f902ccfd" title="leaf management.">GetFrontLeaf</a>() )
<a name="l00412"></a>00412                 {
<a name="l00414"></a>00414                         <a class="code" href="class_gr_polygon_b_s_p_area.html" title="class GrPolygonBSPArea">GrPolygonBSPArea</a>* frontLeaf = root-&gt;<a class="code" href="class_gr_polygon_b_s_p_split.html#585ea05b4c4d67c5851c2176f902ccfd" title="leaf management.">GetFrontLeaf</a>();
<a name="l00415"></a>00415                         <span class="keywordflow">if</span> ( !SubtractAreaFromPortal( frontPortals, frontLeaf ) )
<a name="l00416"></a>00416                         {
<a name="l00417"></a>00417                                 <span class="keyword">delete</span> frontPortals;
<a name="l00418"></a>00418                                 <span class="keywordflow">return</span>;
<a name="l00419"></a>00419                         }
<a name="l00420"></a>00420                         frontPortals-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#d095e8a7483db5cbe0fc518b234bf964">SetNeighbor</a>( frontLeaf );
<a name="l00421"></a>00421 
<a name="l00424"></a>00424                         frontPortals-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#c5ed27275dfb126e94fbf1da5a5e787f" title="reverses the winding of all portals in the set.">ReverseWinding</a>();
<a name="l00425"></a>00425 
<a name="l00427"></a>00427                         neighborLinks.push_back( frontPortals );
<a name="l00428"></a>00428                 }
<a name="l00429"></a>00429         }
<a name="l00430"></a>00430         <span class="keywordflow">if</span> ( backPortals-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#d159b8572928f77a50b23264da9a95ac" title="generate frustums from portal geometry.">GetPortalCount</a>() &gt; 0 )
<a name="l00431"></a>00431         {
<a name="l00432"></a>00432                 <span class="keywordflow">if</span> ( root-&gt;<a class="code" href="class_gr_polygon_b_s_p_split.html#015a96ec133801c0d49b3c3ef99d690d">GetBackChild</a>() )
<a name="l00433"></a>00433                 {
<a name="l00434"></a>00434                         FindPortalSetNeighbors( neighborLinks, root-&gt;<a class="code" href="class_gr_polygon_b_s_p_split.html#015a96ec133801c0d49b3c3ef99d690d">GetBackChild</a>(), backPortals );
<a name="l00435"></a>00435                 }
<a name="l00436"></a>00436                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( root-&gt;<a class="code" href="class_gr_polygon_b_s_p_split.html#f729026e82d6699b67523cec6fa8f4b6">GetBackLeaf</a>() &amp;&amp; originalOwner != root-&gt;<a class="code" href="class_gr_polygon_b_s_p_split.html#f729026e82d6699b67523cec6fa8f4b6">GetBackLeaf</a>() )
<a name="l00437"></a>00437                 {
<a name="l00439"></a>00439                         <a class="code" href="class_gr_polygon_b_s_p_area.html" title="class GrPolygonBSPArea">GrPolygonBSPArea</a>* backLeaf = root-&gt;<a class="code" href="class_gr_polygon_b_s_p_split.html#f729026e82d6699b67523cec6fa8f4b6">GetBackLeaf</a>();
<a name="l00440"></a>00440                         <span class="keywordflow">if</span> ( !SubtractAreaFromPortal( backPortals, backLeaf ) )
<a name="l00441"></a>00441                         {
<a name="l00442"></a>00442                                 <span class="keyword">delete</span> backPortals;
<a name="l00443"></a>00443                                 <span class="keywordflow">return</span>;
<a name="l00444"></a>00444                         }
<a name="l00445"></a>00445                         backPortals-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#d095e8a7483db5cbe0fc518b234bf964">SetNeighbor</a>( backLeaf );
<a name="l00446"></a>00446 
<a name="l00449"></a>00449                         backPortals-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#c5ed27275dfb126e94fbf1da5a5e787f" title="reverses the winding of all portals in the set.">ReverseWinding</a>();
<a name="l00450"></a>00450 
<a name="l00452"></a>00452                         neighborLinks.push_back( backPortals );
<a name="l00453"></a>00453                 }
<a name="l00454"></a>00454         }
<a name="l00455"></a>00455 }
<a name="l00456"></a>00456 
<a name="l00457"></a>00457 <span class="comment">//----------------------------------------------------------</span>
<a name="l00458"></a>00458 <span class="keywordtype">void</span>
<a name="l00459"></a>00459 GrPolygonBSPArea::FloodPVS( std::set&lt; GrPolygonBSPArea* &gt;&amp; visibleLeaves, std::vector&lt; MPlane &gt;&amp; cullPlanes, <span class="keyword">const</span> <a class="code" href="class_gr_portal.html" title="class GrPortal">GrPortal</a>&amp; fromPortal,
<a name="l00460"></a>00460                                          <span class="keyword">const</span> <a class="code" href="class_gr_polygon_b_s_p_split.html" title="class GrPolygonBSPSplit">GrPolygonBSPSplit</a>* portalCreator )
<a name="l00461"></a>00461 {
<a name="l00463"></a>00463         <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( !_inFlood );
<a name="l00464"></a>00464 
<a name="l00466"></a>00466         _inFlood = <span class="keyword">true</span>;
<a name="l00467"></a>00467 
<a name="l00469"></a>00469         visibleLeaves.insert( <span class="keyword">this</span> );
<a name="l00470"></a>00470 
<a name="l00472"></a>00472         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> toPortalSetCount = _portals.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>();
<a name="l00473"></a>00473         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; toPortalSetCount; ++i )
<a name="l00474"></a>00474         {
<a name="l00476"></a>00476                 <a class="code" href="class_gr_polygon_b_s_p_portal_set.html" title="class GrPolygonBSPPortalSet">GrPolygonBSPPortalSet</a>* toPortals = _portals[ i ];
<a name="l00477"></a>00477                 <span class="keywordflow">if</span> ( toPortals-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#1828ab2d1236459003e49503672f4b6c">GetNeighbor</a>()-&gt;<a class="code" href="class_gr_polygon_b_s_p_area.html#e72777c87205635fa994a631fe426e8a">_inFlood</a> )
<a name="l00478"></a>00478                         <span class="keywordflow">continue</span>;
<a name="l00479"></a>00479 
<a name="l00482"></a>00482                 <span class="keywordflow">if</span> ( toPortals-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#c4ae6e28d3a43e9dea180ba4c1b05f47">GetCreator</a>() == portalCreator <span class="comment">/*|| fromPortal.IsCoplanar( toPortals-&gt;GetPlane(), 0.1f * GR_PVS_VISIBILITY_EPSILON )*/</span> )
<a name="l00483"></a>00483                         <span class="keywordflow">continue</span>;
<a name="l00484"></a>00484 
<a name="l00486"></a>00486                 <span class="keywordflow">if</span> ( toPortals-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#1828ab2d1236459003e49503672f4b6c">GetNeighbor</a>()-&gt;<a class="code" href="class_gr_polygon_b_s_p_area.html#63247847ab821f68c3c8d6b166ebc419" title="local polygons.">GetPolygons</a>().<a class="code" href="class_gr_polygon_group.html#3e0a4ae8030ded12301495eed40135df" title="polygon iteration">GetPolygonCount</a>() == 0 )
<a name="l00487"></a>00487                         <span class="keywordflow">continue</span>;
<a name="l00488"></a>00488 
<a name="l00490"></a>00490                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> portalCount = toPortals-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#d159b8572928f77a50b23264da9a95ac" title="generate frustums from portal geometry.">GetPortalCount</a>();
<a name="l00491"></a>00491                 <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; portalCount; ++j )
<a name="l00492"></a>00492                 {
<a name="l00494"></a>00494                         <span class="keyword">const</span> <a class="code" href="class_gr_portal.html" title="class GrPortal">GrPortal</a>&amp; toPortal = toPortals-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#e771e0ac35b02fd0f7c229121e50e561">GetPortal</a>( j );
<a name="l00495"></a>00495 
<a name="l00497"></a>00497                         <span class="keywordflow">if</span> ( IsPortalVisible( toPortal, cullPlanes ) )
<a name="l00498"></a>00498                         {
<a name="l00500"></a>00500                                 <span class="keywordtype">size_t</span> prevSize = cullPlanes.size();
<a name="l00501"></a>00501                                 toPortals-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#d91efd1c01bb37833352a012336cca60">GenCullPlaneSet</a>( cullPlanes, fromPortal, j, <span class="keyword">false</span> );
<a name="l00502"></a>00502 
<a name="l00504"></a>00504                                 toPortals-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#1828ab2d1236459003e49503672f4b6c">GetNeighbor</a>()-&gt;<a class="code" href="class_gr_polygon_b_s_p_area.html#d5cd0189039e2ea0153600516522c992">FloodPVS</a>( visibleLeaves, cullPlanes, fromPortal, portalCreator );
<a name="l00505"></a>00505 
<a name="l00507"></a>00507                                 cullPlanes.erase( cullPlanes.begin() + prevSize, cullPlanes.end() );
<a name="l00508"></a>00508                         }
<a name="l00509"></a>00509                 }
<a name="l00510"></a>00510         }
<a name="l00511"></a>00511 
<a name="l00513"></a>00513         _inFlood = <span class="keyword">false</span>;
<a name="l00514"></a>00514 }
<a name="l00515"></a>00515 <span class="preprocessor">#if 0</span>
<a name="l00516"></a>00516 <span class="preprocessor"></span><span class="comment">//----------------------------------------------------------</span>
<a name="l00517"></a>00517 <span class="keywordtype">bool</span>
<a name="l00518"></a>00518 GrPolygonBSPArea::CheckVisibility( <a class="code" href="class_gr_polygon_b_s_p_area.html" title="class GrPolygonBSPArea">GrPolygonBSPArea</a>* area )
<a name="l00519"></a>00519 {
<a name="l00521"></a>00521         std::vector&lt; MPlane &gt; cullPlanes;
<a name="l00522"></a>00522         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fromPortalSetCount = _portals.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>();
<a name="l00523"></a>00523         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; fromPortalSetCount; ++i )
<a name="l00524"></a>00524         {
<a name="l00526"></a>00526                 <a class="code" href="class_gr_polygon_b_s_p_portal_set.html" title="class GrPolygonBSPPortalSet">GrPolygonBSPPortalSet</a>* fromPortalSet = _portals[ i ];
<a name="l00527"></a>00527                 <a class="code" href="class_gr_polygon_b_s_p_area.html" title="class GrPolygonBSPArea">GrPolygonBSPArea</a>* neighbor = fromPortalSet-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#1828ab2d1236459003e49503672f4b6c">GetNeighbor</a>();
<a name="l00528"></a>00528                 <span class="keywordflow">if</span> ( neighbor == area )
<a name="l00529"></a>00529                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00530"></a>00530 
<a name="l00532"></a>00532                 <a class="code" href="class_m_plane.html" title="class MPlane">MPlane</a> plane = fromPortalSet-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#c58d0feb66fa4c5d875df0d25e7ad352">GetPlane</a>();
<a name="l00533"></a>00533                 plane.<a class="code" href="class_m_plane.html#8fc4ab464ff88f145337b33e8c3d3dd0">ReverseFacing</a>();
<a name="l00534"></a>00534                 cullPlanes.push_back( plane );
<a name="l00535"></a>00535 
<a name="l00537"></a>00537                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fromPortalCount = fromPortalSet-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#d159b8572928f77a50b23264da9a95ac" title="generate frustums from portal geometry.">GetPortalCount</a>();
<a name="l00538"></a>00538                 <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; fromPortalCount; ++j )
<a name="l00539"></a>00539                 {
<a name="l00541"></a>00541                         <span class="keyword">const</span> <a class="code" href="class_gr_portal.html" title="class GrPortal">GrPortal</a>&amp; fromPortal = fromPortalSet-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#e771e0ac35b02fd0f7c229121e50e561">GetPortal</a>( j );
<a name="l00542"></a>00542 
<a name="l00544"></a>00544                         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> toPortalSetCount = area-&gt;<a class="code" href="class_gr_polygon_b_s_p_area.html#8cee3c6e226d3a30f0e2f33172c8d1cc" title="data only needed for PVS generation.">_portals</a>.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>();
<a name="l00545"></a>00545                         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = 0; k &lt; toPortalSetCount; ++k )
<a name="l00546"></a>00546                         {
<a name="l00548"></a>00548                                 <a class="code" href="class_gr_polygon_b_s_p_portal_set.html" title="class GrPolygonBSPPortalSet">GrPolygonBSPPortalSet</a>* toPortalSet = _portals[ i ];
<a name="l00549"></a>00549 
<a name="l00551"></a>00551                                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> toPortalCount = toPortalSet-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#d159b8572928f77a50b23264da9a95ac" title="generate frustums from portal geometry.">GetPortalCount</a>();
<a name="l00552"></a>00552                                 <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> l = 0; l &lt; toPortalCount; ++l )
<a name="l00553"></a>00553                                 {
<a name="l00555"></a>00555                                         <span class="keywordflow">if</span> ( !IsPortalVisible( toPortalSet-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#e771e0ac35b02fd0f7c229121e50e561">GetPortal</a>( j ), cullPlanes ) )
<a name="l00556"></a>00556                                                 <span class="keywordflow">continue</span>;
<a name="l00557"></a>00557 
<a name="l00559"></a>00559                                         <span class="keywordtype">size_t</span> planeSize = cullPlanes.size();
<a name="l00560"></a>00560                                         toPortalSet-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#d91efd1c01bb37833352a012336cca60">GenCullPlaneSet</a>( cullPlanes, fromPortal, l, <span class="keyword">true</span> );
<a name="l00561"></a>00561 
<a name="l00563"></a>00563                                         <span class="keywordflow">if</span> ( neighbor-&gt;<a class="code" href="class_gr_polygon_b_s_p_area.html#b300efcfeba26070219eb941688a35a5">FloodToArea</a>( cullPlanes, fromPortal, area ) )
<a name="l00564"></a>00564                                                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00565"></a>00565 
<a name="l00567"></a>00567                                         cullPlanes.erase( cullPlanes.begin() + planeSize, cullPlanes.end() );
<a name="l00568"></a>00568                                 }
<a name="l00569"></a>00569                         }
<a name="l00570"></a>00570                 }
<a name="l00571"></a>00571 
<a name="l00573"></a>00573                 cullPlanes.pop_back();
<a name="l00574"></a>00574         }
<a name="l00575"></a>00575 
<a name="l00577"></a>00577         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00578"></a>00578 }
<a name="l00579"></a>00579 
<a name="l00580"></a>00580 <span class="comment">//----------------------------------------------------------</span>
<a name="l00581"></a>00581 <span class="keywordtype">bool</span>
<a name="l00582"></a>00582 GrPolygonBSPArea::FloodToArea( std::vector&lt; MPlane &gt;&amp; cullPlanes, <span class="keyword">const</span> <a class="code" href="class_gr_portal.html" title="class GrPortal">GrPortal</a>&amp; fromPortal, <a class="code" href="class_gr_polygon_b_s_p_area.html" title="class GrPolygonBSPArea">GrPolygonBSPArea</a>* toArea )
<a name="l00583"></a>00583 {
<a name="l00584"></a>00584         _lastFloodID = 1;
<a name="l00585"></a>00585 
<a name="l00587"></a>00587         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> portalSetCount = _portals.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>();
<a name="l00588"></a>00588         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; portalSetCount; ++i )
<a name="l00589"></a>00589         {
<a name="l00591"></a>00591                 <a class="code" href="class_gr_polygon_b_s_p_portal_set.html" title="class GrPolygonBSPPortalSet">GrPolygonBSPPortalSet</a>* curPortalSet = _portals[ i ];
<a name="l00592"></a>00592                 <a class="code" href="class_gr_polygon_b_s_p_area.html" title="class GrPolygonBSPArea">GrPolygonBSPArea</a>* neighbor = curPortalSet-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#1828ab2d1236459003e49503672f4b6c">GetNeighbor</a>();
<a name="l00593"></a>00593 
<a name="l00595"></a>00595                 <span class="keywordflow">if</span> ( neighbor-&gt;_lastFloodID == 1 )
<a name="l00596"></a>00596                         <span class="keywordflow">continue</span>;
<a name="l00597"></a>00597 
<a name="l00599"></a>00599                 cullPlanes.push_back( curPortalSet-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#c58d0feb66fa4c5d875df0d25e7ad352">GetPlane</a>() );
<a name="l00600"></a>00600 
<a name="l00602"></a>00602                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> portalCount = curPortalSet-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#d159b8572928f77a50b23264da9a95ac" title="generate frustums from portal geometry.">GetPortalCount</a>();
<a name="l00603"></a>00603                 <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; portalCount; ++j )
<a name="l00604"></a>00604                 {
<a name="l00606"></a>00606                         <span class="keyword">const</span> <a class="code" href="class_gr_portal.html" title="class GrPortal">GrPortal</a>&amp; curPortal = curPortalSet-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#e771e0ac35b02fd0f7c229121e50e561">GetPortal</a>( j );
<a name="l00607"></a>00607 
<a name="l00609"></a>00609                         <span class="keywordflow">if</span> ( IsPortalVisible( curPortal, cullPlanes ) )
<a name="l00610"></a>00610                         {
<a name="l00612"></a>00612                                 <span class="keywordflow">if</span> ( neighbor == toArea )
<a name="l00613"></a>00613                                 {
<a name="l00614"></a>00614                                         _lastFloodID = 0;
<a name="l00615"></a>00615                                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00616"></a>00616                                 }
<a name="l00617"></a>00617 
<a name="l00619"></a>00619                                 <span class="keywordtype">size_t</span> curCullPlaneCount = cullPlanes.size();
<a name="l00620"></a>00620                                 curPortalSet-&gt;<a class="code" href="class_gr_polygon_b_s_p_portal_set.html#d91efd1c01bb37833352a012336cca60">GenCullPlaneSet</a>( cullPlanes, fromPortal, j, <span class="keyword">false</span> );
<a name="l00621"></a>00621 
<a name="l00623"></a>00623                                 <span class="keywordflow">if</span> ( neighbor-&gt;<a class="code" href="class_gr_polygon_b_s_p_area.html#b300efcfeba26070219eb941688a35a5">FloodToArea</a>( cullPlanes, fromPortal, toArea ) )
<a name="l00624"></a>00624                                 {
<a name="l00625"></a>00625                                         _lastFloodID = 0;
<a name="l00626"></a>00626                                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00627"></a>00627                                 }
<a name="l00628"></a>00628 
<a name="l00630"></a>00630                                 cullPlanes.erase( cullPlanes.begin() + curCullPlaneCount, cullPlanes.end() );
<a name="l00631"></a>00631                         }
<a name="l00632"></a>00632                 }
<a name="l00633"></a>00633 
<a name="l00635"></a>00635                 cullPlanes.pop_back();
<a name="l00636"></a>00636         }
<a name="l00637"></a>00637 
<a name="l00639"></a>00639         _lastFloodID = 0;
<a name="l00640"></a>00640         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00641"></a>00641 }
<a name="l00642"></a>00642 <span class="preprocessor">#endif</span>
<a name="l00643"></a>00643 <span class="preprocessor"></span><span class="comment">//----------------------------------------------------------</span>
<a name="l00644"></a>00644 <span class="keywordtype">bool</span>
<a name="l00645"></a>00645 GrPolygonBSPArea::IsPortalVisible( <span class="keyword">const</span> <a class="code" href="class_gr_portal.html" title="class GrPortal">GrPortal</a>&amp; curPortal, <span class="keyword">const</span> std::vector&lt; MPlane &gt;&amp; cullPlanes )
<a name="l00646"></a>00646 {
<a name="l00648"></a>00648         <span class="keywordflow">if</span> ( cullPlanes.size() == 0 )
<a name="l00649"></a>00649                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00650"></a>00650 
<a name="l00652"></a>00652 <span class="comment">//      const GrPolygon&amp; portalPoly = curPortal.GetPolygon();</span>
<a name="l00653"></a>00653         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> portalVertexCount = curPortal.<a class="code" href="class_gr_portal.html#c0d550bb52043d3e5c410f07cc6cd265" title="returns the polygon represented by this portal.">GetVertexCount</a>();
<a name="l00654"></a>00654 
<a name="l00656"></a>00656         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> planeCount = ( <span class="keywordtype">unsigned</span> <a class="code" href="_g_l_aux_8h.html#b832c174e145540d491b0830fc05dbb1">int</a> )cullPlanes.size();
<a name="l00657"></a>00657         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = planeCount;
<a name="l00658"></a>00658 <span class="comment">//      for ( unsigned int i = 0; i &lt; planeCount; ++i )</span>
<a name="l00659"></a>00659         <span class="keywordflow">while</span> ( i-- &gt; 0 )
<a name="l00660"></a>00660         {
<a name="l00662"></a>00662                 <span class="keyword">const</span> <a class="code" href="class_m_plane.html" title="class MPlane">MPlane</a>&amp; curPlane = cullPlanes[ i ];
<a name="l00663"></a>00663 
<a name="l00666"></a>00666                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0;
<a name="l00667"></a>00667                 <span class="keywordflow">for</span> ( ; j &lt; portalVertexCount; ++j )
<a name="l00668"></a>00668                 {
<a name="l00669"></a>00669                         <span class="keywordflow">if</span> ( curPlane.<a class="code" href="class_m_plane.html#ba18afe95e49cc82c2d1f1feca4f1838" title="returns the side the point passed in is on.">GetSide</a>( curPortal.<a class="code" href="class_gr_portal.html#b03b8fbf1a5ab6f367cd880c81d70854">GetVertex</a>( j ), 0.01f * <a class="code" href="_gr_config_8h.html#5da953556974a7618cae83e23f4ee63c">GR_PVS_VISIBILITY_EPSILON</a> ) &gt; 0 )
<a name="l00670"></a>00670                                 <span class="keywordflow">break</span>;
<a name="l00671"></a>00671                 }
<a name="l00672"></a>00672 
<a name="l00675"></a>00675                 <span class="keywordflow">if</span> ( j == portalVertexCount )
<a name="l00676"></a>00676                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00677"></a>00677         }
<a name="l00678"></a>00678 
<a name="l00681"></a>00681         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00682"></a>00682 }
<a name="l00683"></a>00683 <span class="comment">/*</span>
<a name="l00684"></a>00684 <span class="comment">//----------------------------------------------------------</span>
<a name="l00685"></a>00685 <span class="comment">void</span>
<a name="l00686"></a>00686 <span class="comment">GrPolygonBSPArea::CalcPortalBounds()</span>
<a name="l00687"></a>00687 <span class="comment">{</span>
<a name="l00688"></a>00688 <span class="comment">        float minX = FLT_MAX;</span>
<a name="l00689"></a>00689 <span class="comment">        float minY = FLT_MAX;</span>
<a name="l00690"></a>00690 <span class="comment">        float minZ = FLT_MAX;</span>
<a name="l00691"></a>00691 <span class="comment">        float maxX = -FLT_MAX;</span>
<a name="l00692"></a>00692 <span class="comment">        float maxY = -FLT_MAX;</span>
<a name="l00693"></a>00693 <span class="comment">        float maxZ = -FLT_MAX;</span>
<a name="l00694"></a>00694 <span class="comment">        const unsigned int portalSetCount = _portals.GetElemCount();</span>
<a name="l00695"></a>00695 <span class="comment">        for ( unsigned int i = 0; i &lt; portalSetCount; ++i )</span>
<a name="l00696"></a>00696 <span class="comment">        {</span>
<a name="l00697"></a>00697 <span class="comment">                const unsigned int portalCount = _portals[ i ]-&gt;GetPortalCount();</span>
<a name="l00698"></a>00698 <span class="comment">                for ( unsigned int j = 0; j &lt; portalCount; ++j )</span>
<a name="l00699"></a>00699 <span class="comment">                {</span>
<a name="l00701"></a>00701 <span class="comment">                        const GrPortal&amp; curPortal = _portals[ i ]-&gt;GetPortal( j );</span>
<a name="l00702"></a>00702 <span class="comment"></span>
<a name="l00704"></a>00704 <span class="comment">                        const unsigned int portalVertexCount = curPortal.GetVertexCount();</span>
<a name="l00705"></a>00705 <span class="comment">                        for ( unsigned int k = 0; k &lt; portalVertexCount; ++k )</span>
<a name="l00706"></a>00706 <span class="comment">                        {</span>
<a name="l00707"></a>00707 <span class="comment">                                const MVec3&amp; curVertex = curPortal.GetVertex( k );</span>
<a name="l00708"></a>00708 <span class="comment">                                minX = ( curVertex.GetX() &lt; minX ) ? curVertex.GetX() : minX;</span>
<a name="l00709"></a>00709 <span class="comment">                                minY = ( curVertex.GetY() &lt; minY ) ? curVertex.GetY() : minY;</span>
<a name="l00710"></a>00710 <span class="comment">                                minZ = ( curVertex.GetZ() &lt; minZ ) ? curVertex.GetZ() : minZ;</span>
<a name="l00711"></a>00711 <span class="comment">                                maxX = ( curVertex.GetX() &gt; maxX ) ? curVertex.GetX() : maxX;</span>
<a name="l00712"></a>00712 <span class="comment">                                maxY = ( curVertex.GetY() &gt; maxY ) ? curVertex.GetY() : maxY;</span>
<a name="l00713"></a>00713 <span class="comment">                                maxZ = ( curVertex.GetZ() &gt; maxZ ) ? curVertex.GetZ() : maxZ;</span>
<a name="l00714"></a>00714 <span class="comment">                        }</span>
<a name="l00715"></a>00715 <span class="comment">                }</span>
<a name="l00716"></a>00716 <span class="comment">        }</span>
<a name="l00717"></a>00717 <span class="comment"></span>
<a name="l00719"></a>00719 <span class="comment">        _portalBounds = MAABox(</span>
<a name="l00720"></a>00720 <span class="comment">                MVec3(</span>
<a name="l00721"></a>00721 <span class="comment">                        0.5f * ( maxX + minX ),</span>
<a name="l00722"></a>00722 <span class="comment">                        0.5f * ( maxY + minY ), </span>
<a name="l00723"></a>00723 <span class="comment">                        0.5f * ( maxZ + minZ )</span>
<a name="l00724"></a>00724 <span class="comment">                        ),</span>
<a name="l00725"></a>00725 <span class="comment">                MVec3(</span>
<a name="l00726"></a>00726 <span class="comment">                        0.5f * ( maxX - minX ),</span>
<a name="l00727"></a>00727 <span class="comment">                        0.5f * ( maxY - minY ), </span>
<a name="l00728"></a>00728 <span class="comment">                        0.5f * ( maxZ - minZ )</span>
<a name="l00729"></a>00729 <span class="comment">                        )</span>
<a name="l00730"></a>00730 <span class="comment">                );</span>
<a name="l00731"></a>00731 <span class="comment">}</span>
<a name="l00732"></a>00732 <span class="comment">*/</span>
<a name="l00733"></a>00733 <span class="comment">//----------------------------------------------------------</span>
<a name="l00734"></a>00734 <span class="keywordtype">void</span>
<a name="l00735"></a>00735 GrPolygonBSPArea::Clean()
<a name="l00736"></a>00736 {
<a name="l00738"></a>00738         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> portalCount = _portals.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>();
<a name="l00739"></a>00739         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; portalCount; ++i )
<a name="l00740"></a>00740                 <span class="keyword">delete</span> _portals[ i ];
<a name="l00741"></a>00741         _portals.<a class="code" href="class_u_fast_array.html#97c6c9910cc6e541254eaaaa530d48a9">Clear</a>();
<a name="l00742"></a>00742 
<a name="l00744"></a>00744         <span class="keyword">delete</span> _uberData;
<a name="l00745"></a>00745         _uberData = 0;
<a name="l00746"></a>00746 }
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Fri Feb 13 17:19:56 2009 for Bootstrap Engine by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
