<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Bootstrap Engine: C:/Bootstrap/ProjectBX/Documentation/Code/Engine/Graphics/GrBSPArea.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>C:/Bootstrap/ProjectBX/Documentation/Code/Engine/Graphics/GrBSPArea.cpp</h1><a href="_gr_b_s_p_area_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//----------------------------------------------------------</span>
<a name="l00006"></a>00006 <span class="comment"></span><span class="comment">//----------------------------------------------------------</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include "<a class="code" href="graphics__afx_8h.html">graphics_afx.h</a>"</span>
<a name="l00008"></a>00008 
<a name="l00010"></a>00010 <span class="preprocessor">#include "<a class="code" href="_gr_b_s_p_area_8h.html">GrBSPArea.h</a>"</span>
<a name="l00011"></a>00011 
<a name="l00013"></a>00013 <span class="preprocessor">#include "<a class="code" href="_gr_polygon_b_s_p_area_8h.html">GrPolygonBSPArea.h</a>"</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include "<a class="code" href="_gr_mesh_combiner_8h.html">GrMeshCombiner.h</a>"</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include "<a class="code" href="_gr_mesh_inst_8h.html">GrMeshInst.h</a>"</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include "<a class="code" href="_gr_uber_patch_set_8h.html">GrUberPatchSet.h</a>"</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include "<a class="code" href="_gr_scene_traverser_8h.html">GrSceneTraverser.h</a>"</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include "<a class="code" href="_u_reader_8h.html">UReader.h</a>"</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include "<a class="code" href="_u_writer_8h.html">UWriter.h</a>"</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include "<a class="code" href="_m_ray_8h.html">MRay.h</a>"</span>
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="comment">//**********************************************************</span>
<a name="l00024"></a>00024 <span class="comment"></span><span class="comment">//**********************************************************</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="comment">//==========================================================</span>
<a name="l00028"></a>00028 <span class="comment"></span><span class="comment">//==========================================================</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="comment">//----------------------------------------------------------</span>
<a name="l00031"></a><a class="code" href="class_gr_b_s_p_area.html#1917808ab54ae082c728ac4a7d227d51">00031</a> <a class="code" href="class_gr_b_s_p_area.html#1917808ab54ae082c728ac4a7d227d51" title="class header.">GrBSPArea::GrBSPArea</a>( <a class="code" href="class_u_reader.html" title="Purpose: To wrap and simplify pointer read operations.">UReader</a>&amp; reader )
<a name="l00032"></a>00032 : _meshInsts( 0 )
<a name="l00033"></a>00033 , _meshInstCount( 0 )
<a name="l00034"></a>00034 , _uberPatches( 0 )
<a name="l00035"></a>00035 {
<a name="l00036"></a>00036         <a class="code" href="class_gr_b_s_p_area.html#e0b79578e1c1ffc335e6f37d7daf6349" title="load/save.">Load</a>( reader );
<a name="l00037"></a>00037 }
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="comment">//----------------------------------------------------------</span>
<a name="l00040"></a><a class="code" href="class_gr_b_s_p_area.html#c3b18df6dd0993c841482ed39ebe78ee">00040</a> <a class="code" href="class_gr_b_s_p_area.html#1917808ab54ae082c728ac4a7d227d51" title="class header.">GrBSPArea::GrBSPArea</a>( CombinerArray&amp; meshCombiners, <span class="keyword">const</span> <a class="code" href="class_gr_polygon_b_s_p_area.html" title="class GrPolygonBSPArea">GrPolygonBSPArea</a>&amp; polygonBSPArea,
<a name="l00041"></a>00041                                           <span class="keyword">const</span> <a class="code" href="class_gr_polygon_uber_u_v_mapper.html" title="class GrPolygonUberUVMapper">GrPolygonUberUVMapper</a>&amp; uberMapper )
<a name="l00042"></a>00042 : _meshInsts( 0 )
<a name="l00043"></a>00043 , _meshInstCount( 0 )
<a name="l00044"></a>00044 , _uberPatches( 0 )
<a name="l00045"></a>00045 {
<a name="l00047"></a>00047         <span class="keyword">const</span> std::vector&lt; unsigned int &gt;* visibility;
<a name="l00048"></a>00048         polygonBSPArea.<a class="code" href="class_gr_polygon_b_s_p_area.html#15324cca2e63613b45d88de81b4f8666" title="returns a pointer to the list of visibility info.">GetVisibilityData</a>( &amp;visibility );
<a name="l00049"></a>00049         _visibleAreas = *visibility;
<a name="l00050"></a>00050 
<a name="l00052"></a>00052         _boundingBox = polygonBSPArea.<a class="code" href="class_gr_polygon_b_s_p_area.html#dab93dce455697f234e10a72b57806c9" title="mark the area as visible.">GetBoundingAABox</a>();
<a name="l00053"></a>00053 
<a name="l00055"></a>00055         <a class="code" href="class_gr_polygon_uber_patch_group.html" title="class GrPolygonUberPatchGroup">GrPolygonUberPatchGroup</a>* patchGroup = polygonBSPArea.<a class="code" href="class_gr_polygon_b_s_p_area.html#655bfe84fb8008826d8bda2eb2d6f482">GetUberTexPatchGroup</a>();
<a name="l00056"></a>00056         <span class="keywordflow">if</span> ( patchGroup )
<a name="l00057"></a>00057                 _uberPatches = <span class="keyword">new</span> <a class="code" href="class_gr_uber_patch_set.html" title="class GrUberPatchSet">GrUberPatchSet</a>( patchGroup, uberMapper );
<a name="l00058"></a>00058 
<a name="l00060"></a>00060         <a class="code" href="class_gr_b_s_p_area.html#ca3e4c6211c02064ec2d70b4f61738a8">MeshInstVec</a> localMeshInsts;
<a name="l00061"></a>00061         polygonBSPArea.<a class="code" href="class_gr_polygon_b_s_p_area.html#63247847ab821f68c3c8d6b166ebc419" title="local polygons.">GetPolygons</a>().<a class="code" href="class_gr_polygon_group.html#487e928a1d486489a0e0005cc0eb8669" title="converts into mesh(es).">GenMeshes</a>( localMeshInsts, <span class="stringliteral">"bspleaf"</span> );
<a name="l00062"></a>00062 
<a name="l00064"></a>00064         BuildMeshInsts( meshCombiners, localMeshInsts );
<a name="l00065"></a>00065 }
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 <span class="comment">//----------------------------------------------------------</span>
<a name="l00068"></a><a class="code" href="class_gr_b_s_p_area.html#89f1cd22f5fcfd2fad44188428bcddd2">00068</a> <a class="code" href="class_gr_b_s_p_area.html#89f1cd22f5fcfd2fad44188428bcddd2">GrBSPArea::~GrBSPArea</a>()
<a name="l00069"></a>00069 {
<a name="l00070"></a>00070         Clean();
<a name="l00071"></a>00071 }
<a name="l00072"></a>00072 
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 <span class="comment">//==========================================================</span>
<a name="l00076"></a>00076 <span class="comment"></span><span class="comment">//==========================================================</span>
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 <span class="comment">//----------------------------------------------------------</span>
<a name="l00079"></a>00079 <span class="keywordtype">void</span>
<a name="l00080"></a><a class="code" href="class_gr_b_s_p_area.html#f6ab8deb86e82210eb489399ecdc5c5b">00080</a> <a class="code" href="class_gr_b_s_p_area.html#f6ab8deb86e82210eb489399ecdc5c5b" title="public methods">GrBSPArea::SetMeshInstLastVisibleFrameID</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> frameId )
<a name="l00081"></a>00081 {
<a name="l00082"></a>00082         <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( idx &lt; _meshInstCount );
<a name="l00083"></a>00083         _meshInsts[ idx ].<a class="code" href="struct_gr_b_s_p_area_1_1_s_mesh_inst_info.html#4d10e7d119ce090e466f2685808e9ed8">lastVisibleFrameId</a> = frameId;
<a name="l00084"></a>00084 }
<a name="l00085"></a>00085 
<a name="l00086"></a>00086 <span class="comment">//----------------------------------------------------------</span>
<a name="l00087"></a>00087 <span class="keyword">const</span> <a class="code" href="class_m_a_a_box.html" title="class MAABox">MAABox</a>&amp;
<a name="l00088"></a><a class="code" href="class_gr_b_s_p_area.html#7e13e61ee1c244898bbbedb5edfbbdfa">00088</a> <a class="code" href="class_gr_b_s_p_area.html#7e13e61ee1c244898bbbedb5edfbbdfa" title="returns the bounding sphere of the area.">GrBSPArea::GetBoundingBox</a>()<span class="keyword"> const</span>
<a name="l00089"></a>00089 <span class="keyword"></span>{
<a name="l00090"></a>00090         <span class="keywordflow">return</span> _boundingBox;
<a name="l00091"></a>00091 }
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 <span class="comment">//----------------------------------------------------------</span>
<a name="l00094"></a>00094 <span class="keywordtype">bool</span>
<a name="l00095"></a><a class="code" href="class_gr_b_s_p_area.html#9f8a64fe54421b7a44623384ec846477">00095</a> <a class="code" href="class_gr_b_s_p_area.html#9f8a64fe54421b7a44623384ec846477" title="pick against the meshes in the BSP area.">GrBSPArea::Pick</a>( <a class="code" href="class_gr_mesh_inst.html" title="class GrMeshInst">GrMeshInst</a>*&amp; meshInst, <a class="code" href="struct_gr_mesh_1_1_s_tri_collision.html" title="triangle collision data.">GrMesh::STriCollision</a>&amp; hit, <span class="keyword">const</span> MeshInstVec&amp; meshes, <span class="keyword">const</span> <a class="code" href="class_m_ray.html" title="class MRay">MRay</a>&amp; ray )
<a name="l00096"></a>00096 {
<a name="l00099"></a>00099         <span class="keywordflow">if</span> ( !ray.<a class="code" href="class_m_ray.html#d58f4fca993f73968696e69fa58f4a93" title="returns true if the ray intersects with the box provided.">Intersect</a>( _boundingBox ) )
<a name="l00100"></a>00100                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00101"></a>00101 
<a name="l00103"></a>00103         <span class="keywordtype">bool</span> meshHit = <span class="keyword">false</span>;
<a name="l00104"></a>00104         <span class="keywordtype">float</span> hitDistSqr = FLT_MAX;
<a name="l00105"></a>00105         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; _meshInstCount; ++i )
<a name="l00106"></a>00106         {
<a name="l00108"></a>00108                 <a class="code" href="struct_gr_b_s_p_area_1_1_s_mesh_inst_info.html">SMeshInstInfo</a>&amp; curMeshInfo = _meshInsts[ i ];
<a name="l00109"></a>00109 
<a name="l00111"></a>00111                 <a class="code" href="class_gr_mesh_inst.html" title="class GrMeshInst">GrMeshInst</a>* curMeshInst = meshes[ curMeshInfo.<a class="code" href="struct_gr_b_s_p_area_1_1_s_mesh_inst_info.html#cbc04c50efb0f6be8b67797894d4a432">meshInstIdx</a> ];
<a name="l00112"></a>00112                 <a class="code" href="class_gr_mesh.html" title="class GrMesh">GrMesh</a>* curMesh = curMeshInst-&gt;<a class="code" href="class_gr_mesh_inst.html#afe9b877585d9b86d1f464595b65e91c">GetMesh</a>();
<a name="l00113"></a>00113 
<a name="l00115"></a>00115                 <a class="code" href="class_u_fast_array.html" title="Purpose: To act like a std::vector, only faster. Avoids.">GrMesh::TriHitArray</a> hits;
<a name="l00116"></a>00116                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rangeEnd = curMeshInfo.<a class="code" href="struct_gr_b_s_p_area_1_1_s_mesh_inst_info.html#89f8bfcc8ffdf02fb93f230a1c73e1b9">rangeStart</a> + curMeshInfo.<a class="code" href="struct_gr_b_s_p_area_1_1_s_mesh_inst_info.html#862a02786df63d5fb626d51ab88a769c">rangeCount</a>;
<a name="l00117"></a>00117                 <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="glext_8h.html#7b8ad0b27a927682837f95528fa454f5">range</a> = curMeshInfo.<a class="code" href="struct_gr_b_s_p_area_1_1_s_mesh_inst_info.html#89f8bfcc8ffdf02fb93f230a1c73e1b9">rangeStart</a>; <a class="code" href="glext_8h.html#7b8ad0b27a927682837f95528fa454f5">range</a> &lt; rangeEnd; ++<a class="code" href="glext_8h.html#7b8ad0b27a927682837f95528fa454f5">range</a> )
<a name="l00118"></a>00118                 {
<a name="l00120"></a>00120                         curMesh-&gt;<a class="code" href="class_gr_mesh.html#460827f482933fc4d076225afdebd595">PickRange</a>( hits, <a class="code" href="glext_8h.html#7b8ad0b27a927682837f95528fa454f5">range</a>, ray );
<a name="l00121"></a>00121 
<a name="l00123"></a>00123                         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> hitCount = hits.<a class="code" href="class_u_fast_array.html#0f656de7d6eb46b1a090bd3b1c26cb35">GetElemCount</a>();
<a name="l00124"></a>00124                         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> h = 0; h &lt; hitCount; ++h )
<a name="l00125"></a>00125                         {
<a name="l00127"></a>00127                                 <a class="code" href="struct_gr_mesh_1_1_s_tri_collision.html" title="triangle collision data.">GrMesh::STriCollision</a>&amp; curTriHit = hits[ h ];
<a name="l00128"></a>00128                                 <span class="keywordtype">float</span> curDistSqr = ray.<a class="code" href="class_m_ray.html#50cd4ec247b5df4a4a336478a3a19c91">GetStart</a>().<a class="code" href="class_m_vec3.html#71ac5757ebbfabeacbf4e8337f291d7d">DistSqr</a>( curTriHit.<a class="code" href="struct_gr_mesh_1_1_s_tri_collision.html#3a4997da126ca2145ef6974ba9f4b6c2">hitLoc</a> );
<a name="l00129"></a>00129 
<a name="l00131"></a>00131                                 <span class="keywordflow">if</span> ( curDistSqr &lt; hitDistSqr )
<a name="l00132"></a>00132                                 {
<a name="l00133"></a>00133                                         meshHit = <span class="keyword">true</span>;
<a name="l00134"></a>00134                                         hitDistSqr = curDistSqr;
<a name="l00135"></a>00135                                         hit = curTriHit;
<a name="l00136"></a>00136                                         meshInst = curMeshInst;
<a name="l00137"></a>00137                                 }
<a name="l00138"></a>00138                         }
<a name="l00139"></a>00139                 }
<a name="l00140"></a>00140         }
<a name="l00141"></a>00141 
<a name="l00143"></a>00143         <span class="keywordflow">return</span> meshHit;
<a name="l00144"></a>00144 }
<a name="l00145"></a>00145 
<a name="l00146"></a>00146 <span class="comment">//----------------------------------------------------------</span>
<a name="l00147"></a>00147 <span class="keywordtype">void</span>
<a name="l00148"></a><a class="code" href="class_gr_b_s_p_area.html#80374c27c8e8b56812437625236d5f9b">00148</a> <a class="code" href="class_gr_b_s_p_area.html#80374c27c8e8b56812437625236d5f9b">GrBSPArea::Traverse</a>( <a class="code" href="class_gr_scene_traverser.html" title="class GrSceneTraverser">GrSceneTraverser</a>* traverser, <span class="keyword">const</span> MeshInstVec&amp; meshes )
<a name="l00149"></a>00149 {
<a name="l00151"></a>00151         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; _meshInstCount; ++i )
<a name="l00152"></a>00152         {
<a name="l00154"></a>00154                 <span class="keyword">const</span> <a class="code" href="struct_gr_b_s_p_area_1_1_s_mesh_inst_info.html">SMeshInstInfo</a>&amp; curMeshInstInfo = _meshInsts[ i ];
<a name="l00155"></a>00155                 <a class="code" href="class_gr_mesh_inst.html" title="class GrMeshInst">GrMeshInst</a>* curMeshInst = meshes[ curMeshInstInfo.<a class="code" href="struct_gr_b_s_p_area_1_1_s_mesh_inst_info.html#cbc04c50efb0f6be8b67797894d4a432">meshInstIdx</a> ];
<a name="l00156"></a>00156 
<a name="l00158"></a>00158                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="glext_8h.html#7b8ad0b27a927682837f95528fa454f5">range</a> = curMeshInstInfo.<a class="code" href="struct_gr_b_s_p_area_1_1_s_mesh_inst_info.html#89f8bfcc8ffdf02fb93f230a1c73e1b9">rangeStart</a>;
<a name="l00159"></a>00159                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rangeEnd = range + curMeshInstInfo.<a class="code" href="struct_gr_b_s_p_area_1_1_s_mesh_inst_info.html#862a02786df63d5fb626d51ab88a769c">rangeCount</a>;
<a name="l00160"></a>00160                 <span class="keywordflow">for</span> ( ; range &lt; rangeEnd; ++range )
<a name="l00161"></a>00161                         traverser-&gt;<a class="code" href="class_gr_scene_traverser.html#4b78a9ad02a45670f5f3f7544ac3f411" title="this is called when there is a mesh instance range.">OnMeshInstRange</a>( curMeshInst, range );
<a name="l00162"></a>00162         }
<a name="l00163"></a>00163 }
<a name="l00164"></a>00164 
<a name="l00165"></a>00165 <span class="comment">//----------------------------------------------------------</span>
<a name="l00166"></a>00166 <span class="keywordtype">void</span>
<a name="l00167"></a><a class="code" href="class_gr_b_s_p_area.html#e0b79578e1c1ffc335e6f37d7daf6349">00167</a> <a class="code" href="class_gr_b_s_p_area.html#e0b79578e1c1ffc335e6f37d7daf6349" title="load/save.">GrBSPArea::Load</a>( <a class="code" href="class_u_reader.html" title="Purpose: To wrap and simplify pointer read operations.">UReader</a>&amp; reader )
<a name="l00168"></a>00168 {
<a name="l00170"></a>00170         <span class="keywordtype">short</span> minorVer = reader.<a class="code" href="class_u_reader.html#4ddc2edc9b761259588297ef1618a68b">ReadShort</a>();
<a name="l00171"></a>00171         <span class="keywordtype">short</span> majorVer = reader.<a class="code" href="class_u_reader.html#4ddc2edc9b761259588297ef1618a68b">ReadShort</a>();
<a name="l00172"></a>00172 
<a name="l00174"></a>00174         Clean();
<a name="l00175"></a>00175 
<a name="l00177"></a>00177         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> visibleAreaCount = reader.<a class="code" href="class_u_reader.html#14d2bfe8a38307b1ecb774b70c910c65">ReadUInt</a>();
<a name="l00178"></a>00178         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; visibleAreaCount; ++i )
<a name="l00179"></a>00179                 _visibleAreas.push_back( reader.<a class="code" href="class_u_reader.html#e30a8a2deaba30f2dc209781ea1bc16b">ReadInt</a>() );
<a name="l00180"></a>00180 
<a name="l00182"></a>00182         _meshInstCount = reader.<a class="code" href="class_u_reader.html#14d2bfe8a38307b1ecb774b70c910c65">ReadUInt</a>();
<a name="l00183"></a>00183         _meshInsts = <span class="keyword">new</span> <a class="code" href="struct_gr_b_s_p_area_1_1_s_mesh_inst_info.html">SMeshInstInfo</a>[ _meshInstCount ];
<a name="l00184"></a>00184         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; _meshInstCount; ++i )
<a name="l00185"></a>00185         {
<a name="l00186"></a>00186                 _meshInsts[ i ].<a class="code" href="struct_gr_b_s_p_area_1_1_s_mesh_inst_info.html#cbc04c50efb0f6be8b67797894d4a432">meshInstIdx</a> = reader.<a class="code" href="class_u_reader.html#14d2bfe8a38307b1ecb774b70c910c65">ReadUInt</a>();
<a name="l00187"></a>00187                 _meshInsts[ i ].<a class="code" href="struct_gr_b_s_p_area_1_1_s_mesh_inst_info.html#89f8bfcc8ffdf02fb93f230a1c73e1b9">rangeStart</a> = reader.<a class="code" href="class_u_reader.html#14d2bfe8a38307b1ecb774b70c910c65">ReadUInt</a>();
<a name="l00188"></a>00188                 _meshInsts[ i ].<a class="code" href="struct_gr_b_s_p_area_1_1_s_mesh_inst_info.html#862a02786df63d5fb626d51ab88a769c">rangeCount</a> = reader.<a class="code" href="class_u_reader.html#14d2bfe8a38307b1ecb774b70c910c65">ReadUInt</a>();
<a name="l00189"></a>00189                 _meshInsts[ i ].<a class="code" href="struct_gr_b_s_p_area_1_1_s_mesh_inst_info.html#4d10e7d119ce090e466f2685808e9ed8">lastVisibleFrameId</a> = 0;
<a name="l00190"></a>00190         }
<a name="l00191"></a>00191 
<a name="l00193"></a>00193         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> uberPatchFlags = reader.<a class="code" href="class_u_reader.html#14d2bfe8a38307b1ecb774b70c910c65">ReadUInt</a>();
<a name="l00194"></a>00194         <span class="keywordflow">if</span> ( uberPatchFlags &amp; 1 )
<a name="l00195"></a>00195                 _uberPatches = <span class="keyword">new</span> <a class="code" href="class_gr_uber_patch_set.html" title="class GrUberPatchSet">GrUberPatchSet</a>( reader );
<a name="l00196"></a>00196 
<a name="l00198"></a>00198         _boundingBox.<a class="code" href="class_m_a_a_box.html#7658fd191ee1fbbf3d6f93d0221fe13a">Load</a>( reader );
<a name="l00199"></a>00199 }
<a name="l00200"></a>00200 
<a name="l00201"></a>00201 <span class="comment">//----------------------------------------------------------</span>
<a name="l00202"></a>00202 <span class="keywordtype">void</span>
<a name="l00203"></a><a class="code" href="class_gr_b_s_p_area.html#5d647ed462a407fc32cf9101515e9c40">00203</a> <a class="code" href="class_gr_b_s_p_area.html#5d647ed462a407fc32cf9101515e9c40">GrBSPArea::Save</a>( <a class="code" href="class_u_writer.html" title="Purpose: To wrap and simplify pointer write operations.">UWriter</a>&amp; writer )
<a name="l00204"></a>00204 {
<a name="l00206"></a>00206         writer.<a class="code" href="class_u_writer.html#ad53e1a9063eec9545834eb288fe0767">WriteShort</a>( 0x0000 );
<a name="l00207"></a>00207         writer.<a class="code" href="class_u_writer.html#ad53e1a9063eec9545834eb288fe0767">WriteShort</a>( 0x0001 );
<a name="l00208"></a>00208 
<a name="l00210"></a>00210         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> visibleAreaCount = ( <span class="keywordtype">unsigned</span> <a class="code" href="_g_l_aux_8h.html#b832c174e145540d491b0830fc05dbb1">int</a> )_visibleAreas.size();
<a name="l00211"></a>00211         writer.<a class="code" href="class_u_writer.html#a1f6d44d3988a40cc188ab237c5edc0a">WriteUInt</a>( visibleAreaCount );
<a name="l00212"></a>00212         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; visibleAreaCount; ++i )
<a name="l00213"></a>00213                 writer.<a class="code" href="class_u_writer.html#a1f6d44d3988a40cc188ab237c5edc0a">WriteUInt</a>( _visibleAreas[ i ] );
<a name="l00214"></a>00214 
<a name="l00216"></a>00216         writer.<a class="code" href="class_u_writer.html#a1f6d44d3988a40cc188ab237c5edc0a">WriteUInt</a>( _meshInstCount );
<a name="l00217"></a>00217         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; _meshInstCount; ++i )
<a name="l00218"></a>00218         {
<a name="l00219"></a>00219                 writer.<a class="code" href="class_u_writer.html#a1f6d44d3988a40cc188ab237c5edc0a">WriteUInt</a>( _meshInsts[ i ].meshInstIdx );
<a name="l00220"></a>00220                 writer.<a class="code" href="class_u_writer.html#a1f6d44d3988a40cc188ab237c5edc0a">WriteUInt</a>( _meshInsts[ i ].rangeStart );
<a name="l00221"></a>00221                 writer.<a class="code" href="class_u_writer.html#a1f6d44d3988a40cc188ab237c5edc0a">WriteUInt</a>( _meshInsts[ i ].rangeCount );
<a name="l00222"></a>00222         }
<a name="l00223"></a>00223 
<a name="l00225"></a>00225         writer.<a class="code" href="class_u_writer.html#a1f6d44d3988a40cc188ab237c5edc0a">WriteUInt</a>( ( _uberPatches != 0 ) ? 1 : 0 );
<a name="l00226"></a>00226         <span class="keywordflow">if</span> ( _uberPatches )
<a name="l00227"></a>00227                 _uberPatches-&gt;<a class="code" href="class_gr_uber_patch_set.html#53a1e10a947e715bd18568b138d53501">Save</a>( writer );
<a name="l00228"></a>00228 
<a name="l00230"></a>00230         _boundingBox.<a class="code" href="class_m_a_a_box.html#c24b0c3002a56fd52de6628e1864e485">Save</a>( writer );
<a name="l00231"></a>00231 }
<a name="l00232"></a>00232 
<a name="l00233"></a>00233 
<a name="l00234"></a>00234 <span class="comment">//==========================================================</span>
<a name="l00236"></a>00236 <span class="comment"></span><span class="comment">//==========================================================</span>
<a name="l00237"></a>00237 
<a name="l00238"></a>00238 <span class="comment">//----------------------------------------------------------</span>
<a name="l00239"></a>00239 <span class="keywordtype">void</span>
<a name="l00240"></a>00240 GrBSPArea::BuildMeshInsts( CombinerArray&amp; meshCombiners, <span class="keyword">const</span> MeshInstVec&amp; localMeshInsts )
<a name="l00241"></a>00241 {
<a name="l00243"></a>00243         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> localMeshCount = ( <span class="keywordtype">unsigned</span> <a class="code" href="_g_l_aux_8h.html#b832c174e145540d491b0830fc05dbb1">int</a> )localMeshInsts.size();
<a name="l00244"></a>00244         _meshInsts = <span class="keyword">new</span> SMeshInstInfo[ localMeshCount ];
<a name="l00245"></a>00245         _meshInstCount = localMeshCount;
<a name="l00246"></a>00246 
<a name="l00248"></a>00248         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0;
<a name="l00249"></a>00249         MeshInstVec::const_iterator iter = localMeshInsts.begin();
<a name="l00250"></a>00250         <span class="keyword">const</span> MeshInstVec::const_iterator <a class="code" href="_g_l_8h.html#432111147038972f06e049e18a837002">end</a> = localMeshInsts.end();
<a name="l00251"></a>00251         <span class="keywordflow">for</span> ( ; iter != end; ++iter, ++i )
<a name="l00252"></a>00252         {
<a name="l00254"></a>00254                 <a class="code" href="class_gr_mesh_inst.html" title="class GrMeshInst">GrMeshInst</a>* curMeshInst = ( *iter );
<a name="l00255"></a>00255 
<a name="l00257"></a>00257                 <a class="code" href="class_gr_mesh_combiner.html" title="class GrMeshCombiner">GrMeshCombiner</a>* combiner = 0;
<a name="l00258"></a>00258                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> meshIdx = 0;
<a name="l00259"></a>00259                 <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> meshCombinerCount = ( <span class="keywordtype">unsigned</span> <a class="code" href="_g_l_aux_8h.html#b832c174e145540d491b0830fc05dbb1">int</a> )meshCombiners.size();
<a name="l00260"></a>00260                 <span class="keywordflow">for</span> ( ; meshIdx &lt; meshCombinerCount; ++meshIdx )
<a name="l00261"></a>00261                 {
<a name="l00264"></a>00264                         <span class="keywordflow">if</span> ( meshCombiners[ meshIdx ]-&gt;CanAddMesh( curMeshInst ) )
<a name="l00265"></a>00265                         {
<a name="l00267"></a>00267                                 combiner = meshCombiners[ meshIdx ];
<a name="l00268"></a>00268                                 <span class="keywordflow">break</span>;
<a name="l00269"></a>00269                         }
<a name="l00270"></a>00270                 }
<a name="l00271"></a>00271 
<a name="l00274"></a>00274                 <span class="keywordflow">if</span> ( meshIdx == meshCombinerCount )
<a name="l00275"></a>00275                 {
<a name="l00277"></a>00277                         combiner = <span class="keyword">new</span> <a class="code" href="class_gr_mesh_combiner.html" title="class GrMeshCombiner">GrMeshCombiner</a>;
<a name="l00278"></a>00278                         meshCombiners.push_back( combiner );
<a name="l00279"></a>00279                 }
<a name="l00280"></a>00280 
<a name="l00282"></a>00282                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> startRange = combiner-&gt;<a class="code" href="class_gr_mesh_combiner.html#35a035d950b95e8a291fe2e333bb4e8a">AddMesh</a>( curMeshInst );
<a name="l00283"></a>00283 
<a name="l00287"></a>00287                 _meshInsts[ i ].<a class="code" href="struct_gr_b_s_p_area_1_1_s_mesh_inst_info.html#cbc04c50efb0f6be8b67797894d4a432">meshInstIdx</a> = meshIdx;
<a name="l00288"></a>00288                 _meshInsts[ i ].<a class="code" href="struct_gr_b_s_p_area_1_1_s_mesh_inst_info.html#89f8bfcc8ffdf02fb93f230a1c73e1b9">rangeStart</a> = startRange;
<a name="l00289"></a>00289                 _meshInsts[ i ].<a class="code" href="struct_gr_b_s_p_area_1_1_s_mesh_inst_info.html#862a02786df63d5fb626d51ab88a769c">rangeCount</a> = curMeshInst-&gt;<a class="code" href="class_gr_mesh_inst.html#cbd495c05b5c83745059b6d842470607" title="accessors">GetRangeCount</a>();
<a name="l00290"></a>00290                 _meshInsts[ i ].<a class="code" href="struct_gr_b_s_p_area_1_1_s_mesh_inst_info.html#4d10e7d119ce090e466f2685808e9ed8">lastVisibleFrameId</a> = 0;
<a name="l00291"></a>00291         }
<a name="l00292"></a>00292 }
<a name="l00293"></a>00293 
<a name="l00294"></a>00294 <span class="comment">//----------------------------------------------------------</span>
<a name="l00295"></a>00295 <span class="keywordtype">void</span>
<a name="l00296"></a>00296 GrBSPArea::Clean()
<a name="l00297"></a>00297 {
<a name="l00299"></a>00299         <span class="keyword">delete</span>[] _meshInsts;
<a name="l00300"></a>00300         _meshInsts = 0;
<a name="l00301"></a>00301         _visibleAreas.clear();
<a name="l00302"></a>00302         <span class="keyword">delete</span> _uberPatches;
<a name="l00303"></a>00303 }
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Fri Feb 13 17:19:53 2009 for Bootstrap Engine by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
