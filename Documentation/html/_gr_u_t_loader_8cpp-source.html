<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Bootstrap Engine: C:/Bootstrap/ProjectBX/Documentation/Code/Engine/Graphics/GrUTLoader.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>C:/Bootstrap/ProjectBX/Documentation/Code/Engine/Graphics/GrUTLoader.cpp</h1><a href="_gr_u_t_loader_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//----------------------------------------------------------</span>
<a name="l00006"></a>00006 <span class="comment"></span><span class="comment">//----------------------------------------------------------</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include "<a class="code" href="graphics__afx_8h.html">graphics_afx.h</a>"</span>
<a name="l00008"></a>00008 
<a name="l00010"></a>00010 <span class="preprocessor">#include "<a class="code" href="_gr_u_t_loader_8h.html">GrUTLoader.h</a>"</span>
<a name="l00011"></a>00011 
<a name="l00013"></a>00013 <span class="preprocessor">#include "<a class="code" href="_gr_u_t_compress_8h.html">GrUTCompress.h</a>"</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include "<a class="code" href="_gr_u_t_atlas_8h.html">GrUTAtlas.h</a>"</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include "<a class="code" href="_gr_config_8h.html">GrConfig.h</a>"</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include "<a class="code" href="_u_r_l_e_8h.html">URLE.h</a>"</span>
<a name="l00017"></a>00017 
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;process.h&gt;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;stddef.h&gt;</span>
<a name="l00021"></a>00021 
<a name="l00023"></a><a class="code" href="_gr_u_t_loader_8cpp.html#c045dcc99fe23ab148b611ba6fbac7e2">00023</a> <span class="preprocessor">#define UBERTEX_FILE_MAGIC                              "\x90UTX\r\n\x1A\0"</span>
<a name="l00024"></a><a class="code" href="_gr_u_t_loader_8cpp.html#7a21f9990d5e355b5e44af0693e0fe9b">00024</a> <span class="preprocessor"></span><span class="preprocessor">#define UBERTEX_FILE_CHUNK_SIZE                 2048</span>
<a name="l00025"></a><a class="code" href="_gr_u_t_loader_8cpp.html#7c76c402ba6986c03a9217fb8f1c1238">00025</a> <span class="preprocessor"></span><span class="preprocessor">#define WORKER_QUEUE_SIZE                               1024</span>
<a name="l00026"></a><a class="code" href="_gr_u_t_loader_8cpp.html#8b5173357adb02a86c027316e0acdfa0">00026</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_THREADS                                             32U</span>
<a name="l00027"></a><a class="code" href="_gr_u_t_loader_8cpp.html#53cca13b10221f54df430512fb1c07be">00027</a> <span class="preprocessor"></span><span class="preprocessor">#define UBERTEX_USAGE_MASK_SIZE                 ( ( GR_UBERTEX_MAX_SIZE_IN_TILES * GR_UBERTEX_MAX_SIZE_IN_TILES ) / 8 )</span>
<a name="l00028"></a><a class="code" href="_gr_u_t_loader_8cpp.html#588d766cbac1423af361ff71d1c26923">00028</a> <span class="preprocessor"></span><span class="preprocessor">#define RAW_TILE_SIZE                                   32768</span>
<a name="l00029"></a><a class="code" href="_gr_u_t_loader_8cpp.html#a8a165767957cdece95c881020536c3b">00029</a> <span class="preprocessor"></span><span class="preprocessor">#define RAW_ATLAS_SIZE                                  524288</span>
<a name="l00030"></a><a class="code" href="_gr_u_t_loader_8cpp.html#8ef9d2e097bb03e2beb5eed62081345c">00030</a> <span class="preprocessor"></span><span class="preprocessor">#define WRITE_BUFFER_COUNT                              32</span>
<a name="l00031"></a>00031 <span class="preprocessor"></span>
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="comment">//==========================================================</span>
<a name="l00035"></a>00035 <span class="comment"></span><span class="comment">//==========================================================</span>
<a name="l00036"></a>00036 
<a name="l00038"></a>00038 <span class="preprocessor">#pragma pack( push )</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span><span class="preprocessor">#pragma pack( 1 )</span>
<a name="l00040"></a><a class="code" href="struct_s_u_t_header.html">00040</a> <span class="preprocessor"></span><span class="keyword">struct </span><a class="code" href="struct_s_u_t_header.html" title="internal structures.">SUTHeader</a>
<a name="l00041"></a>00041 {
<a name="l00043"></a><a class="code" href="struct_s_u_t_header.html#4b17f37b5ec2b84cd7e556e1db1526fd">00043</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="struct_s_u_t_header.html#4b17f37b5ec2b84cd7e556e1db1526fd" title="ubertexture data.">magic</a>[ 8 ];               
<a name="l00044"></a><a class="code" href="struct_s_u_t_header.html#972e18afc8d7c6b0f613c15c874b409e">00044</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="struct_s_u_t_header.html#972e18afc8d7c6b0f613c15c874b409e" title="must be &amp;#39;&amp;#39;&amp;#39;U&amp;#39;&amp;#39;T&amp;#39;&amp;#39;X&amp;#39;&amp;#39;&amp;#39;&amp;#39; &amp;#39;&amp;#39;&amp;#39;&amp;#39;...">minorVer</a>;                 
<a name="l00045"></a><a class="code" href="struct_s_u_t_header.html#d52c5e749973c73c642fb84681920831">00045</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="struct_s_u_t_header.html#d52c5e749973c73c642fb84681920831" title="must be 0">majorVer</a>;                 
<a name="l00046"></a><a class="code" href="struct_s_u_t_header.html#4dd77cccfd65e78c6f9e151b2c45d885">00046</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="struct_s_u_t_header.html#4dd77cccfd65e78c6f9e151b2c45d885" title="must be 1">metaDataStart</a>;   
<a name="l00047"></a><a class="code" href="struct_s_u_t_header.html#8a505fd64fc60eeaff34a5c624ab1568">00047</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="struct_s_u_t_header.html#8a505fd64fc60eeaff34a5c624ab1568" title="location of any extra data.">metaDataSize</a>;    
<a name="l00048"></a><a class="code" href="struct_s_u_t_header.html#9e7bd76e03d33e6c3abf8bb8dfff7114">00048</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="struct_s_u_t_header.html#9e7bd76e03d33e6c3abf8bb8dfff7114" title="size in bytes of any extra data.">atlasStart</a>;              
<a name="l00049"></a><a class="code" href="struct_s_u_t_header.html#f8d6e268331abd330f1b8a64eb3a6d18">00049</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="struct_s_u_t_header.html#f8d6e268331abd330f1b8a64eb3a6d18" title="location in the file where the atlas starts.">atlasSize</a>;               
<a name="l00050"></a><a class="code" href="struct_s_u_t_header.html#e3658a7f87cd2bab631d25a256ca5d69">00050</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="struct_s_u_t_header.html#e3658a7f87cd2bab631d25a256ca5d69" title="size of the atlas in 2K chunks.">chunkStart</a>;              
<a name="l00051"></a><a class="code" href="struct_s_u_t_header.html#a2005bd7672275f54997ef96dfc69b58">00051</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="struct_s_u_t_header.html#a2005bd7672275f54997ef96dfc69b58" title="the first 2K chunk containing tile data.">basicCheckSum</a>;             
<a name="l00052"></a>00052 };
<a name="l00053"></a>00053 <span class="preprocessor">#pragma pack( pop )</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span>
<a name="l00055"></a><a class="code" href="struct_s_read_op.html">00055</a> <span class="keyword">struct </span><a class="code" href="struct_s_read_op.html">SReadOp</a>
<a name="l00056"></a>00056 {
<a name="l00059"></a><a class="code" href="struct_s_read_op.html#0b63dfe493c6fd53dabbae584ac8ebad">00059</a>         <span class="keyword">volatile</span> <span class="keywordtype">int</span> <a class="code" href="struct_s_read_op.html#0b63dfe493c6fd53dabbae584ac8ebad">inUse</a>;
<a name="l00060"></a>00060 
<a name="l00062"></a><a class="code" href="struct_s_read_op.html#5dfa4e1259cc150ba724f3dfe5347625">00062</a>         <a class="code" href="struct_s_f_s_file_read_buffer__t.html" title="File structures.">SFSFileReadBuffer</a> <a class="code" href="struct_s_read_op.html#5dfa4e1259cc150ba724f3dfe5347625" title="File read buffer.">readBuf</a>;
<a name="l00063"></a>00063 
<a name="l00065"></a><a class="code" href="struct_s_read_op.html#2ab52c14ca79eb32510a57b17687277a">00065</a>         <span class="keywordtype">void</span>* <a class="code" href="struct_s_read_op.html#2ab52c14ca79eb32510a57b17687277a" title="target location.">dst</a>;
<a name="l00066"></a><a class="code" href="struct_s_read_op.html#4cd669ce61cf52bd17aa2e2ffd0ba3d7">00066</a>         <span class="keyword">volatile</span> <span class="keywordtype">int</span>* <a class="code" href="struct_s_read_op.html#4cd669ce61cf52bd17aa2e2ffd0ba3d7">lock</a>;
<a name="l00067"></a>00067 
<a name="l00069"></a><a class="code" href="struct_s_read_op.html#97f473e8a311f9c61ed81c3360db8f5e">00069</a>         <span class="keywordtype">void</span>* <a class="code" href="struct_s_read_op.html#97f473e8a311f9c61ed81c3360db8f5e" title="tile information.">file</a>;
<a name="l00070"></a><a class="code" href="struct_s_read_op.html#6a379dc44d78f10a7c9fb91b195445c6">00070</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="struct_s_read_op.html#6a379dc44d78f10a7c9fb91b195445c6">chunkIndex</a>;
<a name="l00071"></a>00071 
<a name="l00073"></a><a class="code" href="struct_s_read_op.html#8142466165097715bb137171deb0c7ab">00073</a>         <a class="code" href="class_gr_u_t_loader.html#328b8875d7cc411c1ad47f0d9279d8f2">GrUTLoader::ECOLORMODE</a> <a class="code" href="struct_s_read_op.html#8142466165097715bb137171deb0c7ab" title="target format information.">dxtMode</a>;
<a name="l00074"></a>00074 };
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 <span class="comment">//==========================================================</span>
<a name="l00079"></a>00079 <span class="comment"></span><span class="comment">//==========================================================</span>
<a name="l00080"></a>00080 
<a name="l00081"></a>00081 <span class="keyword">static</span> <a class="code" href="struct_s_read_op.html">SReadOp</a> _queue[ <a class="code" href="_gr_u_t_loader_8cpp.html#7c76c402ba6986c03a9217fb8f1c1238">WORKER_QUEUE_SIZE</a> ];
<a name="l00082"></a>00082 <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keywordtype">int</span> _threadQuit = 0;
<a name="l00083"></a>00083 <span class="keyword">static</span> <span class="keywordtype">void</span> ThreadMain( <span class="keywordtype">void</span>* );
<a name="l00084"></a>00084 <span class="keyword">static</span> <span class="keywordtype">void</span> ProcessTile( <span class="keywordtype">void</span>* dest, <a class="code" href="class_u_huffman.html" title="Purpose: To perform huffman encoding and fast decoding.">UHuffman</a>* decoder, <a class="code" href="class_gr_u_t_loader.html#328b8875d7cc411c1ad47f0d9279d8f2">GrUTLoader::ECOLORMODE</a> dxtMode );
<a name="l00085"></a>00085 <span class="keyword">static</span> uintptr_t _threadHandles[ <a class="code" href="_gr_u_t_loader_8cpp.html#8b5173357adb02a86c027316e0acdfa0">MAX_THREADS</a> ];
<a name="l00086"></a>00086 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> _threadCount = 0;
<a name="l00087"></a>00087 
<a name="l00088"></a>00088 
<a name="l00089"></a>00089 <span class="comment">//==========================================================</span>
<a name="l00091"></a>00091 <span class="comment"></span><span class="comment">//==========================================================</span>
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 <span class="comment">//----------------------------------------------------------</span>
<a name="l00095"></a>00095 <span class="comment"></span><span class="keyword">static</span> <a class="code" href="_u_fixed_8cpp.html#87785ca0ea4e806c7b25d5bcfe11451d" title="class header">DECLARE_ALIGNED_16</a>( <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, kCodeLengths[ 256 ] ) =
<a name="l00096"></a>00096 {
<a name="l00097"></a>00097         3, 3, 4, 5, 6, 6, 7, 7, 8, 8, 8, 9, 9, 9, 9, 10, 10, 10, 10, 10, 10, 10, 10, 10, 9, 9, 9, 9, 9, 9, 9, 10,
<a name="l00098"></a>00098         10, 10, 10, 10, 10, 9, 9, 9, 10, 9, 9, 9, 9, 9, 9, 8, 9, 9, 9, 9, 10, 9, 9, 9, 9, 9, 9, 9, 8, 9, 9, 9,
<a name="l00099"></a>00099         10, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 10, 10, 11, 10, 10, 10, 10, 11, 11, 10, 11, 11, 12, 11, 11, 11, 11, 11,
<a name="l00100"></a>00100         10, 11, 11, 10, 10, 10, 10, 11, 12, 12, 13, 13, 13, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15,
<a name="l00101"></a>00101         4, 3, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15,
<a name="l00102"></a>00102         15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15,
<a name="l00103"></a>00103         15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 13,
<a name="l00104"></a>00104         13, 11, 10, 9, 9, 8, 9, 9, 10, 10, 10, 10, 10, 10, 10, 9, 9, 9, 9, 9, 9, 9, 9, 8, 8, 7, 7, 7, 6, 5, 5, 3,
<a name="l00105"></a>00105 };
<a name="l00106"></a>00106 
<a name="l00107"></a>00107 <span class="comment">//----------------------------------------------------------</span>
<a name="l00109"></a><a class="code" href="_gr_u_t_loader_8cpp.html#fd259cfab4e4b230ad7ce822cbcf56e5">00109</a> <span class="comment"></span><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="_gr_u_t_loader_8cpp.html#fd259cfab4e4b230ad7ce822cbcf56e5" title="tile count lookup table, maps atlas-tree depth to node count.">kTotalTileCount</a>[ 12 ] =
<a name="l00110"></a>00110 {
<a name="l00111"></a>00111         5592405,
<a name="l00112"></a>00112         1398101,
<a name="l00113"></a>00113         349525,
<a name="l00114"></a>00114         87381,
<a name="l00115"></a>00115         21845,
<a name="l00116"></a>00116         5461,
<a name="l00117"></a>00117         1365,
<a name="l00118"></a>00118         341,
<a name="l00119"></a>00119         85,
<a name="l00120"></a>00120         21,
<a name="l00121"></a>00121         5,
<a name="l00122"></a>00122         1,
<a name="l00123"></a>00123 };
<a name="l00124"></a>00124 
<a name="l00125"></a>00125 <span class="comment">//==========================================================</span>
<a name="l00127"></a>00127 <span class="comment"></span><span class="comment">//==========================================================</span>
<a name="l00128"></a>00128 
<a name="l00129"></a><a class="code" href="_gr_u_t_loader_8h.html#be3e17a9600d9aa8c939e7674d4348a1">00129</a> <a class="code" href="class_gr_u_t_loader.html" title="class GrUTLoader">GrUTLoader</a>* <a class="code" href="_gr_u_t_loader_8cpp.html#be3e17a9600d9aa8c939e7674d4348a1" title="Global variables.">gGrUTLoader</a> = 0;
<a name="l00130"></a>00130 
<a name="l00131"></a>00131 
<a name="l00132"></a>00132 <span class="comment">//**********************************************************</span>
<a name="l00134"></a>00134 <span class="comment"></span><span class="comment">//**********************************************************</span>
<a name="l00135"></a>00135 
<a name="l00136"></a>00136 <span class="comment">//==========================================================</span>
<a name="l00138"></a>00138 <span class="comment"></span><span class="comment">//==========================================================</span>
<a name="l00139"></a>00139 
<a name="l00140"></a>00140 <span class="comment">//----------------------------------------------------------</span>
<a name="l00141"></a><a class="code" href="class_gr_u_t_loader.html#d422dad3e01b8a264d6b4e3976736e81">00141</a> <a class="code" href="class_gr_u_t_loader.html#d422dad3e01b8a264d6b4e3976736e81" title="class GrUTLoader">GrUTLoader::GrUTLoader</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> workerThreadCount )
<a name="l00142"></a>00142 {
<a name="l00144"></a>00144         <a class="code" href="common__afx_8h.html#2630490ce4292ed6d05359d2957796b8">B_ASSERT</a>( gGrUTLoader == 0 );
<a name="l00145"></a>00145         gGrUTLoader = <span class="keyword">this</span>;
<a name="l00146"></a>00146 
<a name="l00148"></a>00148         <a class="code" href="common__afx_8h.html#9f04579206286b6dc8c9708063450144" title="memory functions.">MemSet</a>( _queue, 0, <span class="keyword">sizeof</span>( _queue ) );
<a name="l00149"></a>00149 
<a name="l00151"></a>00151         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="_gr_u_t_loader_8cpp.html#7c76c402ba6986c03a9217fb8f1c1238">WORKER_QUEUE_SIZE</a>; ++i )
<a name="l00152"></a>00152                 _queue[ i ].readBuf.buffer = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[ <a class="code" href="_gr_u_t_loader_8cpp.html#7a21f9990d5e355b5e44af0693e0fe9b">UBERTEX_FILE_CHUNK_SIZE</a> ];
<a name="l00153"></a>00153 
<a name="l00155"></a>00155         <a class="code" href="_gr_u_t_compress_8cpp.html#98ef4e40a287ce4df9b8667da6e358d0" title="Global functions.">GrUTInitCompressor</a>();
<a name="l00156"></a>00156 
<a name="l00158"></a>00158         _writeBuffers = <span class="keyword">new</span> <a class="code" href="struct_s_f_s_file_write_buffer__t.html">SFSFileWriteBuffer</a>[ <a class="code" href="_gr_u_t_loader_8cpp.html#8ef9d2e097bb03e2beb5eed62081345c">WRITE_BUFFER_COUNT</a> ];
<a name="l00159"></a>00159         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="_gr_u_t_loader_8cpp.html#8ef9d2e097bb03e2beb5eed62081345c">WRITE_BUFFER_COUNT</a>; ++i )
<a name="l00160"></a>00160         {
<a name="l00161"></a>00161                 _writeBuffers[ i ].<a class="code" href="struct_s_f_s_file_write_buffer__t.html#e7d9298412a9564b5eeec70f8095ed37">buffer</a> = <a class="code" href="common__afx_8cpp.html#408828bf7887e862154788b40930b54a" title="aligned memory allocation">AlignedAlloc</a>( 2048, 2048 );
<a name="l00162"></a>00162                 _writeBuffers[ i ].<a class="code" href="struct_s_f_s_file_write_buffer__t.html#d0b3938d8a46849111f6b6b244c2e026">complete</a> = 1;
<a name="l00163"></a>00163         }
<a name="l00164"></a>00164 
<a name="l00166"></a>00166         _encoder.<a class="code" href="class_u_huffman.html#9597786e7e70571b8d790728380b71ac">SetCompCodeLengths</a>( kCodeLengths );
<a name="l00167"></a>00167 
<a name="l00169"></a>00169         _threadCount = <a class="code" href="common__afx_8h.html#0296e17691267defafdfde06589f50d5">Min</a>( workerThreadCount, <a class="code" href="_gr_u_t_loader_8cpp.html#8b5173357adb02a86c027316e0acdfa0">MAX_THREADS</a> );
<a name="l00170"></a>00170         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; workerThreadCount; ++i )
<a name="l00171"></a>00171                 _threadHandles[ i ] = _beginthread( ThreadMain, 1024, 0 );
<a name="l00172"></a>00172 
<a name="l00173"></a>00173 <span class="preprocessor">#if 0</span>
<a name="l00174"></a>00174 <span class="preprocessor"></span>        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> compStream[ 2 ];
<a name="l00175"></a>00175         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; 256; ++i )
<a name="l00176"></a>00176         {
<a name="l00177"></a>00177                 _entropyEncoder.SetCompStream( compStream, kCodeLengths );
<a name="l00178"></a>00178                 _entropyEncoder.WriteValue( i );
<a name="l00179"></a>00179                 _entropyEncoder.SetDecompStream( kCodeLengths, compStream, _entropyEncoder.FinishWriting() );
<a name="l00180"></a>00180                 <span class="keywordflow">if</span> ( _entropyEncoder.ReadValue() != i )
<a name="l00181"></a>00181                         <a class="code" href="common__afx_8cpp.html#f1a1e0f08b49000974368246e5b97f84" title="debug output/console output function.">PrintF</a>( <span class="stringliteral">"Entropy error on value %d.\n"</span>, i );
<a name="l00182"></a>00182         }
<a name="l00183"></a>00183         <span class="keywordtype">bool</span> breakpt = <span class="keyword">false</span>;
<a name="l00184"></a>00184         breakpt = breakpt;
<a name="l00185"></a>00185 <span class="preprocessor">#endif</span>
<a name="l00186"></a>00186 <span class="preprocessor"></span>}
<a name="l00187"></a>00187 
<a name="l00188"></a>00188 <span class="comment">//----------------------------------------------------------</span>
<a name="l00189"></a><a class="code" href="class_gr_u_t_loader.html#470a07f30f44b351519508c66b11ef22">00189</a> <a class="code" href="class_gr_u_t_loader.html#470a07f30f44b351519508c66b11ef22">GrUTLoader::~GrUTLoader</a>()
<a name="l00190"></a>00190 {
<a name="l00192"></a>00192         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="_gr_u_t_loader_8cpp.html#7c76c402ba6986c03a9217fb8f1c1238">WORKER_QUEUE_SIZE</a>; ++i )
<a name="l00193"></a>00193         {
<a name="l00195"></a>00195                 <span class="keywordflow">while</span> ( LockCompareAndSwap( &amp;_queue[ i ].inUse, 0, 1 ) == 1 )
<a name="l00196"></a>00196                         LockPause();
<a name="l00197"></a>00197 
<a name="l00199"></a>00199                 <span class="keyword">delete</span>[] _queue[ i ].<a class="code" href="struct_s_read_op.html#5dfa4e1259cc150ba724f3dfe5347625" title="File read buffer.">readBuf</a>.<a class="code" href="struct_s_f_s_file_read_buffer__t.html#bc7bdce1c0dfdad630db6fedce106bab">buffer</a>;
<a name="l00200"></a>00200         }
<a name="l00201"></a>00201 
<a name="l00203"></a>00203         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; _threadCount; ++i )
<a name="l00204"></a>00204         {
<a name="l00208"></a>00208                 <span class="keywordflow">while</span> ( LockSwap( &amp;_threadQuit, LOCK_TAKEN ) == LOCK_TAKEN )
<a name="l00209"></a>00209                         LockPause();
<a name="l00210"></a>00210         }
<a name="l00211"></a>00211 
<a name="l00213"></a>00213         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="_gr_u_t_loader_8cpp.html#8ef9d2e097bb03e2beb5eed62081345c">WRITE_BUFFER_COUNT</a>; ++i )
<a name="l00214"></a>00214                 <a class="code" href="common__afx_8cpp.html#2fd85effcc325614b972f5a87070d6b2">AlignedFree</a>( ( <span class="keywordtype">void</span>* )_writeBuffers[ i ].<a class="code" href="glext_8h.html#c4fdb15bdbcd63430bab668b5419ed9f">buffer</a> );
<a name="l00215"></a>00215         <span class="keyword">delete</span>[] _writeBuffers;
<a name="l00216"></a>00216 
<a name="l00218"></a>00218         gGrUTLoader = 0;
<a name="l00219"></a>00219 }
<a name="l00220"></a>00220 
<a name="l00221"></a>00221 
<a name="l00222"></a>00222 <span class="comment">//==========================================================</span>
<a name="l00224"></a>00224 <span class="comment"></span><span class="comment">//==========================================================</span>
<a name="l00225"></a>00225 
<a name="l00226"></a>00226 <span class="comment">//----------------------------------------------------------</span>
<a name="l00227"></a>00227 <a class="code" href="class_gr_u_t_atlas.html" title="class GrUTAtlas">GrUTAtlas</a>*
<a name="l00228"></a><a class="code" href="class_gr_u_t_loader.html#9a52f424b6e3bb62afbfbd05e13d048a">00228</a> <a class="code" href="class_gr_u_t_loader.html#9a52f424b6e3bb62afbfbd05e13d048a" title="public methods">GrUTLoader::CreateUbertex</a>( <span class="keywordtype">void</span>* file, <span class="keyword">const</span> <span class="keywordtype">void</span>* tileUseBitMask, <span class="keyword">const</span> <span class="keywordtype">void</span>* metaData,
<a name="l00229"></a>00229                                                    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> metaDataSize, ProgressCallback callback )
<a name="l00230"></a>00230 {
<a name="l00232"></a>00232         <a class="code" href="class_gr_u_t_loader.html#a2715cc250d1bdbb321200ef630756cb" title="wait for all decode requests to finish.">Flush</a>();
<a name="l00233"></a>00233 
<a name="l00236"></a>00236         <a class="code" href="class_u_r_l_e.html" title="Purpose: To encode and decode RLE compressed data.">URLE</a> rleEncoder;
<a name="l00237"></a>00237         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rleBufSize = rleEncoder.<a class="code" href="class_u_r_l_e.html#517415db71b4453c352c58ad288cc224" title="compression routines.">CalcMaxCompSize</a>( <a class="code" href="_gr_u_t_loader_8cpp.html#53cca13b10221f54df430512fb1c07be">UBERTEX_USAGE_MASK_SIZE</a> );
<a name="l00238"></a>00238 
<a name="l00240"></a>00240         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* atlasData = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[ rleBufSize ];
<a name="l00241"></a>00241         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> atlasDataSize = rleEncoder.<a class="code" href="class_u_r_l_e.html#d41520530d62de1703824d56bb214116">Compress</a>( atlasData, ( <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* )tileUseBitMask, <a class="code" href="_gr_u_t_loader_8cpp.html#53cca13b10221f54df430512fb1c07be">UBERTEX_USAGE_MASK_SIZE</a> );
<a name="l00242"></a>00242 
<a name="l00244"></a>00244         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> metaDataStart = <span class="keyword">sizeof</span>( <a class="code" href="struct_s_u_t_header.html" title="internal structures.">SUTHeader</a> );
<a name="l00245"></a>00245         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> atlasDataStart = metaDataStart + metaDataSize;
<a name="l00246"></a>00246         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> chunkStart = ( atlasDataStart + atlasDataSize + 2047 ) / 2048;
<a name="l00247"></a>00247 
<a name="l00249"></a>00249         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dataSize = <span class="keyword">sizeof</span>( <a class="code" href="struct_s_u_t_header.html" title="internal structures.">SUTHeader</a> ) + metaDataSize + atlasDataSize;
<a name="l00250"></a>00250         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fileBufSize = ( ( dataSize + 2047 ) / 2048 ) * 2048;
<a name="l00251"></a>00251         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* fileBuf = ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* )<a class="code" href="common__afx_8cpp.html#408828bf7887e862154788b40930b54a" title="aligned memory allocation">AlignedAlloc</a>( 2048, fileBufSize );
<a name="l00252"></a>00252 
<a name="l00254"></a>00254         <a class="code" href="struct_s_u_t_header.html" title="internal structures.">SUTHeader</a>* header = ( <a class="code" href="struct_s_u_t_header.html" title="internal structures.">SUTHeader</a>* )fileBuf;
<a name="l00255"></a>00255         memcpy( header-&gt;<a class="code" href="struct_s_u_t_header.html#4b17f37b5ec2b84cd7e556e1db1526fd" title="ubertexture data.">magic</a>, <a class="code" href="_gr_u_t_loader_8cpp.html#c045dcc99fe23ab148b611ba6fbac7e2" title="class header.">UBERTEX_FILE_MAGIC</a>, 8 );
<a name="l00256"></a>00256         header-&gt;<a class="code" href="struct_s_u_t_header.html#972e18afc8d7c6b0f613c15c874b409e" title="must be &amp;#39;&amp;#39;&amp;#39;U&amp;#39;&amp;#39;T&amp;#39;&amp;#39;X&amp;#39;&amp;#39;&amp;#39;&amp;#39; &amp;#39;&amp;#39;&amp;#39;&amp;#39;...">minorVer</a> = 0;
<a name="l00257"></a>00257         header-&gt;<a class="code" href="struct_s_u_t_header.html#d52c5e749973c73c642fb84681920831" title="must be 0">majorVer</a> = 1;
<a name="l00258"></a>00258         header-&gt;<a class="code" href="struct_s_u_t_header.html#4dd77cccfd65e78c6f9e151b2c45d885" title="must be 1">metaDataStart</a> = metaDataStart;
<a name="l00259"></a>00259         header-&gt;<a class="code" href="struct_s_u_t_header.html#8a505fd64fc60eeaff34a5c624ab1568" title="location of any extra data.">metaDataSize</a> = metaDataSize;
<a name="l00260"></a>00260         header-&gt;<a class="code" href="struct_s_u_t_header.html#9e7bd76e03d33e6c3abf8bb8dfff7114" title="size in bytes of any extra data.">atlasStart</a> = atlasDataStart;
<a name="l00261"></a>00261         header-&gt;<a class="code" href="struct_s_u_t_header.html#f8d6e268331abd330f1b8a64eb3a6d18" title="location in the file where the atlas starts.">atlasSize</a> = atlasDataSize;
<a name="l00262"></a>00262         header-&gt;<a class="code" href="struct_s_u_t_header.html#e3658a7f87cd2bab631d25a256ca5d69" title="size of the atlas in 2K chunks.">chunkStart</a> = chunkStart;
<a name="l00263"></a>00263         header-&gt;<a class="code" href="struct_s_u_t_header.html#a2005bd7672275f54997ef96dfc69b58" title="the first 2K chunk containing tile data.">basicCheckSum</a> = <a class="code" href="common__afx_8cpp.html#b19f946d095ffc1c2e60309e6d2e75ed" title="hash functions.">HashMem32</a>( header, offsetof( <a class="code" href="struct_s_u_t_header.html" title="internal structures.">SUTHeader</a>, basicCheckSum ) );
<a name="l00264"></a>00264 
<a name="l00266"></a>00266         <span class="keywordflow">if</span> ( metaDataSize &gt; 0 )
<a name="l00267"></a>00267                 <a class="code" href="common__afx_8cpp.html#b4b15928b71967d4c4eb8c12c3108643">MemCopy</a>( fileBuf + metaDataStart, metaData, metaDataSize );
<a name="l00268"></a>00268 
<a name="l00270"></a>00270         <a class="code" href="common__afx_8cpp.html#b4b15928b71967d4c4eb8c12c3108643">MemCopy</a>( fileBuf + atlasDataStart, atlasData, atlasDataSize );
<a name="l00271"></a>00271 
<a name="l00273"></a>00273         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> paddingStart = atlasDataStart + atlasDataSize;
<a name="l00274"></a>00274         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> paddingSize = fileBufSize - paddingStart;
<a name="l00275"></a>00275         <a class="code" href="common__afx_8h.html#9f04579206286b6dc8c9708063450144" title="memory functions.">MemSet</a>( fileBuf + paddingStart, 0, paddingSize );
<a name="l00276"></a>00276 
<a name="l00278"></a>00278         <a class="code" href="struct_s_f_s_file_write_buffer__t.html">SFSFileWriteBuffer_t</a> writeBuf;
<a name="l00279"></a>00279         writeBuf.<a class="code" href="struct_s_f_s_file_write_buffer__t.html#e7d9298412a9564b5eeec70f8095ed37">buffer</a> = fileBuf;
<a name="l00280"></a>00280         writeBuf.<a class="code" href="struct_s_f_s_file_write_buffer__t.html#d0b3938d8a46849111f6b6b244c2e026">complete</a> = 0;
<a name="l00281"></a>00281         <a class="code" href="_f_s_disk_serv_8h.html#c7abe5c9b19a9611de00573a09fd3a61">FS_WriteFile</a>( file, 0, &amp;writeBuf, fileBufSize );
<a name="l00282"></a>00282         <a class="code" href="_f_s_disk_serv_8h.html#b8abbd85f1942b0f3dca1793ea4e8978">FS_Wait</a>( &amp;writeBuf.<a class="code" href="struct_s_f_s_file_write_buffer__t.html#d0b3938d8a46849111f6b6b244c2e026">complete</a> );
<a name="l00283"></a>00283 
<a name="l00285"></a>00285         <a class="code" href="common__afx_8cpp.html#2fd85effcc325614b972f5a87070d6b2">AlignedFree</a>( fileBuf );
<a name="l00286"></a>00286         <span class="keyword">delete</span>[] atlasData;
<a name="l00287"></a>00287 
<a name="l00289"></a>00289         <a class="code" href="class_gr_u_t_atlas.html" title="class GrUTAtlas">GrUTAtlas</a>* atlas = <span class="keyword">new</span> <a class="code" href="class_gr_u_t_atlas.html" title="class GrUTAtlas">GrUTAtlas</a>( ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>* )tileUseBitMask, chunkStart );
<a name="l00290"></a>00290 
<a name="l00292"></a>00292         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* tileData = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> [ <a class="code" href="_gr_u_t_loader_8cpp.html#588d766cbac1423af361ff71d1c26923">RAW_TILE_SIZE</a> ];
<a name="l00293"></a>00293         <a class="code" href="common__afx_8h.html#9f04579206286b6dc8c9708063450144" title="memory functions.">MemSet</a>( tileData, 0x7F, <a class="code" href="_gr_u_t_loader_8cpp.html#588d766cbac1423af361ff71d1c26923">RAW_TILE_SIZE</a> );
<a name="l00294"></a>00294 
<a name="l00296"></a>00296         FillChunks( file, atlas, tileData );
<a name="l00297"></a>00297         <span class="keyword">delete</span>[] tileData;
<a name="l00298"></a>00298 
<a name="l00300"></a>00300         <span class="keywordflow">return</span> atlas;
<a name="l00301"></a>00301 }
<a name="l00302"></a>00302 
<a name="l00303"></a>00303 <span class="comment">//----------------------------------------------------------</span>
<a name="l00304"></a>00304 <a class="code" href="class_gr_u_t_atlas.html" title="class GrUTAtlas">GrUTAtlas</a>*
<a name="l00305"></a><a class="code" href="class_gr_u_t_loader.html#8e7dbf8a92517c281d2b0587a4bcdf55">00305</a> <a class="code" href="class_gr_u_t_loader.html#8e7dbf8a92517c281d2b0587a4bcdf55">GrUTLoader::LoadUbertex</a>( <span class="keywordtype">void</span>* file )
<a name="l00306"></a>00306 {
<a name="l00308"></a>00308         DECLARE_ALIGNED( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, headerBuf[ <a class="code" href="_gr_u_t_loader_8cpp.html#7a21f9990d5e355b5e44af0693e0fe9b">UBERTEX_FILE_CHUNK_SIZE</a> ], UBERTEX_FILE_CHUNK_SIZE );
<a name="l00309"></a>00309 
<a name="l00311"></a>00311         <a class="code" href="class_u_r_l_e.html" title="Purpose: To encode and decode RLE compressed data.">URLE</a> rleDecoder;
<a name="l00312"></a>00312 
<a name="l00316"></a>00316         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> kInitReadBufSize = 65536;
<a name="l00317"></a>00317 
<a name="l00319"></a>00319         <a class="code" href="struct_s_f_s_file_read_buffer__t.html" title="File structures.">SFSFileReadBuffer</a> readBuf;
<a name="l00320"></a>00320         readBuf.<a class="code" href="struct_s_f_s_file_read_buffer__t.html#bc7bdce1c0dfdad630db6fedce106bab">buffer</a> = headerBuf;
<a name="l00321"></a>00321         readBuf.<a class="code" href="struct_s_f_s_file_read_buffer__t.html#87bd7289db7343742a40bdc52f4fff0a">complete</a> = 0;
<a name="l00322"></a>00322         <a class="code" href="_f_s_disk_serv_8h.html#9e21afbbba101c7dc7be9a43fd5291f6">FS_ReadFile</a>( &amp;readBuf, file, 0, UBERTEX_FILE_CHUNK_SIZE );
<a name="l00323"></a>00323         <a class="code" href="_f_s_disk_serv_8h.html#b8abbd85f1942b0f3dca1793ea4e8978">FS_Wait</a>( &amp;readBuf.<a class="code" href="struct_s_f_s_file_read_buffer__t.html#87bd7289db7343742a40bdc52f4fff0a">complete</a> );
<a name="l00324"></a>00324 
<a name="l00328"></a>00328         <a class="code" href="struct_s_u_t_header.html" title="internal structures.">SUTHeader</a>* header = ( <a class="code" href="struct_s_u_t_header.html" title="internal structures.">SUTHeader</a>* )headerBuf;
<a name="l00329"></a>00329 
<a name="l00331"></a>00331         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> checkSum = <a class="code" href="common__afx_8cpp.html#b19f946d095ffc1c2e60309e6d2e75ed" title="hash functions.">HashMem32</a>( header, offsetof( <a class="code" href="struct_s_u_t_header.html" title="internal structures.">SUTHeader</a>, basicCheckSum ) );
<a name="l00332"></a>00332         <span class="keywordflow">if</span> ( checkSum != header-&gt;<a class="code" href="struct_s_u_t_header.html#a2005bd7672275f54997ef96dfc69b58" title="the first 2K chunk containing tile data.">basicCheckSum</a> )
<a name="l00333"></a>00333                 <span class="keywordflow">return</span> 0;
<a name="l00334"></a>00334 
<a name="l00338"></a>00338         <span class="keywordflow">if</span> ( memcmp( header-&gt;<a class="code" href="struct_s_u_t_header.html#4b17f37b5ec2b84cd7e556e1db1526fd" title="ubertexture data.">magic</a>, <a class="code" href="_gr_u_t_loader_8cpp.html#c045dcc99fe23ab148b611ba6fbac7e2" title="class header.">UBERTEX_FILE_MAGIC</a>, 8 ) != 0 )
<a name="l00339"></a>00339                 <span class="keywordflow">return</span> 0;
<a name="l00340"></a>00340 
<a name="l00342"></a>00342         <span class="keywordflow">if</span> ( header-&gt;<a class="code" href="struct_s_u_t_header.html#d52c5e749973c73c642fb84681920831" title="must be 0">majorVer</a> &gt; 1 )
<a name="l00343"></a>00343                 <span class="keywordflow">return</span> 0;
<a name="l00344"></a>00344 
<a name="l00348"></a>00348         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fullHeaderSize = header-&gt;<a class="code" href="struct_s_u_t_header.html#e3658a7f87cd2bab631d25a256ca5d69" title="size of the atlas in 2K chunks.">chunkStart</a> * UBERTEX_FILE_CHUNK_SIZE;
<a name="l00349"></a>00349 
<a name="l00352"></a>00352         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* headerReadBuf = ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* )<a class="code" href="common__afx_8cpp.html#408828bf7887e862154788b40930b54a" title="aligned memory allocation">AlignedAlloc</a>( UBERTEX_FILE_CHUNK_SIZE, fullHeaderSize );
<a name="l00353"></a>00353         <a class="code" href="common__afx_8cpp.html#b4b15928b71967d4c4eb8c12c3108643">MemCopy</a>( headerReadBuf, headerBuf, UBERTEX_FILE_CHUNK_SIZE );
<a name="l00354"></a>00354 
<a name="l00356"></a>00356         readBuf.<a class="code" href="struct_s_f_s_file_read_buffer__t.html#bc7bdce1c0dfdad630db6fedce106bab">buffer</a> = headerReadBuf + UBERTEX_FILE_CHUNK_SIZE;
<a name="l00357"></a>00357         readBuf.<a class="code" href="struct_s_f_s_file_read_buffer__t.html#87bd7289db7343742a40bdc52f4fff0a">complete</a> = 0;
<a name="l00358"></a>00358         <a class="code" href="_f_s_disk_serv_8h.html#9e21afbbba101c7dc7be9a43fd5291f6">FS_ReadFile</a>( &amp;readBuf, file, UBERTEX_FILE_CHUNK_SIZE, fullHeaderSize - UBERTEX_FILE_CHUNK_SIZE );
<a name="l00359"></a>00359         <a class="code" href="_f_s_disk_serv_8h.html#b8abbd85f1942b0f3dca1793ea4e8978">FS_Wait</a>( &amp;readBuf.<a class="code" href="struct_s_f_s_file_read_buffer__t.html#87bd7289db7343742a40bdc52f4fff0a">complete</a> );
<a name="l00360"></a>00360 
<a name="l00362"></a>00362         <span class="keywordtype">void</span>* atlasBitmap = <a class="code" href="common__afx_8cpp.html#a38123a381fda4eb71767e320a1331d1" title="temporary memory allocation">TempAlloc</a>( <a class="code" href="_gr_u_t_loader_8cpp.html#a8a165767957cdece95c881020536c3b">RAW_ATLAS_SIZE</a> );
<a name="l00363"></a>00363         rleDecoder.<a class="code" href="class_u_r_l_e.html#4be2c4f71c9902b4b9dd8292e74bb58f" title="decompression routines.">Decompress</a>( ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* )atlasBitmap, <a class="code" href="_gr_u_t_loader_8cpp.html#a8a165767957cdece95c881020536c3b">RAW_ATLAS_SIZE</a>, headerReadBuf + header-&gt;<a class="code" href="struct_s_u_t_header.html#9e7bd76e03d33e6c3abf8bb8dfff7114" title="size in bytes of any extra data.">atlasStart</a> );
<a name="l00364"></a>00364 
<a name="l00366"></a>00366         <a class="code" href="common__afx_8cpp.html#2fd85effcc325614b972f5a87070d6b2">AlignedFree</a>( headerReadBuf );
<a name="l00367"></a>00367 
<a name="l00369"></a>00369         <a class="code" href="class_gr_u_t_atlas.html" title="class GrUTAtlas">GrUTAtlas</a>* atlas = <span class="keyword">new</span> <a class="code" href="class_gr_u_t_atlas.html" title="class GrUTAtlas">GrUTAtlas</a>( ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>* )atlasBitmap, header-&gt;<a class="code" href="struct_s_u_t_header.html#e3658a7f87cd2bab631d25a256ca5d69" title="size of the atlas in 2K chunks.">chunkStart</a> );
<a name="l00370"></a>00370 
<a name="l00372"></a>00372         <a class="code" href="common__afx_8cpp.html#4f8b297dfd37bb5e5081041d840d19cf">TempFree</a>( atlasBitmap );
<a name="l00373"></a>00373 
<a name="l00375"></a>00375         <span class="keywordflow">return</span> atlas;
<a name="l00376"></a>00376 }
<a name="l00377"></a>00377 
<a name="l00378"></a>00378 <span class="comment">//----------------------------------------------------------</span>
<a name="l00379"></a>00379 <span class="keywordtype">void</span>
<a name="l00380"></a><a class="code" href="class_gr_u_t_loader.html#291cd71cede4de0eafd22aad048f50e6">00380</a> <a class="code" href="class_gr_u_t_loader.html#291cd71cede4de0eafd22aad048f50e6">GrUTLoader::ChangeLayout</a>( <span class="keywordtype">void</span>* file, <span class="keyword">const</span> <span class="keywordtype">void</span>* tileUseBitMask, ProgressCallback callback )
<a name="l00381"></a>00381 {
<a name="l00383"></a>00383         <a class="code" href="class_gr_u_t_loader.html#a2715cc250d1bdbb321200ef630756cb" title="wait for all decode requests to finish.">Flush</a>();
<a name="l00384"></a>00384 
<a name="l00386"></a>00386         
<a name="l00387"></a>00387 
<a name="l00388"></a>00388         <span class="comment">//</span>
<a name="l00389"></a>00389         
<a name="l00390"></a>00390 }
<a name="l00391"></a>00391 
<a name="l00392"></a>00392 <span class="comment">//----------------------------------------------------------</span>
<a name="l00393"></a>00393 <span class="keywordtype">void</span>
<a name="l00394"></a><a class="code" href="class_gr_u_t_loader.html#c61068d4af869e277fa8303dd2fc6689">00394</a> <a class="code" href="class_gr_u_t_loader.html#c61068d4af869e277fa8303dd2fc6689" title="call this to free an atlas.">GrUTLoader::FreeAtlas</a>( <a class="code" href="class_gr_u_t_atlas.html" title="class GrUTAtlas">GrUTAtlas</a>* atlas )
<a name="l00395"></a>00395 {
<a name="l00396"></a>00396         <span class="keyword">delete</span> atlas;
<a name="l00397"></a>00397 }
<a name="l00398"></a>00398 
<a name="l00399"></a>00399 <span class="comment">//----------------------------------------------------------</span>
<a name="l00400"></a>00400 <span class="keywordtype">void</span>
<a name="l00401"></a><a class="code" href="class_gr_u_t_loader.html#021fb0768072b4306207993a4e8e5415">00401</a> <a class="code" href="class_gr_u_t_loader.html#021fb0768072b4306207993a4e8e5415">GrUTLoader::DecodeChunk</a>( <span class="keywordtype">void</span>* <a class="code" href="glext_8h.html#92034251bfd455d524a9b5610cddba00">dst</a>, <span class="keyword">volatile</span> <span class="keywordtype">int</span>* lock, <span class="keywordtype">void</span>* file, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> chunkIndex, <a class="code" href="class_gr_u_t_loader.html#328b8875d7cc411c1ad47f0d9279d8f2">ECOLORMODE</a> dxtMode )
<a name="l00402"></a>00402 {
<a name="l00404"></a>00404         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="_gr_u_t_loader_8cpp.html#7c76c402ba6986c03a9217fb8f1c1238">WORKER_QUEUE_SIZE</a>; ++i )
<a name="l00405"></a>00405         {
<a name="l00407"></a>00407                 <span class="keywordflow">if</span> ( !TryTakeLock( &amp;_queue[ i ].inUse ) )
<a name="l00408"></a>00408                         <span class="keywordflow">continue</span>;
<a name="l00409"></a>00409 
<a name="l00411"></a>00411                 TakeLockWait( lock );
<a name="l00412"></a>00412 
<a name="l00414"></a>00414                 _queue[ i ].<a class="code" href="struct_s_read_op.html#2ab52c14ca79eb32510a57b17687277a" title="target location.">dst</a> = dst;
<a name="l00415"></a>00415                 _queue[ i ].<a class="code" href="struct_s_read_op.html#4cd669ce61cf52bd17aa2e2ffd0ba3d7">lock</a> = lock;
<a name="l00416"></a>00416 
<a name="l00418"></a>00418                 _queue[ i ].<a class="code" href="struct_s_read_op.html#97f473e8a311f9c61ed81c3360db8f5e" title="tile information.">file</a> = file;
<a name="l00419"></a>00419                 _queue[ i ].<a class="code" href="struct_s_read_op.html#6a379dc44d78f10a7c9fb91b195445c6">chunkIndex</a> = chunkIndex;
<a name="l00420"></a>00420 
<a name="l00423"></a>00423                 <a class="code" href="filesystem__afx_8h.html#2dfedf2033eee861d23c808f79ed5837">FSsize</a> <a class="code" href="glext_8h.html#a782f3aea23e3c30029c811241dc2c82">offset</a> = chunkIndex * <a class="code" href="_gr_u_t_loader_8cpp.html#7a21f9990d5e355b5e44af0693e0fe9b">UBERTEX_FILE_CHUNK_SIZE</a>;
<a name="l00424"></a>00424 
<a name="l00428"></a>00428                 <a class="code" href="_f_s_disk_serv_8h.html#9e21afbbba101c7dc7be9a43fd5291f6">FS_ReadFile</a>( &amp;_queue[ i ].readBuf, file, offset, UBERTEX_FILE_CHUNK_SIZE );
<a name="l00429"></a>00429         }
<a name="l00430"></a>00430 }
<a name="l00431"></a>00431 
<a name="l00432"></a>00432 <span class="comment">//----------------------------------------------------------</span>
<a name="l00433"></a>00433 <span class="keywordtype">void</span>
<a name="l00434"></a><a class="code" href="class_gr_u_t_loader.html#9eca6963597c1c7e5c1f378774606f2f">00434</a> <a class="code" href="class_gr_u_t_loader.html#9eca6963597c1c7e5c1f378774606f2f">GrUTLoader::WriteChunk</a>( <span class="keywordtype">void</span>* file, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> chunkIndex, <span class="keyword">const</span> <span class="keywordtype">void</span>* <a class="code" href="glext_8h.html#72e0fdf0f845ded60b1fada9e9195cd7">src</a> )
<a name="l00435"></a>00435 {
<a name="l00437"></a>00437         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* bump = ( ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* )src ) + 0;
<a name="l00438"></a>00438         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* diffuse = ( ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* )src ) + 4096;
<a name="l00439"></a>00439         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* specular = ( ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* )src ) + 20480;
<a name="l00440"></a>00440 
<a name="l00442"></a>00442         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> slot = 0;
<a name="l00443"></a>00443         <span class="keywordflow">while</span>( <span class="keyword">true</span> )
<a name="l00444"></a>00444         {
<a name="l00447"></a>00447                 <span class="keywordflow">if</span> ( <a class="code" href="_f_s_disk_serv_8h.html#013362d3615068eee7220194a88a4d73" title="waits for and resets the gate&amp;#39;s value.">FS_IsComplete</a>( &amp;_writeBuffers[ slot ].complete ) )
<a name="l00448"></a>00448                         <span class="keywordflow">break</span>;
<a name="l00449"></a>00449 
<a name="l00451"></a>00451                 slot = ( slot + 1 ) % <a class="code" href="_gr_u_t_loader_8cpp.html#8ef9d2e097bb03e2beb5eed62081345c">WRITE_BUFFER_COUNT</a>;
<a name="l00452"></a>00452         }
<a name="l00453"></a>00453 
<a name="l00456"></a>00456         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> kMaxBitCount = 16384;
<a name="l00457"></a>00457 
<a name="l00459"></a>00459         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> chop = 0;
<a name="l00460"></a>00460         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bitCount = 0;
<a name="l00461"></a>00461         <span class="keywordflow">do</span>
<a name="l00462"></a>00462         {
<a name="l00464"></a>00464                 _encoder.<a class="code" href="class_u_huffman.html#9787e1690a35cb0338b9225a2699b01e">SetCompStreamFast</a>( ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* )_writeBuffers[ slot ].<a class="code" href="glext_8h.html#c4fdb15bdbcd63430bab668b5419ed9f">buffer</a> );
<a name="l00465"></a>00465 
<a name="l00467"></a>00467                 <a class="code" href="_gr_u_t_compress_8cpp.html#2ea5fdafb94e6cac88ddc851b171bc05">GrUTCompressA</a>( &amp;_encoder, bump, 1, chop );
<a name="l00468"></a>00468                 <a class="code" href="_gr_u_t_compress_8cpp.html#bee5db5b42213cb69584c47cbf9eeec2" title="ubertexture compression services">GrUTCompressBGRX</a>( &amp;_encoder, diffuse, chop );
<a name="l00469"></a>00469                 <a class="code" href="_gr_u_t_compress_8cpp.html#2ea5fdafb94e6cac88ddc851b171bc05">GrUTCompressA</a>( &amp;_encoder, diffuse + 3, 4, chop );
<a name="l00470"></a>00470                 <a class="code" href="_gr_u_t_compress_8cpp.html#bee5db5b42213cb69584c47cbf9eeec2" title="ubertexture compression services">GrUTCompressBGRX</a>( &amp;_encoder, specular, chop );
<a name="l00471"></a>00471 
<a name="l00474"></a>00474                 bitCount = _encoder.<a class="code" href="class_u_huffman.html#516c71caadbb3ae69cff3d66453c140f">FinishWriting</a>();
<a name="l00475"></a>00475 
<a name="l00478"></a>00478                 ++chop;
<a name="l00479"></a>00479         } <span class="keywordflow">while</span>( bitCount &gt; kMaxBitCount );
<a name="l00480"></a>00480 
<a name="l00482"></a>00482         <a class="code" href="_f_s_disk_serv_8h.html#c7abe5c9b19a9611de00573a09fd3a61">FS_WriteFile</a>( file, chunkIndex * 2048, _writeBuffers + slot, 2048 );
<a name="l00483"></a>00483 }
<a name="l00484"></a>00484 
<a name="l00485"></a>00485 <span class="comment">//----------------------------------------------------------</span>
<a name="l00486"></a>00486 <span class="keywordtype">void</span>
<a name="l00487"></a><a class="code" href="class_gr_u_t_loader.html#a2715cc250d1bdbb321200ef630756cb">00487</a> <a class="code" href="class_gr_u_t_loader.html#a2715cc250d1bdbb321200ef630756cb" title="wait for all decode requests to finish.">GrUTLoader::Flush</a>()
<a name="l00488"></a>00488 {
<a name="l00490"></a>00490         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="_gr_u_t_loader_8cpp.html#7c76c402ba6986c03a9217fb8f1c1238">WORKER_QUEUE_SIZE</a>; ++i )
<a name="l00491"></a>00491                 WaitLockFree( &amp;_queue[ i ].inUse );
<a name="l00492"></a>00492 }
<a name="l00493"></a>00493 
<a name="l00494"></a>00494 
<a name="l00495"></a>00495 <span class="comment">//==========================================================</span>
<a name="l00497"></a>00497 <span class="comment"></span><span class="comment">//==========================================================</span>
<a name="l00498"></a>00498 
<a name="l00499"></a>00499 <span class="comment">//----------------------------------------------------------</span>
<a name="l00500"></a>00500 <span class="keywordtype">void</span>
<a name="l00501"></a>00501 GrUTLoader::FillChunks( <span class="keywordtype">void</span>* file, <a class="code" href="class_gr_u_t_atlas.html" title="class GrUTAtlas">GrUTAtlas</a>* atlas, <span class="keyword">const</span> <span class="keywordtype">void</span>* tileData, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="glext_8h.html#1c814629538debe12a7bfe2509a3671e">depth</a> )
<a name="l00502"></a>00502 {
<a name="l00504"></a>00504         <span class="keywordflow">if</span> ( atlas-&gt;<a class="code" href="class_gr_u_t_atlas.html#b2181198f45b057ad3776187e11b6bfe">IsEmpty</a>() )
<a name="l00505"></a>00505                 <span class="keywordflow">return</span>;
<a name="l00506"></a>00506 
<a name="l00510"></a>00510         <span class="keywordflow">if</span> ( atlas-&gt;<a class="code" href="class_gr_u_t_atlas.html#51707ae21d8a5b2d4349b23ba4209651" title="tree traversal.">IsLeaf</a>() )
<a name="l00511"></a>00511         {
<a name="l00513"></a>00513                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> chunkIndex = atlas-&gt;<a class="code" href="class_gr_u_t_atlas.html#8cdc84f1ac50f1d3b2e6f9bc889e9c15">GetChunk</a>();
<a name="l00514"></a>00514                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> chunkEnd = chunkIndex + <a class="code" href="_gr_u_t_loader_8cpp.html#fd259cfab4e4b230ad7ce822cbcf56e5" title="tile count lookup table, maps atlas-tree depth to node count.">kTotalTileCount</a>[ depth ];
<a name="l00515"></a>00515                 <span class="keywordflow">for</span> ( ; chunkIndex != chunkEnd; ++chunkIndex )
<a name="l00516"></a>00516                         <a class="code" href="class_gr_u_t_loader.html#9eca6963597c1c7e5c1f378774606f2f">WriteChunk</a>( file, chunkIndex, tileData );
<a name="l00517"></a>00517         }
<a name="l00518"></a>00518         <span class="keywordflow">else</span>
<a name="l00519"></a>00519         {
<a name="l00521"></a>00521                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> chunkIndex = atlas-&gt;<a class="code" href="class_gr_u_t_atlas.html#8cdc84f1ac50f1d3b2e6f9bc889e9c15">GetChunk</a>();
<a name="l00522"></a>00522                 <a class="code" href="class_gr_u_t_loader.html#9eca6963597c1c7e5c1f378774606f2f">WriteChunk</a>( file, chunkIndex, tileData );
<a name="l00523"></a>00523 
<a name="l00525"></a>00525                 <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; 4; ++i )
<a name="l00526"></a>00526                         FillChunks( file, atlas-&gt;<a class="code" href="class_gr_u_t_atlas.html#ac1053adb8f881c4db9bce7d0ee185d4">GetChild</a>( i ), tileData, depth + 1 );          
<a name="l00527"></a>00527         }
<a name="l00528"></a>00528 }
<a name="l00529"></a>00529 
<a name="l00530"></a>00530 
<a name="l00531"></a>00531 <span class="comment">//**********************************************************</span>
<a name="l00533"></a>00533 <span class="comment"></span><span class="comment">//**********************************************************</span>
<a name="l00534"></a>00534 
<a name="l00535"></a>00535 <span class="comment">//----------------------------------------------------------</span>
<a name="l00536"></a>00536 <span class="keywordtype">void</span> ThreadMain( <span class="keywordtype">void</span>* )
<a name="l00537"></a>00537 {
<a name="l00539"></a>00539         <a class="code" href="class_u_huffman.html" title="Purpose: To perform huffman encoding and fast decoding.">UHuffman</a> decoder;
<a name="l00540"></a>00540         decoder.<a class="code" href="class_u_huffman.html#96d45824c8002b45be38b9cf6ce36e02">SetDecompCodeLengths</a>( kCodeLengths );
<a name="l00541"></a>00541 
<a name="l00543"></a>00543         <span class="keywordflow">while</span> ( LockSwap( &amp;_threadQuit, LOCK_FREE ) == LOCK_FREE )
<a name="l00544"></a>00544         {
<a name="l00547"></a>00547                 <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="_gr_u_t_loader_8cpp.html#7c76c402ba6986c03a9217fb8f1c1238">WORKER_QUEUE_SIZE</a>; ++i )
<a name="l00548"></a>00548                 {
<a name="l00550"></a>00550                         <span class="keywordflow">if</span> ( !<a class="code" href="_f_s_disk_serv_8h.html#013362d3615068eee7220194a88a4d73" title="waits for and resets the gate&amp;#39;s value.">FS_IsComplete</a>( &amp;_queue[ i ].readBuf.complete ) )
<a name="l00551"></a>00551                                 <span class="keywordflow">continue</span>;
<a name="l00552"></a>00552 
<a name="l00554"></a>00554                         decoder.<a class="code" href="class_u_huffman.html#a6ec33a164afdf0b2dc7809a44603953">SetDecompStreamFast</a>( ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* )_queue[ i ].readBuf.buffer, 8 * 2048 );
<a name="l00555"></a>00555 
<a name="l00558"></a>00558                         ProcessTile( _queue[ i ].<a class="code" href="glext_8h.html#92034251bfd455d524a9b5610cddba00">dst</a>, &amp;decoder, _queue[ i ].dxtMode );
<a name="l00559"></a>00559         
<a name="l00561"></a>00561                         FreeLock( _queue[ i ].lock );
<a name="l00562"></a>00562                         FreeLock( &amp;_queue[ i ].inUse );
<a name="l00563"></a>00563                 }
<a name="l00564"></a>00564         }
<a name="l00565"></a>00565 }
<a name="l00566"></a>00566 
<a name="l00567"></a>00567 <span class="comment">//----------------------------------------------------------</span>
<a name="l00568"></a>00568 <span class="keywordtype">void</span> ProcessTile( <span class="keywordtype">void</span>* dest, <a class="code" href="class_u_huffman.html" title="Purpose: To perform huffman encoding and fast decoding.">UHuffman</a>* decoder, <a class="code" href="class_gr_u_t_loader.html#328b8875d7cc411c1ad47f0d9279d8f2">GrUTLoader::ECOLORMODE</a> dxtMode )
<a name="l00569"></a>00569 {
<a name="l00571"></a>00571         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* bump = ( ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* )dest ) + 0;
<a name="l00572"></a>00572         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* diffuse = ( ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* )dest ) + 4096;
<a name="l00573"></a>00573         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* specular = ( ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* )dest ) + 20480;
<a name="l00574"></a>00574 
<a name="l00576"></a>00576         <a class="code" href="_gr_u_t_compress_8cpp.html#3b9ce4279465ebba9c0c804101bb4e57">GrUTDecompressA</a>( bump, 1, decoder );
<a name="l00577"></a>00577         <a class="code" href="_gr_u_t_compress_8cpp.html#7399a317047a570d67f4339531719e01" title="ubertexture decompression services.">GrUTDecompressBGRX</a>( diffuse, decoder );
<a name="l00578"></a>00578         <a class="code" href="_gr_u_t_compress_8cpp.html#3b9ce4279465ebba9c0c804101bb4e57">GrUTDecompressA</a>( diffuse + 3, 4, decoder );
<a name="l00579"></a>00579         <a class="code" href="_gr_u_t_compress_8cpp.html#7399a317047a570d67f4339531719e01" title="ubertexture decompression services.">GrUTDecompressBGRX</a>( specular, decoder );
<a name="l00580"></a>00580 }
<a name="l00581"></a>00581 
<a name="l00582"></a>00582 
<a name="l00583"></a>00583 <span class="preprocessor">#if 0</span>
<a name="l00584"></a>00584 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="_gr_image_8h.html">GrImage.h</a>"</span>
<a name="l00585"></a>00585 <span class="preprocessor">#include "<a class="code" href="_gr_debug_8h.html">GrDebug.h</a>"</span>
<a name="l00586"></a>00586 <span class="preprocessor">#include "<a class="code" href="_r_file_mgr_8h.html">RFileMgr.h</a>"</span>
<a name="l00587"></a>00587 <span class="preprocessor">#include "<a class="code" href="_r_file_8h.html">RFile.h</a>"</span>
<a name="l00588"></a>00588 <span class="preprocessor">#include "<a class="code" href="_u_reader_8h.html">UReader.h</a>"</span>
<a name="l00589"></a>00589 <span class="comment">//----------------------------------------------------------</span>
<a name="l00590"></a>00590 <span class="keywordtype">void</span>
<a name="l00591"></a>00591 GrUTLoader::Test( <span class="keyword">const</span> <span class="keywordtype">char</span>** images, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="_g_l_8h.html#10b284d589000663becfbc6867a3a9f7">count</a> )
<a name="l00592"></a>00592 {
<a name="l00593"></a>00593 <span class="preprocessor">#if 1</span>
<a name="l00596"></a>00596 <span class="preprocessor">        for ( unsigned int i = 0; i &lt; count; ++i )</span>
<a name="l00597"></a>00597 <span class="preprocessor"></span>        {
<a name="l00598"></a>00598                 <a class="code" href="common__afx_8cpp.html#f1a1e0f08b49000974368246e5b97f84" title="debug output/console output function.">PrintF</a>( <span class="stringliteral">"Compressing image %s... "</span>, images[ i ] );
<a name="l00599"></a>00599                 <span class="keywordtype">float</span> mse[ 3 ] = { 0.0f, 0.0f, 0.0f };
<a name="l00600"></a>00600                 <span class="keywordtype">float</span> psnr[ 3 ] = { 0.0f, 0.0f, 0.0f };
<a name="l00601"></a>00601                 CalcImageError( psnr, mse, images[ i ], kQuantY, kQuantCo, kQuantCg, <span class="keyword">true</span> );
<a name="l00602"></a>00602                 <a class="code" href="common__afx_8cpp.html#f1a1e0f08b49000974368246e5b97f84" title="debug output/console output function.">PrintF</a>( <span class="stringliteral">"[done]\n"</span> );
<a name="l00603"></a>00603         }
<a name="l00604"></a>00604 <span class="preprocessor">#endif</span>
<a name="l00605"></a>00605 <span class="preprocessor"></span>
<a name="l00606"></a>00606 <span class="preprocessor">#if 0</span>
<a name="l00608"></a>00608 <span class="preprocessor"></span>
<a name="l00610"></a>00610 <span class="preprocessor">        DECLARE_ALIGNED_16( unsigned short, yQuantMat[ 65 ] );</span>
<a name="l00611"></a>00611 <span class="preprocessor"></span>        <a class="code" href="_u_fixed_8cpp.html#87785ca0ea4e806c7b25d5bcfe11451d" title="class header">DECLARE_ALIGNED_16</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, coQuantMat[ 65 ] );
<a name="l00612"></a>00612         <a class="code" href="_u_fixed_8cpp.html#87785ca0ea4e806c7b25d5bcfe11451d" title="class header">DECLARE_ALIGNED_16</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, cgQuantMat[ 65 ] );
<a name="l00613"></a>00613 
<a name="l00615"></a>00615         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; 65; ++j )
<a name="l00616"></a>00616         {
<a name="l00617"></a>00617                 yQuantMat[ j ] = 16;
<a name="l00618"></a>00618                 coQuantMat[ j ] = 16;
<a name="l00619"></a>00619                 cgQuantMat[ j ] = 16;
<a name="l00620"></a>00620         }
<a name="l00621"></a>00621 
<a name="l00622"></a>00622         <span class="keywordtype">float</span> avgMSE[ 65 ][ 3 ];
<a name="l00623"></a>00623         <span class="keywordtype">float</span> avgPSNR[ 65 ][ 3 ];
<a name="l00624"></a>00624         <a class="code" href="common__afx_8h.html#9f04579206286b6dc8c9708063450144" title="memory functions.">MemSet</a>( avgMSE, 0, <span class="keyword">sizeof</span>( avgMSE ) );
<a name="l00625"></a>00625         <a class="code" href="common__afx_8h.html#9f04579206286b6dc8c9708063450144" title="memory functions.">MemSet</a>( avgPSNR, 0, <span class="keyword">sizeof</span>( avgPSNR ) );
<a name="l00626"></a>00626 
<a name="l00628"></a>00628         <span class="keyword">const</span> <span class="keywordtype">char</span>* kComponentLUT[ 3 ] = { <span class="stringliteral">"Y\n"</span>, <span class="stringliteral">"Co\n"</span>, <span class="stringliteral">"Cg\n"</span> };
<a name="l00629"></a>00629         <span class="keyword">const</span> <span class="keywordtype">char</span>* kComponentLUT2[ 3 ] = { <span class="stringliteral">"Y"</span>, <span class="stringliteral">"Co"</span>, <span class="stringliteral">"Cg"</span> };
<a name="l00630"></a>00630         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>* quantTables[ 3 ] = { yQuantMat, coQuantMat, cgQuantMat };
<a name="l00631"></a>00631         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> file = 0; file &lt; count; ++file )
<a name="l00632"></a>00632         {
<a name="l00633"></a>00633                 <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> = 0; <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> &lt; 3; ++<a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> )
<a name="l00634"></a>00634                 {
<a name="l00635"></a>00635                         <a class="code" href="common__afx_8cpp.html#f1a1e0f08b49000974368246e5b97f84" title="debug output/console output function.">PrintF</a>( <span class="stringliteral">"Calculating %s quantization data for image %s... ["</span>, kComponentLUT2[ <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> ], images[ file ] );
<a name="l00636"></a>00636                         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>* quantMat = quantTables[ <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> ];
<a name="l00637"></a>00637                         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; 65; ++i )
<a name="l00638"></a>00638                         {
<a name="l00640"></a>00640                                 quantMat[ i ] = 128;
<a name="l00641"></a>00641 
<a name="l00643"></a>00643                                 <span class="keywordflow">if</span> ( ( i &amp; 15 ) == 0 &amp;&amp; i &gt; 0 )
<a name="l00644"></a>00644                                         <a class="code" href="common__afx_8cpp.html#f1a1e0f08b49000974368246e5b97f84" title="debug output/console output function.">PrintF</a>( <span class="stringliteral">"*"</span> );
<a name="l00645"></a>00645 
<a name="l00647"></a>00647                                 <span class="keywordtype">float</span> mse[ 3 ] = { 0.0f, 0.0f, 0.0f };
<a name="l00648"></a>00648                                 <span class="keywordtype">float</span> psnr[ 3 ] = { 0.0f, 0.0f, 0.0f };
<a name="l00649"></a>00649                                 CalcImageError( psnr, mse, images[ file ], yQuantMat, coQuantMat, cgQuantMat, <span class="keyword">false</span> );
<a name="l00650"></a>00650 
<a name="l00652"></a>00652                                 avgMSE[ i ][ <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> ] += mse[ 0 ];
<a name="l00653"></a>00653                                 avgMSE[ i ][ <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> ] += mse[ 1 ];
<a name="l00654"></a>00654                                 avgMSE[ i ][ <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> ] += mse[ 2 ];
<a name="l00655"></a>00655                                 avgPSNR[ i ][ <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> ] += psnr[ 0 ];
<a name="l00656"></a>00656                                 avgPSNR[ i ][ <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> ] += psnr[ 1 ];
<a name="l00657"></a>00657                                 avgPSNR[ i ][ <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> ] += psnr[ 2 ];
<a name="l00658"></a>00658 
<a name="l00660"></a>00660                                 quantMat[ i ] = 16;
<a name="l00661"></a>00661                         }
<a name="l00662"></a>00662                         <a class="code" href="common__afx_8cpp.html#f1a1e0f08b49000974368246e5b97f84" title="debug output/console output function.">PrintF</a>( <span class="stringliteral">"]\n"</span> );
<a name="l00663"></a>00663                 }
<a name="l00664"></a>00664         }
<a name="l00665"></a>00665 
<a name="l00667"></a>00667         <span class="keywordtype">float</span> invCount = 1.0f / ( 3 * count );
<a name="l00668"></a>00668         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; 65; ++i )
<a name="l00669"></a>00669         {
<a name="l00670"></a>00670                 avgMSE[ i ][ 0 ] *= invCount;
<a name="l00671"></a>00671                 avgMSE[ i ][ 1 ] *= invCount;
<a name="l00672"></a>00672                 avgMSE[ i ][ 2 ] *= invCount;
<a name="l00673"></a>00673                 avgPSNR[ i ][ 0 ] *= invCount;
<a name="l00674"></a>00674                 avgPSNR[ i ][ 1 ] *= invCount;
<a name="l00675"></a>00675                 avgPSNR[ i ][ 2 ] *= invCount;
<a name="l00676"></a>00676         }
<a name="l00677"></a>00677 
<a name="l00679"></a>00679         <a class="code" href="common__afx_8h.html#816fa58fd77499b0edb2c69ebe803d5c" title="include BootstrapFS.">tstring</a> quantInfo;
<a name="l00680"></a>00680         quantInfo += <span class="stringliteral">"PSNR Info:\n"</span>;
<a name="l00681"></a>00681         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> = 0; <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> &lt; 3; ++<a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> )
<a name="l00682"></a>00682         {
<a name="l00683"></a>00683                 quantInfo += kComponentLUT[ <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> ];
<a name="l00684"></a>00684                 <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; 65; ++i )
<a name="l00685"></a>00685                 {
<a name="l00686"></a>00686                         <span class="keywordtype">float</span> psnrDif = avgPSNR[ i ][ <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> ]; 
<a name="l00687"></a>00687                         quantInfo &lt;&lt; psnrDif;
<a name="l00688"></a>00688 
<a name="l00689"></a>00689                         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> eol = ( i &amp; 7 );
<a name="l00690"></a>00690                         <span class="keywordflow">if</span> ( eol == 7 )
<a name="l00691"></a>00691                                 quantInfo += <span class="stringliteral">",\n"</span>;
<a name="l00692"></a>00692                         <span class="keywordflow">else</span>
<a name="l00693"></a>00693                                 quantInfo += <span class="stringliteral">", "</span>;
<a name="l00694"></a>00694                 }
<a name="l00695"></a>00695                 quantInfo += <span class="stringliteral">"\n"</span>;
<a name="l00696"></a>00696         }
<a name="l00697"></a>00697 
<a name="l00699"></a>00699         quantInfo += <span class="stringliteral">"\n"</span>;
<a name="l00700"></a>00700         quantInfo += <span class="stringliteral">"MSE Info:\n"</span>;
<a name="l00701"></a>00701         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> = 0; <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> &lt; 3; ++<a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> )
<a name="l00702"></a>00702         {
<a name="l00703"></a>00703                 quantInfo += kComponentLUT[ <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> ];
<a name="l00704"></a>00704                 <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; 65; ++i )
<a name="l00705"></a>00705                 {
<a name="l00706"></a>00706                         <span class="keywordtype">float</span> mseDif = avgMSE[ i ][ <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> ]; 
<a name="l00707"></a>00707                         quantInfo &lt;&lt; mseDif;
<a name="l00708"></a>00708 
<a name="l00709"></a>00709                         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> eol = ( i &amp; 7 );
<a name="l00710"></a>00710                         <span class="keywordflow">if</span> ( eol == 7 )
<a name="l00711"></a>00711                                 quantInfo += <span class="stringliteral">",\n"</span>;
<a name="l00712"></a>00712                         <span class="keywordflow">else</span>
<a name="l00713"></a>00713                                 quantInfo += <span class="stringliteral">", "</span>;
<a name="l00714"></a>00714                 }
<a name="l00715"></a>00715                 quantInfo += <span class="stringliteral">"\n"</span>;
<a name="l00716"></a>00716         }
<a name="l00717"></a>00717 
<a name="l00718"></a>00718         quantInfo += <span class="stringliteral">"\nRecommended Quantization Coefficients:\n\n"</span>;
<a name="l00719"></a>00719 
<a name="l00721"></a>00721         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> = 0; <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> &lt; 3; ++<a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> )
<a name="l00722"></a>00722         {
<a name="l00724"></a>00724                 quantInfo += kComponentLUT[ <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> ];
<a name="l00725"></a>00725 
<a name="l00727"></a>00727                 <span class="keywordtype">float</span> minComponent = FLT_MAX;
<a name="l00728"></a>00728                 <span class="keywordtype">float</span> maxComponent = 0.0f;
<a name="l00729"></a>00729                 <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 1; i &lt; 65; ++i )
<a name="l00730"></a>00730                 {
<a name="l00731"></a>00731                         minComponent = <a class="code" href="common__afx_8h.html#0296e17691267defafdfde06589f50d5">Min</a>( avgMSE[ i ][ <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> ], minComponent );
<a name="l00732"></a>00732                         maxComponent = <a class="code" href="common__afx_8h.html#dd09d155ffe827b203d3236b451752e7">Max</a>( avgMSE[ i ][ <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> ], maxComponent );
<a name="l00733"></a>00733                 }
<a name="l00734"></a>00734 
<a name="l00736"></a>00736                 quantInfo &lt;&lt; 8;
<a name="l00737"></a>00737                 quantInfo += <span class="stringliteral">", "</span>;
<a name="l00738"></a>00738 
<a name="l00740"></a>00740                 <span class="keywordtype">float</span> invRange = 1.0f / ( maxComponent - minComponent );
<a name="l00741"></a>00741                 <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 1; i &lt; 64; ++i )
<a name="l00742"></a>00742                 {
<a name="l00744"></a>00744                         <span class="keywordtype">float</span> <a class="code" href="glext_8h.html#00140d6f5c548b26daf170bf16e86a6d">t</a> = invRange * ( avgMSE[ i ][ <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> ] - minComponent );
<a name="l00745"></a>00745                         <span class="keywordtype">float</span> coeff = <a class="code" href="common__afx_8h.html#e1fb23c1e592f53f89861e329acc843a">Lerp</a>( 128.0f, 8.0f, <a class="code" href="common__afx_8h.html#28313dfeda7c503b70ae96a4e3ab1bc3">Sqrt</a>( t ) );
<a name="l00746"></a>00746 
<a name="l00748"></a>00748                         quantInfo &lt;&lt; ( <a class="code" href="_g_l_aux_8h.html#b832c174e145540d491b0830fc05dbb1">int</a> )coeff;
<a name="l00749"></a>00749                         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> eol = ( i &amp; 7 );
<a name="l00750"></a>00750                         <span class="keywordflow">if</span> ( eol == 7 )
<a name="l00751"></a>00751                                 quantInfo += <span class="stringliteral">",\n"</span>;
<a name="l00752"></a>00752                         <span class="keywordflow">else</span>
<a name="l00753"></a>00753                                 quantInfo += <span class="stringliteral">", "</span>;
<a name="l00754"></a>00754                 }
<a name="l00755"></a>00755                 quantInfo += <span class="stringliteral">"\n"</span>;
<a name="l00756"></a>00756         }
<a name="l00757"></a>00757 
<a name="l00759"></a>00759         <a class="code" href="class_u_ref.html">URef&lt; RFile &gt;</a> file = <a class="code" href="_r_file_mgr_8cpp.html#b27cd6d5cc5b23b502509e7fdab9c32e">gRFileMgr</a>-&gt;<a class="code" href="class_r_file_mgr.html#d7f101aeebcb703282cfcb6c8eba67f9" title="get a file.">GetFile</a>( <span class="stringliteral">"quant.txt"</span>, RFileMgr::kFlagCreate | <a class="code" href="class_r_file_mgr.html#d50cfef45d5e20a1de1abc17c0691067">RFileMgr::kFlagWrite</a> );
<a name="l00760"></a>00760         file-&gt;WriteData( 0, quantInfo.c_str(), ( <span class="keywordtype">unsigned</span> <a class="code" href="_g_l_aux_8h.html#b832c174e145540d491b0830fc05dbb1">int</a> )quantInfo.length() );
<a name="l00761"></a>00761 <span class="preprocessor">#endif</span>
<a name="l00762"></a>00762 <span class="preprocessor"></span>}
<a name="l00763"></a>00763 
<a name="l00764"></a>00764 <span class="comment">//----------------------------------------------------------</span>
<a name="l00765"></a>00765 <span class="keywordtype">void</span> GrUTLoader::CalcImageError( <span class="keywordtype">float</span>* psnr, <span class="keywordtype">float</span>* mse, <span class="keyword">const</span> <span class="keywordtype">char</span>* fileName, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>* yQuant,
<a name="l00766"></a>00766                                                                  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>* coQuant, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>* cbQuant, <span class="keywordtype">bool</span> saveResult )
<a name="l00767"></a>00767 {
<a name="l00769"></a>00769         <a class="code" href="_u_fixed_8cpp.html#87785ca0ea4e806c7b25d5bcfe11451d" title="class header">DECLARE_ALIGNED_16</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, bgra[ 256 ] );
<a name="l00770"></a>00770 
<a name="l00772"></a>00772         <a class="code" href="_u_fixed_8cpp.html#87785ca0ea4e806c7b25d5bcfe11451d" title="class header">DECLARE_ALIGNED_16</a>( <span class="keywordtype">short</span>, Y0[ 64 ] );
<a name="l00773"></a>00773         <a class="code" href="_u_fixed_8cpp.html#87785ca0ea4e806c7b25d5bcfe11451d" title="class header">DECLARE_ALIGNED_16</a>( <span class="keywordtype">short</span>, Y1[ 64 ] );
<a name="l00774"></a>00774         <a class="code" href="_u_fixed_8cpp.html#87785ca0ea4e806c7b25d5bcfe11451d" title="class header">DECLARE_ALIGNED_16</a>( <span class="keywordtype">short</span>, Y2[ 64 ] );
<a name="l00775"></a>00775         <a class="code" href="_u_fixed_8cpp.html#87785ca0ea4e806c7b25d5bcfe11451d" title="class header">DECLARE_ALIGNED_16</a>( <span class="keywordtype">short</span>, Y3[ 64 ] );
<a name="l00776"></a>00776         <a class="code" href="_u_fixed_8cpp.html#87785ca0ea4e806c7b25d5bcfe11451d" title="class header">DECLARE_ALIGNED_16</a>( <span class="keywordtype">short</span>, Co[ 64 ] );
<a name="l00777"></a>00777         <a class="code" href="_u_fixed_8cpp.html#87785ca0ea4e806c7b25d5bcfe11451d" title="class header">DECLARE_ALIGNED_16</a>( <span class="keywordtype">short</span>, Cg[ 64 ] );
<a name="l00778"></a>00778 
<a name="l00780"></a>00780         <a class="code" href="_u_fixed_8cpp.html#87785ca0ea4e806c7b25d5bcfe11451d" title="class header">DECLARE_ALIGNED_16</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, cmpCo[ 64 ] );
<a name="l00781"></a>00781         <a class="code" href="_u_fixed_8cpp.html#87785ca0ea4e806c7b25d5bcfe11451d" title="class header">DECLARE_ALIGNED_16</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, cmpCg[ 64 ] );
<a name="l00782"></a>00782         <a class="code" href="_u_fixed_8cpp.html#87785ca0ea4e806c7b25d5bcfe11451d" title="class header">DECLARE_ALIGNED_16</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, cmpY0[ 64 ] );
<a name="l00783"></a>00783         <a class="code" href="_u_fixed_8cpp.html#87785ca0ea4e806c7b25d5bcfe11451d" title="class header">DECLARE_ALIGNED_16</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, cmpY1[ 64 ] );
<a name="l00784"></a>00784         <a class="code" href="_u_fixed_8cpp.html#87785ca0ea4e806c7b25d5bcfe11451d" title="class header">DECLARE_ALIGNED_16</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, cmpY2[ 64 ] );
<a name="l00785"></a>00785         <a class="code" href="_u_fixed_8cpp.html#87785ca0ea4e806c7b25d5bcfe11451d" title="class header">DECLARE_ALIGNED_16</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, cmpY3[ 64 ] );
<a name="l00786"></a>00786 
<a name="l00788"></a>00788         <a class="code" href="class_u_ref.html">URef&lt; RFile &gt;</a> file = <a class="code" href="_r_file_mgr_8cpp.html#b27cd6d5cc5b23b502509e7fdab9c32e">gRFileMgr</a>-&gt;<a class="code" href="class_r_file_mgr.html#d7f101aeebcb703282cfcb6c8eba67f9" title="get a file.">GetFile</a>( fileName, <a class="code" href="class_r_file_mgr.html#cf4103da9315f00f0ca524c2f263a1b4">RFileMgr::kFlagRead</a> );
<a name="l00789"></a>00789         <a class="code" href="class_u_reader.html" title="Purpose: To wrap and simplify pointer read operations.">UReader</a> reader( file-&gt;GetData(), ( <span class="keywordtype">unsigned</span> long )file-&gt;GetSize(), false );
<a name="l00790"></a>00790         <a class="code" href="class_gr_image.html" title="class GrTexture">GrImage</a> <a class="code" href="glext_8h.html#4f252db605f5b9117603096756e79824">image</a>( fileName, reader );
<a name="l00791"></a>00791         reader.Reset();
<a name="l00792"></a>00792         <a class="code" href="class_gr_image.html" title="class GrTexture">GrImage</a> backup( fileName, reader );
<a name="l00793"></a>00793 
<a name="l00795"></a>00795         <span class="keywordtype">void</span>* <a class="code" href="_g_l_8h.html#89ce72163394e6aef63b551a8806e93f">data</a> = <a class="code" href="glext_8h.html#4f252db605f5b9117603096756e79824">image</a>.GetImageData();
<a name="l00796"></a>00796         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="_g_l_8h.html#e6531b1788ca42a9ae8155b0c52e7630">width</a> = <a class="code" href="glext_8h.html#4f252db605f5b9117603096756e79824">image</a>.GetWidth();
<a name="l00797"></a>00797         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="_g_l_8h.html#b2e63df950c3789599e1e43f477bc9e3">height</a> = <a class="code" href="glext_8h.html#4f252db605f5b9117603096756e79824">image</a>.GetHeight();
<a name="l00798"></a>00798         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxSizeInBytes = 0;
<a name="l00799"></a>00799         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> totalSizeInBytes = 0;
<a name="l00800"></a>00800 
<a name="l00804"></a>00804 
<a name="l00806"></a>00806         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bitCount = 0;
<a name="l00807"></a>00807         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bytesPerPel = <a class="code" href="glext_8h.html#4f252db605f5b9117603096756e79824">image</a>.GetBytesPerPixel();
<a name="l00808"></a>00808         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="_g_l_8h.html#9298c7ad619074f5285b32c6b72bfdea">y</a> = 0; <a class="code" href="_g_l_8h.html#9298c7ad619074f5285b32c6b72bfdea">y</a> &lt; height; <a class="code" href="_g_l_8h.html#9298c7ad619074f5285b32c6b72bfdea">y</a> += 16 )
<a name="l00809"></a>00809         {
<a name="l00810"></a>00810                 <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="glext_8h.html#d77deca22f617d3f0e0eb786445689fc">x</a> = 0; <a class="code" href="glext_8h.html#d77deca22f617d3f0e0eb786445689fc">x</a> &lt; width; <a class="code" href="glext_8h.html#d77deca22f617d3f0e0eb786445689fc">x</a> += 16 )
<a name="l00811"></a>00811                 {
<a name="l00813"></a>00813                         ExtractBlockBGR( bgra, ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* )data, width, bytesPerPel, <a class="code" href="glext_8h.html#d77deca22f617d3f0e0eb786445689fc">x</a> + 0, <a class="code" href="_g_l_8h.html#9298c7ad619074f5285b32c6b72bfdea">y</a> + 0 );
<a name="l00814"></a>00814                         <a class="code" href="_gr_u_t_compress_8cpp.html#837db1acd9af4e8656f2de61bfc4934b">PackYCoCg</a>( Y0, Co +  0, Cg +  0, bgra );
<a name="l00815"></a>00815 
<a name="l00816"></a>00816                         ExtractBlockBGR( bgra, ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* )data, width, bytesPerPel, <a class="code" href="glext_8h.html#d77deca22f617d3f0e0eb786445689fc">x</a> + 8, <a class="code" href="_g_l_8h.html#9298c7ad619074f5285b32c6b72bfdea">y</a> + 0 );
<a name="l00817"></a>00817                         <a class="code" href="_gr_u_t_compress_8cpp.html#837db1acd9af4e8656f2de61bfc4934b">PackYCoCg</a>( Y1, Co +  4, Cg +  4, bgra );
<a name="l00818"></a>00818 
<a name="l00819"></a>00819                         ExtractBlockBGR( bgra, ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* )data, width, bytesPerPel, <a class="code" href="glext_8h.html#d77deca22f617d3f0e0eb786445689fc">x</a> + 0, <a class="code" href="_g_l_8h.html#9298c7ad619074f5285b32c6b72bfdea">y</a> + 8 );
<a name="l00820"></a>00820                         <a class="code" href="_gr_u_t_compress_8cpp.html#837db1acd9af4e8656f2de61bfc4934b">PackYCoCg</a>( Y2, Co + 32, Cg + 32, bgra );
<a name="l00821"></a>00821 
<a name="l00822"></a>00822                         ExtractBlockBGR( bgra, ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* )data, width, bytesPerPel, <a class="code" href="glext_8h.html#d77deca22f617d3f0e0eb786445689fc">x</a> + 8, <a class="code" href="_g_l_8h.html#9298c7ad619074f5285b32c6b72bfdea">y</a> + 8 );
<a name="l00823"></a>00823                         <a class="code" href="_gr_u_t_compress_8cpp.html#837db1acd9af4e8656f2de61bfc4934b">PackYCoCg</a>( Y3, Co + 36, Cg + 36, bgra );
<a name="l00824"></a>00824 
<a name="l00825"></a>00825                         _entropyEncoder.SetCompStream( cmpCo, kCodeLengths );
<a name="l00826"></a>00826                         bitCount = <a class="code" href="_gr_u_t_compress_8cpp.html#a2dc6af8d8de355af5a29f54662ee89a">EncodeBlock</a>( &amp;_entropyEncoder, Co, coQuant, 0 );
<a name="l00827"></a>00827                         _entropyEncoder.SetDecompStream( kCodeLengths, cmpCo, bitCount );
<a name="l00828"></a>00828                         <a class="code" href="_gr_u_t_compress_8cpp.html#28ae6c6b1c96f54c4aa404da48daa0d8">DecodeBlock</a>( Co, &amp;_entropyEncoder, coQuant );
<a name="l00829"></a>00829                         maxSizeInBytes = <a class="code" href="common__afx_8h.html#dd09d155ffe827b203d3236b451752e7">Max</a>( maxSizeInBytes, ( bitCount + 7 ) / 8 );
<a name="l00830"></a>00830                         totalSizeInBytes += ( bitCount + 7 ) / 8;
<a name="l00831"></a>00831 
<a name="l00832"></a>00832                         _entropyEncoder.SetCompStream( cmpCg, kCodeLengths );
<a name="l00833"></a>00833                         bitCount = <a class="code" href="_gr_u_t_compress_8cpp.html#a2dc6af8d8de355af5a29f54662ee89a">EncodeBlock</a>( &amp;_entropyEncoder, Cg, cbQuant, 0 );
<a name="l00834"></a>00834                         _entropyEncoder.SetDecompStream( kCodeLengths, cmpCg, bitCount );
<a name="l00835"></a>00835                         <a class="code" href="_gr_u_t_compress_8cpp.html#28ae6c6b1c96f54c4aa404da48daa0d8">DecodeBlock</a>( Cg, &amp;_entropyEncoder, cbQuant );
<a name="l00836"></a>00836                         maxSizeInBytes = <a class="code" href="common__afx_8h.html#dd09d155ffe827b203d3236b451752e7">Max</a>( maxSizeInBytes, ( bitCount + 7 ) / 8 );
<a name="l00837"></a>00837                         totalSizeInBytes += ( bitCount + 7 ) / 8;
<a name="l00838"></a>00838 
<a name="l00839"></a>00839                         _entropyEncoder.SetCompStream( cmpY0, kCodeLengths );
<a name="l00840"></a>00840                         bitCount = <a class="code" href="_gr_u_t_compress_8cpp.html#a2dc6af8d8de355af5a29f54662ee89a">EncodeBlock</a>( &amp;_entropyEncoder, Y0, yQuant, 0 );
<a name="l00841"></a>00841                         _entropyEncoder.SetDecompStream( kCodeLengths, cmpY0, bitCount );
<a name="l00842"></a>00842                         <a class="code" href="_gr_u_t_compress_8cpp.html#28ae6c6b1c96f54c4aa404da48daa0d8">DecodeBlock</a>( Y0, &amp;_entropyEncoder, yQuant );
<a name="l00843"></a>00843                         maxSizeInBytes = <a class="code" href="common__afx_8h.html#dd09d155ffe827b203d3236b451752e7">Max</a>( maxSizeInBytes, ( bitCount + 7 ) / 8 );
<a name="l00844"></a>00844                         totalSizeInBytes += ( bitCount + 7 ) / 8;
<a name="l00845"></a>00845 
<a name="l00846"></a>00846                         _entropyEncoder.SetCompStream( cmpY1, kCodeLengths );
<a name="l00847"></a>00847                         bitCount = <a class="code" href="_gr_u_t_compress_8cpp.html#a2dc6af8d8de355af5a29f54662ee89a">EncodeBlock</a>( &amp;_entropyEncoder, Y1, yQuant, 0 );
<a name="l00848"></a>00848                         _entropyEncoder.SetDecompStream( kCodeLengths, cmpY1, bitCount );
<a name="l00849"></a>00849                         <a class="code" href="_gr_u_t_compress_8cpp.html#28ae6c6b1c96f54c4aa404da48daa0d8">DecodeBlock</a>( Y1, &amp;_entropyEncoder, yQuant );
<a name="l00850"></a>00850                         maxSizeInBytes = <a class="code" href="common__afx_8h.html#dd09d155ffe827b203d3236b451752e7">Max</a>( maxSizeInBytes, ( bitCount + 7 ) / 8 );
<a name="l00851"></a>00851                         totalSizeInBytes += ( bitCount + 7 ) / 8;
<a name="l00852"></a>00852 
<a name="l00853"></a>00853                         _entropyEncoder.SetCompStream( cmpY2, kCodeLengths );
<a name="l00854"></a>00854                         bitCount = <a class="code" href="_gr_u_t_compress_8cpp.html#a2dc6af8d8de355af5a29f54662ee89a">EncodeBlock</a>( &amp;_entropyEncoder, Y2, yQuant, 0 );
<a name="l00855"></a>00855                         _entropyEncoder.SetDecompStream( kCodeLengths, cmpY2, bitCount );
<a name="l00856"></a>00856                         <a class="code" href="_gr_u_t_compress_8cpp.html#28ae6c6b1c96f54c4aa404da48daa0d8">DecodeBlock</a>( Y2, &amp;_entropyEncoder, yQuant );
<a name="l00857"></a>00857                         maxSizeInBytes = <a class="code" href="common__afx_8h.html#dd09d155ffe827b203d3236b451752e7">Max</a>( maxSizeInBytes, ( bitCount + 7 ) / 8 );
<a name="l00858"></a>00858                         totalSizeInBytes += ( bitCount + 7 ) / 8;
<a name="l00859"></a>00859 
<a name="l00860"></a>00860                         _entropyEncoder.SetCompStream( cmpY3, kCodeLengths );
<a name="l00861"></a>00861                         bitCount = <a class="code" href="_gr_u_t_compress_8cpp.html#a2dc6af8d8de355af5a29f54662ee89a">EncodeBlock</a>( &amp;_entropyEncoder, Y3, yQuant, 0 );
<a name="l00862"></a>00862                         _entropyEncoder.SetDecompStream( kCodeLengths, cmpY3, bitCount );
<a name="l00863"></a>00863                         <a class="code" href="_gr_u_t_compress_8cpp.html#28ae6c6b1c96f54c4aa404da48daa0d8">DecodeBlock</a>( Y3, &amp;_entropyEncoder, yQuant );
<a name="l00864"></a>00864                         maxSizeInBytes = <a class="code" href="common__afx_8h.html#dd09d155ffe827b203d3236b451752e7">Max</a>( maxSizeInBytes, ( bitCount + 7 ) / 8 );
<a name="l00865"></a>00865                         totalSizeInBytes += ( bitCount + 7 ) / 8;
<a name="l00866"></a>00866 
<a name="l00868"></a>00868                         <a class="code" href="_gr_u_t_compress_8cpp.html#0bb3bd6d7081978578686fd177fa740b">UnpackYCoCg</a>( bgra, Y0, Co +  0, Cg +  0 );
<a name="l00869"></a>00869                         InsertBlockBGR( ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* )data, width, bytesPerPel, <a class="code" href="glext_8h.html#d77deca22f617d3f0e0eb786445689fc">x</a> + 0, <a class="code" href="_g_l_8h.html#9298c7ad619074f5285b32c6b72bfdea">y</a> + 0, bgra );
<a name="l00870"></a>00870 
<a name="l00871"></a>00871                         <a class="code" href="_gr_u_t_compress_8cpp.html#0bb3bd6d7081978578686fd177fa740b">UnpackYCoCg</a>( bgra, Y1, Co +  4, Cg +  4 );
<a name="l00872"></a>00872                         InsertBlockBGR( ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* )data, width, bytesPerPel, <a class="code" href="glext_8h.html#d77deca22f617d3f0e0eb786445689fc">x</a> + 8, <a class="code" href="_g_l_8h.html#9298c7ad619074f5285b32c6b72bfdea">y</a> + 0, bgra );
<a name="l00873"></a>00873 
<a name="l00874"></a>00874                         <a class="code" href="_gr_u_t_compress_8cpp.html#0bb3bd6d7081978578686fd177fa740b">UnpackYCoCg</a>( bgra, Y2, Co + 32, Cg + 32 );
<a name="l00875"></a>00875                         InsertBlockBGR( ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* )data, width, bytesPerPel, <a class="code" href="glext_8h.html#d77deca22f617d3f0e0eb786445689fc">x</a> + 0, <a class="code" href="_g_l_8h.html#9298c7ad619074f5285b32c6b72bfdea">y</a> + 8, bgra );
<a name="l00876"></a>00876 
<a name="l00877"></a>00877                         <a class="code" href="_gr_u_t_compress_8cpp.html#0bb3bd6d7081978578686fd177fa740b">UnpackYCoCg</a>( bgra, Y3, Co + 36, Cg + 36 );
<a name="l00878"></a>00878                         InsertBlockBGR( ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* )data, width, bytesPerPel, <a class="code" href="glext_8h.html#d77deca22f617d3f0e0eb786445689fc">x</a> + 8, <a class="code" href="_g_l_8h.html#9298c7ad619074f5285b32c6b72bfdea">y</a> + 8, bgra );
<a name="l00879"></a>00879                 }
<a name="l00880"></a>00880         }
<a name="l00881"></a>00881 
<a name="l00883"></a>00883         <span class="keywordtype">float</span> meanSqrError = 0.0f;
<a name="l00884"></a>00884         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* lossy = ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* )<a class="code" href="glext_8h.html#4f252db605f5b9117603096756e79824">image</a>.GetImageData();
<a name="l00885"></a>00885         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* <a class="code" href="glext_8h.html#72e0fdf0f845ded60b1fada9e9195cd7">src</a> = ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* )backup.GetImageData();
<a name="l00886"></a>00886 
<a name="l00889"></a>00889         <span class="keywordtype">double</span> localMse[ 3 ] = { 0.0, 0.0, 0.0 };
<a name="l00890"></a>00890         <span class="keywordtype">double</span> invPelCount = 1.0 / ( width * height );
<a name="l00891"></a>00891         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="_g_l_8h.html#9298c7ad619074f5285b32c6b72bfdea">y</a> = 0; <a class="code" href="_g_l_8h.html#9298c7ad619074f5285b32c6b72bfdea">y</a> &lt; height; ++<a class="code" href="_g_l_8h.html#9298c7ad619074f5285b32c6b72bfdea">y</a> )
<a name="l00892"></a>00892                 <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="glext_8h.html#d77deca22f617d3f0e0eb786445689fc">x</a> = 0; <a class="code" href="glext_8h.html#d77deca22f617d3f0e0eb786445689fc">x</a> &lt; width; ++<a class="code" href="glext_8h.html#d77deca22f617d3f0e0eb786445689fc">x</a>, lossy += bytesPerPel, src += bytesPerPel )
<a name="l00893"></a>00893                         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> = 0; <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> &lt; 3; ++<a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> )
<a name="l00894"></a>00894                                 localMse[ <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> ] += invPelCount * <a class="code" href="common__afx_8h.html#9443605a3554459dd5144f28f698d16d">Sqr</a>( ( <span class="keywordtype">double</span> )lossy[ <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> ] - ( double )src[ <a class="code" href="glext_8h.html#1f2d7f8147412c43ba2303a56f97ee73">c</a> ] );
<a name="l00895"></a>00895 
<a name="l00897"></a>00897         mse[ 0 ] = ( float )localMse[ 0 ];
<a name="l00898"></a>00898         mse[ 1 ] = ( float )localMse[ 1 ];
<a name="l00899"></a>00899         mse[ 2 ] = ( float )localMse[ 2 ];
<a name="l00900"></a>00900 
<a name="l00902"></a>00902         psnr[ 0 ] = psnr[ 1 ] = psnr[ 2 ] = 0;
<a name="l00903"></a>00903         <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; 3; ++c )
<a name="l00904"></a>00904                 psnr[ c ] = 20.0f * <a class="code" href="common__afx_8h.html#8b9271c5b1156867f41e4bff995849cb">Log</a>( 255.0f / <a class="code" href="common__afx_8h.html#28313dfeda7c503b70ae96a4e3ab1bc3">Sqrt</a>( ( <span class="keywordtype">float</span> )mse[ c ] ) );
<a name="l00905"></a>00905 
<a name="l00906"></a>00906 <span class="preprocessor">#if 1</span>
<a name="l00907"></a>00907 <span class="preprocessor"></span>        <a class="code" href="common__afx_8cpp.html#f1a1e0f08b49000974368246e5b97f84" title="debug output/console output function.">PrintF</a>( <span class="stringliteral">"Compression statistics for %s...\n"</span>, fileName );
<a name="l00908"></a>00908         <a class="code" href="common__afx_8cpp.html#f1a1e0f08b49000974368246e5b97f84" title="debug output/console output function.">PrintF</a>( <span class="stringliteral">" PSNR (BGR): %f, %f, %f\n"</span>, psnr[ 0 ], psnr[ 1 ], psnr[ 2 ] );
<a name="l00909"></a>00909 
<a name="l00910"></a>00910         <a class="code" href="common__afx_8cpp.html#f1a1e0f08b49000974368246e5b97f84" title="debug output/console output function.">PrintF</a>( <span class="stringliteral">" Total image size in bytes: %d\n"</span>, totalSizeInBytes );
<a name="l00911"></a>00911         <a class="code" href="common__afx_8cpp.html#f1a1e0f08b49000974368246e5b97f84" title="debug output/console output function.">PrintF</a>( <span class="stringliteral">" Max block size in bytes: %d\n"</span>, maxSizeInBytes );
<a name="l00912"></a>00912 <span class="preprocessor">#endif</span>
<a name="l00913"></a>00913 <span class="preprocessor"></span>
<a name="l00914"></a>00914         <span class="keywordflow">if</span> ( saveResult )
<a name="l00915"></a>00915         {
<a name="l00918"></a>00918                 <span class="keywordtype">char</span> prefix[] = <span class="stringliteral">"cmp_"</span>;
<a name="l00919"></a>00919                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fileNameMemSize = ( <span class="keywordtype">unsigned</span> <a class="code" href="_g_l_aux_8h.html#b832c174e145540d491b0830fc05dbb1">int</a> )strlen( fileName ) + 1;
<a name="l00920"></a>00920                 <span class="keywordtype">char</span>* tempBuf = <span class="keyword">new</span> <span class="keywordtype">char</span>[ <span class="keyword">sizeof</span>( prefix ) + fileNameMemSize ];
<a name="l00921"></a>00921                 <a class="code" href="common__afx_8cpp.html#b4b15928b71967d4c4eb8c12c3108643">MemCopy</a>( tempBuf, prefix, 4 );
<a name="l00922"></a>00922                 <a class="code" href="common__afx_8cpp.html#b4b15928b71967d4c4eb8c12c3108643">MemCopy</a>( tempBuf + 4, fileName, fileNameMemSize );
<a name="l00923"></a>00923 
<a name="l00925"></a>00925                 <a class="code" href="_gr_debug_8cpp.html#f82ebae2e158d721c11ff92a1c69fe69" title="functions implementations.">GrSaveTGA</a>( tempBuf, data, width, height, bytesPerPel );
<a name="l00926"></a>00926 
<a name="l00928"></a>00928                 <span class="keyword">delete</span>[] tempBuf;
<a name="l00929"></a>00929         }
<a name="l00930"></a>00930 }
<a name="l00931"></a>00931 <span class="preprocessor">#endif</span>
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Fri Feb 13 17:20:00 2009 for Bootstrap Engine by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
